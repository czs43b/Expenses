import{a as b_,b as R_,c as P_,d as x_,e as Oa,f as N_,g as D_,h as Ma,i as ty}from"./chunk-UXHUM5PL.js";import{$ as Pa,$a as Da,$b as el,B as Ca,G as Aa,Gb as S_,H as cr,Ha as w_,Hb as Va,I as f_,Ib as Fa,J as p_,Jb as C_,K as ba,Ka as Ke,Kb as ti,L as m_,La as Mt,Mb as A_,O as g_,Pb as za,Q as ei,Qb as Ka,R as Ra,Rb as Wa,Sb as Ue,T as An,Ta as Pt,Tb as Qa,Ub as $a,V as ee,Vb as Ha,W as on,Wa as Lt,Wb as z_,Xa as hr,Xb as Ya,Ya as ue,Yb as Ja,Za as ie,Zb as Xa,_ as bn,_a as an,_b as Za,ab as vt,ac as tl,ba as __,bb as dr,bc as nl,c as Ta,cb as E_,cc as rl,da as y_,db as I_,dc as il,eb as fe,ec as K_,fb as ka,fc as ln,gb as eh,gc as W_,h as Sa,hb as Rn,hc as ah,ia as Ds,ib as fr,ic as Q_,j as xs,ja as ks,jb as Vs,jc as $_,k as Ns,kb as th,kc as sl,lc as H_,mc as Y_,nc as J_,o as De,oa as v_,oc as X_,pa as xa,pc as Z_,qc as ey,rb as T_,u as Xc,v as Zc,va as Na}from"./chunk-7MNE7OZS.js";import{A as B_,B as wt,C as Pn,D as Ba,E as Os,F as ih,G as q_,H as G_,I as K,J as ct,K as Le,L as sh,M as j_,N as Ms,O as te,P as Bt,Q as qa,R as oh,S as Et,T as ri,U as Ga,V as ja,X as ii,Y as xn,a as Cn,b as Ps,c as Jc,d as N,i as F,j as ni,k as k_,l as V_,m as F_,n as rt,o as La,p as Fs,q as nh,r as O_,s as Ut,t as rh,u as M_,v as L_,x as Ua,y as ke,z as U_}from"./chunk-EE3PDMKV.js";var ny="@firebase/database",ry="1.0.8";var vd="";function wd(n){vd=n}var mh=class{constructor(e){this.domStorage_=e,this.prefix_="firebase:"}set(e,t){t==null?this.domStorage_.removeItem(this.prefixedName_(e)):this.domStorage_.setItem(this.prefixedName_(e),ke(t))}get(e){let t=this.domStorage_.getItem(this.prefixedName_(e));return t==null?null:Ua(t)}remove(e){this.domStorage_.removeItem(this.prefixedName_(e))}prefixedName_(e){return this.prefix_+e}toString(){return this.domStorage_.toString()}};var gh=class{constructor(){this.cache_={},this.isInMemoryStorage=!0}set(e,t){t==null?delete this.cache_[e]:this.cache_[e]=t}get(e){return wt(this.cache_,e)?this.cache_[e]:null}remove(e){delete this.cache_[e]}};var Vy=function(n){try{if(typeof window<"u"&&typeof window[n]<"u"){let e=window[n];return e.setItem("firebase:sentinel","cache"),e.removeItem("firebase:sentinel"),new mh(e)}}catch{}return new gh},mr=Vy("localStorage"),_h=Vy("sessionStorage");var li=new ri("@firebase/database"),Fy=function(){let n=1;return function(){return n++}}(),Oy=function(n){let e=j_(n),t=new G_;t.update(e);let r=t.digest();return k_.encodeByteArray(r)},ao=function(...n){let e="";for(let t=0;t<n.length;t++){let r=n[t];Array.isArray(r)||r&&typeof r=="object"&&typeof r.length=="number"?e+=ao.apply(null,r):typeof r=="object"?e+=ke(r):e+=r,e+=" "}return e},gr=null,iy=!0,My=function(n,e){F(!e||n===!0||n===!1,"Can't turn on custom loggers persistently."),n===!0?(li.logLevel=Et.VERBOSE,gr=li.log.bind(li),e&&_h.set("logging_enabled",!0)):typeof n=="function"?gr=n:(gr=null,_h.remove("logging_enabled"))},Ge=function(...n){if(iy===!0&&(iy=!1,gr===null&&_h.get("logging_enabled")===!0&&My(!0)),gr){let e=ao.apply(null,n);gr(e)}},lo=function(n){return function(...e){Ge(n,...e)}},yh=function(...n){let e="FIREBASE INTERNAL ERROR: "+ao(...n);li.error(e)},jt=function(...n){let e=`FIREBASE FATAL ERROR: ${ao(...n)}`;throw li.error(e),new Error(e)},Xe=function(...n){let e="FIREBASE WARNING: "+ao(...n);li.warn(e)},H0=function(){typeof window<"u"&&window.location&&window.location.protocol&&window.location.protocol.indexOf("https:")!==-1&&Xe("Insecure Firebase access from a secure page. Please use https in calls to new Firebase().")},kl=function(n){return typeof n=="number"&&(n!==n||n===Number.POSITIVE_INFINITY||n===Number.NEGATIVE_INFINITY)},Y0=function(n){if(Ut()||document.readyState==="complete")n();else{let e=!1,t=function(){if(!document.body){setTimeout(t,Math.floor(10));return}e||(e=!0,n())};document.addEventListener?(document.addEventListener("DOMContentLoaded",t,!1),window.addEventListener("load",t,!1)):document.attachEvent&&(document.attachEvent("onreadystatechange",()=>{document.readyState==="complete"&&t()}),window.attachEvent("onload",t))}},Vn="[MIN_NAME]",un="[MAX_NAME]",yr=function(n,e){if(n===e)return 0;if(n===Vn||e===un)return-1;if(e===Vn||n===un)return 1;{let t=sy(n),r=sy(e);return t!==null?r!==null?t-r===0?n.length-e.length:t-r:-1:r!==null?1:n<e?-1:1}},J0=function(n,e){return n===e?0:n<e?-1:1},Ls=function(n,e){if(e&&n in e)return e[n];throw new Error("Missing required key ("+n+") in object: "+ke(e))},Ed=function(n){if(typeof n!="object"||n===null)return ke(n);let e=[];for(let r in n)e.push(r);e.sort();let t="{";for(let r=0;r<e.length;r++)r!==0&&(t+=","),t+=ke(e[r]),t+=":",t+=Ed(n[e[r]]);return t+="}",t},Ly=function(n,e){let t=n.length;if(t<=e)return[n];let r=[];for(let i=0;i<t;i+=e)i+e>t?r.push(n.substring(i,t)):r.push(n.substring(i,i+e));return r};function je(n,e){for(let t in n)n.hasOwnProperty(t)&&e(t,n[t])}var Uy=function(n){F(!kl(n),"Invalid JSON number");let e=11,t=52,r=(1<<e-1)-1,i,s,o,l,u;n===0?(s=0,o=0,i=1/n===-1/0?1:0):(i=n<0,n=Math.abs(n),n>=Math.pow(2,1-r)?(l=Math.min(Math.floor(Math.log(n)/Math.LN2),r),s=l+r,o=Math.round(n*Math.pow(2,t-l)-Math.pow(2,t))):(s=0,o=Math.round(n/Math.pow(2,1-r-t))));let c=[];for(u=t;u;u-=1)c.push(o%2?1:0),o=Math.floor(o/2);for(u=e;u;u-=1)c.push(s%2?1:0),s=Math.floor(s/2);c.push(i?1:0),c.reverse();let d=c.join(""),p="";for(u=0;u<64;u+=8){let m=parseInt(d.substr(u,8),2).toString(16);m.length===1&&(m="0"+m),p=p+m}return p.toLowerCase()},X0=function(){return!!(typeof window=="object"&&window.chrome&&window.chrome.extension&&!/^chrome/.test(window.location.href))},Z0=function(){return typeof Windows=="object"&&typeof Windows.UI=="object"};function eS(n,e){let t="Unknown Error";n==="too_big"?t="The data requested exceeds the maximum size that can be accessed with a single request.":n==="permission_denied"?t="Client doesn't have permission to access the desired data.":n==="unavailable"&&(t="The service is unavailable");let r=new Error(n+" at "+e._path.toString()+": "+t);return r.code=n.toUpperCase(),r}var tS=new RegExp("^-?(0*)\\d{1,10}$"),nS=-2147483648,rS=2147483647,sy=function(n){if(tS.test(n)){let e=Number(n);if(e>=nS&&e<=rS)return e}return null},_i=function(n){try{n()}catch(e){setTimeout(()=>{let t=e.stack||"";throw Xe("Exception was thrown by user callback.",t),e},Math.floor(0))}},iS=function(){return(typeof window=="object"&&window.navigator&&window.navigator.userAgent||"").search(/googlebot|google webmaster tools|bingbot|yahoo! slurp|baiduspider|yandexbot|duckduckbot/i)>=0},Gs=function(n,e){let t=setTimeout(n,e);return typeof t=="number"&&typeof Deno<"u"&&Deno.unrefTimer?Deno.unrefTimer(t):typeof t=="object"&&t.unref&&t.unref(),t};var vh=class{constructor(e,t){this.appName_=e,this.appCheckProvider=t,this.appCheck=t?.getImmediate({optional:!0}),this.appCheck||t?.get().then(r=>this.appCheck=r)}getToken(e){return this.appCheck?this.appCheck.getToken(e):new Promise((t,r)=>{setTimeout(()=>{this.appCheck?this.getToken(e).then(t,r):t(null)},0)})}addTokenChangeListener(e){var t;(t=this.appCheckProvider)===null||t===void 0||t.get().then(r=>r.addTokenListener(e))}notifyForInvalidToken(){Xe(`Provided AppCheck credentials for the app named "${this.appName_}" are invalid. This usually indicates your app was not initialized correctly.`)}};var wh=class{constructor(e,t,r){this.appName_=e,this.firebaseOptions_=t,this.authProvider_=r,this.auth_=null,this.auth_=r.getImmediate({optional:!0}),this.auth_||r.onInit(i=>this.auth_=i)}getToken(e){return this.auth_?this.auth_.getToken(e).catch(t=>t&&t.code==="auth/token-not-initialized"?(Ge("Got auth/token-not-initialized error.  Treating as null token."),null):Promise.reject(t)):new Promise((t,r)=>{setTimeout(()=>{this.auth_?this.getToken(e).then(t,r):t(null)},0)})}addTokenChangeListener(e){this.auth_?this.auth_.addAuthTokenListener(e):this.authProvider_.get().then(t=>t.addAuthTokenListener(e))}removeTokenChangeListener(e){this.authProvider_.get().then(t=>t.removeAuthTokenListener(e))}notifyForInvalidToken(){let e='Provided authentication credentials for the app named "'+this.appName_+'" are invalid. This usually indicates your app was not initialized correctly. ';"credential"in this.firebaseOptions_?e+='Make sure the "credential" property provided to initializeApp() is authorized to access the specified "databaseURL" and is from the correct project.':"serviceAccount"in this.firebaseOptions_?e+='Make sure the "serviceAccount" property provided to initializeApp() is authorized to access the specified "databaseURL" and is from the correct project.':e+='Make sure the "apiKey" and "databaseURL" properties provided to initializeApp() match the values provided for your app at https://console.firebase.google.com/.',Xe(e)}},js=(()=>{class n{constructor(t){this.accessToken=t}getToken(t){return Promise.resolve({accessToken:this.accessToken})}addTokenChangeListener(t){t(this.accessToken)}removeTokenChangeListener(t){}notifyForInvalidToken(){}}n.OWNER="owner";return n})(),al="5",By="v",qy="s",Gy="r",jy="f",zy=/(console\.firebase|firebase-console-\w+\.corp|firebase\.corp)\.google\.com/,Ky="ls",Wy="p",Eh="ac",Qy="websocket",$y="long_polling";var ll=class{constructor(e,t,r,i,s=!1,o="",l=!1,u=!1){this.secure=t,this.namespace=r,this.webSocketOnly=i,this.nodeAdmin=s,this.persistenceKey=o,this.includeNamespaceInQueryParams=l,this.isUsingEmulator=u,this._host=e.toLowerCase(),this._domain=this._host.substr(this._host.indexOf(".")+1),this.internalHost=mr.get("host:"+e)||this._host}isCacheableHost(){return this.internalHost.substr(0,2)==="s-"}isCustomHost(){return this._domain!=="firebaseio.com"&&this._domain!=="firebaseio-demo.com"}get host(){return this._host}set host(e){e!==this.internalHost&&(this.internalHost=e,this.isCacheableHost()&&mr.set("host:"+this._host,this.internalHost))}toString(){let e=this.toURLString();return this.persistenceKey&&(e+="<"+this.persistenceKey+">"),e}toURLString(){let e=this.secure?"https://":"http://",t=this.includeNamespaceInQueryParams?`?ns=${this.namespace}`:"";return`${e}${this.host}/${t}`}};function sS(n){return n.host!==n.internalHost||n.isCustomHost()||n.includeNamespaceInQueryParams}function Hy(n,e,t){F(typeof e=="string","typeof type must == string"),F(typeof t=="object","typeof params must == object");let r;if(e===Qy)r=(n.secure?"wss://":"ws://")+n.internalHost+"/.ws?";else if(e===$y)r=(n.secure?"https://":"http://")+n.internalHost+"/.lp?";else throw new Error("Unknown connection type: "+e);sS(n)&&(t.ns=n.namespace);let i=[];return je(t,(s,o)=>{i.push(s+"="+o)}),r+i.join("&")}var Ih=class{constructor(){this.counters_={}}incrementCounter(e,t=1){wt(this.counters_,e)||(this.counters_[e]=0),this.counters_[e]+=t}get(){return F_(this.counters_)}};var lh={},uh={};function Id(n){let e=n.toString();return lh[e]||(lh[e]=new Ih),lh[e]}function oS(n,e){let t=n.toString();return uh[t]||(uh[t]=e()),uh[t]}var Th=class{constructor(e){this.onMessage_=e,this.pendingResponses=[],this.currentResponseNum=0,this.closeAfterResponse=-1,this.onClose=null}closeAfter(e,t){this.closeAfterResponse=e,this.onClose=t,this.closeAfterResponse<this.currentResponseNum&&(this.onClose(),this.onClose=null)}handleResponse(e,t){for(this.pendingResponses[e]=t;this.pendingResponses[this.currentResponseNum];){let r=this.pendingResponses[this.currentResponseNum];delete this.pendingResponses[this.currentResponseNum];for(let i=0;i<r.length;++i)r[i]&&_i(()=>{this.onMessage_(r[i])});if(this.currentResponseNum===this.closeAfterResponse){this.onClose&&(this.onClose(),this.onClose=null);break}this.currentResponseNum++}}};var oy="start",aS="close",lS="pLPCommand",uS="pRTLPCB",Yy="id",Jy="pw",Xy="ser",cS="cb",hS="seg",dS="ts",fS="d",pS="dframe",Zy=1870,ev=30,mS=Zy-ev,gS=25e3,_S=3e4,Qs=class n{constructor(e,t,r,i,s,o,l){this.connId=e,this.repoInfo=t,this.applicationId=r,this.appCheckToken=i,this.authToken=s,this.transportSessionId=o,this.lastSessionId=l,this.bytesSent=0,this.bytesReceived=0,this.everConnected_=!1,this.log_=lo(e),this.stats_=Id(t),this.urlFn=u=>(this.appCheckToken&&(u[Eh]=this.appCheckToken),Hy(t,$y,u))}open(e,t){this.curSegmentNum=0,this.onDisconnect_=t,this.myPacketOrderer=new Th(e),this.isClosed_=!1,this.connectTimeoutTimer_=setTimeout(()=>{this.log_("Timed out trying to connect."),this.onClosed_(),this.connectTimeoutTimer_=null},Math.floor(_S)),Y0(()=>{if(this.isClosed_)return;this.scriptTagHolder=new Sh((...s)=>{let[o,l,u,c,d]=s;if(this.incrementIncomingBytes_(s),!!this.scriptTagHolder)if(this.connectTimeoutTimer_&&(clearTimeout(this.connectTimeoutTimer_),this.connectTimeoutTimer_=null),this.everConnected_=!0,o===oy)this.id=l,this.password=u;else if(o===aS)l?(this.scriptTagHolder.sendNewPolls=!1,this.myPacketOrderer.closeAfter(l,()=>{this.onClosed_()})):this.onClosed_();else throw new Error("Unrecognized command received: "+o)},(...s)=>{let[o,l]=s;this.incrementIncomingBytes_(s),this.myPacketOrderer.handleResponse(o,l)},()=>{this.onClosed_()},this.urlFn);let r={};r[oy]="t",r[Xy]=Math.floor(Math.random()*1e8),this.scriptTagHolder.uniqueCallbackIdentifier&&(r[cS]=this.scriptTagHolder.uniqueCallbackIdentifier),r[By]=al,this.transportSessionId&&(r[qy]=this.transportSessionId),this.lastSessionId&&(r[Ky]=this.lastSessionId),this.applicationId&&(r[Wy]=this.applicationId),this.appCheckToken&&(r[Eh]=this.appCheckToken),typeof location<"u"&&location.hostname&&zy.test(location.hostname)&&(r[Gy]=jy);let i=this.urlFn(r);this.log_("Connecting via long-poll to "+i),this.scriptTagHolder.addTag(i,()=>{})})}start(){this.scriptTagHolder.startLongPoll(this.id,this.password),this.addDisconnectPingFrame(this.id,this.password)}static forceAllow(){n.forceAllow_=!0}static forceDisallow(){n.forceDisallow_=!0}static isAvailable(){return Ut()?!1:n.forceAllow_?!0:!n.forceDisallow_&&typeof document<"u"&&document.createElement!=null&&!X0()&&!Z0()}markConnectionHealthy(){}shutdown_(){this.isClosed_=!0,this.scriptTagHolder&&(this.scriptTagHolder.close(),this.scriptTagHolder=null),this.myDisconnFrame&&(document.body.removeChild(this.myDisconnFrame),this.myDisconnFrame=null),this.connectTimeoutTimer_&&(clearTimeout(this.connectTimeoutTimer_),this.connectTimeoutTimer_=null)}onClosed_(){this.isClosed_||(this.log_("Longpoll is closing itself"),this.shutdown_(),this.onDisconnect_&&(this.onDisconnect_(this.everConnected_),this.onDisconnect_=null))}close(){this.isClosed_||(this.log_("Longpoll is being closed."),this.shutdown_())}send(e){let t=ke(e);this.bytesSent+=t.length,this.stats_.incrementCounter("bytes_sent",t.length);let r=V_(t),i=Ly(r,mS);for(let s=0;s<i.length;s++)this.scriptTagHolder.enqueueSegment(this.curSegmentNum,i.length,i[s]),this.curSegmentNum++}addDisconnectPingFrame(e,t){if(Ut())return;this.myDisconnFrame=document.createElement("iframe");let r={};r[pS]="t",r[Yy]=e,r[Jy]=t,this.myDisconnFrame.src=this.urlFn(r),this.myDisconnFrame.style.display="none",document.body.appendChild(this.myDisconnFrame)}incrementIncomingBytes_(e){let t=ke(e).length;this.bytesReceived+=t,this.stats_.incrementCounter("bytes_received",t)}},Sh=class n{constructor(e,t,r,i){if(this.onDisconnect=r,this.urlFn=i,this.outstandingRequests=new Set,this.pendingSegs=[],this.currentSerial=Math.floor(Math.random()*1e8),this.sendNewPolls=!0,Ut())this.commandCB=e,this.onMessageCB=t;else{this.uniqueCallbackIdentifier=Fy(),window[lS+this.uniqueCallbackIdentifier]=e,window[uS+this.uniqueCallbackIdentifier]=t,this.myIFrame=n.createIFrame_();let s="";this.myIFrame.src&&this.myIFrame.src.substr(0,11)==="javascript:"&&(s='<script>document.domain="'+document.domain+'";<\/script>');let o="<html><body>"+s+"</body></html>";try{this.myIFrame.doc.open(),this.myIFrame.doc.write(o),this.myIFrame.doc.close()}catch(l){Ge("frame writing exception"),l.stack&&Ge(l.stack),Ge(l)}}}static createIFrame_(){let e=document.createElement("iframe");if(e.style.display="none",document.body){document.body.appendChild(e);try{e.contentWindow.document||Ge("No IE domain setting required")}catch{let r=document.domain;e.src="javascript:void((function(){document.open();document.domain='"+r+"';document.close();})())"}}else throw"Document body has not initialized. Wait to initialize Firebase until after the document is ready.";return e.contentDocument?e.doc=e.contentDocument:e.contentWindow?e.doc=e.contentWindow.document:e.document&&(e.doc=e.document),e}close(){this.alive=!1,this.myIFrame&&(this.myIFrame.doc.body.textContent="",setTimeout(()=>{this.myIFrame!==null&&(document.body.removeChild(this.myIFrame),this.myIFrame=null)},Math.floor(0)));let e=this.onDisconnect;e&&(this.onDisconnect=null,e())}startLongPoll(e,t){for(this.myID=e,this.myPW=t,this.alive=!0;this.newRequest_(););}newRequest_(){if(this.alive&&this.sendNewPolls&&this.outstandingRequests.size<(this.pendingSegs.length>0?2:1)){this.currentSerial++;let e={};e[Yy]=this.myID,e[Jy]=this.myPW,e[Xy]=this.currentSerial;let t=this.urlFn(e),r="",i=0;for(;this.pendingSegs.length>0&&this.pendingSegs[0].d.length+ev+r.length<=Zy;){let o=this.pendingSegs.shift();r=r+"&"+hS+i+"="+o.seg+"&"+dS+i+"="+o.ts+"&"+fS+i+"="+o.d,i++}return t=t+r,this.addLongPollTag_(t,this.currentSerial),!0}else return!1}enqueueSegment(e,t,r){this.pendingSegs.push({seg:e,ts:t,d:r}),this.alive&&this.newRequest_()}addLongPollTag_(e,t){this.outstandingRequests.add(t);let r=()=>{this.outstandingRequests.delete(t),this.newRequest_()},i=setTimeout(r,Math.floor(gS)),s=()=>{clearTimeout(i),r()};this.addTag(e,s)}addTag(e,t){Ut()?this.doNodeLongPoll(e,t):setTimeout(()=>{try{if(!this.sendNewPolls)return;let r=this.myIFrame.doc.createElement("script");r.type="text/javascript",r.async=!0,r.src=e,r.onload=r.onreadystatechange=function(){let i=r.readyState;(!i||i==="loaded"||i==="complete")&&(r.onload=r.onreadystatechange=null,r.parentNode&&r.parentNode.removeChild(r),t())},r.onerror=()=>{Ge("Long-poll script failed to load: "+e),this.sendNewPolls=!1,this.close()},this.myIFrame.doc.body.appendChild(r)}catch{}},Math.floor(1))}};var yS=16384,vS=45e3,ul=null;typeof MozWebSocket<"u"?ul=MozWebSocket:typeof WebSocket<"u"&&(ul=WebSocket);var oi=(()=>{class n{constructor(t,r,i,s,o,l,u){this.connId=t,this.applicationId=i,this.appCheckToken=s,this.authToken=o,this.keepaliveTimer=null,this.frames=null,this.totalFrames=0,this.bytesSent=0,this.bytesReceived=0,this.log_=lo(this.connId),this.stats_=Id(r),this.connURL=n.connectionURL_(r,l,u,s,i),this.nodeAdmin=r.nodeAdmin}static connectionURL_(t,r,i,s,o){let l={};return l[By]=al,!Ut()&&typeof location<"u"&&location.hostname&&zy.test(location.hostname)&&(l[Gy]=jy),r&&(l[qy]=r),i&&(l[Ky]=i),s&&(l[Eh]=s),o&&(l[Wy]=o),Hy(t,Qy,l)}open(t,r){this.onDisconnect=r,this.onMessage=t,this.log_("Websocket connecting to "+this.connURL),this.everConnected_=!1,mr.set("previous_websocket_failure",!0);try{let i;if(Ut()){let s=this.nodeAdmin?"AdminNode":"Node";i={headers:{"User-Agent":`Firebase/${al}/${vd}/${process.platform}/${s}`,"X-Firebase-GMPID":this.applicationId||""}},this.authToken&&(i.headers.Authorization=`Bearer ${this.authToken}`),this.appCheckToken&&(i.headers["X-Firebase-AppCheck"]=this.appCheckToken);let o=process.env,l=this.connURL.indexOf("wss://")===0?o.HTTPS_PROXY||o.https_proxy:o.HTTP_PROXY||o.http_proxy;l&&(i.proxy={origin:l})}this.mySock=new ul(this.connURL,[],i)}catch(i){this.log_("Error instantiating WebSocket.");let s=i.message||i.data;s&&this.log_(s),this.onClosed_();return}this.mySock.onopen=()=>{this.log_("Websocket connected."),this.everConnected_=!0},this.mySock.onclose=()=>{this.log_("Websocket connection was disconnected."),this.mySock=null,this.onClosed_()},this.mySock.onmessage=i=>{this.handleIncomingFrame(i)},this.mySock.onerror=i=>{this.log_("WebSocket error.  Closing connection.");let s=i.message||i.data;s&&this.log_(s),this.onClosed_()}}start(){}static forceDisallow(){n.forceDisallow_=!0}static isAvailable(){let t=!1;if(typeof navigator<"u"&&navigator.userAgent){let r=/Android ([0-9]{0,}\.[0-9]{0,})/,i=navigator.userAgent.match(r);i&&i.length>1&&parseFloat(i[1])<4.4&&(t=!0)}return!t&&ul!==null&&!n.forceDisallow_}static previouslyFailed(){return mr.isInMemoryStorage||mr.get("previous_websocket_failure")===!0}markConnectionHealthy(){mr.remove("previous_websocket_failure")}appendFrame_(t){if(this.frames.push(t),this.frames.length===this.totalFrames){let r=this.frames.join("");this.frames=null;let i=Ua(r);this.onMessage(i)}}handleNewFrameCount_(t){this.totalFrames=t,this.frames=[]}extractFrameCount_(t){if(F(this.frames===null,"We already have a frame buffer"),t.length<=6){let r=Number(t);if(!isNaN(r))return this.handleNewFrameCount_(r),null}return this.handleNewFrameCount_(1),t}handleIncomingFrame(t){if(this.mySock===null)return;let r=t.data;if(this.bytesReceived+=r.length,this.stats_.incrementCounter("bytes_received",r.length),this.resetKeepAlive(),this.frames!==null)this.appendFrame_(r);else{let i=this.extractFrameCount_(r);i!==null&&this.appendFrame_(i)}}send(t){this.resetKeepAlive();let r=ke(t);this.bytesSent+=r.length,this.stats_.incrementCounter("bytes_sent",r.length);let i=Ly(r,yS);i.length>1&&this.sendString_(String(i.length));for(let s=0;s<i.length;s++)this.sendString_(i[s])}shutdown_(){this.isClosed_=!0,this.keepaliveTimer&&(clearInterval(this.keepaliveTimer),this.keepaliveTimer=null),this.mySock&&(this.mySock.close(),this.mySock=null)}onClosed_(){this.isClosed_||(this.log_("WebSocket is closing itself"),this.shutdown_(),this.onDisconnect&&(this.onDisconnect(this.everConnected_),this.onDisconnect=null))}close(){this.isClosed_||(this.log_("WebSocket is being closed"),this.shutdown_())}resetKeepAlive(){clearInterval(this.keepaliveTimer),this.keepaliveTimer=setInterval(()=>{this.mySock&&this.sendString_("0"),this.resetKeepAlive()},Math.floor(vS))}sendString_(t){try{this.mySock.send(t)}catch(r){this.log_("Exception thrown from WebSocket.send():",r.message||r.data,"Closing connection."),setTimeout(this.onClosed_.bind(this),0)}}}n.responsesRequiredToBeHealthy=2,n.healthyTimeout=3e4;return n})(),tv=(()=>{class n{constructor(t){this.initTransports_(t)}static get ALL_TRANSPORTS(){return[Qs,oi]}static get IS_TRANSPORT_INITIALIZED(){return this.globalTransportInitialized_}initTransports_(t){let r=oi&&oi.isAvailable(),i=r&&!oi.previouslyFailed();if(t.webSocketOnly&&(r||Xe("wss:// URL used, but browser isn't known to support websockets.  Trying anyway."),i=!0),i)this.transports_=[oi];else{let s=this.transports_=[];for(let o of n.ALL_TRANSPORTS)o&&o.isAvailable()&&s.push(o);n.globalTransportInitialized_=!0}}initialTransport(){if(this.transports_.length>0)return this.transports_[0];throw new Error("No transports available")}upgradeTransport(){return this.transports_.length>1?this.transports_[1]:null}}n.globalTransportInitialized_=!1;return n})(),wS=6e4,ES=5e3,IS=10*1024,TS=100*1024,ch="t",ay="d",SS="s",ly="r",CS="e",uy="o",cy="a",hy="n",dy="p",AS="h",Ch=class{constructor(e,t,r,i,s,o,l,u,c,d){this.id=e,this.repoInfo_=t,this.applicationId_=r,this.appCheckToken_=i,this.authToken_=s,this.onMessage_=o,this.onReady_=l,this.onDisconnect_=u,this.onKill_=c,this.lastSessionId=d,this.connectionCount=0,this.pendingDataMessages=[],this.state_=0,this.log_=lo("c:"+this.id+":"),this.transportManager_=new tv(t),this.log_("Connection created"),this.start_()}start_(){let e=this.transportManager_.initialTransport();this.conn_=new e(this.nextTransportId_(),this.repoInfo_,this.applicationId_,this.appCheckToken_,this.authToken_,null,this.lastSessionId),this.primaryResponsesRequired_=e.responsesRequiredToBeHealthy||0;let t=this.connReceiver_(this.conn_),r=this.disconnReceiver_(this.conn_);this.tx_=this.conn_,this.rx_=this.conn_,this.secondaryConn_=null,this.isHealthy_=!1,setTimeout(()=>{this.conn_&&this.conn_.open(t,r)},Math.floor(0));let i=e.healthyTimeout||0;i>0&&(this.healthyTimeout_=Gs(()=>{this.healthyTimeout_=null,this.isHealthy_||(this.conn_&&this.conn_.bytesReceived>TS?(this.log_("Connection exceeded healthy timeout but has received "+this.conn_.bytesReceived+" bytes.  Marking connection healthy."),this.isHealthy_=!0,this.conn_.markConnectionHealthy()):this.conn_&&this.conn_.bytesSent>IS?this.log_("Connection exceeded healthy timeout but has sent "+this.conn_.bytesSent+" bytes.  Leaving connection alive."):(this.log_("Closing unhealthy connection after timeout."),this.close()))},Math.floor(i)))}nextTransportId_(){return"c:"+this.id+":"+this.connectionCount++}disconnReceiver_(e){return t=>{e===this.conn_?this.onConnectionLost_(t):e===this.secondaryConn_?(this.log_("Secondary connection lost."),this.onSecondaryConnectionLost_()):this.log_("closing an old connection")}}connReceiver_(e){return t=>{this.state_!==2&&(e===this.rx_?this.onPrimaryMessageReceived_(t):e===this.secondaryConn_?this.onSecondaryMessageReceived_(t):this.log_("message on old connection"))}}sendRequest(e){let t={t:"d",d:e};this.sendData_(t)}tryCleanupConnection(){this.tx_===this.secondaryConn_&&this.rx_===this.secondaryConn_&&(this.log_("cleaning up and promoting a connection: "+this.secondaryConn_.connId),this.conn_=this.secondaryConn_,this.secondaryConn_=null)}onSecondaryControl_(e){if(ch in e){let t=e[ch];t===cy?this.upgradeIfSecondaryHealthy_():t===ly?(this.log_("Got a reset on secondary, closing it"),this.secondaryConn_.close(),(this.tx_===this.secondaryConn_||this.rx_===this.secondaryConn_)&&this.close()):t===uy&&(this.log_("got pong on secondary."),this.secondaryResponsesRequired_--,this.upgradeIfSecondaryHealthy_())}}onSecondaryMessageReceived_(e){let t=Ls("t",e),r=Ls("d",e);if(t==="c")this.onSecondaryControl_(r);else if(t==="d")this.pendingDataMessages.push(r);else throw new Error("Unknown protocol layer: "+t)}upgradeIfSecondaryHealthy_(){this.secondaryResponsesRequired_<=0?(this.log_("Secondary connection is healthy."),this.isHealthy_=!0,this.secondaryConn_.markConnectionHealthy(),this.proceedWithUpgrade_()):(this.log_("sending ping on secondary."),this.secondaryConn_.send({t:"c",d:{t:dy,d:{}}}))}proceedWithUpgrade_(){this.secondaryConn_.start(),this.log_("sending client ack on secondary"),this.secondaryConn_.send({t:"c",d:{t:cy,d:{}}}),this.log_("Ending transmission on primary"),this.conn_.send({t:"c",d:{t:hy,d:{}}}),this.tx_=this.secondaryConn_,this.tryCleanupConnection()}onPrimaryMessageReceived_(e){let t=Ls("t",e),r=Ls("d",e);t==="c"?this.onControl_(r):t==="d"&&this.onDataMessage_(r)}onDataMessage_(e){this.onPrimaryResponse_(),this.onMessage_(e)}onPrimaryResponse_(){this.isHealthy_||(this.primaryResponsesRequired_--,this.primaryResponsesRequired_<=0&&(this.log_("Primary connection is healthy."),this.isHealthy_=!0,this.conn_.markConnectionHealthy()))}onControl_(e){let t=Ls(ch,e);if(ay in e){let r=e[ay];if(t===AS){let i=Object.assign({},r);this.repoInfo_.isUsingEmulator&&(i.h=this.repoInfo_.host),this.onHandshake_(i)}else if(t===hy){this.log_("recvd end transmission on primary"),this.rx_=this.secondaryConn_;for(let i=0;i<this.pendingDataMessages.length;++i)this.onDataMessage_(this.pendingDataMessages[i]);this.pendingDataMessages=[],this.tryCleanupConnection()}else t===SS?this.onConnectionShutdown_(r):t===ly?this.onReset_(r):t===CS?yh("Server Error: "+r):t===uy?(this.log_("got pong on primary."),this.onPrimaryResponse_(),this.sendPingOnPrimaryIfNecessary_()):yh("Unknown control packet command: "+t)}}onHandshake_(e){let t=e.ts,r=e.v,i=e.h;this.sessionId=e.s,this.repoInfo_.host=i,this.state_===0&&(this.conn_.start(),this.onConnectionEstablished_(this.conn_,t),al!==r&&Xe("Protocol version mismatch detected"),this.tryStartUpgrade_())}tryStartUpgrade_(){let e=this.transportManager_.upgradeTransport();e&&this.startUpgrade_(e)}startUpgrade_(e){this.secondaryConn_=new e(this.nextTransportId_(),this.repoInfo_,this.applicationId_,this.appCheckToken_,this.authToken_,this.sessionId),this.secondaryResponsesRequired_=e.responsesRequiredToBeHealthy||0;let t=this.connReceiver_(this.secondaryConn_),r=this.disconnReceiver_(this.secondaryConn_);this.secondaryConn_.open(t,r),Gs(()=>{this.secondaryConn_&&(this.log_("Timed out trying to upgrade."),this.secondaryConn_.close())},Math.floor(wS))}onReset_(e){this.log_("Reset packet received.  New host: "+e),this.repoInfo_.host=e,this.state_===1?this.close():(this.closeConnections_(),this.start_())}onConnectionEstablished_(e,t){this.log_("Realtime connection established."),this.conn_=e,this.state_=1,this.onReady_&&(this.onReady_(t,this.sessionId),this.onReady_=null),this.primaryResponsesRequired_===0?(this.log_("Primary connection is healthy."),this.isHealthy_=!0):Gs(()=>{this.sendPingOnPrimaryIfNecessary_()},Math.floor(ES))}sendPingOnPrimaryIfNecessary_(){!this.isHealthy_&&this.state_===1&&(this.log_("sending ping on primary."),this.sendData_({t:"c",d:{t:dy,d:{}}}))}onSecondaryConnectionLost_(){let e=this.secondaryConn_;this.secondaryConn_=null,(this.tx_===e||this.rx_===e)&&this.close()}onConnectionLost_(e){this.conn_=null,!e&&this.state_===0?(this.log_("Realtime connection failed."),this.repoInfo_.isCacheableHost()&&(mr.remove("host:"+this.repoInfo_.host),this.repoInfo_.internalHost=this.repoInfo_.host)):this.state_===1&&this.log_("Realtime connection lost."),this.close()}onConnectionShutdown_(e){this.log_("Connection shutdown command received. Shutting down..."),this.onKill_&&(this.onKill_(e),this.onKill_=null),this.onDisconnect_=null,this.close()}sendData_(e){if(this.state_!==1)throw"Connection is not connected";this.tx_.send(e)}close(){this.state_!==2&&(this.log_("Closing realtime connection."),this.state_=2,this.closeConnections_(),this.onDisconnect_&&(this.onDisconnect_(),this.onDisconnect_=null))}closeConnections_(){this.log_("Shutting down all connections"),this.conn_&&(this.conn_.close(),this.conn_=null),this.secondaryConn_&&(this.secondaryConn_.close(),this.secondaryConn_=null),this.healthyTimeout_&&(clearTimeout(this.healthyTimeout_),this.healthyTimeout_=null)}};var cl=class{put(e,t,r,i){}merge(e,t,r,i){}refreshAuthToken(e){}refreshAppCheckToken(e){}onDisconnectPut(e,t,r){}onDisconnectMerge(e,t,r){}onDisconnectCancel(e,t){}reportStats(e){}};var hl=class{constructor(e){this.allowedEvents_=e,this.listeners_={},F(Array.isArray(e)&&e.length>0,"Requires a non-empty array")}trigger(e,...t){if(Array.isArray(this.listeners_[e])){let r=[...this.listeners_[e]];for(let i=0;i<r.length;i++)r[i].callback.apply(r[i].context,t)}}on(e,t,r){this.validateEventType_(e),this.listeners_[e]=this.listeners_[e]||[],this.listeners_[e].push({callback:t,context:r});let i=this.getInitialEvent(e);i&&t.apply(r,i)}off(e,t,r){this.validateEventType_(e);let i=this.listeners_[e]||[];for(let s=0;s<i.length;s++)if(i[s].callback===t&&(!r||r===i[s].context)){i.splice(s,1);return}}validateEventType_(e){F(this.allowedEvents_.find(t=>t===e),"Unknown event: "+e)}};var dl=class n extends hl{constructor(){super(["online"]),this.online_=!0,typeof window<"u"&&typeof window.addEventListener<"u"&&!nh()&&(window.addEventListener("online",()=>{this.online_||(this.online_=!0,this.trigger("online",!0))},!1),window.addEventListener("offline",()=>{this.online_&&(this.online_=!1,this.trigger("online",!1))},!1))}static getInstance(){return new n}getInitialEvent(e){return F(e==="online","Unknown event type: "+e),[this.online_]}currentlyOnline(){return this.online_}};var fy=32,py=768,he=class{constructor(e,t){if(t===void 0){this.pieces_=e.split("/");let r=0;for(let i=0;i<this.pieces_.length;i++)this.pieces_[i].length>0&&(this.pieces_[r]=this.pieces_[i],r++);this.pieces_.length=r,this.pieceNum_=0}else this.pieces_=e,this.pieceNum_=t}toString(){let e="";for(let t=this.pieceNum_;t<this.pieces_.length;t++)this.pieces_[t]!==""&&(e+="/"+this.pieces_[t]);return e||"/"}};function ce(){return new he("")}function J(n){return n.pieceNum_>=n.pieces_.length?null:n.pieces_[n.pieceNum_]}function Fn(n){return n.pieces_.length-n.pieceNum_}function me(n){let e=n.pieceNum_;return e<n.pieces_.length&&e++,new he(n.pieces_,e)}function Td(n){return n.pieceNum_<n.pieces_.length?n.pieces_[n.pieces_.length-1]:null}function bS(n){let e="";for(let t=n.pieceNum_;t<n.pieces_.length;t++)n.pieces_[t]!==""&&(e+="/"+encodeURIComponent(String(n.pieces_[t])));return e||"/"}function $s(n,e=0){return n.pieces_.slice(n.pieceNum_+e)}function nv(n){if(n.pieceNum_>=n.pieces_.length)return null;let e=[];for(let t=n.pieceNum_;t<n.pieces_.length-1;t++)e.push(n.pieces_[t]);return new he(e,0)}function Ee(n,e){let t=[];for(let r=n.pieceNum_;r<n.pieces_.length;r++)t.push(n.pieces_[r]);if(e instanceof he)for(let r=e.pieceNum_;r<e.pieces_.length;r++)t.push(e.pieces_[r]);else{let r=e.split("/");for(let i=0;i<r.length;i++)r[i].length>0&&t.push(r[i])}return new he(t,0)}function X(n){return n.pieceNum_>=n.pieces_.length}function it(n,e){let t=J(n),r=J(e);if(t===null)return e;if(t===r)return it(me(n),me(e));throw new Error("INTERNAL ERROR: innerPath ("+e+") is not within outerPath ("+n+")")}function RS(n,e){let t=$s(n,0),r=$s(e,0);for(let i=0;i<t.length&&i<r.length;i++){let s=yr(t[i],r[i]);if(s!==0)return s}return t.length===r.length?0:t.length<r.length?-1:1}function Sd(n,e){if(Fn(n)!==Fn(e))return!1;for(let t=n.pieceNum_,r=e.pieceNum_;t<=n.pieces_.length;t++,r++)if(n.pieces_[t]!==e.pieces_[r])return!1;return!0}function It(n,e){let t=n.pieceNum_,r=e.pieceNum_;if(Fn(n)>Fn(e))return!1;for(;t<n.pieces_.length;){if(n.pieces_[t]!==e.pieces_[r])return!1;++t,++r}return!0}var Ah=class{constructor(e,t){this.errorPrefix_=t,this.parts_=$s(e,0),this.byteLength_=Math.max(1,this.parts_.length);for(let r=0;r<this.parts_.length;r++)this.byteLength_+=Ms(this.parts_[r]);rv(this)}};function PS(n,e){n.parts_.length>0&&(n.byteLength_+=1),n.parts_.push(e),n.byteLength_+=Ms(e),rv(n)}function xS(n){let e=n.parts_.pop();n.byteLength_-=Ms(e),n.parts_.length>0&&(n.byteLength_-=1)}function rv(n){if(n.byteLength_>py)throw new Error(n.errorPrefix_+"has a key path longer than "+py+" bytes ("+n.byteLength_+").");if(n.parts_.length>fy)throw new Error(n.errorPrefix_+"path specified exceeds the maximum depth that can be written ("+fy+") or object contains a cycle "+pr(n))}function pr(n){return n.parts_.length===0?"":"in property '"+n.parts_.join(".")+"'"}var bh=class n extends hl{constructor(){super(["visible"]);let e,t;typeof document<"u"&&typeof document.addEventListener<"u"&&(typeof document.hidden<"u"?(t="visibilitychange",e="hidden"):typeof document.mozHidden<"u"?(t="mozvisibilitychange",e="mozHidden"):typeof document.msHidden<"u"?(t="msvisibilitychange",e="msHidden"):typeof document.webkitHidden<"u"&&(t="webkitvisibilitychange",e="webkitHidden")),this.visible_=!0,t&&document.addEventListener(t,()=>{let r=!document[e];r!==this.visible_&&(this.visible_=r,this.trigger("visible",r))},!1)}static getInstance(){return new n}getInitialEvent(e){return F(e==="visible","Unknown event type: "+e),[this.visible_]}};var Us=1e3,NS=60*5*1e3,my=30*1e3,DS=1.3,kS=3e4,VS="server_kill",gy=3,Cd=(()=>{class n extends cl{constructor(t,r,i,s,o,l,u,c){if(super(),this.repoInfo_=t,this.applicationId_=r,this.onDataUpdate_=i,this.onConnectStatus_=s,this.onServerInfoUpdate_=o,this.authTokenProvider_=l,this.appCheckTokenProvider_=u,this.authOverride_=c,this.id=n.nextPersistentConnectionId_++,this.log_=lo("p:"+this.id+":"),this.interruptReasons_={},this.listens=new Map,this.outstandingPuts_=[],this.outstandingGets_=[],this.outstandingPutCount_=0,this.outstandingGetCount_=0,this.onDisconnectRequestQueue_=[],this.connected_=!1,this.reconnectDelay_=Us,this.maxReconnectDelay_=NS,this.securityDebugCallback_=null,this.lastSessionId=null,this.establishConnectionTimer_=null,this.visible_=!1,this.requestCBHash_={},this.requestNumber_=0,this.realtime_=null,this.authToken_=null,this.appCheckToken_=null,this.forceTokenRefresh_=!1,this.invalidAuthTokenCount_=0,this.invalidAppCheckTokenCount_=0,this.firstConnection_=!0,this.lastConnectionAttemptTime_=null,this.lastConnectionEstablishedTime_=null,c&&!Ut())throw new Error("Auth override specified in options, but not supported on non Node.js platforms");bh.getInstance().on("visible",this.onVisible_,this),t.host.indexOf("fblocal")===-1&&dl.getInstance().on("online",this.onOnline_,this)}sendRequest(t,r,i){let s=++this.requestNumber_,o={r:s,a:t,b:r};this.log_(ke(o)),F(this.connected_,"sendRequest call when we're not connected not allowed."),this.realtime_.sendRequest(o),i&&(this.requestCBHash_[s]=i)}get(t){this.initConnection_();let r=new rt,s={action:"g",request:{p:t._path.toString(),q:t._queryObject},onComplete:l=>{let u=l.d;l.s==="ok"?r.resolve(u):r.reject(u)}};this.outstandingGets_.push(s),this.outstandingGetCount_++;let o=this.outstandingGets_.length-1;return this.connected_&&this.sendGet_(o),r.promise}listen(t,r,i,s){this.initConnection_();let o=t._queryIdentifier,l=t._path.toString();this.log_("Listen called for "+l+" "+o),this.listens.has(l)||this.listens.set(l,new Map),F(t._queryParams.isDefault()||!t._queryParams.loadsAllData(),"listen() called for non-default but complete query"),F(!this.listens.get(l).has(o),"listen() called twice for same path/queryId.");let u={onComplete:s,hashFn:r,query:t,tag:i};this.listens.get(l).set(o,u),this.connected_&&this.sendListen_(u)}sendGet_(t){let r=this.outstandingGets_[t];this.sendRequest("g",r.request,i=>{delete this.outstandingGets_[t],this.outstandingGetCount_--,this.outstandingGetCount_===0&&(this.outstandingGets_=[]),r.onComplete&&r.onComplete(i)})}sendListen_(t){let r=t.query,i=r._path.toString(),s=r._queryIdentifier;this.log_("Listen on "+i+" for "+s);let o={p:i},l="q";t.tag&&(o.q=r._queryObject,o.t=t.tag),o.h=t.hashFn(),this.sendRequest(l,o,u=>{let c=u.d,d=u.s;n.warnOnListenWarnings_(c,r),(this.listens.get(i)&&this.listens.get(i).get(s))===t&&(this.log_("listen response",u),d!=="ok"&&this.removeListen_(i,s),t.onComplete&&t.onComplete(d,c))})}static warnOnListenWarnings_(t,r){if(t&&typeof t=="object"&&wt(t,"w")){let i=Pn(t,"w");if(Array.isArray(i)&&~i.indexOf("no_index")){let s='".indexOn": "'+r._queryParams.getIndex().toString()+'"',o=r._path.toString();Xe(`Using an unspecified index. Your data will be downloaded and filtered on the client. Consider adding ${s} at ${o} to your security rules for better performance.`)}}}refreshAuthToken(t){this.authToken_=t,this.log_("Auth token refreshed"),this.authToken_?this.tryAuth():this.connected_&&this.sendRequest("unauth",{},()=>{}),this.reduceReconnectDelayIfAdminCredential_(t)}reduceReconnectDelayIfAdminCredential_(t){(t&&t.length===40||B_(t))&&(this.log_("Admin auth credential detected.  Reducing max reconnect time."),this.maxReconnectDelay_=my)}refreshAppCheckToken(t){this.appCheckToken_=t,this.log_("App check token refreshed"),this.appCheckToken_?this.tryAppCheck():this.connected_&&this.sendRequest("unappeck",{},()=>{})}tryAuth(){if(this.connected_&&this.authToken_){let t=this.authToken_,r=U_(t)?"auth":"gauth",i={cred:t};this.authOverride_===null?i.noauth=!0:typeof this.authOverride_=="object"&&(i.authvar=this.authOverride_),this.sendRequest(r,i,s=>{let o=s.s,l=s.d||"error";this.authToken_===t&&(o==="ok"?this.invalidAuthTokenCount_=0:this.onAuthRevoked_(o,l))})}}tryAppCheck(){this.connected_&&this.appCheckToken_&&this.sendRequest("appcheck",{token:this.appCheckToken_},t=>{let r=t.s,i=t.d||"error";r==="ok"?this.invalidAppCheckTokenCount_=0:this.onAppCheckRevoked_(r,i)})}unlisten(t,r){let i=t._path.toString(),s=t._queryIdentifier;this.log_("Unlisten called for "+i+" "+s),F(t._queryParams.isDefault()||!t._queryParams.loadsAllData(),"unlisten() called for non-default but complete query"),this.removeListen_(i,s)&&this.connected_&&this.sendUnlisten_(i,s,t._queryObject,r)}sendUnlisten_(t,r,i,s){this.log_("Unlisten on "+t+" for "+r);let o={p:t},l="n";s&&(o.q=i,o.t=s),this.sendRequest(l,o)}onDisconnectPut(t,r,i){this.initConnection_(),this.connected_?this.sendOnDisconnect_("o",t,r,i):this.onDisconnectRequestQueue_.push({pathString:t,action:"o",data:r,onComplete:i})}onDisconnectMerge(t,r,i){this.initConnection_(),this.connected_?this.sendOnDisconnect_("om",t,r,i):this.onDisconnectRequestQueue_.push({pathString:t,action:"om",data:r,onComplete:i})}onDisconnectCancel(t,r){this.initConnection_(),this.connected_?this.sendOnDisconnect_("oc",t,null,r):this.onDisconnectRequestQueue_.push({pathString:t,action:"oc",data:null,onComplete:r})}sendOnDisconnect_(t,r,i,s){let o={p:r,d:i};this.log_("onDisconnect "+t,o),this.sendRequest(t,o,l=>{s&&setTimeout(()=>{s(l.s,l.d)},Math.floor(0))})}put(t,r,i,s){this.putInternal("p",t,r,i,s)}merge(t,r,i,s){this.putInternal("m",t,r,i,s)}putInternal(t,r,i,s,o){this.initConnection_();let l={p:r,d:i};o!==void 0&&(l.h=o),this.outstandingPuts_.push({action:t,request:l,onComplete:s}),this.outstandingPutCount_++;let u=this.outstandingPuts_.length-1;this.connected_?this.sendPut_(u):this.log_("Buffering put: "+r)}sendPut_(t){let r=this.outstandingPuts_[t].action,i=this.outstandingPuts_[t].request,s=this.outstandingPuts_[t].onComplete;this.outstandingPuts_[t].queued=this.connected_,this.sendRequest(r,i,o=>{this.log_(r+" response",o),delete this.outstandingPuts_[t],this.outstandingPutCount_--,this.outstandingPutCount_===0&&(this.outstandingPuts_=[]),s&&s(o.s,o.d)})}reportStats(t){if(this.connected_){let r={c:t};this.log_("reportStats",r),this.sendRequest("s",r,i=>{if(i.s!=="ok"){let o=i.d;this.log_("reportStats","Error sending stats: "+o)}})}}onDataMessage_(t){if("r"in t){this.log_("from server: "+ke(t));let r=t.r,i=this.requestCBHash_[r];i&&(delete this.requestCBHash_[r],i(t.b))}else{if("error"in t)throw"A server-side error has occurred: "+t.error;"a"in t&&this.onDataPush_(t.a,t.b)}}onDataPush_(t,r){this.log_("handleServerMessage",t,r),t==="d"?this.onDataUpdate_(r.p,r.d,!1,r.t):t==="m"?this.onDataUpdate_(r.p,r.d,!0,r.t):t==="c"?this.onListenRevoked_(r.p,r.q):t==="ac"?this.onAuthRevoked_(r.s,r.d):t==="apc"?this.onAppCheckRevoked_(r.s,r.d):t==="sd"?this.onSecurityDebugPacket_(r):yh("Unrecognized action received from server: "+ke(t)+`
Are you using the latest client?`)}onReady_(t,r){this.log_("connection ready"),this.connected_=!0,this.lastConnectionEstablishedTime_=new Date().getTime(),this.handleTimestamp_(t),this.lastSessionId=r,this.firstConnection_&&this.sendConnectStats_(),this.restoreState_(),this.firstConnection_=!1,this.onConnectStatus_(!0)}scheduleConnect_(t){F(!this.realtime_,"Scheduling a connect when we're already connected/ing?"),this.establishConnectionTimer_&&clearTimeout(this.establishConnectionTimer_),this.establishConnectionTimer_=setTimeout(()=>{this.establishConnectionTimer_=null,this.establishConnection_()},Math.floor(t))}initConnection_(){!this.realtime_&&this.firstConnection_&&this.scheduleConnect_(0)}onVisible_(t){t&&!this.visible_&&this.reconnectDelay_===this.maxReconnectDelay_&&(this.log_("Window became visible.  Reducing delay."),this.reconnectDelay_=Us,this.realtime_||this.scheduleConnect_(0)),this.visible_=t}onOnline_(t){t?(this.log_("Browser went online."),this.reconnectDelay_=Us,this.realtime_||this.scheduleConnect_(0)):(this.log_("Browser went offline.  Killing connection."),this.realtime_&&this.realtime_.close())}onRealtimeDisconnect_(){if(this.log_("data client disconnected"),this.connected_=!1,this.realtime_=null,this.cancelSentTransactions_(),this.requestCBHash_={},this.shouldReconnect_()){this.visible_?this.lastConnectionEstablishedTime_&&(new Date().getTime()-this.lastConnectionEstablishedTime_>kS&&(this.reconnectDelay_=Us),this.lastConnectionEstablishedTime_=null):(this.log_("Window isn't visible.  Delaying reconnect."),this.reconnectDelay_=this.maxReconnectDelay_,this.lastConnectionAttemptTime_=new Date().getTime());let t=new Date().getTime()-this.lastConnectionAttemptTime_,r=Math.max(0,this.reconnectDelay_-t);r=Math.random()*r,this.log_("Trying to reconnect in "+r+"ms"),this.scheduleConnect_(r),this.reconnectDelay_=Math.min(this.maxReconnectDelay_,this.reconnectDelay_*DS)}this.onConnectStatus_(!1)}establishConnection_(){return N(this,null,function*(){if(this.shouldReconnect_()){this.log_("Making a connection attempt"),this.lastConnectionAttemptTime_=new Date().getTime(),this.lastConnectionEstablishedTime_=null;let t=this.onDataMessage_.bind(this),r=this.onReady_.bind(this),i=this.onRealtimeDisconnect_.bind(this),s=this.id+":"+n.nextConnectionId_++,o=this.lastSessionId,l=!1,u=null,c=function(){u?u.close():(l=!0,i())},d=function(m){F(u,"sendRequest call when we're not connected not allowed."),u.sendRequest(m)};this.realtime_={close:c,sendRequest:d};let p=this.forceTokenRefresh_;this.forceTokenRefresh_=!1;try{let[m,y]=yield Promise.all([this.authTokenProvider_.getToken(p),this.appCheckTokenProvider_.getToken(p)]);l?Ge("getToken() completed but was canceled"):(Ge("getToken() completed. Creating connection."),this.authToken_=m&&m.accessToken,this.appCheckToken_=y&&y.token,u=new Ch(s,this.repoInfo_,this.applicationId_,this.appCheckToken_,this.authToken_,t,r,i,C=>{Xe(C+" ("+this.repoInfo_.toString()+")"),this.interrupt(VS)},o))}catch(m){this.log_("Failed to get token: "+m),l||(this.repoInfo_.nodeAdmin&&Xe(m),c())}}})}interrupt(t){Ge("Interrupting connection for reason: "+t),this.interruptReasons_[t]=!0,this.realtime_?this.realtime_.close():(this.establishConnectionTimer_&&(clearTimeout(this.establishConnectionTimer_),this.establishConnectionTimer_=null),this.connected_&&this.onRealtimeDisconnect_())}resume(t){Ge("Resuming connection for reason: "+t),delete this.interruptReasons_[t],Ba(this.interruptReasons_)&&(this.reconnectDelay_=Us,this.realtime_||this.scheduleConnect_(0))}handleTimestamp_(t){let r=t-new Date().getTime();this.onServerInfoUpdate_({serverTimeOffset:r})}cancelSentTransactions_(){for(let t=0;t<this.outstandingPuts_.length;t++){let r=this.outstandingPuts_[t];r&&"h"in r.request&&r.queued&&(r.onComplete&&r.onComplete("disconnect"),delete this.outstandingPuts_[t],this.outstandingPutCount_--)}this.outstandingPutCount_===0&&(this.outstandingPuts_=[])}onListenRevoked_(t,r){let i;r?i=r.map(o=>Ed(o)).join("$"):i="default";let s=this.removeListen_(t,i);s&&s.onComplete&&s.onComplete("permission_denied")}removeListen_(t,r){let i=new he(t).toString(),s;if(this.listens.has(i)){let o=this.listens.get(i);s=o.get(r),o.delete(r),o.size===0&&this.listens.delete(i)}else s=void 0;return s}onAuthRevoked_(t,r){Ge("Auth token revoked: "+t+"/"+r),this.authToken_=null,this.forceTokenRefresh_=!0,this.realtime_.close(),(t==="invalid_token"||t==="permission_denied")&&(this.invalidAuthTokenCount_++,this.invalidAuthTokenCount_>=gy&&(this.reconnectDelay_=my,this.authTokenProvider_.notifyForInvalidToken()))}onAppCheckRevoked_(t,r){Ge("App check token revoked: "+t+"/"+r),this.appCheckToken_=null,this.forceTokenRefresh_=!0,(t==="invalid_token"||t==="permission_denied")&&(this.invalidAppCheckTokenCount_++,this.invalidAppCheckTokenCount_>=gy&&this.appCheckTokenProvider_.notifyForInvalidToken())}onSecurityDebugPacket_(t){this.securityDebugCallback_?this.securityDebugCallback_(t):"msg"in t&&console.log("FIREBASE: "+t.msg.replace(`
`,`
FIREBASE: `))}restoreState_(){this.tryAuth(),this.tryAppCheck();for(let t of this.listens.values())for(let r of t.values())this.sendListen_(r);for(let t=0;t<this.outstandingPuts_.length;t++)this.outstandingPuts_[t]&&this.sendPut_(t);for(;this.onDisconnectRequestQueue_.length;){let t=this.onDisconnectRequestQueue_.shift();this.sendOnDisconnect_(t.action,t.pathString,t.data,t.onComplete)}for(let t=0;t<this.outstandingGets_.length;t++)this.outstandingGets_[t]&&this.sendGet_(t)}sendConnectStats_(){let t={},r="js";Ut()&&(this.repoInfo_.nodeAdmin?r="admin_node":r="node"),t["sdk."+r+"."+vd.replace(/\./g,"-")]=1,nh()?t["framework.cordova"]=1:O_()&&(t["framework.reactnative"]=1),this.reportStats(t)}shouldReconnect_(){let t=dl.getInstance().currentlyOnline();return Ba(this.interruptReasons_)&&t}}n.nextPersistentConnectionId_=0,n.nextConnectionId_=0;return n})(),Z=class n{constructor(e,t){this.name=e,this.node=t}static Wrap(e,t){return new n(e,t)}};var ui=class{getCompare(){return this.compare.bind(this)}indexedValueChanged(e,t){let r=new Z(Vn,e),i=new Z(Vn,t);return this.compare(r,i)!==0}minPost(){return Z.MIN}};var ol,fl=class extends ui{static get __EMPTY_NODE(){return ol}static set __EMPTY_NODE(e){ol=e}compare(e,t){return yr(e.name,t.name)}isDefinedOn(e){throw ni("KeyIndex.isDefinedOn not expected to be called.")}indexedValueChanged(e,t){return!1}minPost(){return Z.MIN}maxPost(){return new Z(un,ol)}makePost(e,t){return F(typeof e=="string","KeyIndex indexValue must always be a string."),new Z(e,ol)}toString(){return".key"}},Gt=new fl;var ai=class{constructor(e,t,r,i,s=null){this.isReverse_=i,this.resultGenerator_=s,this.nodeStack_=[];let o=1;for(;!e.isEmpty();)if(e=e,o=t?r(e.key,t):1,i&&(o*=-1),o<0)this.isReverse_?e=e.left:e=e.right;else if(o===0){this.nodeStack_.push(e);break}else this.nodeStack_.push(e),this.isReverse_?e=e.right:e=e.left}getNext(){if(this.nodeStack_.length===0)return null;let e=this.nodeStack_.pop(),t;if(this.resultGenerator_?t=this.resultGenerator_(e.key,e.value):t={key:e.key,value:e.value},this.isReverse_)for(e=e.left;!e.isEmpty();)this.nodeStack_.push(e),e=e.right;else for(e=e.right;!e.isEmpty();)this.nodeStack_.push(e),e=e.left;return t}hasNext(){return this.nodeStack_.length>0}peek(){if(this.nodeStack_.length===0)return null;let e=this.nodeStack_[this.nodeStack_.length-1];return this.resultGenerator_?this.resultGenerator_(e.key,e.value):{key:e.key,value:e.value}}},xt=(()=>{class n{constructor(t,r,i,s,o){this.key=t,this.value=r,this.color=i??n.RED,this.left=s??Tt.EMPTY_NODE,this.right=o??Tt.EMPTY_NODE}copy(t,r,i,s,o){return new n(t??this.key,r??this.value,i??this.color,s??this.left,o??this.right)}count(){return this.left.count()+1+this.right.count()}isEmpty(){return!1}inorderTraversal(t){return this.left.inorderTraversal(t)||!!t(this.key,this.value)||this.right.inorderTraversal(t)}reverseTraversal(t){return this.right.reverseTraversal(t)||t(this.key,this.value)||this.left.reverseTraversal(t)}min_(){return this.left.isEmpty()?this:this.left.min_()}minKey(){return this.min_().key}maxKey(){return this.right.isEmpty()?this.key:this.right.maxKey()}insert(t,r,i){let s=this,o=i(t,s.key);return o<0?s=s.copy(null,null,null,s.left.insert(t,r,i),null):o===0?s=s.copy(null,r,null,null,null):s=s.copy(null,null,null,null,s.right.insert(t,r,i)),s.fixUp_()}removeMin_(){if(this.left.isEmpty())return Tt.EMPTY_NODE;let t=this;return!t.left.isRed_()&&!t.left.left.isRed_()&&(t=t.moveRedLeft_()),t=t.copy(null,null,null,t.left.removeMin_(),null),t.fixUp_()}remove(t,r){let i,s;if(i=this,r(t,i.key)<0)!i.left.isEmpty()&&!i.left.isRed_()&&!i.left.left.isRed_()&&(i=i.moveRedLeft_()),i=i.copy(null,null,null,i.left.remove(t,r),null);else{if(i.left.isRed_()&&(i=i.rotateRight_()),!i.right.isEmpty()&&!i.right.isRed_()&&!i.right.left.isRed_()&&(i=i.moveRedRight_()),r(t,i.key)===0){if(i.right.isEmpty())return Tt.EMPTY_NODE;s=i.right.min_(),i=i.copy(s.key,s.value,null,null,i.right.removeMin_())}i=i.copy(null,null,null,null,i.right.remove(t,r))}return i.fixUp_()}isRed_(){return this.color}fixUp_(){let t=this;return t.right.isRed_()&&!t.left.isRed_()&&(t=t.rotateLeft_()),t.left.isRed_()&&t.left.left.isRed_()&&(t=t.rotateRight_()),t.left.isRed_()&&t.right.isRed_()&&(t=t.colorFlip_()),t}moveRedLeft_(){let t=this.colorFlip_();return t.right.left.isRed_()&&(t=t.copy(null,null,null,null,t.right.rotateRight_()),t=t.rotateLeft_(),t=t.colorFlip_()),t}moveRedRight_(){let t=this.colorFlip_();return t.left.left.isRed_()&&(t=t.rotateRight_(),t=t.colorFlip_()),t}rotateLeft_(){let t=this.copy(null,null,n.RED,null,this.right.left);return this.right.copy(null,null,this.color,t,null)}rotateRight_(){let t=this.copy(null,null,n.RED,this.left.right,null);return this.left.copy(null,null,this.color,null,t)}colorFlip_(){let t=this.left.copy(null,null,!this.left.color,null,null),r=this.right.copy(null,null,!this.right.color,null,null);return this.copy(null,null,!this.color,t,r)}checkMaxDepth_(){let t=this.check_();return Math.pow(2,t)<=this.count()+1}check_(){if(this.isRed_()&&this.left.isRed_())throw new Error("Red node has red child("+this.key+","+this.value+")");if(this.right.isRed_())throw new Error("Right child of ("+this.key+","+this.value+") is red");let t=this.left.check_();if(t!==this.right.check_())throw new Error("Black depths differ");return t+(this.isRed_()?0:1)}}return n.RED=!0,n.BLACK=!1,n})(),Rh=class{copy(e,t,r,i,s){return this}insert(e,t,r){return new xt(e,t,null)}remove(e,t){return this}count(){return 0}isEmpty(){return!0}inorderTraversal(e){return!1}reverseTraversal(e){return!1}minKey(){return null}maxKey(){return null}check_(){return 0}isRed_(){return!1}},Tt=class n{constructor(e,t=n.EMPTY_NODE){this.comparator_=e,this.root_=t}insert(e,t){return new n(this.comparator_,this.root_.insert(e,t,this.comparator_).copy(null,null,xt.BLACK,null,null))}remove(e){return new n(this.comparator_,this.root_.remove(e,this.comparator_).copy(null,null,xt.BLACK,null,null))}get(e){let t,r=this.root_;for(;!r.isEmpty();){if(t=this.comparator_(e,r.key),t===0)return r.value;t<0?r=r.left:t>0&&(r=r.right)}return null}getPredecessorKey(e){let t,r=this.root_,i=null;for(;!r.isEmpty();)if(t=this.comparator_(e,r.key),t===0){if(r.left.isEmpty())return i?i.key:null;for(r=r.left;!r.right.isEmpty();)r=r.right;return r.key}else t<0?r=r.left:t>0&&(i=r,r=r.right);throw new Error("Attempted to find predecessor key for a nonexistent key.  What gives?")}isEmpty(){return this.root_.isEmpty()}count(){return this.root_.count()}minKey(){return this.root_.minKey()}maxKey(){return this.root_.maxKey()}inorderTraversal(e){return this.root_.inorderTraversal(e)}reverseTraversal(e){return this.root_.reverseTraversal(e)}getIterator(e){return new ai(this.root_,null,this.comparator_,!1,e)}getIteratorFrom(e,t){return new ai(this.root_,e,this.comparator_,!1,t)}getReverseIteratorFrom(e,t){return new ai(this.root_,e,this.comparator_,!0,t)}getReverseIterator(e){return new ai(this.root_,null,this.comparator_,!0,e)}};Tt.EMPTY_NODE=new Rh;function FS(n,e){return yr(n.name,e.name)}function Ad(n,e){return yr(n,e)}var Ph;function OS(n){Ph=n}var iv=function(n){return typeof n=="number"?"number:"+Uy(n):"string:"+n},sv=function(n){if(n.isLeafNode()){let e=n.val();F(typeof e=="string"||typeof e=="number"||typeof e=="object"&&wt(e,".sv"),"Priority must be a string or number.")}else F(n===Ph||n.isEmpty(),"priority of unexpected type.");F(n===Ph||n.getPriority().isEmpty(),"Priority nodes can't have a priority of their own.")};var _y,ci=(()=>{class n{constructor(t,r=n.__childrenNodeConstructor.EMPTY_NODE){this.value_=t,this.priorityNode_=r,this.lazyHash_=null,F(this.value_!==void 0&&this.value_!==null,"LeafNode shouldn't be created with null/undefined value."),sv(this.priorityNode_)}static set __childrenNodeConstructor(t){_y=t}static get __childrenNodeConstructor(){return _y}isLeafNode(){return!0}getPriority(){return this.priorityNode_}updatePriority(t){return new n(this.value_,t)}getImmediateChild(t){return t===".priority"?this.priorityNode_:n.__childrenNodeConstructor.EMPTY_NODE}getChild(t){return X(t)?this:J(t)===".priority"?this.priorityNode_:n.__childrenNodeConstructor.EMPTY_NODE}hasChild(){return!1}getPredecessorChildName(t,r){return null}updateImmediateChild(t,r){return t===".priority"?this.updatePriority(r):r.isEmpty()&&t!==".priority"?this:n.__childrenNodeConstructor.EMPTY_NODE.updateImmediateChild(t,r).updatePriority(this.priorityNode_)}updateChild(t,r){let i=J(t);return i===null?r:r.isEmpty()&&i!==".priority"?this:(F(i!==".priority"||Fn(t)===1,".priority must be the last token in a path"),this.updateImmediateChild(i,n.__childrenNodeConstructor.EMPTY_NODE.updateChild(me(t),r)))}isEmpty(){return!1}numChildren(){return 0}forEachChild(t,r){return!1}val(t){return t&&!this.getPriority().isEmpty()?{".value":this.getValue(),".priority":this.getPriority().val()}:this.getValue()}hash(){if(this.lazyHash_===null){let t="";this.priorityNode_.isEmpty()||(t+="priority:"+iv(this.priorityNode_.val())+":");let r=typeof this.value_;t+=r+":",r==="number"?t+=Uy(this.value_):t+=this.value_,this.lazyHash_=Oy(t)}return this.lazyHash_}getValue(){return this.value_}compareTo(t){return t===n.__childrenNodeConstructor.EMPTY_NODE?1:t instanceof n.__childrenNodeConstructor?-1:(F(t.isLeafNode(),"Unknown node type"),this.compareToLeafNode_(t))}compareToLeafNode_(t){let r=typeof t.value_,i=typeof this.value_,s=n.VALUE_TYPE_ORDER.indexOf(r),o=n.VALUE_TYPE_ORDER.indexOf(i);return F(s>=0,"Unknown leaf type: "+r),F(o>=0,"Unknown leaf type: "+i),s===o?i==="object"?0:this.value_<t.value_?-1:this.value_===t.value_?0:1:o-s}withIndex(){return this}isIndexed(){return!0}equals(t){if(t===this)return!0;if(t.isLeafNode()){let r=t;return this.value_===r.value_&&this.priorityNode_.equals(r.priorityNode_)}else return!1}}n.VALUE_TYPE_ORDER=["object","boolean","number","string"];return n})(),ov,av;function MS(n){ov=n}function LS(n){av=n}var xh=class extends ui{compare(e,t){let r=e.node.getPriority(),i=t.node.getPriority(),s=r.compareTo(i);return s===0?yr(e.name,t.name):s}isDefinedOn(e){return!e.getPriority().isEmpty()}indexedValueChanged(e,t){return!e.getPriority().equals(t.getPriority())}minPost(){return Z.MIN}maxPost(){return new Z(un,new ci("[PRIORITY-POST]",av))}makePost(e,t){let r=ov(e);return new Z(t,new ci("[PRIORITY-POST]",r))}toString(){return".priority"}},_e=new xh;var US=Math.log(2),Nh=class{constructor(e){let t=s=>parseInt(Math.log(s)/US,10),r=s=>parseInt(Array(s+1).join("1"),2);this.count=t(e+1),this.current_=this.count-1;let i=r(this.count);this.bits_=e+1&i}nextBitIsOne(){let e=!(this.bits_&1<<this.current_);return this.current_--,e}},pl=function(n,e,t,r){n.sort(e);let i=function(u,c){let d=c-u,p,m;if(d===0)return null;if(d===1)return p=n[u],m=t?t(p):p,new xt(m,p.node,xt.BLACK,null,null);{let y=parseInt(d/2,10)+u,C=i(u,y),x=i(y+1,c);return p=n[y],m=t?t(p):p,new xt(m,p.node,xt.BLACK,C,x)}},s=function(u){let c=null,d=null,p=n.length,m=function(C,x){let D=p-C,q=p;p-=C;let j=i(D+1,q),B=n[D],Y=t?t(B):B;y(new xt(Y,B.node,x,null,j))},y=function(C){c?(c.left=C,c=C):(d=C,c=C)};for(let C=0;C<u.count;++C){let x=u.nextBitIsOne(),D=Math.pow(2,u.count-(C+1));x?m(D,xt.BLACK):(m(D,xt.BLACK),m(D,xt.RED))}return d},o=new Nh(n.length),l=s(o);return new Tt(r||e,l)};var hh,si={},hi=class n{constructor(e,t){this.indexes_=e,this.indexSet_=t}static get Default(){return F(si&&_e,"ChildrenNode.ts has not been loaded"),hh=hh||new n({".priority":si},{".priority":_e}),hh}get(e){let t=Pn(this.indexes_,e);if(!t)throw new Error("No index defined for "+e);return t instanceof Tt?t:null}hasIndex(e){return wt(this.indexSet_,e.toString())}addIndex(e,t){F(e!==Gt,"KeyIndex always exists and isn't meant to be added to the IndexMap.");let r=[],i=!1,s=t.getIterator(Z.Wrap),o=s.getNext();for(;o;)i=i||e.isDefinedOn(o.node),r.push(o),o=s.getNext();let l;i?l=pl(r,e.getCompare()):l=si;let u=e.toString(),c=Object.assign({},this.indexSet_);c[u]=e;let d=Object.assign({},this.indexes_);return d[u]=l,new n(d,c)}addToIndexes(e,t){let r=Os(this.indexes_,(i,s)=>{let o=Pn(this.indexSet_,s);if(F(o,"Missing index implementation for "+s),i===si)if(o.isDefinedOn(e.node)){let l=[],u=t.getIterator(Z.Wrap),c=u.getNext();for(;c;)c.name!==e.name&&l.push(c),c=u.getNext();return l.push(e),pl(l,o.getCompare())}else return si;else{let l=t.get(e.name),u=i;return l&&(u=u.remove(new Z(e.name,l))),u.insert(e,e.node)}});return new n(r,this.indexSet_)}removeFromIndexes(e,t){let r=Os(this.indexes_,i=>{if(i===si)return i;{let s=t.get(e.name);return s?i.remove(new Z(e.name,s)):i}});return new n(r,this.indexSet_)}};var Bs,$=(()=>{class n{constructor(t,r,i){this.children_=t,this.priorityNode_=r,this.indexMap_=i,this.lazyHash_=null,this.priorityNode_&&sv(this.priorityNode_),this.children_.isEmpty()&&F(!this.priorityNode_||this.priorityNode_.isEmpty(),"An empty node cannot have a priority")}static get EMPTY_NODE(){return Bs||(Bs=new n(new Tt(Ad),null,hi.Default))}isLeafNode(){return!1}getPriority(){return this.priorityNode_||Bs}updatePriority(t){return this.children_.isEmpty()?this:new n(this.children_,t,this.indexMap_)}getImmediateChild(t){if(t===".priority")return this.getPriority();{let r=this.children_.get(t);return r===null?Bs:r}}getChild(t){let r=J(t);return r===null?this:this.getImmediateChild(r).getChild(me(t))}hasChild(t){return this.children_.get(t)!==null}updateImmediateChild(t,r){if(F(r,"We should always be passing snapshot nodes"),t===".priority")return this.updatePriority(r);{let i=new Z(t,r),s,o;r.isEmpty()?(s=this.children_.remove(t),o=this.indexMap_.removeFromIndexes(i,this.children_)):(s=this.children_.insert(t,r),o=this.indexMap_.addToIndexes(i,this.children_));let l=s.isEmpty()?Bs:this.priorityNode_;return new n(s,l,o)}}updateChild(t,r){let i=J(t);if(i===null)return r;{F(J(t)!==".priority"||Fn(t)===1,".priority must be the last token in a path");let s=this.getImmediateChild(i).updateChild(me(t),r);return this.updateImmediateChild(i,s)}}isEmpty(){return this.children_.isEmpty()}numChildren(){return this.children_.count()}val(t){if(this.isEmpty())return null;let r={},i=0,s=0,o=!0;if(this.forEachChild(_e,(l,u)=>{r[l]=u.val(t),i++,o&&n.INTEGER_REGEXP_.test(l)?s=Math.max(s,Number(l)):o=!1}),!t&&o&&s<2*i){let l=[];for(let u in r)l[u]=r[u];return l}else return t&&!this.getPriority().isEmpty()&&(r[".priority"]=this.getPriority().val()),r}hash(){if(this.lazyHash_===null){let t="";this.getPriority().isEmpty()||(t+="priority:"+iv(this.getPriority().val())+":"),this.forEachChild(_e,(r,i)=>{let s=i.hash();s!==""&&(t+=":"+r+":"+s)}),this.lazyHash_=t===""?"":Oy(t)}return this.lazyHash_}getPredecessorChildName(t,r,i){let s=this.resolveIndex_(i);if(s){let o=s.getPredecessorKey(new Z(t,r));return o?o.name:null}else return this.children_.getPredecessorKey(t)}getFirstChildName(t){let r=this.resolveIndex_(t);if(r){let i=r.minKey();return i&&i.name}else return this.children_.minKey()}getFirstChild(t){let r=this.getFirstChildName(t);return r?new Z(r,this.children_.get(r)):null}getLastChildName(t){let r=this.resolveIndex_(t);if(r){let i=r.maxKey();return i&&i.name}else return this.children_.maxKey()}getLastChild(t){let r=this.getLastChildName(t);return r?new Z(r,this.children_.get(r)):null}forEachChild(t,r){let i=this.resolveIndex_(t);return i?i.inorderTraversal(s=>r(s.name,s.node)):this.children_.inorderTraversal(r)}getIterator(t){return this.getIteratorFrom(t.minPost(),t)}getIteratorFrom(t,r){let i=this.resolveIndex_(r);if(i)return i.getIteratorFrom(t,s=>s);{let s=this.children_.getIteratorFrom(t.name,Z.Wrap),o=s.peek();for(;o!=null&&r.compare(o,t)<0;)s.getNext(),o=s.peek();return s}}getReverseIterator(t){return this.getReverseIteratorFrom(t.maxPost(),t)}getReverseIteratorFrom(t,r){let i=this.resolveIndex_(r);if(i)return i.getReverseIteratorFrom(t,s=>s);{let s=this.children_.getReverseIteratorFrom(t.name,Z.Wrap),o=s.peek();for(;o!=null&&r.compare(o,t)>0;)s.getNext(),o=s.peek();return s}}compareTo(t){return this.isEmpty()?t.isEmpty()?0:-1:t.isLeafNode()||t.isEmpty()?1:t===uo?-1:0}withIndex(t){if(t===Gt||this.indexMap_.hasIndex(t))return this;{let r=this.indexMap_.addIndex(t,this.children_);return new n(this.children_,this.priorityNode_,r)}}isIndexed(t){return t===Gt||this.indexMap_.hasIndex(t)}equals(t){if(t===this)return!0;if(t.isLeafNode())return!1;{let r=t;if(this.getPriority().equals(r.getPriority()))if(this.children_.count()===r.children_.count()){let i=this.getIterator(_e),s=r.getIterator(_e),o=i.getNext(),l=s.getNext();for(;o&&l;){if(o.name!==l.name||!o.node.equals(l.node))return!1;o=i.getNext(),l=s.getNext()}return o===null&&l===null}else return!1;else return!1}}resolveIndex_(t){return t===Gt?null:this.indexMap_.get(t.toString())}}return n.INTEGER_REGEXP_=/^(0|[1-9]\d*)$/,n})(),Dh=class extends ${constructor(){super(new Tt(Ad),$.EMPTY_NODE,hi.Default)}compareTo(e){return e===this?0:1}equals(e){return e===this}getPriority(){return this}getImmediateChild(e){return $.EMPTY_NODE}isEmpty(){return!1}},uo=new Dh;Object.defineProperties(Z,{MIN:{value:new Z(Vn,$.EMPTY_NODE)},MAX:{value:new Z(un,uo)}});fl.__EMPTY_NODE=$.EMPTY_NODE;ci.__childrenNodeConstructor=$;OS(uo);LS(uo);var BS=!0;function Te(n,e=null){if(n===null)return $.EMPTY_NODE;if(typeof n=="object"&&".priority"in n&&(e=n[".priority"]),F(e===null||typeof e=="string"||typeof e=="number"||typeof e=="object"&&".sv"in e,"Invalid priority type found: "+typeof e),typeof n=="object"&&".value"in n&&n[".value"]!==null&&(n=n[".value"]),typeof n!="object"||".sv"in n){let t=n;return new ci(t,Te(e))}if(!(n instanceof Array)&&BS){let t=[],r=!1;if(je(n,(o,l)=>{if(o.substring(0,1)!=="."){let u=Te(l);u.isEmpty()||(r=r||!u.getPriority().isEmpty(),t.push(new Z(o,u)))}}),t.length===0)return $.EMPTY_NODE;let s=pl(t,FS,o=>o.name,Ad);if(r){let o=pl(t,_e.getCompare());return new $(s,Te(e),new hi({".priority":o},{".priority":_e}))}else return new $(s,Te(e),hi.Default)}else{let t=$.EMPTY_NODE;return je(n,(r,i)=>{if(wt(n,r)&&r.substring(0,1)!=="."){let s=Te(i);(s.isLeafNode()||!s.isEmpty())&&(t=t.updateImmediateChild(r,s))}}),t.updatePriority(Te(e))}}MS(Te);var Hs=class extends ui{constructor(e){super(),this.indexPath_=e,F(!X(e)&&J(e)!==".priority","Can't create PathIndex with empty path or .priority key")}extractChild(e){return e.getChild(this.indexPath_)}isDefinedOn(e){return!e.getChild(this.indexPath_).isEmpty()}compare(e,t){let r=this.extractChild(e.node),i=this.extractChild(t.node),s=r.compareTo(i);return s===0?yr(e.name,t.name):s}makePost(e,t){let r=Te(e),i=$.EMPTY_NODE.updateChild(this.indexPath_,r);return new Z(t,i)}maxPost(){let e=$.EMPTY_NODE.updateChild(this.indexPath_,uo);return new Z(un,e)}toString(){return $s(this.indexPath_,0).join("/")}};var kh=class extends ui{compare(e,t){let r=e.node.compareTo(t.node);return r===0?yr(e.name,t.name):r}isDefinedOn(e){return!0}indexedValueChanged(e,t){return!e.equals(t)}minPost(){return Z.MIN}maxPost(){return Z.MAX}makePost(e,t){let r=Te(e);return new Z(t,r)}toString(){return".value"}},bd=new kh;function lv(n){return{type:"value",snapshotNode:n}}function di(n,e){return{type:"child_added",snapshotNode:e,childName:n}}function Ys(n,e){return{type:"child_removed",snapshotNode:e,childName:n}}function Js(n,e,t){return{type:"child_changed",snapshotNode:e,childName:n,oldSnap:t}}function qS(n,e){return{type:"child_moved",snapshotNode:e,childName:n}}var Xs=class{constructor(e){this.index_=e}updateChild(e,t,r,i,s,o){F(e.isIndexed(this.index_),"A node must be indexed if only a child is updated");let l=e.getImmediateChild(t);return l.getChild(i).equals(r.getChild(i))&&l.isEmpty()===r.isEmpty()||(o!=null&&(r.isEmpty()?e.hasChild(t)?o.trackChildChange(Ys(t,l)):F(e.isLeafNode(),"A child remove without an old child only makes sense on a leaf node"):l.isEmpty()?o.trackChildChange(di(t,r)):o.trackChildChange(Js(t,r,l))),e.isLeafNode()&&r.isEmpty())?e:e.updateImmediateChild(t,r).withIndex(this.index_)}updateFullNode(e,t,r){return r!=null&&(e.isLeafNode()||e.forEachChild(_e,(i,s)=>{t.hasChild(i)||r.trackChildChange(Ys(i,s))}),t.isLeafNode()||t.forEachChild(_e,(i,s)=>{if(e.hasChild(i)){let o=e.getImmediateChild(i);o.equals(s)||r.trackChildChange(Js(i,s,o))}else r.trackChildChange(di(i,s))})),t.withIndex(this.index_)}updatePriority(e,t){return e.isEmpty()?$.EMPTY_NODE:e.updatePriority(t)}filtersNodes(){return!1}getIndexedFilter(){return this}getIndex(){return this.index_}};var ml=class n{constructor(e){this.indexedFilter_=new Xs(e.getIndex()),this.index_=e.getIndex(),this.startPost_=n.getStartPost_(e),this.endPost_=n.getEndPost_(e),this.startIsInclusive_=!e.startAfterSet_,this.endIsInclusive_=!e.endBeforeSet_}getStartPost(){return this.startPost_}getEndPost(){return this.endPost_}matches(e){let t=this.startIsInclusive_?this.index_.compare(this.getStartPost(),e)<=0:this.index_.compare(this.getStartPost(),e)<0,r=this.endIsInclusive_?this.index_.compare(e,this.getEndPost())<=0:this.index_.compare(e,this.getEndPost())<0;return t&&r}updateChild(e,t,r,i,s,o){return this.matches(new Z(t,r))||(r=$.EMPTY_NODE),this.indexedFilter_.updateChild(e,t,r,i,s,o)}updateFullNode(e,t,r){t.isLeafNode()&&(t=$.EMPTY_NODE);let i=t.withIndex(this.index_);i=i.updatePriority($.EMPTY_NODE);let s=this;return t.forEachChild(_e,(o,l)=>{s.matches(new Z(o,l))||(i=i.updateImmediateChild(o,$.EMPTY_NODE))}),this.indexedFilter_.updateFullNode(e,i,r)}updatePriority(e,t){return e}filtersNodes(){return!0}getIndexedFilter(){return this.indexedFilter_}getIndex(){return this.index_}static getStartPost_(e){if(e.hasStart()){let t=e.getIndexStartName();return e.getIndex().makePost(e.getIndexStartValue(),t)}else return e.getIndex().minPost()}static getEndPost_(e){if(e.hasEnd()){let t=e.getIndexEndName();return e.getIndex().makePost(e.getIndexEndValue(),t)}else return e.getIndex().maxPost()}};var Vh=class{constructor(e){this.withinDirectionalStart=t=>this.reverse_?this.withinEndPost(t):this.withinStartPost(t),this.withinDirectionalEnd=t=>this.reverse_?this.withinStartPost(t):this.withinEndPost(t),this.withinStartPost=t=>{let r=this.index_.compare(this.rangedFilter_.getStartPost(),t);return this.startIsInclusive_?r<=0:r<0},this.withinEndPost=t=>{let r=this.index_.compare(t,this.rangedFilter_.getEndPost());return this.endIsInclusive_?r<=0:r<0},this.rangedFilter_=new ml(e),this.index_=e.getIndex(),this.limit_=e.getLimit(),this.reverse_=!e.isViewFromLeft(),this.startIsInclusive_=!e.startAfterSet_,this.endIsInclusive_=!e.endBeforeSet_}updateChild(e,t,r,i,s,o){return this.rangedFilter_.matches(new Z(t,r))||(r=$.EMPTY_NODE),e.getImmediateChild(t).equals(r)?e:e.numChildren()<this.limit_?this.rangedFilter_.getIndexedFilter().updateChild(e,t,r,i,s,o):this.fullLimitUpdateChild_(e,t,r,s,o)}updateFullNode(e,t,r){let i;if(t.isLeafNode()||t.isEmpty())i=$.EMPTY_NODE.withIndex(this.index_);else if(this.limit_*2<t.numChildren()&&t.isIndexed(this.index_)){i=$.EMPTY_NODE.withIndex(this.index_);let s;this.reverse_?s=t.getReverseIteratorFrom(this.rangedFilter_.getEndPost(),this.index_):s=t.getIteratorFrom(this.rangedFilter_.getStartPost(),this.index_);let o=0;for(;s.hasNext()&&o<this.limit_;){let l=s.getNext();if(this.withinDirectionalStart(l))if(this.withinDirectionalEnd(l))i=i.updateImmediateChild(l.name,l.node),o++;else break;else continue}}else{i=t.withIndex(this.index_),i=i.updatePriority($.EMPTY_NODE);let s;this.reverse_?s=i.getReverseIterator(this.index_):s=i.getIterator(this.index_);let o=0;for(;s.hasNext();){let l=s.getNext();o<this.limit_&&this.withinDirectionalStart(l)&&this.withinDirectionalEnd(l)?o++:i=i.updateImmediateChild(l.name,$.EMPTY_NODE)}}return this.rangedFilter_.getIndexedFilter().updateFullNode(e,i,r)}updatePriority(e,t){return e}filtersNodes(){return!0}getIndexedFilter(){return this.rangedFilter_.getIndexedFilter()}getIndex(){return this.index_}fullLimitUpdateChild_(e,t,r,i,s){let o;if(this.reverse_){let p=this.index_.getCompare();o=(m,y)=>p(y,m)}else o=this.index_.getCompare();let l=e;F(l.numChildren()===this.limit_,"");let u=new Z(t,r),c=this.reverse_?l.getFirstChild(this.index_):l.getLastChild(this.index_),d=this.rangedFilter_.matches(u);if(l.hasChild(t)){let p=l.getImmediateChild(t),m=i.getChildAfterChild(this.index_,c,this.reverse_);for(;m!=null&&(m.name===t||l.hasChild(m.name));)m=i.getChildAfterChild(this.index_,m,this.reverse_);let y=m==null?1:o(m,u);if(d&&!r.isEmpty()&&y>=0)return s?.trackChildChange(Js(t,r,p)),l.updateImmediateChild(t,r);{s?.trackChildChange(Ys(t,p));let x=l.updateImmediateChild(t,$.EMPTY_NODE);return m!=null&&this.rangedFilter_.matches(m)?(s?.trackChildChange(di(m.name,m.node)),x.updateImmediateChild(m.name,m.node)):x}}else return r.isEmpty()?e:d&&o(c,u)>=0?(s!=null&&(s.trackChildChange(Ys(c.name,c.node)),s.trackChildChange(di(t,r))),l.updateImmediateChild(t,r).updateImmediateChild(c.name,$.EMPTY_NODE)):e}};var Zs=class n{constructor(){this.limitSet_=!1,this.startSet_=!1,this.startNameSet_=!1,this.startAfterSet_=!1,this.endSet_=!1,this.endNameSet_=!1,this.endBeforeSet_=!1,this.limit_=0,this.viewFrom_="",this.indexStartValue_=null,this.indexStartName_="",this.indexEndValue_=null,this.indexEndName_="",this.index_=_e}hasStart(){return this.startSet_}isViewFromLeft(){return this.viewFrom_===""?this.startSet_:this.viewFrom_==="l"}getIndexStartValue(){return F(this.startSet_,"Only valid if start has been set"),this.indexStartValue_}getIndexStartName(){return F(this.startSet_,"Only valid if start has been set"),this.startNameSet_?this.indexStartName_:Vn}hasEnd(){return this.endSet_}getIndexEndValue(){return F(this.endSet_,"Only valid if end has been set"),this.indexEndValue_}getIndexEndName(){return F(this.endSet_,"Only valid if end has been set"),this.endNameSet_?this.indexEndName_:un}hasLimit(){return this.limitSet_}hasAnchoredLimit(){return this.limitSet_&&this.viewFrom_!==""}getLimit(){return F(this.limitSet_,"Only valid if limit has been set"),this.limit_}getIndex(){return this.index_}loadsAllData(){return!(this.startSet_||this.endSet_||this.limitSet_)}isDefault(){return this.loadsAllData()&&this.index_===_e}copy(){let e=new n;return e.limitSet_=this.limitSet_,e.limit_=this.limit_,e.startSet_=this.startSet_,e.startAfterSet_=this.startAfterSet_,e.indexStartValue_=this.indexStartValue_,e.startNameSet_=this.startNameSet_,e.indexStartName_=this.indexStartName_,e.endSet_=this.endSet_,e.endBeforeSet_=this.endBeforeSet_,e.indexEndValue_=this.indexEndValue_,e.endNameSet_=this.endNameSet_,e.indexEndName_=this.indexEndName_,e.index_=this.index_,e.viewFrom_=this.viewFrom_,e}};function GS(n){return n.loadsAllData()?new Xs(n.getIndex()):n.hasLimit()?new Vh(n):new ml(n)}function jS(n,e){let t=n.copy();return t.limitSet_=!0,t.limit_=e,t.viewFrom_="l",t}function zS(n,e){let t=n.copy();return t.limitSet_=!0,t.limit_=e,t.viewFrom_="r",t}function Fh(n,e,t){let r=n.copy();return r.startSet_=!0,e===void 0&&(e=null),r.indexStartValue_=e,t!=null?(r.startNameSet_=!0,r.indexStartName_=t):(r.startNameSet_=!1,r.indexStartName_=""),r}function KS(n,e,t){let r;return n.index_===Gt||t?r=Fh(n,e,t):r=Fh(n,e,un),r.startAfterSet_=!0,r}function Oh(n,e,t){let r=n.copy();return r.endSet_=!0,e===void 0&&(e=null),r.indexEndValue_=e,t!==void 0?(r.endNameSet_=!0,r.indexEndName_=t):(r.endNameSet_=!1,r.indexEndName_=""),r}function WS(n,e,t){let r;return n.index_===Gt||t?r=Oh(n,e,t):r=Oh(n,e,Vn),r.endBeforeSet_=!0,r}function Vl(n,e){let t=n.copy();return t.index_=e,t}function yy(n){let e={};if(n.isDefault())return e;let t;if(n.index_===_e?t="$priority":n.index_===bd?t="$value":n.index_===Gt?t="$key":(F(n.index_ instanceof Hs,"Unrecognized index type!"),t=n.index_.toString()),e.orderBy=ke(t),n.startSet_){let r=n.startAfterSet_?"startAfter":"startAt";e[r]=ke(n.indexStartValue_),n.startNameSet_&&(e[r]+=","+ke(n.indexStartName_))}if(n.endSet_){let r=n.endBeforeSet_?"endBefore":"endAt";e[r]=ke(n.indexEndValue_),n.endNameSet_&&(e[r]+=","+ke(n.indexEndName_))}return n.limitSet_&&(n.isViewFromLeft()?e.limitToFirst=n.limit_:e.limitToLast=n.limit_),e}function vy(n){let e={};if(n.startSet_&&(e.sp=n.indexStartValue_,n.startNameSet_&&(e.sn=n.indexStartName_),e.sin=!n.startAfterSet_),n.endSet_&&(e.ep=n.indexEndValue_,n.endNameSet_&&(e.en=n.indexEndName_),e.ein=!n.endBeforeSet_),n.limitSet_){e.l=n.limit_;let t=n.viewFrom_;t===""&&(n.isViewFromLeft()?t="l":t="r"),e.vf=t}return n.index_!==_e&&(e.i=n.index_.toString()),e}var Mh=class n extends cl{constructor(e,t,r,i){super(),this.repoInfo_=e,this.onDataUpdate_=t,this.authTokenProvider_=r,this.appCheckTokenProvider_=i,this.log_=lo("p:rest:"),this.listens_={}}reportStats(e){throw new Error("Method not implemented.")}static getListenId_(e,t){return t!==void 0?"tag$"+t:(F(e._queryParams.isDefault(),"should have a tag if it's not a default query."),e._path.toString())}listen(e,t,r,i){let s=e._path.toString();this.log_("Listen called for "+s+" "+e._queryIdentifier);let o=n.getListenId_(e,r),l={};this.listens_[o]=l;let u=yy(e._queryParams);this.restRequest_(s+".json",u,(c,d)=>{let p=d;if(c===404&&(p=null,c=null),c===null&&this.onDataUpdate_(s,p,!1,r),Pn(this.listens_,o)===l){let m;c?c===401?m="permission_denied":m="rest_error:"+c:m="ok",i(m,null)}})}unlisten(e,t){let r=n.getListenId_(e,t);delete this.listens_[r]}get(e){let t=yy(e._queryParams),r=e._path.toString(),i=new rt;return this.restRequest_(r+".json",t,(s,o)=>{let l=o;s===404&&(l=null,s=null),s===null?(this.onDataUpdate_(r,l,!1,null),i.resolve(l)):i.reject(new Error(l))}),i.promise}refreshAuthToken(e){}restRequest_(e,t={},r){return t.format="export",Promise.all([this.authTokenProvider_.getToken(!1),this.appCheckTokenProvider_.getToken(!1)]).then(([i,s])=>{i&&i.accessToken&&(t.auth=i.accessToken),s&&s.token&&(t.ac=s.token);let o=(this.repoInfo_.secure?"https://":"http://")+this.repoInfo_.host+e+"?ns="+this.repoInfo_.namespace+q_(t);this.log_("Sending REST request for "+o);let l=new XMLHttpRequest;l.onreadystatechange=()=>{if(r&&l.readyState===4){this.log_("REST Response for "+o+" received. status:",l.status,"response:",l.responseText);let u=null;if(l.status>=200&&l.status<300){try{u=Ua(l.responseText)}catch{Xe("Failed to parse JSON response for "+o+": "+l.responseText)}r(null,u)}else l.status!==401&&l.status!==404&&Xe("Got unsuccessful REST response for "+o+" Status: "+l.status),r(l.status);r=null}},l.open("GET",o,!0),l.send()})}};var Lh=class{constructor(){this.rootNode_=$.EMPTY_NODE}getNode(e){return this.rootNode_.getChild(e)}updateSnapshot(e,t){this.rootNode_=this.rootNode_.updateChild(e,t)}};function gl(){return{value:null,children:new Map}}function yi(n,e,t){if(X(e))n.value=t,n.children.clear();else if(n.value!==null)n.value=n.value.updateChild(e,t);else{let r=J(e);n.children.has(r)||n.children.set(r,gl());let i=n.children.get(r);e=me(e),yi(i,e,t)}}function Uh(n,e){if(X(e))return n.value=null,n.children.clear(),!0;if(n.value!==null){if(n.value.isLeafNode())return!1;{let t=n.value;return n.value=null,t.forEachChild(_e,(r,i)=>{yi(n,new he(r),i)}),Uh(n,e)}}else if(n.children.size>0){let t=J(e);return e=me(e),n.children.has(t)&&Uh(n.children.get(t),e)&&n.children.delete(t),n.children.size===0}else return!0}function Bh(n,e,t){n.value!==null?t(e,n.value):QS(n,(r,i)=>{let s=new he(e.toString()+"/"+r);Bh(i,s,t)})}function QS(n,e){n.children.forEach((t,r)=>{e(r,t)})}var qh=class{constructor(e){this.collection_=e,this.last_=null}get(){let e=this.collection_.get(),t=Object.assign({},e);return this.last_&&je(this.last_,(r,i)=>{t[r]=t[r]-i}),this.last_=e,t}};var wy=10*1e3,$S=30*1e3,HS=5*60*1e3,Gh=class{constructor(e,t){this.server_=t,this.statsToReport_={},this.statsListener_=new qh(e);let r=wy+($S-wy)*Math.random();Gs(this.reportStats_.bind(this),Math.floor(r))}reportStats_(){let e=this.statsListener_.get(),t={},r=!1;je(e,(i,s)=>{s>0&&wt(this.statsToReport_,i)&&(t[i]=s,r=!0)}),r&&this.server_.reportStats(t),Gs(this.reportStats_.bind(this),Math.floor(Math.random()*2*HS))}};var qt=function(n){return n[n.OVERWRITE=0]="OVERWRITE",n[n.MERGE=1]="MERGE",n[n.ACK_USER_WRITE=2]="ACK_USER_WRITE",n[n.LISTEN_COMPLETE=3]="LISTEN_COMPLETE",n}(qt||{});function Rd(){return{fromUser:!0,fromServer:!1,queryId:null,tagged:!1}}function Pd(){return{fromUser:!1,fromServer:!0,queryId:null,tagged:!1}}function xd(n){return{fromUser:!1,fromServer:!0,queryId:n,tagged:!0}}var jh=class n{constructor(e,t,r){this.path=e,this.affectedTree=t,this.revert=r,this.type=qt.ACK_USER_WRITE,this.source=Rd()}operationForChild(e){if(X(this.path)){if(this.affectedTree.value!=null)return F(this.affectedTree.children.isEmpty(),"affectedTree should not have overlapping affected paths."),this;{let t=this.affectedTree.subtree(new he(e));return new n(ce(),t,this.revert)}}else return F(J(this.path)===e,"operationForChild called for unrelated child."),new n(me(this.path),this.affectedTree,this.revert)}};var _l=class n{constructor(e,t){this.source=e,this.path=t,this.type=qt.LISTEN_COMPLETE}operationForChild(e){return X(this.path)?new n(this.source,ce()):new n(this.source,me(this.path))}};var fi=class n{constructor(e,t,r){this.source=e,this.path=t,this.snap=r,this.type=qt.OVERWRITE}operationForChild(e){return X(this.path)?new n(this.source,ce(),this.snap.getImmediateChild(e)):new n(this.source,me(this.path),this.snap)}};var eo=class n{constructor(e,t,r){this.source=e,this.path=t,this.children=r,this.type=qt.MERGE}operationForChild(e){if(X(this.path)){let t=this.children.subtree(new he(e));return t.isEmpty()?null:t.value?new fi(this.source,ce(),t.value):new n(this.source,ce(),t)}else return F(J(this.path)===e,"Can't get a merge for a child not on the path of the operation"),new n(this.source,me(this.path),this.children)}toString(){return"Operation("+this.path+": "+this.source.toString()+" merge: "+this.children.toString()+")"}};var zt=class{constructor(e,t,r){this.node_=e,this.fullyInitialized_=t,this.filtered_=r}isFullyInitialized(){return this.fullyInitialized_}isFiltered(){return this.filtered_}isCompleteForPath(e){if(X(e))return this.isFullyInitialized()&&!this.filtered_;let t=J(e);return this.isCompleteForChild(t)}isCompleteForChild(e){return this.isFullyInitialized()&&!this.filtered_||this.node_.hasChild(e)}getNode(){return this.node_}};var zh=class{constructor(e){this.query_=e,this.index_=this.query_._queryParams.getIndex()}};function YS(n,e,t,r){let i=[],s=[];return e.forEach(o=>{o.type==="child_changed"&&n.index_.indexedValueChanged(o.oldSnap,o.snapshotNode)&&s.push(qS(o.childName,o.snapshotNode))}),qs(n,i,"child_removed",e,r,t),qs(n,i,"child_added",e,r,t),qs(n,i,"child_moved",s,r,t),qs(n,i,"child_changed",e,r,t),qs(n,i,"value",e,r,t),i}function qs(n,e,t,r,i,s){let o=r.filter(l=>l.type===t);o.sort((l,u)=>XS(n,l,u)),o.forEach(l=>{let u=JS(n,l,s);i.forEach(c=>{c.respondsTo(l.type)&&e.push(c.createEvent(u,n.query_))})})}function JS(n,e,t){return e.type==="value"||e.type==="child_removed"||(e.prevName=t.getPredecessorChildName(e.childName,e.snapshotNode,n.index_)),e}function XS(n,e,t){if(e.childName==null||t.childName==null)throw ni("Should only compare child_ events.");let r=new Z(e.childName,e.snapshotNode),i=new Z(t.childName,t.snapshotNode);return n.index_.compare(r,i)}function Fl(n,e){return{eventCache:n,serverCache:e}}function zs(n,e,t,r){return Fl(new zt(e,t,r),n.serverCache)}function uv(n,e,t,r){return Fl(n.eventCache,new zt(e,t,r))}function yl(n){return n.eventCache.isFullyInitialized()?n.eventCache.getNode():null}function _r(n){return n.serverCache.isFullyInitialized()?n.serverCache.getNode():null}var dh,ZS=()=>(dh||(dh=new Tt(J0)),dh),st=class n{constructor(e,t=ZS()){this.value=e,this.children=t}static fromObject(e){let t=new n(null);return je(e,(r,i)=>{t=t.set(new he(r),i)}),t}isEmpty(){return this.value===null&&this.children.isEmpty()}findRootMostMatchingPathAndValue(e,t){if(this.value!=null&&t(this.value))return{path:ce(),value:this.value};if(X(e))return null;{let r=J(e),i=this.children.get(r);if(i!==null){let s=i.findRootMostMatchingPathAndValue(me(e),t);return s!=null?{path:Ee(new he(r),s.path),value:s.value}:null}else return null}}findRootMostValueAndPath(e){return this.findRootMostMatchingPathAndValue(e,()=>!0)}subtree(e){if(X(e))return this;{let t=J(e),r=this.children.get(t);return r!==null?r.subtree(me(e)):new n(null)}}set(e,t){if(X(e))return new n(t,this.children);{let r=J(e),s=(this.children.get(r)||new n(null)).set(me(e),t),o=this.children.insert(r,s);return new n(this.value,o)}}remove(e){if(X(e))return this.children.isEmpty()?new n(null):new n(null,this.children);{let t=J(e),r=this.children.get(t);if(r){let i=r.remove(me(e)),s;return i.isEmpty()?s=this.children.remove(t):s=this.children.insert(t,i),this.value===null&&s.isEmpty()?new n(null):new n(this.value,s)}else return this}}get(e){if(X(e))return this.value;{let t=J(e),r=this.children.get(t);return r?r.get(me(e)):null}}setTree(e,t){if(X(e))return t;{let r=J(e),s=(this.children.get(r)||new n(null)).setTree(me(e),t),o;return s.isEmpty()?o=this.children.remove(r):o=this.children.insert(r,s),new n(this.value,o)}}fold(e){return this.fold_(ce(),e)}fold_(e,t){let r={};return this.children.inorderTraversal((i,s)=>{r[i]=s.fold_(Ee(e,i),t)}),t(e,this.value,r)}findOnPath(e,t){return this.findOnPath_(e,ce(),t)}findOnPath_(e,t,r){let i=this.value?r(t,this.value):!1;if(i)return i;if(X(e))return null;{let s=J(e),o=this.children.get(s);return o?o.findOnPath_(me(e),Ee(t,s),r):null}}foreachOnPath(e,t){return this.foreachOnPath_(e,ce(),t)}foreachOnPath_(e,t,r){if(X(e))return this;{this.value&&r(t,this.value);let i=J(e),s=this.children.get(i);return s?s.foreachOnPath_(me(e),Ee(t,i),r):new n(null)}}foreach(e){this.foreach_(ce(),e)}foreach_(e,t){this.children.inorderTraversal((r,i)=>{i.foreach_(Ee(e,r),t)}),this.value&&t(e,this.value)}foreachChild(e){this.children.inorderTraversal((t,r)=>{r.value&&e(t,r.value)})}};var Nt=class n{constructor(e){this.writeTree_=e}static empty(){return new n(new st(null))}};function Ks(n,e,t){if(X(e))return new Nt(new st(t));{let r=n.writeTree_.findRootMostValueAndPath(e);if(r!=null){let i=r.path,s=r.value,o=it(i,e);return s=s.updateChild(o,t),new Nt(n.writeTree_.set(i,s))}else{let i=new st(t),s=n.writeTree_.setTree(e,i);return new Nt(s)}}}function Kh(n,e,t){let r=n;return je(t,(i,s)=>{r=Ks(r,Ee(e,i),s)}),r}function Ey(n,e){if(X(e))return Nt.empty();{let t=n.writeTree_.setTree(e,new st(null));return new Nt(t)}}function Wh(n,e){return vr(n,e)!=null}function vr(n,e){let t=n.writeTree_.findRootMostValueAndPath(e);return t!=null?n.writeTree_.get(t.path).getChild(it(t.path,e)):null}function Iy(n){let e=[],t=n.writeTree_.value;return t!=null?t.isLeafNode()||t.forEachChild(_e,(r,i)=>{e.push(new Z(r,i))}):n.writeTree_.children.inorderTraversal((r,i)=>{i.value!=null&&e.push(new Z(r,i.value))}),e}function Dn(n,e){if(X(e))return n;{let t=vr(n,e);return t!=null?new Nt(new st(t)):new Nt(n.writeTree_.subtree(e))}}function Qh(n){return n.writeTree_.isEmpty()}function pi(n,e){return cv(ce(),n.writeTree_,e)}function cv(n,e,t){if(e.value!=null)return t.updateChild(n,e.value);{let r=null;return e.children.inorderTraversal((i,s)=>{i===".priority"?(F(s.value!==null,"Priority writes must always be leaf nodes"),r=s.value):t=cv(Ee(n,i),s,t)}),!t.getChild(n).isEmpty()&&r!==null&&(t=t.updateChild(Ee(n,".priority"),r)),t}}function Ol(n,e){return pv(e,n)}function eC(n,e,t,r,i){F(r>n.lastWriteId,"Stacking an older write on top of newer ones"),i===void 0&&(i=!0),n.allWrites.push({path:e,snap:t,writeId:r,visible:i}),i&&(n.visibleWrites=Ks(n.visibleWrites,e,t)),n.lastWriteId=r}function tC(n,e,t,r){F(r>n.lastWriteId,"Stacking an older merge on top of newer ones"),n.allWrites.push({path:e,children:t,writeId:r,visible:!0}),n.visibleWrites=Kh(n.visibleWrites,e,t),n.lastWriteId=r}function nC(n,e){for(let t=0;t<n.allWrites.length;t++){let r=n.allWrites[t];if(r.writeId===e)return r}return null}function rC(n,e){let t=n.allWrites.findIndex(l=>l.writeId===e);F(t>=0,"removeWrite called with nonexistent writeId.");let r=n.allWrites[t];n.allWrites.splice(t,1);let i=r.visible,s=!1,o=n.allWrites.length-1;for(;i&&o>=0;){let l=n.allWrites[o];l.visible&&(o>=t&&iC(l,r.path)?i=!1:It(r.path,l.path)&&(s=!0)),o--}if(i){if(s)return sC(n),!0;if(r.snap)n.visibleWrites=Ey(n.visibleWrites,r.path);else{let l=r.children;je(l,u=>{n.visibleWrites=Ey(n.visibleWrites,Ee(r.path,u))})}return!0}else return!1}function iC(n,e){if(n.snap)return It(n.path,e);for(let t in n.children)if(n.children.hasOwnProperty(t)&&It(Ee(n.path,t),e))return!0;return!1}function sC(n){n.visibleWrites=hv(n.allWrites,oC,ce()),n.allWrites.length>0?n.lastWriteId=n.allWrites[n.allWrites.length-1].writeId:n.lastWriteId=-1}function oC(n){return n.visible}function hv(n,e,t){let r=Nt.empty();for(let i=0;i<n.length;++i){let s=n[i];if(e(s)){let o=s.path,l;if(s.snap)It(t,o)?(l=it(t,o),r=Ks(r,l,s.snap)):It(o,t)&&(l=it(o,t),r=Ks(r,ce(),s.snap.getChild(l)));else if(s.children){if(It(t,o))l=it(t,o),r=Kh(r,l,s.children);else if(It(o,t))if(l=it(o,t),X(l))r=Kh(r,ce(),s.children);else{let u=Pn(s.children,J(l));if(u){let c=u.getChild(me(l));r=Ks(r,ce(),c)}}}else throw ni("WriteRecord should have .snap or .children")}}return r}function dv(n,e,t,r,i){if(!r&&!i){let s=vr(n.visibleWrites,e);if(s!=null)return s;{let o=Dn(n.visibleWrites,e);if(Qh(o))return t;if(t==null&&!Wh(o,ce()))return null;{let l=t||$.EMPTY_NODE;return pi(o,l)}}}else{let s=Dn(n.visibleWrites,e);if(!i&&Qh(s))return t;if(!i&&t==null&&!Wh(s,ce()))return null;{let o=function(c){return(c.visible||i)&&(!r||!~r.indexOf(c.writeId))&&(It(c.path,e)||It(e,c.path))},l=hv(n.allWrites,o,e),u=t||$.EMPTY_NODE;return pi(l,u)}}}function aC(n,e,t){let r=$.EMPTY_NODE,i=vr(n.visibleWrites,e);if(i)return i.isLeafNode()||i.forEachChild(_e,(s,o)=>{r=r.updateImmediateChild(s,o)}),r;if(t){let s=Dn(n.visibleWrites,e);return t.forEachChild(_e,(o,l)=>{let u=pi(Dn(s,new he(o)),l);r=r.updateImmediateChild(o,u)}),Iy(s).forEach(o=>{r=r.updateImmediateChild(o.name,o.node)}),r}else{let s=Dn(n.visibleWrites,e);return Iy(s).forEach(o=>{r=r.updateImmediateChild(o.name,o.node)}),r}}function lC(n,e,t,r,i){F(r||i,"Either existingEventSnap or existingServerSnap must exist");let s=Ee(e,t);if(Wh(n.visibleWrites,s))return null;{let o=Dn(n.visibleWrites,s);return Qh(o)?i.getChild(t):pi(o,i.getChild(t))}}function uC(n,e,t,r){let i=Ee(e,t),s=vr(n.visibleWrites,i);if(s!=null)return s;if(r.isCompleteForChild(t)){let o=Dn(n.visibleWrites,i);return pi(o,r.getNode().getImmediateChild(t))}else return null}function cC(n,e){return vr(n.visibleWrites,e)}function hC(n,e,t,r,i,s,o){let l,u=Dn(n.visibleWrites,e),c=vr(u,ce());if(c!=null)l=c;else if(t!=null)l=pi(u,t);else return[];if(l=l.withIndex(o),!l.isEmpty()&&!l.isLeafNode()){let d=[],p=o.getCompare(),m=s?l.getReverseIteratorFrom(r,o):l.getIteratorFrom(r,o),y=m.getNext();for(;y&&d.length<i;)p(y,r)!==0&&d.push(y),y=m.getNext();return d}else return[]}function dC(){return{visibleWrites:Nt.empty(),allWrites:[],lastWriteId:-1}}function vl(n,e,t,r){return dv(n.writeTree,n.treePath,e,t,r)}function Nd(n,e){return aC(n.writeTree,n.treePath,e)}function Ty(n,e,t,r){return lC(n.writeTree,n.treePath,e,t,r)}function wl(n,e){return cC(n.writeTree,Ee(n.treePath,e))}function fC(n,e,t,r,i,s){return hC(n.writeTree,n.treePath,e,t,r,i,s)}function Dd(n,e,t){return uC(n.writeTree,n.treePath,e,t)}function fv(n,e){return pv(Ee(n.treePath,e),n.writeTree)}function pv(n,e){return{treePath:n,writeTree:e}}var $h=class{constructor(){this.changeMap=new Map}trackChildChange(e){let t=e.type,r=e.childName;F(t==="child_added"||t==="child_changed"||t==="child_removed","Only child changes supported for tracking"),F(r!==".priority","Only non-priority child changes can be tracked.");let i=this.changeMap.get(r);if(i){let s=i.type;if(t==="child_added"&&s==="child_removed")this.changeMap.set(r,Js(r,e.snapshotNode,i.snapshotNode));else if(t==="child_removed"&&s==="child_added")this.changeMap.delete(r);else if(t==="child_removed"&&s==="child_changed")this.changeMap.set(r,Ys(r,i.oldSnap));else if(t==="child_changed"&&s==="child_added")this.changeMap.set(r,di(r,e.snapshotNode));else if(t==="child_changed"&&s==="child_changed")this.changeMap.set(r,Js(r,e.snapshotNode,i.oldSnap));else throw ni("Illegal combination of changes: "+e+" occurred after "+i)}else this.changeMap.set(r,e)}getChanges(){return Array.from(this.changeMap.values())}};var Hh=class{getCompleteChild(e){return null}getChildAfterChild(e,t,r){return null}},mv=new Hh,to=class{constructor(e,t,r=null){this.writes_=e,this.viewCache_=t,this.optCompleteServerCache_=r}getCompleteChild(e){let t=this.viewCache_.eventCache;if(t.isCompleteForChild(e))return t.getNode().getImmediateChild(e);{let r=this.optCompleteServerCache_!=null?new zt(this.optCompleteServerCache_,!0,!1):this.viewCache_.serverCache;return Dd(this.writes_,e,r)}}getChildAfterChild(e,t,r){let i=this.optCompleteServerCache_!=null?this.optCompleteServerCache_:_r(this.viewCache_),s=fC(this.writes_,i,t,1,r,e);return s.length===0?null:s[0]}};function pC(n){return{filter:n}}function mC(n,e){F(e.eventCache.getNode().isIndexed(n.filter.getIndex()),"Event snap not indexed"),F(e.serverCache.getNode().isIndexed(n.filter.getIndex()),"Server snap not indexed")}function gC(n,e,t,r,i){let s=new $h,o,l;if(t.type===qt.OVERWRITE){let c=t;c.source.fromUser?o=Yh(n,e,c.path,c.snap,r,i,s):(F(c.source.fromServer,"Unknown source."),l=c.source.tagged||e.serverCache.isFiltered()&&!X(c.path),o=El(n,e,c.path,c.snap,r,i,l,s))}else if(t.type===qt.MERGE){let c=t;c.source.fromUser?o=yC(n,e,c.path,c.children,r,i,s):(F(c.source.fromServer,"Unknown source."),l=c.source.tagged||e.serverCache.isFiltered(),o=Jh(n,e,c.path,c.children,r,i,l,s))}else if(t.type===qt.ACK_USER_WRITE){let c=t;c.revert?o=EC(n,e,c.path,r,i,s):o=vC(n,e,c.path,c.affectedTree,r,i,s)}else if(t.type===qt.LISTEN_COMPLETE)o=wC(n,e,t.path,r,s);else throw ni("Unknown operation type: "+t.type);let u=s.getChanges();return _C(e,o,u),{viewCache:o,changes:u}}function _C(n,e,t){let r=e.eventCache;if(r.isFullyInitialized()){let i=r.getNode().isLeafNode()||r.getNode().isEmpty(),s=yl(n);(t.length>0||!n.eventCache.isFullyInitialized()||i&&!r.getNode().equals(s)||!r.getNode().getPriority().equals(s.getPriority()))&&t.push(lv(yl(e)))}}function gv(n,e,t,r,i,s){let o=e.eventCache;if(wl(r,t)!=null)return e;{let l,u;if(X(t))if(F(e.serverCache.isFullyInitialized(),"If change path is empty, we must have complete server data"),e.serverCache.isFiltered()){let c=_r(e),d=c instanceof $?c:$.EMPTY_NODE,p=Nd(r,d);l=n.filter.updateFullNode(e.eventCache.getNode(),p,s)}else{let c=vl(r,_r(e));l=n.filter.updateFullNode(e.eventCache.getNode(),c,s)}else{let c=J(t);if(c===".priority"){F(Fn(t)===1,"Can't have a priority with additional path components");let d=o.getNode();u=e.serverCache.getNode();let p=Ty(r,t,d,u);p!=null?l=n.filter.updatePriority(d,p):l=o.getNode()}else{let d=me(t),p;if(o.isCompleteForChild(c)){u=e.serverCache.getNode();let m=Ty(r,t,o.getNode(),u);m!=null?p=o.getNode().getImmediateChild(c).updateChild(d,m):p=o.getNode().getImmediateChild(c)}else p=Dd(r,c,e.serverCache);p!=null?l=n.filter.updateChild(o.getNode(),c,p,d,i,s):l=o.getNode()}}return zs(e,l,o.isFullyInitialized()||X(t),n.filter.filtersNodes())}}function El(n,e,t,r,i,s,o,l){let u=e.serverCache,c,d=o?n.filter:n.filter.getIndexedFilter();if(X(t))c=d.updateFullNode(u.getNode(),r,null);else if(d.filtersNodes()&&!u.isFiltered()){let y=u.getNode().updateChild(t,r);c=d.updateFullNode(u.getNode(),y,null)}else{let y=J(t);if(!u.isCompleteForPath(t)&&Fn(t)>1)return e;let C=me(t),D=u.getNode().getImmediateChild(y).updateChild(C,r);y===".priority"?c=d.updatePriority(u.getNode(),D):c=d.updateChild(u.getNode(),y,D,C,mv,null)}let p=uv(e,c,u.isFullyInitialized()||X(t),d.filtersNodes()),m=new to(i,p,s);return gv(n,p,t,i,m,l)}function Yh(n,e,t,r,i,s,o){let l=e.eventCache,u,c,d=new to(i,e,s);if(X(t))c=n.filter.updateFullNode(e.eventCache.getNode(),r,o),u=zs(e,c,!0,n.filter.filtersNodes());else{let p=J(t);if(p===".priority")c=n.filter.updatePriority(e.eventCache.getNode(),r),u=zs(e,c,l.isFullyInitialized(),l.isFiltered());else{let m=me(t),y=l.getNode().getImmediateChild(p),C;if(X(m))C=r;else{let x=d.getCompleteChild(p);x!=null?Td(m)===".priority"&&x.getChild(nv(m)).isEmpty()?C=x:C=x.updateChild(m,r):C=$.EMPTY_NODE}if(y.equals(C))u=e;else{let x=n.filter.updateChild(l.getNode(),p,C,m,d,o);u=zs(e,x,l.isFullyInitialized(),n.filter.filtersNodes())}}}return u}function Sy(n,e){return n.eventCache.isCompleteForChild(e)}function yC(n,e,t,r,i,s,o){let l=e;return r.foreach((u,c)=>{let d=Ee(t,u);Sy(e,J(d))&&(l=Yh(n,l,d,c,i,s,o))}),r.foreach((u,c)=>{let d=Ee(t,u);Sy(e,J(d))||(l=Yh(n,l,d,c,i,s,o))}),l}function Cy(n,e,t){return t.foreach((r,i)=>{e=e.updateChild(r,i)}),e}function Jh(n,e,t,r,i,s,o,l){if(e.serverCache.getNode().isEmpty()&&!e.serverCache.isFullyInitialized())return e;let u=e,c;X(t)?c=r:c=new st(null).setTree(t,r);let d=e.serverCache.getNode();return c.children.inorderTraversal((p,m)=>{if(d.hasChild(p)){let y=e.serverCache.getNode().getImmediateChild(p),C=Cy(n,y,m);u=El(n,u,new he(p),C,i,s,o,l)}}),c.children.inorderTraversal((p,m)=>{let y=!e.serverCache.isCompleteForChild(p)&&m.value===null;if(!d.hasChild(p)&&!y){let C=e.serverCache.getNode().getImmediateChild(p),x=Cy(n,C,m);u=El(n,u,new he(p),x,i,s,o,l)}}),u}function vC(n,e,t,r,i,s,o){if(wl(i,t)!=null)return e;let l=e.serverCache.isFiltered(),u=e.serverCache;if(r.value!=null){if(X(t)&&u.isFullyInitialized()||u.isCompleteForPath(t))return El(n,e,t,u.getNode().getChild(t),i,s,l,o);if(X(t)){let c=new st(null);return u.getNode().forEachChild(Gt,(d,p)=>{c=c.set(new he(d),p)}),Jh(n,e,t,c,i,s,l,o)}else return e}else{let c=new st(null);return r.foreach((d,p)=>{let m=Ee(t,d);u.isCompleteForPath(m)&&(c=c.set(d,u.getNode().getChild(m)))}),Jh(n,e,t,c,i,s,l,o)}}function wC(n,e,t,r,i){let s=e.serverCache,o=uv(e,s.getNode(),s.isFullyInitialized()||X(t),s.isFiltered());return gv(n,o,t,r,mv,i)}function EC(n,e,t,r,i,s){let o;if(wl(r,t)!=null)return e;{let l=new to(r,e,i),u=e.eventCache.getNode(),c;if(X(t)||J(t)===".priority"){let d;if(e.serverCache.isFullyInitialized())d=vl(r,_r(e));else{let p=e.serverCache.getNode();F(p instanceof $,"serverChildren would be complete if leaf node"),d=Nd(r,p)}d=d,c=n.filter.updateFullNode(u,d,s)}else{let d=J(t),p=Dd(r,d,e.serverCache);p==null&&e.serverCache.isCompleteForChild(d)&&(p=u.getImmediateChild(d)),p!=null?c=n.filter.updateChild(u,d,p,me(t),l,s):e.eventCache.getNode().hasChild(d)?c=n.filter.updateChild(u,d,$.EMPTY_NODE,me(t),l,s):c=u,c.isEmpty()&&e.serverCache.isFullyInitialized()&&(o=vl(r,_r(e)),o.isLeafNode()&&(c=n.filter.updateFullNode(c,o,s)))}return o=e.serverCache.isFullyInitialized()||wl(r,ce())!=null,zs(e,c,o,n.filter.filtersNodes())}}var Xh=class{constructor(e,t){this.query_=e,this.eventRegistrations_=[];let r=this.query_._queryParams,i=new Xs(r.getIndex()),s=GS(r);this.processor_=pC(s);let o=t.serverCache,l=t.eventCache,u=i.updateFullNode($.EMPTY_NODE,o.getNode(),null),c=s.updateFullNode($.EMPTY_NODE,l.getNode(),null),d=new zt(u,o.isFullyInitialized(),i.filtersNodes()),p=new zt(c,l.isFullyInitialized(),s.filtersNodes());this.viewCache_=Fl(p,d),this.eventGenerator_=new zh(this.query_)}get query(){return this.query_}};function IC(n){return n.viewCache_.serverCache.getNode()}function TC(n){return yl(n.viewCache_)}function SC(n,e){let t=_r(n.viewCache_);return t&&(n.query._queryParams.loadsAllData()||!X(e)&&!t.getImmediateChild(J(e)).isEmpty())?t.getChild(e):null}function Ay(n){return n.eventRegistrations_.length===0}function CC(n,e){n.eventRegistrations_.push(e)}function by(n,e,t){let r=[];if(t){F(e==null,"A cancel should cancel all event registrations.");let i=n.query._path;n.eventRegistrations_.forEach(s=>{let o=s.createCancelEvent(t,i);o&&r.push(o)})}if(e){let i=[];for(let s=0;s<n.eventRegistrations_.length;++s){let o=n.eventRegistrations_[s];if(!o.matches(e))i.push(o);else if(e.hasAnyCallback()){i=i.concat(n.eventRegistrations_.slice(s+1));break}}n.eventRegistrations_=i}else n.eventRegistrations_=[];return r}function Ry(n,e,t,r){e.type===qt.MERGE&&e.source.queryId!==null&&(F(_r(n.viewCache_),"We should always have a full cache before handling merges"),F(yl(n.viewCache_),"Missing event cache, even though we have a server cache"));let i=n.viewCache_,s=gC(n.processor_,i,e,t,r);return mC(n.processor_,s.viewCache),F(s.viewCache.serverCache.isFullyInitialized()||!i.serverCache.isFullyInitialized(),"Once a server snap is complete, it should never go back"),n.viewCache_=s.viewCache,_v(n,s.changes,s.viewCache.eventCache.getNode(),null)}function AC(n,e){let t=n.viewCache_.eventCache,r=[];return t.getNode().isLeafNode()||t.getNode().forEachChild(_e,(s,o)=>{r.push(di(s,o))}),t.isFullyInitialized()&&r.push(lv(t.getNode())),_v(n,r,t.getNode(),e)}function _v(n,e,t,r){let i=r?[r]:n.eventRegistrations_;return YS(n.eventGenerator_,e,t,i)}var Il,Tl=class{constructor(){this.views=new Map}};function bC(n){F(!Il,"__referenceConstructor has already been defined"),Il=n}function RC(){return F(Il,"Reference.ts has not been loaded"),Il}function PC(n){return n.views.size===0}function kd(n,e,t,r){let i=e.source.queryId;if(i!==null){let s=n.views.get(i);return F(s!=null,"SyncTree gave us an op for an invalid query."),Ry(s,e,t,r)}else{let s=[];for(let o of n.views.values())s=s.concat(Ry(o,e,t,r));return s}}function yv(n,e,t,r,i){let s=e._queryIdentifier,o=n.views.get(s);if(!o){let l=vl(t,i?r:null),u=!1;l?u=!0:r instanceof $?(l=Nd(t,r),u=!1):(l=$.EMPTY_NODE,u=!1);let c=Fl(new zt(l,u,!1),new zt(r,i,!1));return new Xh(e,c)}return o}function xC(n,e,t,r,i,s){let o=yv(n,e,r,i,s);return n.views.has(e._queryIdentifier)||n.views.set(e._queryIdentifier,o),CC(o,t),AC(o,t)}function NC(n,e,t,r){let i=e._queryIdentifier,s=[],o=[],l=On(n);if(i==="default")for(let[u,c]of n.views.entries())o=o.concat(by(c,t,r)),Ay(c)&&(n.views.delete(u),c.query._queryParams.loadsAllData()||s.push(c.query));else{let u=n.views.get(i);u&&(o=o.concat(by(u,t,r)),Ay(u)&&(n.views.delete(i),u.query._queryParams.loadsAllData()||s.push(u.query)))}return l&&!On(n)&&s.push(new(RC())(e._repo,e._path)),{removed:s,events:o}}function vv(n){let e=[];for(let t of n.views.values())t.query._queryParams.loadsAllData()||e.push(t);return e}function kn(n,e){let t=null;for(let r of n.views.values())t=t||SC(r,e);return t}function wv(n,e){if(e._queryParams.loadsAllData())return Ml(n);{let r=e._queryIdentifier;return n.views.get(r)}}function Ev(n,e){return wv(n,e)!=null}function On(n){return Ml(n)!=null}function Ml(n){for(let e of n.views.values())if(e.query._queryParams.loadsAllData())return e;return null}var Sl;function DC(n){F(!Sl,"__referenceConstructor has already been defined"),Sl=n}function kC(){return F(Sl,"Reference.ts has not been loaded"),Sl}var VC=1,Cl=class{constructor(e){this.listenProvider_=e,this.syncPointTree_=new st(null),this.pendingWriteTree_=dC(),this.tagToQueryMap=new Map,this.queryToTagMap=new Map}};function Vd(n,e,t,r,i){return eC(n.pendingWriteTree_,e,t,r,i),i?vi(n,new fi(Rd(),e,t)):[]}function FC(n,e,t,r){tC(n.pendingWriteTree_,e,t,r);let i=st.fromObject(t);return vi(n,new eo(Rd(),e,i))}function Nn(n,e,t=!1){let r=nC(n.pendingWriteTree_,e);if(rC(n.pendingWriteTree_,e)){let s=new st(null);return r.snap!=null?s=s.set(ce(),!0):je(r.children,o=>{s=s.set(new he(o),!0)}),vi(n,new jh(r.path,s,t))}else return[]}function co(n,e,t){return vi(n,new fi(Pd(),e,t))}function OC(n,e,t){let r=st.fromObject(t);return vi(n,new eo(Pd(),e,r))}function MC(n,e){return vi(n,new _l(Pd(),e))}function LC(n,e,t){let r=Fd(n,t);if(r){let i=Od(r),s=i.path,o=i.queryId,l=it(s,e),u=new _l(xd(o),l);return Md(n,s,u)}else return[]}function Al(n,e,t,r,i=!1){let s=e._path,o=n.syncPointTree_.get(s),l=[];if(o&&(e._queryIdentifier==="default"||Ev(o,e))){let u=NC(o,e,t,r);PC(o)&&(n.syncPointTree_=n.syncPointTree_.remove(s));let c=u.removed;if(l=u.events,!i){let d=c.findIndex(m=>m._queryParams.loadsAllData())!==-1,p=n.syncPointTree_.findOnPath(s,(m,y)=>On(y));if(d&&!p){let m=n.syncPointTree_.subtree(s);if(!m.isEmpty()){let y=qC(m);for(let C=0;C<y.length;++C){let x=y[C],D=x.query,q=Cv(n,x);n.listenProvider_.startListening(Ws(D),no(n,D),q.hashFn,q.onComplete)}}}!p&&c.length>0&&!r&&(d?n.listenProvider_.stopListening(Ws(e),null):c.forEach(m=>{let y=n.queryToTagMap.get(Ul(m));n.listenProvider_.stopListening(Ws(m),y)}))}GC(n,c)}return l}function Iv(n,e,t,r){let i=Fd(n,r);if(i!=null){let s=Od(i),o=s.path,l=s.queryId,u=it(o,e),c=new fi(xd(l),u,t);return Md(n,o,c)}else return[]}function UC(n,e,t,r){let i=Fd(n,r);if(i){let s=Od(i),o=s.path,l=s.queryId,u=it(o,e),c=st.fromObject(t),d=new eo(xd(l),u,c);return Md(n,o,d)}else return[]}function Zh(n,e,t,r=!1){let i=e._path,s=null,o=!1;n.syncPointTree_.foreachOnPath(i,(m,y)=>{let C=it(m,i);s=s||kn(y,C),o=o||On(y)});let l=n.syncPointTree_.get(i);l?(o=o||On(l),s=s||kn(l,ce())):(l=new Tl,n.syncPointTree_=n.syncPointTree_.set(i,l));let u;s!=null?u=!0:(u=!1,s=$.EMPTY_NODE,n.syncPointTree_.subtree(i).foreachChild((y,C)=>{let x=kn(C,ce());x&&(s=s.updateImmediateChild(y,x))}));let c=Ev(l,e);if(!c&&!e._queryParams.loadsAllData()){let m=Ul(e);F(!n.queryToTagMap.has(m),"View does not exist, but we have a tag");let y=jC();n.queryToTagMap.set(m,y),n.tagToQueryMap.set(y,m)}let d=Ol(n.pendingWriteTree_,i),p=xC(l,e,t,d,s,u);if(!c&&!o&&!r){let m=wv(l,e);p=p.concat(zC(n,e,m))}return p}function Ll(n,e,t){let i=n.pendingWriteTree_,s=n.syncPointTree_.findOnPath(e,(o,l)=>{let u=it(o,e),c=kn(l,u);if(c)return c});return dv(i,e,s,t,!0)}function BC(n,e){let t=e._path,r=null;n.syncPointTree_.foreachOnPath(t,(c,d)=>{let p=it(c,t);r=r||kn(d,p)});let i=n.syncPointTree_.get(t);i?r=r||kn(i,ce()):(i=new Tl,n.syncPointTree_=n.syncPointTree_.set(t,i));let s=r!=null,o=s?new zt(r,!0,!1):null,l=Ol(n.pendingWriteTree_,e._path),u=yv(i,e,l,s?o.getNode():$.EMPTY_NODE,s);return TC(u)}function vi(n,e){return Tv(e,n.syncPointTree_,null,Ol(n.pendingWriteTree_,ce()))}function Tv(n,e,t,r){if(X(n.path))return Sv(n,e,t,r);{let i=e.get(ce());t==null&&i!=null&&(t=kn(i,ce()));let s=[],o=J(n.path),l=n.operationForChild(o),u=e.children.get(o);if(u&&l){let c=t?t.getImmediateChild(o):null,d=fv(r,o);s=s.concat(Tv(l,u,c,d))}return i&&(s=s.concat(kd(i,n,r,t))),s}}function Sv(n,e,t,r){let i=e.get(ce());t==null&&i!=null&&(t=kn(i,ce()));let s=[];return e.children.inorderTraversal((o,l)=>{let u=t?t.getImmediateChild(o):null,c=fv(r,o),d=n.operationForChild(o);d&&(s=s.concat(Sv(d,l,u,c)))}),i&&(s=s.concat(kd(i,n,r,t))),s}function Cv(n,e){let t=e.query,r=no(n,t);return{hashFn:()=>(IC(e)||$.EMPTY_NODE).hash(),onComplete:i=>{if(i==="ok")return r?LC(n,t._path,r):MC(n,t._path);{let s=eS(i,t);return Al(n,t,null,s)}}}}function no(n,e){let t=Ul(e);return n.queryToTagMap.get(t)}function Ul(n){return n._path.toString()+"$"+n._queryIdentifier}function Fd(n,e){return n.tagToQueryMap.get(e)}function Od(n){let e=n.indexOf("$");return F(e!==-1&&e<n.length-1,"Bad queryKey."),{queryId:n.substr(e+1),path:new he(n.substr(0,e))}}function Md(n,e,t){let r=n.syncPointTree_.get(e);F(r,"Missing sync point for query tag that we're tracking");let i=Ol(n.pendingWriteTree_,e);return kd(r,t,i,null)}function qC(n){return n.fold((e,t,r)=>{if(t&&On(t))return[Ml(t)];{let i=[];return t&&(i=vv(t)),je(r,(s,o)=>{i=i.concat(o)}),i}})}function Ws(n){return n._queryParams.loadsAllData()&&!n._queryParams.isDefault()?new(kC())(n._repo,n._path):n}function GC(n,e){for(let t=0;t<e.length;++t){let r=e[t];if(!r._queryParams.loadsAllData()){let i=Ul(r),s=n.queryToTagMap.get(i);n.queryToTagMap.delete(i),n.tagToQueryMap.delete(s)}}}function jC(){return VC++}function zC(n,e,t){let r=e._path,i=no(n,e),s=Cv(n,t),o=n.listenProvider_.startListening(Ws(e),i,s.hashFn,s.onComplete),l=n.syncPointTree_.subtree(r);if(i)F(!On(l.value),"If we're adding a query, it shouldn't be shadowed");else{let u=l.fold((c,d,p)=>{if(!X(c)&&d&&On(d))return[Ml(d).query];{let m=[];return d&&(m=m.concat(vv(d).map(y=>y.query))),je(p,(y,C)=>{m=m.concat(C)}),m}});for(let c=0;c<u.length;++c){let d=u[c];n.listenProvider_.stopListening(Ws(d),no(n,d))}}return o}var ed=class n{constructor(e){this.node_=e}getImmediateChild(e){let t=this.node_.getImmediateChild(e);return new n(t)}node(){return this.node_}},td=class n{constructor(e,t){this.syncTree_=e,this.path_=t}getImmediateChild(e){let t=Ee(this.path_,e);return new n(this.syncTree_,t)}node(){return Ll(this.syncTree_,this.path_)}},KC=function(n){return n=n||{},n.timestamp=n.timestamp||new Date().getTime(),n},Py=function(n,e,t){if(!n||typeof n!="object")return n;if(F(".sv"in n,"Unexpected leaf node or priority contents"),typeof n[".sv"]=="string")return WC(n[".sv"],e,t);if(typeof n[".sv"]=="object")return QC(n[".sv"],e);F(!1,"Unexpected server value: "+JSON.stringify(n,null,2))},WC=function(n,e,t){switch(n){case"timestamp":return t.timestamp;default:F(!1,"Unexpected server value: "+n)}},QC=function(n,e,t){n.hasOwnProperty("increment")||F(!1,"Unexpected server value: "+JSON.stringify(n,null,2));let r=n.increment;typeof r!="number"&&F(!1,"Unexpected increment value: "+r);let i=e.node();if(F(i!==null&&typeof i<"u","Expected ChildrenNode.EMPTY_NODE for nulls"),!i.isLeafNode())return r;let o=i.getValue();return typeof o!="number"?r:o+r},Av=function(n,e,t,r){return Ud(e,new td(t,n),r)},Ld=function(n,e,t){return Ud(n,new ed(e),t)};function Ud(n,e,t){let r=n.getPriority().val(),i=Py(r,e.getImmediateChild(".priority"),t),s;if(n.isLeafNode()){let o=n,l=Py(o.getValue(),e,t);return l!==o.getValue()||i!==o.getPriority().val()?new ci(l,Te(i)):n}else{let o=n;return s=o,i!==o.getPriority().val()&&(s=s.updatePriority(new ci(i))),o.forEachChild(_e,(l,u)=>{let c=Ud(u,e.getImmediateChild(l),t);c!==u&&(s=s.updateImmediateChild(l,c))}),s}}var ro=class{constructor(e="",t=null,r={children:{},childCount:0}){this.name=e,this.parent=t,this.node=r}};function Bl(n,e){let t=e instanceof he?e:new he(e),r=n,i=J(t);for(;i!==null;){let s=Pn(r.node.children,i)||{children:{},childCount:0};r=new ro(i,r,s),t=me(t),i=J(t)}return r}function wr(n){return n.node.value}function Bd(n,e){n.node.value=e,nd(n)}function bv(n){return n.node.childCount>0}function $C(n){return wr(n)===void 0&&!bv(n)}function ql(n,e){je(n.node.children,(t,r)=>{e(new ro(t,n,r))})}function Rv(n,e,t,r){t&&!r&&e(n),ql(n,i=>{Rv(i,e,!0,r)}),t&&r&&e(n)}function HC(n,e,t){let r=t?n:n.parent;for(;r!==null;){if(e(r))return!0;r=r.parent}return!1}function ho(n){return new he(n.parent===null?n.name:ho(n.parent)+"/"+n.name)}function nd(n){n.parent!==null&&YC(n.parent,n.name,n)}function YC(n,e,t){let r=$C(t),i=wt(n.node.children,e);r&&i?(delete n.node.children[e],n.node.childCount--,nd(n)):!r&&!i&&(n.node.children[e]=t.node,n.node.childCount++,nd(n))}var JC=/[\[\].#$\/\u0000-\u001F\u007F]/,XC=/[\[\].#$\u0000-\u001F\u007F]/,fh=10*1024*1024,Gl=function(n){return typeof n=="string"&&n.length!==0&&!JC.test(n)},Pv=function(n){return typeof n=="string"&&n.length!==0&&!XC.test(n)},ZC=function(n){return n&&(n=n.replace(/^\/*\.info(\/|$)/,"/")),Pv(n)},io=function(n){return n===null||typeof n=="string"||typeof n=="number"&&!kl(n)||n&&typeof n=="object"&&wt(n,".sv")},Kt=function(n,e,t,r){r&&e===void 0||fo(ct(n,"value"),e,t)},fo=function(n,e,t){let r=t instanceof he?new Ah(t,n):t;if(e===void 0)throw new Error(n+"contains undefined "+pr(r));if(typeof e=="function")throw new Error(n+"contains a function "+pr(r)+" with contents = "+e.toString());if(kl(e))throw new Error(n+"contains "+e.toString()+" "+pr(r));if(typeof e=="string"&&e.length>fh/3&&Ms(e)>fh)throw new Error(n+"contains a string greater than "+fh+" utf8 bytes "+pr(r)+" ('"+e.substring(0,50)+"...')");if(e&&typeof e=="object"){let i=!1,s=!1;if(je(e,(o,l)=>{if(o===".value")i=!0;else if(o!==".priority"&&o!==".sv"&&(s=!0,!Gl(o)))throw new Error(n+" contains an invalid key ("+o+") "+pr(r)+`.  Keys must be non-empty strings and can't contain ".", "#", "$", "/", "[", or "]"`);PS(r,o),fo(n,l,r),xS(r)}),i&&s)throw new Error(n+' contains ".value" child '+pr(r)+" in addition to actual children.")}},eA=function(n,e){let t,r;for(t=0;t<e.length;t++){r=e[t];let s=$s(r);for(let o=0;o<s.length;o++)if(!(s[o]===".priority"&&o===s.length-1)){if(!Gl(s[o]))throw new Error(n+"contains an invalid key ("+s[o]+") in path "+r.toString()+`. Keys must be non-empty strings and can't contain ".", "#", "$", "/", "[", or "]"`)}}e.sort(RS);let i=null;for(t=0;t<e.length;t++){if(r=e[t],i!==null&&It(i,r))throw new Error(n+"contains a path "+i.toString()+" that is ancestor of another path "+r.toString());i=r}},xv=function(n,e,t,r){if(r&&e===void 0)return;let i=ct(n,"values");if(!(e&&typeof e=="object")||Array.isArray(e))throw new Error(i+" must be an object containing the children to replace.");let s=[];je(e,(o,l)=>{let u=new he(o);if(fo(i,l,Ee(t,u)),Td(u)===".priority"&&!io(l))throw new Error(i+"contains an invalid value for '"+u.toString()+"', which must be a valid Firebase priority (a string, finite number, server value, or null).");s.push(u)}),eA(i,s)},qd=function(n,e,t){if(!(t&&e===void 0)){if(kl(e))throw new Error(ct(n,"priority")+"is "+e.toString()+", but must be a valid Firebase priority (a string, finite number, server value, or null).");if(!io(e))throw new Error(ct(n,"priority")+"must be a valid Firebase priority (a string, finite number, server value, or null).")}},po=function(n,e,t,r){if(!(r&&t===void 0)&&!Gl(t))throw new Error(ct(n,e)+'was an invalid key = "'+t+`".  Firebase keys must be non-empty strings and can't contain ".", "#", "$", "/", "[", or "]").`)},wi=function(n,e,t,r){if(!(r&&t===void 0)&&!Pv(t))throw new Error(ct(n,e)+'was an invalid path = "'+t+`". Paths must be non-empty strings and can't contain ".", "#", "$", "[", or "]"`)},tA=function(n,e,t,r){t&&(t=t.replace(/^\/*\.info(\/|$)/,"/")),wi(n,e,t,r)},ft=function(n,e){if(J(e)===".info")throw new Error(n+" failed = Can't modify data under /.info/")},Nv=function(n,e){let t=e.path.toString();if(typeof e.repoInfo.host!="string"||e.repoInfo.host.length===0||!Gl(e.repoInfo.namespace)&&e.repoInfo.host.split(":")[0]!=="localhost"||t.length!==0&&!ZC(t))throw new Error(ct(n,"url")+`must be a valid firebase URL and the path can't contain ".", "#", "$", "[", or "]".`)};var rd=class{constructor(){this.eventLists_=[],this.recursionDepth_=0}};function jl(n,e){let t=null;for(let r=0;r<e.length;r++){let i=e[r],s=i.getPath();t!==null&&!Sd(s,t.path)&&(n.eventLists_.push(t),t=null),t===null&&(t={events:[],path:s}),t.events.push(i)}t&&n.eventLists_.push(t)}function Dv(n,e,t){jl(n,t),kv(n,r=>Sd(r,e))}function pt(n,e,t){jl(n,t),kv(n,r=>It(r,e)||It(e,r))}function kv(n,e){n.recursionDepth_++;let t=!0;for(let r=0;r<n.eventLists_.length;r++){let i=n.eventLists_[r];if(i){let s=i.path;e(s)?(nA(n.eventLists_[r]),n.eventLists_[r]=null):t=!1}}t&&(n.eventLists_=[]),n.recursionDepth_--}function nA(n){for(let e=0;e<n.events.length;e++){let t=n.events[e];if(t!==null){n.events[e]=null;let r=t.getEventRunner();gr&&Ge("event: "+t.toString()),_i(r)}}}var Vv="repo_interrupt",rA=25,id=class{constructor(e,t,r,i){this.repoInfo_=e,this.forceRestClient_=t,this.authTokenProvider_=r,this.appCheckProvider_=i,this.dataUpdateCount=0,this.statsListener_=null,this.eventQueue_=new rd,this.nextWriteId_=1,this.interceptServerDataCallback_=null,this.onDisconnect_=gl(),this.transactionQueueTree_=new ro,this.persistentConnection_=null,this.key=this.repoInfo_.toURLString()}toString(){return(this.repoInfo_.secure?"https://":"http://")+this.repoInfo_.host}};function iA(n,e,t){if(n.stats_=Id(n.repoInfo_),n.forceRestClient_||iS())n.server_=new Mh(n.repoInfo_,(r,i,s,o)=>{xy(n,r,i,s,o)},n.authTokenProvider_,n.appCheckProvider_),setTimeout(()=>Ny(n,!0),0);else{if(typeof t<"u"&&t!==null){if(typeof t!="object")throw new Error("Only objects are supported for option databaseAuthVariableOverride");try{ke(t)}catch(r){throw new Error("Invalid authOverride provided: "+r)}}n.persistentConnection_=new Cd(n.repoInfo_,e,(r,i,s,o)=>{xy(n,r,i,s,o)},r=>{Ny(n,r)},r=>{sA(n,r)},n.authTokenProvider_,n.appCheckProvider_,t),n.server_=n.persistentConnection_}n.authTokenProvider_.addTokenChangeListener(r=>{n.server_.refreshAuthToken(r)}),n.appCheckProvider_.addTokenChangeListener(r=>{n.server_.refreshAppCheckToken(r.token)}),n.statsReporter_=oS(n.repoInfo_,()=>new Gh(n.stats_,n.server_)),n.infoData_=new Lh,n.infoSyncTree_=new Cl({startListening:(r,i,s,o)=>{let l=[],u=n.infoData_.getNode(r._path);return u.isEmpty()||(l=co(n.infoSyncTree_,r._path,u),setTimeout(()=>{o("ok")},0)),l},stopListening:()=>{}}),Gd(n,"connected",!1),n.serverSyncTree_=new Cl({startListening:(r,i,s,o)=>(n.server_.listen(r,s,i,(l,u)=>{let c=o(l,u);pt(n.eventQueue_,r._path,c)}),[]),stopListening:(r,i)=>{n.server_.unlisten(r,i)}})}function Fv(n){let t=n.infoData_.getNode(new he(".info/serverTimeOffset")).val()||0;return new Date().getTime()+t}function mo(n){return KC({timestamp:Fv(n)})}function xy(n,e,t,r,i){n.dataUpdateCount++;let s=new he(e);t=n.interceptServerDataCallback_?n.interceptServerDataCallback_(e,t):t;let o=[];if(i)if(r){let u=Os(t,c=>Te(c));o=UC(n.serverSyncTree_,s,u,i)}else{let u=Te(t);o=Iv(n.serverSyncTree_,s,u,i)}else if(r){let u=Os(t,c=>Te(c));o=OC(n.serverSyncTree_,s,u)}else{let u=Te(t);o=co(n.serverSyncTree_,s,u)}let l=s;o.length>0&&(l=mi(n,s)),pt(n.eventQueue_,l,o)}function Ny(n,e){Gd(n,"connected",e),e===!1&&lA(n)}function sA(n,e){je(e,(t,r)=>{Gd(n,t,r)})}function Gd(n,e,t){let r=new he("/.info/"+e),i=Te(t);n.infoData_.updateSnapshot(r,i);let s=co(n.infoSyncTree_,r,i);pt(n.eventQueue_,r,s)}function zl(n){return n.nextWriteId_++}function oA(n,e,t){let r=BC(n.serverSyncTree_,e);return r!=null?Promise.resolve(r):n.server_.get(e).then(i=>{let s=Te(i).withIndex(e._queryParams.getIndex());Zh(n.serverSyncTree_,e,t,!0);let o;if(e._queryParams.loadsAllData())o=co(n.serverSyncTree_,e._path,s);else{let l=no(n.serverSyncTree_,e);o=Iv(n.serverSyncTree_,e._path,s,l)}return pt(n.eventQueue_,e._path,o),Al(n.serverSyncTree_,e,t,null,!0),s},i=>(Ei(n,"get for query "+ke(e)+" failed: "+i),Promise.reject(new Error(i))))}function jd(n,e,t,r,i){Ei(n,"set",{path:e.toString(),value:t,priority:r});let s=mo(n),o=Te(t,r),l=Ll(n.serverSyncTree_,e),u=Ld(o,l,s),c=zl(n),d=Vd(n.serverSyncTree_,e,u,c,!0);jl(n.eventQueue_,d),n.server_.put(e.toString(),o.val(!0),(m,y)=>{let C=m==="ok";C||Xe("set at "+e+" failed: "+m);let x=Nn(n.serverSyncTree_,c,!C);pt(n.eventQueue_,e,x),Mn(n,i,m,y)});let p=Kd(n,e);mi(n,p),pt(n.eventQueue_,p,[])}function aA(n,e,t,r){Ei(n,"update",{path:e.toString(),value:t});let i=!0,s=mo(n),o={};if(je(t,(l,u)=>{i=!1,o[l]=Av(Ee(e,l),Te(u),n.serverSyncTree_,s)}),i)Ge("update() called with empty data.  Don't do anything."),Mn(n,r,"ok",void 0);else{let l=zl(n),u=FC(n.serverSyncTree_,e,o,l);jl(n.eventQueue_,u),n.server_.merge(e.toString(),t,(c,d)=>{let p=c==="ok";p||Xe("update at "+e+" failed: "+c);let m=Nn(n.serverSyncTree_,l,!p),y=m.length>0?mi(n,e):e;pt(n.eventQueue_,y,m),Mn(n,r,c,d)}),je(t,c=>{let d=Kd(n,Ee(e,c));mi(n,d)}),pt(n.eventQueue_,e,[])}}function lA(n){Ei(n,"onDisconnectEvents");let e=mo(n),t=gl();Bh(n.onDisconnect_,ce(),(i,s)=>{let o=Av(i,s,n.serverSyncTree_,e);yi(t,i,o)});let r=[];Bh(t,ce(),(i,s)=>{r=r.concat(co(n.serverSyncTree_,i,s));let o=Kd(n,i);mi(n,o)}),n.onDisconnect_=gl(),pt(n.eventQueue_,ce(),r)}function uA(n,e,t){n.server_.onDisconnectCancel(e.toString(),(r,i)=>{r==="ok"&&Uh(n.onDisconnect_,e),Mn(n,t,r,i)})}function Dy(n,e,t,r){let i=Te(t);n.server_.onDisconnectPut(e.toString(),i.val(!0),(s,o)=>{s==="ok"&&yi(n.onDisconnect_,e,i),Mn(n,r,s,o)})}function cA(n,e,t,r,i){let s=Te(t,r);n.server_.onDisconnectPut(e.toString(),s.val(!0),(o,l)=>{o==="ok"&&yi(n.onDisconnect_,e,s),Mn(n,i,o,l)})}function hA(n,e,t,r){if(Ba(t)){Ge("onDisconnect().update() called with empty data.  Don't do anything."),Mn(n,r,"ok",void 0);return}n.server_.onDisconnectMerge(e.toString(),t,(i,s)=>{i==="ok"&&je(t,(o,l)=>{let u=Te(l);yi(n.onDisconnect_,Ee(e,o),u)}),Mn(n,r,i,s)})}function dA(n,e,t){let r;J(e._path)===".info"?r=Zh(n.infoSyncTree_,e,t):r=Zh(n.serverSyncTree_,e,t),Dv(n.eventQueue_,e._path,r)}function sd(n,e,t){let r;J(e._path)===".info"?r=Al(n.infoSyncTree_,e,t):r=Al(n.serverSyncTree_,e,t),Dv(n.eventQueue_,e._path,r)}function Ov(n){n.persistentConnection_&&n.persistentConnection_.interrupt(Vv)}function fA(n){n.persistentConnection_&&n.persistentConnection_.resume(Vv)}function Ei(n,...e){let t="";n.persistentConnection_&&(t=n.persistentConnection_.id+":"),Ge(t,...e)}function Mn(n,e,t,r){e&&_i(()=>{if(t==="ok")e(null);else{let i=(t||"error").toUpperCase(),s=i;r&&(s+=": "+r);let o=new Error(s);o.code=i,e(o)}})}function pA(n,e,t,r,i,s){Ei(n,"transaction on "+e);let o={path:e,update:t,onComplete:r,status:null,order:Fy(),applyLocally:s,retryCount:0,unwatcher:i,abortReason:null,currentWriteId:null,currentInputSnapshot:null,currentOutputSnapshotRaw:null,currentOutputSnapshotResolved:null},l=zd(n,e,void 0);o.currentInputSnapshot=l;let u=o.update(l.val());if(u===void 0)o.unwatcher(),o.currentOutputSnapshotRaw=null,o.currentOutputSnapshotResolved=null,o.onComplete&&o.onComplete(null,!1,o.currentInputSnapshot);else{fo("transaction failed: Data returned ",u,o.path),o.status=0;let c=Bl(n.transactionQueueTree_,e),d=wr(c)||[];d.push(o),Bd(c,d);let p;typeof u=="object"&&u!==null&&wt(u,".priority")?(p=Pn(u,".priority"),F(io(p),"Invalid priority returned by transaction. Priority must be a valid string, finite number, server value, or null.")):p=(Ll(n.serverSyncTree_,e)||$.EMPTY_NODE).getPriority().val();let m=mo(n),y=Te(u,p),C=Ld(y,l,m);o.currentOutputSnapshotRaw=y,o.currentOutputSnapshotResolved=C,o.currentWriteId=zl(n);let x=Vd(n.serverSyncTree_,e,C,o.currentWriteId,o.applyLocally);pt(n.eventQueue_,e,x),Kl(n,n.transactionQueueTree_)}}function zd(n,e,t){return Ll(n.serverSyncTree_,e,t)||$.EMPTY_NODE}function Kl(n,e=n.transactionQueueTree_){if(e||Wl(n,e),wr(e)){let t=Lv(n,e);F(t.length>0,"Sending zero length transaction queue"),t.every(i=>i.status===0)&&mA(n,ho(e),t)}else bv(e)&&ql(e,t=>{Kl(n,t)})}function mA(n,e,t){let r=t.map(c=>c.currentWriteId),i=zd(n,e,r),s=i,o=i.hash();for(let c=0;c<t.length;c++){let d=t[c];F(d.status===0,"tryToSendTransactionQueue_: items in queue should all be run."),d.status=1,d.retryCount++;let p=it(e,d.path);s=s.updateChild(p,d.currentOutputSnapshotRaw)}let l=s.val(!0),u=e;n.server_.put(u.toString(),l,c=>{Ei(n,"transaction put response",{path:u.toString(),status:c});let d=[];if(c==="ok"){let p=[];for(let m=0;m<t.length;m++)t[m].status=2,d=d.concat(Nn(n.serverSyncTree_,t[m].currentWriteId)),t[m].onComplete&&p.push(()=>t[m].onComplete(null,!0,t[m].currentOutputSnapshotResolved)),t[m].unwatcher();Wl(n,Bl(n.transactionQueueTree_,e)),Kl(n,n.transactionQueueTree_),pt(n.eventQueue_,e,d);for(let m=0;m<p.length;m++)_i(p[m])}else{if(c==="datastale")for(let p=0;p<t.length;p++)t[p].status===3?t[p].status=4:t[p].status=0;else{Xe("transaction at "+u.toString()+" failed: "+c);for(let p=0;p<t.length;p++)t[p].status=4,t[p].abortReason=c}mi(n,e)}},o)}function mi(n,e){let t=Mv(n,e),r=ho(t),i=Lv(n,t);return gA(n,i,r),r}function gA(n,e,t){if(e.length===0)return;let r=[],i=[],o=e.filter(l=>l.status===0).map(l=>l.currentWriteId);for(let l=0;l<e.length;l++){let u=e[l],c=it(t,u.path),d=!1,p;if(F(c!==null,"rerunTransactionsUnderNode_: relativePath should not be null."),u.status===4)d=!0,p=u.abortReason,i=i.concat(Nn(n.serverSyncTree_,u.currentWriteId,!0));else if(u.status===0)if(u.retryCount>=rA)d=!0,p="maxretry",i=i.concat(Nn(n.serverSyncTree_,u.currentWriteId,!0));else{let m=zd(n,u.path,o);u.currentInputSnapshot=m;let y=e[l].update(m.val());if(y!==void 0){fo("transaction failed: Data returned ",y,u.path);let C=Te(y);typeof y=="object"&&y!=null&&wt(y,".priority")||(C=C.updatePriority(m.getPriority()));let D=u.currentWriteId,q=mo(n),j=Ld(C,m,q);u.currentOutputSnapshotRaw=C,u.currentOutputSnapshotResolved=j,u.currentWriteId=zl(n),o.splice(o.indexOf(D),1),i=i.concat(Vd(n.serverSyncTree_,u.path,j,u.currentWriteId,u.applyLocally)),i=i.concat(Nn(n.serverSyncTree_,D,!0))}else d=!0,p="nodata",i=i.concat(Nn(n.serverSyncTree_,u.currentWriteId,!0))}pt(n.eventQueue_,t,i),i=[],d&&(e[l].status=2,function(m){setTimeout(m,Math.floor(0))}(e[l].unwatcher),e[l].onComplete&&(p==="nodata"?r.push(()=>e[l].onComplete(null,!1,e[l].currentInputSnapshot)):r.push(()=>e[l].onComplete(new Error(p),!1,null))))}Wl(n,n.transactionQueueTree_);for(let l=0;l<r.length;l++)_i(r[l]);Kl(n,n.transactionQueueTree_)}function Mv(n,e){let t,r=n.transactionQueueTree_;for(t=J(e);t!==null&&wr(r)===void 0;)r=Bl(r,t),e=me(e),t=J(e);return r}function Lv(n,e){let t=[];return Uv(n,e,t),t.sort((r,i)=>r.order-i.order),t}function Uv(n,e,t){let r=wr(e);if(r)for(let i=0;i<r.length;i++)t.push(r[i]);ql(e,i=>{Uv(n,i,t)})}function Wl(n,e){let t=wr(e);if(t){let r=0;for(let i=0;i<t.length;i++)t[i].status!==2&&(t[r]=t[i],r++);t.length=r,Bd(e,t.length>0?t:void 0)}ql(e,r=>{Wl(n,r)})}function Kd(n,e){let t=ho(Mv(n,e)),r=Bl(n.transactionQueueTree_,e);return HC(r,i=>{ph(n,i)}),ph(n,r),Rv(r,i=>{ph(n,i)}),t}function ph(n,e){let t=wr(e);if(t){let r=[],i=[],s=-1;for(let o=0;o<t.length;o++)t[o].status===3||(t[o].status===1?(F(s===o-1,"All SENT items should be at beginning of queue."),s=o,t[o].status=3,t[o].abortReason="set"):(F(t[o].status===0,"Unexpected transaction status in abort"),t[o].unwatcher(),i=i.concat(Nn(n.serverSyncTree_,t[o].currentWriteId,!0)),t[o].onComplete&&r.push(t[o].onComplete.bind(null,new Error("set"),!1,null))));s===-1?Bd(e,void 0):t.length=s+1,pt(n.eventQueue_,ho(e),i);for(let o=0;o<r.length;o++)_i(r[o])}}function _A(n){let e="",t=n.split("/");for(let r=0;r<t.length;r++)if(t[r].length>0){let i=t[r];try{i=decodeURIComponent(i.replace(/\+/g," "))}catch{}e+="/"+i}return e}function yA(n){let e={};n.charAt(0)==="?"&&(n=n.substring(1));for(let t of n.split("&")){if(t.length===0)continue;let r=t.split("=");r.length===2?e[decodeURIComponent(r[0])]=decodeURIComponent(r[1]):Xe(`Invalid query segment '${t}' in query '${n}'`)}return e}var od=function(n,e){let t=vA(n),r=t.namespace;t.domain==="firebase.com"&&jt(t.host+" is no longer supported. Please use <YOUR FIREBASE>.firebaseio.com instead"),(!r||r==="undefined")&&t.domain!=="localhost"&&jt("Cannot parse Firebase url. Please use https://<YOUR FIREBASE>.firebaseio.com"),t.secure||H0();let i=t.scheme==="ws"||t.scheme==="wss";return{repoInfo:new ll(t.host,t.secure,r,i,e,"",r!==t.subdomain),path:new he(t.pathString)}},vA=function(n){let e="",t="",r="",i="",s="",o=!0,l="https",u=443;if(typeof n=="string"){let c=n.indexOf("//");c>=0&&(l=n.substring(0,c-1),n=n.substring(c+2));let d=n.indexOf("/");d===-1&&(d=n.length);let p=n.indexOf("?");p===-1&&(p=n.length),e=n.substring(0,Math.min(d,p)),d<p&&(i=_A(n.substring(d,p)));let m=yA(n.substring(Math.min(n.length,p)));c=e.indexOf(":"),c>=0?(o=l==="https"||l==="wss",u=parseInt(e.substring(c+1),10)):c=e.length;let y=e.slice(0,c);if(y.toLowerCase()==="localhost")t="localhost";else if(y.split(".").length<=2)t=y;else{let C=e.indexOf(".");r=e.substring(0,C).toLowerCase(),t=e.substring(C+1),s=r}"ns"in m&&(s=m.ns)}return{host:e,port:u,domain:t,subdomain:r,secure:o,scheme:l,pathString:i,namespace:s}};var ky="-0123456789ABCDEFGHIJKLMNOPQRSTUVWXYZ_abcdefghijklmnopqrstuvwxyz",wA=function(){let n=0,e=[];return function(t){let r=t===n;n=t;let i,s=new Array(8);for(i=7;i>=0;i--)s[i]=ky.charAt(t%64),t=Math.floor(t/64);F(t===0,"Cannot push at time == 0");let o=s.join("");if(r){for(i=11;i>=0&&e[i]===63;i--)e[i]=0;e[i]++}else for(i=0;i<12;i++)e[i]=Math.floor(Math.random()*64);for(i=0;i<12;i++)o+=ky.charAt(e[i]);return F(o.length===20,"nextPushId: Length should be 20."),o}}();var bl=class{constructor(e,t,r,i){this.eventType=e,this.eventRegistration=t,this.snapshot=r,this.prevName=i}getPath(){let e=this.snapshot.ref;return this.eventType==="value"?e._path:e.parent._path}getEventType(){return this.eventType}getEventRunner(){return this.eventRegistration.getEventRunner(this)}toString(){return this.getPath().toString()+":"+this.eventType+":"+ke(this.snapshot.exportVal())}},Rl=class{constructor(e,t,r){this.eventRegistration=e,this.error=t,this.path=r}getPath(){return this.path}getEventType(){return"cancel"}getEventRunner(){return this.eventRegistration.getEventRunner(this)}toString(){return this.path.toString()+":cancel"}};var so=class{constructor(e,t){this.snapshotCallback=e,this.cancelCallback=t}onValue(e,t){this.snapshotCallback.call(null,e,t)}onCancel(e){return F(this.hasCancelCallback,"Raising a cancel event on a listener with no cancel callback"),this.cancelCallback.call(null,e)}get hasCancelCallback(){return!!this.cancelCallback}matches(e){return this.snapshotCallback===e.snapshotCallback||this.snapshotCallback.userCallback!==void 0&&this.snapshotCallback.userCallback===e.snapshotCallback.userCallback&&this.snapshotCallback.context===e.snapshotCallback.context}};var Pl=class{constructor(e,t){this._repo=e,this._path=t}cancel(){let e=new rt;return uA(this._repo,this._path,e.wrapCallback(()=>{})),e.promise}remove(){ft("OnDisconnect.remove",this._path);let e=new rt;return Dy(this._repo,this._path,null,e.wrapCallback(()=>{})),e.promise}set(e){ft("OnDisconnect.set",this._path),Kt("OnDisconnect.set",e,this._path,!1);let t=new rt;return Dy(this._repo,this._path,e,t.wrapCallback(()=>{})),t.promise}setWithPriority(e,t){ft("OnDisconnect.setWithPriority",this._path),Kt("OnDisconnect.setWithPriority",e,this._path,!1),qd("OnDisconnect.setWithPriority",t,!1);let r=new rt;return cA(this._repo,this._path,e,t,r.wrapCallback(()=>{})),r.promise}update(e){ft("OnDisconnect.update",this._path),xv("OnDisconnect.update",e,this._path,!1);let t=new rt;return hA(this._repo,this._path,e,t.wrapCallback(()=>{})),t.promise}};var ot=class n{constructor(e,t,r,i){this._repo=e,this._path=t,this._queryParams=r,this._orderByCalled=i}get key(){return X(this._path)?null:Td(this._path)}get ref(){return new mt(this._repo,this._path)}get _queryIdentifier(){let e=vy(this._queryParams),t=Ed(e);return t==="{}"?"default":t}get _queryObject(){return vy(this._queryParams)}isEqual(e){if(e=te(e),!(e instanceof n))return!1;let t=this._repo===e._repo,r=Sd(this._path,e._path),i=this._queryIdentifier===e._queryIdentifier;return t&&r&&i}toJSON(){return this.toString()}toString(){return this._repo.toString()+bS(this._path)}};function Ql(n,e){if(n._orderByCalled===!0)throw new Error(e+": You can't combine multiple orderBy calls.")}function Un(n){let e=null,t=null;if(n.hasStart()&&(e=n.getIndexStartValue()),n.hasEnd()&&(t=n.getIndexEndValue()),n.getIndex()===Gt){let r="Query: When ordering by key, you may only pass one argument to startAt(), endAt(), or equalTo().",i="Query: When ordering by key, the argument passed to startAt(), startAfter(), endAt(), endBefore(), or equalTo() must be a string.";if(n.hasStart()){if(n.getIndexStartName()!==Vn)throw new Error(r);if(typeof e!="string")throw new Error(i)}if(n.hasEnd()){if(n.getIndexEndName()!==un)throw new Error(r);if(typeof t!="string")throw new Error(i)}}else if(n.getIndex()===_e){if(e!=null&&!io(e)||t!=null&&!io(t))throw new Error("Query: When ordering by priority, the first argument passed to startAt(), startAfter() endAt(), endBefore(), or equalTo() must be a valid priority value (null, a number, or a string).")}else if(F(n.getIndex()instanceof Hs||n.getIndex()===bd,"unknown index type."),e!=null&&typeof e=="object"||t!=null&&typeof t=="object")throw new Error("Query: First argument passed to startAt(), startAfter(), endAt(), endBefore(), or equalTo() cannot be an object.")}function $l(n){if(n.hasStart()&&n.hasEnd()&&n.hasLimit()&&!n.hasAnchoredLimit())throw new Error("Query: Can't combine startAt(), startAfter(), endAt(), endBefore(), and limit(). Use limitToFirst() or limitToLast() instead.")}var mt=class n extends ot{constructor(e,t){super(e,t,new Zs,!1)}get parent(){let e=nv(this._path);return e===null?null:new n(this._repo,e)}get root(){let e=this;for(;e.parent!==null;)e=e.parent;return e}},gi=class n{constructor(e,t,r){this._node=e,this.ref=t,this._index=r}get priority(){return this._node.getPriority().val()}get key(){return this.ref.key}get size(){return this._node.numChildren()}child(e){let t=new he(e),r=Ln(this.ref,e);return new n(this._node.getChild(t),r,_e)}exists(){return!this._node.isEmpty()}exportVal(){return this._node.val(!0)}forEach(e){return this._node.isLeafNode()?!1:!!this._node.forEachChild(this._index,(r,i)=>e(new n(i,Ln(this.ref,r),_e)))}hasChild(e){let t=new he(e);return!this._node.getChild(t).isEmpty()}hasChildren(){return this._node.isLeafNode()?!1:!this._node.isEmpty()}toJSON(){return this.exportVal()}val(){return this._node.val()}};function Wd(n,e){return n=te(n),n._checkNotDeleted("ref"),e!==void 0?Ln(n._root,e):n._root}function Qd(n,e){n=te(n),n._checkNotDeleted("refFromURL");let t=od(e,n._repo.repoInfo_.nodeAdmin);Nv("refFromURL",t);let r=t.repoInfo;return!n._repo.repoInfo_.isCustomHost()&&r.host!==n._repo.repoInfo_.host&&jt("refFromURL: Host name does not match the current database: (found "+r.host+" but expected "+n._repo.repoInfo_.host+")"),Wd(n,t.path.toString())}function Ln(n,e){return n=te(n),J(n._path)===null?tA("child","path",e,!1):wi("child","path",e,!1),new mt(n._repo,Ee(n._path,e))}function Bv(n,e){n=te(n),ft("push",n._path),Kt("push",e,n._path,!0);let t=Fv(n._repo),r=wA(t),i=Ln(n,r),s=Ln(n,r),o;return e!=null?o=Hl(s,e).then(()=>s):o=Promise.resolve(s),i.then=o.then.bind(o),i.catch=o.then.bind(o,void 0),i}function qv(n){return ft("remove",n._path),Hl(n,null)}function Hl(n,e){n=te(n),ft("set",n._path),Kt("set",e,n._path,!1);let t=new rt;return jd(n._repo,n._path,e,null,t.wrapCallback(()=>{})),t.promise}function Gv(n,e){n=te(n),ft("setPriority",n._path),qd("setPriority",e,!1);let t=new rt;return jd(n._repo,Ee(n._path,".priority"),e,null,t.wrapCallback(()=>{})),t.promise}function jv(n,e,t){if(ft("setWithPriority",n._path),Kt("setWithPriority",e,n._path,!1),qd("setWithPriority",t,!1),n.key===".length"||n.key===".keys")throw"setWithPriority failed: "+n.key+" is a read-only object.";let r=new rt;return jd(n._repo,n._path,e,t,r.wrapCallback(()=>{})),r.promise}function zv(n,e){xv("update",e,n._path,!1);let t=new rt;return aA(n._repo,n._path,e,t.wrapCallback(()=>{})),t.promise}function Kv(n){n=te(n);let e=new so(()=>{}),t=new oo(e);return oA(n._repo,n,t).then(r=>new gi(r,new mt(n._repo,n._path),n._queryParams.getIndex()))}var oo=class n{constructor(e){this.callbackContext=e}respondsTo(e){return e==="value"}createEvent(e,t){let r=t._queryParams.getIndex();return new bl("value",this,new gi(e.snapshotNode,new mt(t._repo,t._path),r))}getEventRunner(e){return e.getEventType()==="cancel"?()=>this.callbackContext.onCancel(e.error):()=>this.callbackContext.onValue(e.snapshot,null)}createCancelEvent(e,t){return this.callbackContext.hasCancelCallback?new Rl(this,e,t):null}matches(e){return e instanceof n?!e.callbackContext||!this.callbackContext?!0:e.callbackContext.matches(this.callbackContext):!1}hasAnyCallback(){return this.callbackContext!==null}},xl=class n{constructor(e,t){this.eventType=e,this.callbackContext=t}respondsTo(e){let t=e==="children_added"?"child_added":e;return t=t==="children_removed"?"child_removed":t,this.eventType===t}createCancelEvent(e,t){return this.callbackContext.hasCancelCallback?new Rl(this,e,t):null}createEvent(e,t){F(e.childName!=null,"Child events should have a childName.");let r=Ln(new mt(t._repo,t._path),e.childName),i=t._queryParams.getIndex();return new bl(e.type,this,new gi(e.snapshotNode,r,i),e.prevName)}getEventRunner(e){return e.getEventType()==="cancel"?()=>this.callbackContext.onCancel(e.error):()=>this.callbackContext.onValue(e.snapshot,e.prevName)}matches(e){return e instanceof n?this.eventType===e.eventType&&(!this.callbackContext||!e.callbackContext||this.callbackContext.matches(e.callbackContext)):!1}hasAnyCallback(){return!!this.callbackContext}};function go(n,e,t,r,i){let s;if(typeof r=="object"&&(s=void 0,i=r),typeof r=="function"&&(s=r),i&&i.onlyOnce){let u=t,c=(d,p)=>{sd(n._repo,n,l),u(d,p)};c.userCallback=t.userCallback,c.context=t.context,t=c}let o=new so(t,s||void 0),l=e==="value"?new oo(o):new xl(e,o);return dA(n._repo,n,l),()=>sd(n._repo,n,l)}function Yl(n,e,t,r){return go(n,"value",e,t,r)}function $d(n,e,t,r){return go(n,"child_added",e,t,r)}function Hd(n,e,t,r){return go(n,"child_changed",e,t,r)}function Yd(n,e,t,r){return go(n,"child_moved",e,t,r)}function Jd(n,e,t,r){return go(n,"child_removed",e,t,r)}function Xd(n,e,t){let r=null,i=t?new so(t):null;e==="value"?r=new oo(i):e&&(r=new xl(e,i)),sd(n._repo,n,r)}var gt=class{},Nl=class extends gt{constructor(e,t){super(),this._value=e,this._key=t,this.type="endAt"}_apply(e){Kt("endAt",this._value,e._path,!0);let t=Oh(e._queryParams,this._value,this._key);if($l(t),Un(t),e._queryParams.hasEnd())throw new Error("endAt: Starting point was already set (by another call to endAt, endBefore or equalTo).");return new ot(e._repo,e._path,t,e._orderByCalled)}};function Wv(n,e){return po("endAt","key",e,!0),new Nl(n,e)}var ad=class extends gt{constructor(e,t){super(),this._value=e,this._key=t,this.type="endBefore"}_apply(e){Kt("endBefore",this._value,e._path,!1);let t=WS(e._queryParams,this._value,this._key);if($l(t),Un(t),e._queryParams.hasEnd())throw new Error("endBefore: Starting point was already set (by another call to endAt, endBefore or equalTo).");return new ot(e._repo,e._path,t,e._orderByCalled)}};function Qv(n,e){return po("endBefore","key",e,!0),new ad(n,e)}var Dl=class extends gt{constructor(e,t){super(),this._value=e,this._key=t,this.type="startAt"}_apply(e){Kt("startAt",this._value,e._path,!0);let t=Fh(e._queryParams,this._value,this._key);if($l(t),Un(t),e._queryParams.hasStart())throw new Error("startAt: Starting point was already set (by another call to startAt, startBefore or equalTo).");return new ot(e._repo,e._path,t,e._orderByCalled)}};function $v(n=null,e){return po("startAt","key",e,!0),new Dl(n,e)}var ld=class extends gt{constructor(e,t){super(),this._value=e,this._key=t,this.type="startAfter"}_apply(e){Kt("startAfter",this._value,e._path,!1);let t=KS(e._queryParams,this._value,this._key);if($l(t),Un(t),e._queryParams.hasStart())throw new Error("startAfter: Starting point was already set (by another call to startAt, startAfter, or equalTo).");return new ot(e._repo,e._path,t,e._orderByCalled)}};function Hv(n,e){return po("startAfter","key",e,!0),new ld(n,e)}var ud=class extends gt{constructor(e){super(),this._limit=e,this.type="limitToFirst"}_apply(e){if(e._queryParams.hasLimit())throw new Error("limitToFirst: Limit was already set (by another call to limitToFirst or limitToLast).");return new ot(e._repo,e._path,jS(e._queryParams,this._limit),e._orderByCalled)}};function Yv(n){if(typeof n!="number"||Math.floor(n)!==n||n<=0)throw new Error("limitToFirst: First argument must be a positive integer.");return new ud(n)}var cd=class extends gt{constructor(e){super(),this._limit=e,this.type="limitToLast"}_apply(e){if(e._queryParams.hasLimit())throw new Error("limitToLast: Limit was already set (by another call to limitToFirst or limitToLast).");return new ot(e._repo,e._path,zS(e._queryParams,this._limit),e._orderByCalled)}};function Jv(n){if(typeof n!="number"||Math.floor(n)!==n||n<=0)throw new Error("limitToLast: First argument must be a positive integer.");return new cd(n)}var hd=class extends gt{constructor(e){super(),this._path=e,this.type="orderByChild"}_apply(e){Ql(e,"orderByChild");let t=new he(this._path);if(X(t))throw new Error("orderByChild: cannot pass in empty path. Use orderByValue() instead.");let r=new Hs(t),i=Vl(e._queryParams,r);return Un(i),new ot(e._repo,e._path,i,!0)}};function Xv(n){if(n==="$key")throw new Error('orderByChild: "$key" is invalid.  Use orderByKey() instead.');if(n==="$priority")throw new Error('orderByChild: "$priority" is invalid.  Use orderByPriority() instead.');if(n==="$value")throw new Error('orderByChild: "$value" is invalid.  Use orderByValue() instead.');return wi("orderByChild","path",n,!1),new hd(n)}var dd=class extends gt{constructor(){super(...arguments),this.type="orderByKey"}_apply(e){Ql(e,"orderByKey");let t=Vl(e._queryParams,Gt);return Un(t),new ot(e._repo,e._path,t,!0)}};function Zv(){return new dd}var fd=class extends gt{constructor(){super(...arguments),this.type="orderByPriority"}_apply(e){Ql(e,"orderByPriority");let t=Vl(e._queryParams,_e);return Un(t),new ot(e._repo,e._path,t,!0)}};function ew(){return new fd}var pd=class extends gt{constructor(){super(...arguments),this.type="orderByValue"}_apply(e){Ql(e,"orderByValue");let t=Vl(e._queryParams,bd);return Un(t),new ot(e._repo,e._path,t,!0)}};function tw(){return new pd}var md=class extends gt{constructor(e,t){super(),this._value=e,this._key=t,this.type="equalTo"}_apply(e){if(Kt("equalTo",this._value,e._path,!1),e._queryParams.hasStart())throw new Error("equalTo: Starting point was already set (by another call to startAt/startAfter or equalTo).");if(e._queryParams.hasEnd())throw new Error("equalTo: Ending point was already set (by another call to endAt/endBefore or equalTo).");return new Nl(this._value,this._key)._apply(new Dl(this._value,this._key)._apply(e))}};function nw(n,e){return po("equalTo","key",e,!0),new md(n,e)}function St(n,...e){let t=te(n);for(let r of e)t=r._apply(t);return t}bC(mt);DC(mt);var EA="FIREBASE_DATABASE_EMULATOR_HOST",gd={},IA=!1;function TA(n,e,t,r){n.repoInfo_=new ll(`${e}:${t}`,!1,n.repoInfo_.namespace,n.repoInfo_.webSocketOnly,n.repoInfo_.nodeAdmin,n.repoInfo_.persistenceKey,n.repoInfo_.includeNamespaceInQueryParams,!0),r&&(n.authTokenProvider_=r)}function Zd(n,e,t,r,i){let s=r||n.options.databaseURL;s===void 0&&(n.options.projectId||jt("Can't determine Firebase Database URL. Be sure to include  a Project ID when calling firebase.initializeApp()."),Ge("Using default host for project ",n.options.projectId),s=`${n.options.projectId}-default-rtdb.firebaseio.com`);let o=od(s,i),l=o.repoInfo,u,c;typeof process<"u"&&process.env&&(c=process.env[EA]),c?(u=!0,s=`http://${c}?ns=${l.namespace}`,o=od(s,i),l=o.repoInfo):u=!o.repoInfo.secure;let d=i&&u?new js(js.OWNER):new wh(n.name,n.options,e);Nv("Invalid Firebase Database URL",o),X(o.path)||jt("Database URL must point to the root of a Firebase Database (not including a child path).");let p=CA(l,n,d,new vh(n.name,t));return new _d(p,n)}function SA(n,e){let t=gd[e];(!t||t[n.key]!==n)&&jt(`Database ${e}(${n.repoInfo_}) has already been deleted.`),Ov(n),delete t[n.key]}function CA(n,e,t,r){let i=gd[e.name];i||(i={},gd[e.name]=i);let s=i[n.toURLString()];return s&&jt("Database initialized multiple times. Please make sure the format of the database URL matches with each database() call."),s=new id(n,IA,t,r),i[n.toURLString()]=s,s}var _d=class{constructor(e,t){this._repoInternal=e,this.app=t,this.type="database",this._instanceStarted=!1}get _repo(){return this._instanceStarted||(iA(this._repoInternal,this.app.options.appId,this.app.options.databaseAuthVariableOverride),this._instanceStarted=!0),this._repoInternal}get _root(){return this._rootInternal||(this._rootInternal=new mt(this._repo,ce())),this._rootInternal}_delete(){return this._rootInternal!==null&&(SA(this._repo,this.app.name),this._repoInternal=null,this._rootInternal=null),Promise.resolve()}_checkNotDeleted(e){this._rootInternal===null&&jt("Cannot call "+e+" on a deleted database.")}};function rw(){tv.IS_TRANSPORT_INITIALIZED&&Xe("Transport has already been initialized. Please call this function before calling ref or setting up a listener")}function iw(){rw(),Qs.forceDisallow()}function sw(){rw(),oi.forceDisallow(),Qs.forceAllow()}function ow(n,e,t,r={}){n=te(n),n._checkNotDeleted("useEmulator"),n._instanceStarted&&jt("Cannot call useEmulator() after instance has already been initialized.");let i=n._repoInternal,s;if(i.repoInfo_.nodeAdmin)r.mockUserToken&&jt('mockUserToken is not supported by the Admin SDK. For client access with mock users, please use the "firebase" package instead of "firebase-admin".'),s=new js(js.OWNER);else if(r.mockUserToken){let o=typeof r.mockUserToken=="string"?r.mockUserToken:La(r.mockUserToken,n.app.options.projectId);s=new js(o)}TA(i,e,t,s)}function aw(n){n=te(n),n._checkNotDeleted("goOffline"),Ov(n._repo)}function lw(n){n=te(n),n._checkNotDeleted("goOnline"),fA(n._repo)}function uw(n,e){My(n,e)}function AA(n){wd(ja),Ga(new Bt("database",(e,{instanceIdentifier:t})=>{let r=e.getProvider("app").getImmediate(),i=e.getProvider("auth-internal"),s=e.getProvider("app-check-internal");return Zd(r,i,s,t)},"PUBLIC").setMultipleInstances(!0)),ii(ny,ry,n),ii(ny,ry,"esm2017")}var bA={".sv":"timestamp"};function cw(){return bA}function hw(n){return{".sv":{increment:n}}}var yd=class{constructor(e,t){this.committed=e,this.snapshot=t}toJSON(){return{committed:this.committed,snapshot:this.snapshot.toJSON()}}};function dw(n,e,t){var r;if(n=te(n),ft("Reference.transaction",n._path),n.key===".length"||n.key===".keys")throw"Reference.transaction failed: "+n.key+" is a read-only object.";let i=(r=t?.applyLocally)!==null&&r!==void 0?r:!0,s=new rt,o=(u,c,d)=>{let p=null;u?s.reject(u):(p=new gi(d,new mt(n._repo,n._path),_e),s.resolve(new yd(c,p)))},l=Yl(n,()=>{});return pA(n._repo,n._path,e,o,l,i),s.promise}Cd.prototype.simpleListen=function(n,e){this.sendRequest("q",{p:n},e)};Cd.prototype.echo=function(n,e){this.sendRequest("echo",{d:n},e)};AA();var RA="@firebase/database-compat",PA="1.0.8";var xA=new ri("@firebase/database-compat"),fw=function(n){let e="FIREBASE WARNING: "+n;xA.warn(e)};var NA=function(n,e,t,r){if(!(r&&t===void 0)&&typeof t!="boolean")throw new Error(ct(n,e)+"must be a boolean.")},DA=function(n,e,t){if(!(t&&e===void 0))switch(e){case"value":case"child_added":case"child_removed":case"child_changed":case"child_moved":break;default:throw new Error(ct(n,"eventType")+'must be a valid event type = "value", "child_added", "child_removed", "child_changed", or "child_moved".')}};var ef=class{constructor(e){this._delegate=e}cancel(e){K("OnDisconnect.cancel",0,1,arguments.length),Le("OnDisconnect.cancel","onComplete",e,!0);let t=this._delegate.cancel();return e&&t.then(()=>e(null),r=>e(r)),t}remove(e){K("OnDisconnect.remove",0,1,arguments.length),Le("OnDisconnect.remove","onComplete",e,!0);let t=this._delegate.remove();return e&&t.then(()=>e(null),r=>e(r)),t}set(e,t){K("OnDisconnect.set",1,2,arguments.length),Le("OnDisconnect.set","onComplete",t,!0);let r=this._delegate.set(e);return t&&r.then(()=>t(null),i=>t(i)),r}setWithPriority(e,t,r){K("OnDisconnect.setWithPriority",2,3,arguments.length),Le("OnDisconnect.setWithPriority","onComplete",r,!0);let i=this._delegate.setWithPriority(e,t);return r&&i.then(()=>r(null),s=>r(s)),i}update(e,t){if(K("OnDisconnect.update",1,2,arguments.length),Array.isArray(e)){let i={};for(let s=0;s<e.length;++s)i[""+s]=e[s];e=i,fw("Passing an Array to firebase.database.onDisconnect().update() is deprecated. Use set() if you want to overwrite the existing data, or an Object with integer keys if you really do want to only update some of the children.")}Le("OnDisconnect.update","onComplete",t,!0);let r=this._delegate.update(e);return t&&r.then(()=>t(null),i=>t(i)),r}};var tf=class{constructor(e,t){this.committed=e,this.snapshot=t}toJSON(){return K("TransactionResult.toJSON",0,1,arguments.length),{committed:this.committed,snapshot:this.snapshot.toJSON()}}};var Er=class n{constructor(e,t){this._database=e,this._delegate=t}val(){return K("DataSnapshot.val",0,0,arguments.length),this._delegate.val()}exportVal(){return K("DataSnapshot.exportVal",0,0,arguments.length),this._delegate.exportVal()}toJSON(){return K("DataSnapshot.toJSON",0,1,arguments.length),this._delegate.toJSON()}exists(){return K("DataSnapshot.exists",0,0,arguments.length),this._delegate.exists()}child(e){return K("DataSnapshot.child",0,1,arguments.length),e=String(e),wi("DataSnapshot.child","path",e,!1),new n(this._database,this._delegate.child(e))}hasChild(e){return K("DataSnapshot.hasChild",1,1,arguments.length),wi("DataSnapshot.hasChild","path",e,!1),this._delegate.hasChild(e)}getPriority(){return K("DataSnapshot.getPriority",0,0,arguments.length),this._delegate.priority}forEach(e){return K("DataSnapshot.forEach",1,1,arguments.length),Le("DataSnapshot.forEach","action",e,!1),this._delegate.forEach(t=>e(new n(this._database,t)))}hasChildren(){return K("DataSnapshot.hasChildren",0,0,arguments.length),this._delegate.hasChildren()}get key(){return this._delegate.key}numChildren(){return K("DataSnapshot.numChildren",0,0,arguments.length),this._delegate.size}getRef(){return K("DataSnapshot.ref",0,0,arguments.length),new cn(this._database,this._delegate.ref)}get ref(){return this.getRef()}},Jl=class n{constructor(e,t){this.database=e,this._delegate=t}on(e,t,r,i){var s;K("Query.on",2,4,arguments.length),Le("Query.on","callback",t,!1);let o=n.getCancelAndContextArgs_("Query.on",r,i),l=(c,d)=>{t.call(o.context,new Er(this.database,c),d)};l.userCallback=t,l.context=o.context;let u=(s=o.cancel)===null||s===void 0?void 0:s.bind(o.context);switch(e){case"value":return Yl(this._delegate,l,u),t;case"child_added":return $d(this._delegate,l,u),t;case"child_removed":return Jd(this._delegate,l,u),t;case"child_changed":return Hd(this._delegate,l,u),t;case"child_moved":return Yd(this._delegate,l,u),t;default:throw new Error(ct("Query.on","eventType")+'must be a valid event type = "value", "child_added", "child_removed", "child_changed", or "child_moved".')}}off(e,t,r){if(K("Query.off",0,3,arguments.length),DA("Query.off",e,!0),Le("Query.off","callback",t,!0),sh("Query.off","context",r,!0),t){let i=()=>{};i.userCallback=t,i.context=r,Xd(this._delegate,e,i)}else Xd(this._delegate,e)}get(){return Kv(this._delegate).then(e=>new Er(this.database,e))}once(e,t,r,i){K("Query.once",1,4,arguments.length),Le("Query.once","callback",t,!0);let s=n.getCancelAndContextArgs_("Query.once",r,i),o=new rt,l=(c,d)=>{let p=new Er(this.database,c);t&&t.call(s.context,p,d),o.resolve(p)};l.userCallback=t,l.context=s.context;let u=c=>{s.cancel&&s.cancel.call(s.context,c),o.reject(c)};switch(e){case"value":Yl(this._delegate,l,u,{onlyOnce:!0});break;case"child_added":$d(this._delegate,l,u,{onlyOnce:!0});break;case"child_removed":Jd(this._delegate,l,u,{onlyOnce:!0});break;case"child_changed":Hd(this._delegate,l,u,{onlyOnce:!0});break;case"child_moved":Yd(this._delegate,l,u,{onlyOnce:!0});break;default:throw new Error(ct("Query.once","eventType")+'must be a valid event type = "value", "child_added", "child_removed", "child_changed", or "child_moved".')}return o.promise}limitToFirst(e){return K("Query.limitToFirst",1,1,arguments.length),new n(this.database,St(this._delegate,Yv(e)))}limitToLast(e){return K("Query.limitToLast",1,1,arguments.length),new n(this.database,St(this._delegate,Jv(e)))}orderByChild(e){return K("Query.orderByChild",1,1,arguments.length),new n(this.database,St(this._delegate,Xv(e)))}orderByKey(){return K("Query.orderByKey",0,0,arguments.length),new n(this.database,St(this._delegate,Zv()))}orderByPriority(){return K("Query.orderByPriority",0,0,arguments.length),new n(this.database,St(this._delegate,ew()))}orderByValue(){return K("Query.orderByValue",0,0,arguments.length),new n(this.database,St(this._delegate,tw()))}startAt(e=null,t){return K("Query.startAt",0,2,arguments.length),new n(this.database,St(this._delegate,$v(e,t)))}startAfter(e=null,t){return K("Query.startAfter",0,2,arguments.length),new n(this.database,St(this._delegate,Hv(e,t)))}endAt(e=null,t){return K("Query.endAt",0,2,arguments.length),new n(this.database,St(this._delegate,Wv(e,t)))}endBefore(e=null,t){return K("Query.endBefore",0,2,arguments.length),new n(this.database,St(this._delegate,Qv(e,t)))}equalTo(e,t){return K("Query.equalTo",1,2,arguments.length),new n(this.database,St(this._delegate,nw(e,t)))}toString(){return K("Query.toString",0,0,arguments.length),this._delegate.toString()}toJSON(){return K("Query.toJSON",0,1,arguments.length),this._delegate.toJSON()}isEqual(e){if(K("Query.isEqual",1,1,arguments.length),!(e instanceof n)){let t="Query.isEqual failed: First argument must be an instance of firebase.database.Query.";throw new Error(t)}return this._delegate.isEqual(e._delegate)}static getCancelAndContextArgs_(e,t,r){let i={cancel:void 0,context:void 0};if(t&&r)i.cancel=t,Le(e,"cancel",i.cancel,!0),i.context=r,sh(e,"context",i.context,!0);else if(t)if(typeof t=="object"&&t!==null)i.context=t;else if(typeof t=="function")i.cancel=t;else throw new Error(ct(e,"cancelOrContext")+" must either be a cancel callback or a context object.");return i}get ref(){return new cn(this.database,new mt(this._delegate._repo,this._delegate._path))}},cn=class n extends Jl{constructor(e,t){super(e,new ot(t._repo,t._path,new Zs,!1)),this.database=e,this._delegate=t}getKey(){return K("Reference.key",0,0,arguments.length),this._delegate.key}child(e){return K("Reference.child",1,1,arguments.length),typeof e=="number"&&(e=String(e)),new n(this.database,Ln(this._delegate,e))}getParent(){K("Reference.parent",0,0,arguments.length);let e=this._delegate.parent;return e?new n(this.database,e):null}getRoot(){return K("Reference.root",0,0,arguments.length),new n(this.database,this._delegate.root)}set(e,t){K("Reference.set",1,2,arguments.length),Le("Reference.set","onComplete",t,!0);let r=Hl(this._delegate,e);return t&&r.then(()=>t(null),i=>t(i)),r}update(e,t){if(K("Reference.update",1,2,arguments.length),Array.isArray(e)){let i={};for(let s=0;s<e.length;++s)i[""+s]=e[s];e=i,fw("Passing an Array to Firebase.update() is deprecated. Use set() if you want to overwrite the existing data, or an Object with integer keys if you really do want to only update some of the children.")}ft("Reference.update",this._delegate._path),Le("Reference.update","onComplete",t,!0);let r=zv(this._delegate,e);return t&&r.then(()=>t(null),i=>t(i)),r}setWithPriority(e,t,r){K("Reference.setWithPriority",2,3,arguments.length),Le("Reference.setWithPriority","onComplete",r,!0);let i=jv(this._delegate,e,t);return r&&i.then(()=>r(null),s=>r(s)),i}remove(e){K("Reference.remove",0,1,arguments.length),Le("Reference.remove","onComplete",e,!0);let t=qv(this._delegate);return e&&t.then(()=>e(null),r=>e(r)),t}transaction(e,t,r){K("Reference.transaction",1,3,arguments.length),Le("Reference.transaction","transactionUpdate",e,!1),Le("Reference.transaction","onComplete",t,!0),NA("Reference.transaction","applyLocally",r,!0);let i=dw(this._delegate,e,{applyLocally:r}).then(s=>new tf(s.committed,new Er(this.database,s.snapshot)));return t&&i.then(s=>t(null,s.committed,s.snapshot),s=>t(s,!1,null)),i}setPriority(e,t){K("Reference.setPriority",1,2,arguments.length),Le("Reference.setPriority","onComplete",t,!0);let r=Gv(this._delegate,e);return t&&r.then(()=>t(null),i=>t(i)),r}push(e,t){K("Reference.push",0,2,arguments.length),Le("Reference.push","onComplete",t,!0);let r=Bv(this._delegate,e),i=r.then(o=>new n(this.database,o));t&&i.then(()=>t(null),o=>t(o));let s=new n(this.database,r);return s.then=i.then.bind(i),s.catch=i.catch.bind(i,void 0),s}onDisconnect(){return ft("Reference.onDisconnect",this._delegate._path),new ef(new Pl(this._delegate._repo,this._delegate._path))}get key(){return this.getKey()}get parent(){return this.getParent()}get root(){return this.getRoot()}};var Ir=class{constructor(e,t){this._delegate=e,this.app=t,this.INTERNAL={delete:()=>this._delegate._delete(),forceWebSockets:iw,forceLongPolling:sw}}useEmulator(e,t,r={}){ow(this._delegate,e,t,r)}ref(e){if(K("database.ref",0,1,arguments.length),e instanceof cn){let t=Qd(this._delegate,e.toString());return new cn(this,t)}else{let t=Wd(this._delegate,e);return new cn(this,t)}}refFromURL(e){K("database.refFromURL",1,1,arguments.length);let r=Qd(this._delegate,e);return new cn(this,r)}goOffline(){return K("database.goOffline",0,0,arguments.length),aw(this._delegate)}goOnline(){return K("database.goOnline",0,0,arguments.length),lw(this._delegate)}};Ir.ServerValue={TIMESTAMP:cw(),increment:n=>hw(n)};function kA({app:n,url:e,version:t,customAuthImpl:r,customAppCheckImpl:i,namespace:s,nodeAdmin:o=!1}){wd(t);let l=new oh("database-standalone"),u=new qa("auth-internal",l);u.setComponent(new Bt("auth-internal",()=>r,"PRIVATE"));let c;return i&&(c=new qa("app-check-internal",l),c.setComponent(new Bt("app-check-internal",()=>i,"PRIVATE"))),{instance:new Ir(Zd(n,u,c,e,o),n),namespace:s}}var VA=Object.freeze({__proto__:null,initStandalone:kA});var FA=Ir.ServerValue;function OA(n){n.INTERNAL.registerComponent(new Bt("database-compat",(e,{instanceIdentifier:t})=>{let r=e.getProvider("app-compat").getImmediate(),i=e.getProvider("database").getImmediate({identifier:t});return new Ir(i,r)},"PUBLIC").setServiceProps({Reference:cn,Query:Jl,Database:Ir,DataSnapshot:Er,enableLogging:uw,INTERNAL:VA,ServerValue:FA}).setMultipleInstances(!0)),n.registerVersion(RA,PA)}OA(xn);function _o(n,e,t="on",r=Sa){return new Ta(i=>{let s=null;return s=n[t](e,(o,l)=>{r.schedule(()=>{i.next({snapshot:o,prevKey:l})}),t==="once"&&r.schedule(()=>i.complete())},o=>{r.schedule(()=>i.error(o))}),t==="on"?{unsubscribe(){s!=null&&n.off(e,s)}}:{unsubscribe(){}}}).pipe(De(i=>{let{snapshot:s,prevKey:o}=i,l=null;return s.exists()&&(l=s.key),{type:e,payload:s,prevKey:o,key:l}}),f_())}function BA(n){return typeof n=="string"}function qA(n){return typeof n.exportVal=="function"}function yw(n){return n==null}function vw(n){return typeof n.set=="function"}function pw(n,e){return vw(e)?e:n.ref(e)}function ww(n,e){if(BA(n))return e.stringCase();if(vw(n))return e.firebaseCase();if(qA(n))return e.snapshotCase();throw new Error(`Expects a string, snapshot, or reference. Got: ${typeof n}`)}function Ew(n){return(yw(n)||n.length===0)&&(n=["child_added","child_removed","child_changed","child_moved"]),n}function Iw(n,e,t){e=Ew(e);let r=e.map(i=>_o(n,i,"on",t));return Xc(...r)}function GA(n,e,t){let r=Iw(n,e).pipe(cr((i,s)=>[...i,s],[]));return zA(n,r,t)}function jA(n,e){return _o(n,"value","on",e).pipe(De(t=>{let r;return t.payload.forEach(i=>(r=i.key,!1)),{data:t,lastKeyToLoad:r}}))}function zA(n,e,t){return jA(n,t).pipe(g_(e),De(([i,s])=>{let o=i.lastKeyToLoad,l=s.map(u=>u.key);return{actions:s,lastKeyToLoad:o,loadedKeys:l}}),p_(i=>i.loadedKeys.indexOf(i.lastKeyToLoad)===-1),De(i=>i.actions))}function mw(n,e){return function(r,i){return ww(r,{stringCase:()=>n.child(r)[e](i),firebaseCase:()=>r[e](i),snapshotCase:()=>r.ref[e](i)})}}function KA(n){return function(t){return t?ww(t,{stringCase:()=>n.child(t).remove(),firebaseCase:()=>t.remove(),snapshotCase:()=>t.ref.remove()}):n.remove()}}function WA(n,e,t){return _o(n,"value","once",t).pipe(m_(r=>{let i=[Ns(r)];return e.forEach(s=>i.push(_o(n,s,"on",t))),Xc(...i).pipe(cr($A,[]))}),Ca())}function Tw(n,e){let t=n.length;for(let r=0;r<t;r++)if(n[r].payload.key===e)return r;return-1}function QA(n,e){if(yw(e))return 0;{let t=Tw(n,e);return t===-1?n.length:t+1}}function $A(n,e){let{payload:t,prevKey:r,key:i}=e,s=Tw(n,i),o=QA(n,r);switch(e.type){case"value":if(e.payload?.exists()){let l=null;e.payload.forEach(u=>{let c={payload:u,type:"value",prevKey:l,key:u.key};return l=u.key,n=[...n,c],!1})}return n;case"child_added":if(s>-1)(n[s-1]?.key||null)!==r&&(n=n.filter(u=>u.payload.key!==t.key),n.splice(o,0,e));else{if(r==null)return[e,...n];n=n.slice(),n.splice(o,0,e)}return n;case"child_removed":return n.filter(l=>l.payload.key!==t.key);case"child_changed":return n.map(l=>l.payload.key===i?e:l);case"child_moved":if(s>-1){let l=n.splice(s,1)[0];return n=n.slice(),n.splice(o,0,l),n}return n;default:return n}}function gw(n,e,t){return e=Ew(e),WA(n,e,t)}function HA(n,e){let t=e.schedulers.outsideAngular,r=e.schedulers.ngZone.run(()=>n.ref);return{query:n,update:mw(r,"update"),set:mw(r,"set"),push:i=>r.push(i),remove:KA(r),snapshotChanges(i){return gw(n,i,t).pipe(Ue)},stateChanges(i){return Iw(n,i,t).pipe(Ue)},auditTrail(i){return GA(n,i,t).pipe(Ue)},valueChanges(i,s){return gw(n,i,t).pipe(De(l=>l.map(u=>s&&s.idField?Ps(Cn({},u.payload.val()),{[s.idField]:u.key}):u.payload.val())),Ue)}}}function _w(n,e){return function(){return _o(n,"value","on",e)}}function YA(n,e){return{query:n,snapshotChanges(){return _w(n,e.schedulers.outsideAngular)().pipe(Ue)},update(t){return n.ref.update(t)},set(t){return n.ref.set(t)},remove(){return n.ref.remove()},valueChanges(){return _w(n,e.schedulers.outsideAngular)().pipe(Ue,De(r=>r.payload.exists()?r.payload.val():null))}}}var JA=new An("angularfire2.realtimeDatabaseURL"),XA=new An("angularfire2.database.use-emulator"),ZA=(()=>{class n{schedulers;database;constructor(t,r,i,s,o,l,u,c,d,p,m,y,C,x,D){this.schedulers=l;let q=u,j=Ha(t,o,r);c&&rl(j,o,d,m,y,C,p,x),this.database=Ya(`${j.name}.database.${i}`,"AngularFireDatabase",j.name,()=>{let B=o.runOutsideAngular(()=>j.database(i||void 0));return q&&B.useEmulator(...q),B},[q])}list(t,r){let i=this.schedulers.ngZone.runOutsideAngular(()=>pw(this.database,t)),s=i;return r&&(s=r(i)),HA(s,this)}object(t){let r=this.schedulers.ngZone.runOutsideAngular(()=>pw(this.database,t));return YA(r,this)}createPushId(){return this.schedulers.ngZone.runOutsideAngular(()=>this.database.ref()).push().key}static \u0275fac=function(r){return new(r||n)(ee(Qa),ee($a,8),ee(JA,8),ee(Na),ee(xa),ee(Wa),ee(XA,8),ee(il,8),ee(Ja,8),ee(Xa,8),ee(Za,8),ee(el,8),ee(tl,8),ee(nl,8),ee(Ka,8))};static \u0275prov=ei({token:n,factory:n.\u0275fac,providedIn:"any"})}return n})(),Sw=(()=>{class n{constructor(){xn.registerVersion("angularfire",za.full,"rtdb-compat")}static \u0275fac=function(r){return new(r||n)};static \u0275mod=Pa({type:n});static \u0275inj=Ra({providers:[ZA]})}return n})();var Cw=typeof globalThis<"u"?globalThis:typeof window<"u"?window:typeof global<"u"?global:typeof self<"u"?self:{},Aw={};var Bn,nf;(function(){var n;function e(E,_){function w(){}w.prototype=_.prototype,E.D=_.prototype,E.prototype=new w,E.prototype.constructor=E,E.C=function(I,T,A){for(var v=Array(arguments.length-2),nn=2;nn<arguments.length;nn++)v[nn-2]=arguments[nn];return _.prototype[T].apply(I,v)}}function t(){this.blockSize=-1}function r(){this.blockSize=-1,this.blockSize=64,this.g=Array(4),this.B=Array(this.blockSize),this.o=this.h=0,this.s()}e(r,t),r.prototype.s=function(){this.g[0]=1732584193,this.g[1]=4023233417,this.g[2]=2562383102,this.g[3]=271733878,this.o=this.h=0};function i(E,_,w){w||(w=0);var I=Array(16);if(typeof _=="string")for(var T=0;16>T;++T)I[T]=_.charCodeAt(w++)|_.charCodeAt(w++)<<8|_.charCodeAt(w++)<<16|_.charCodeAt(w++)<<24;else for(T=0;16>T;++T)I[T]=_[w++]|_[w++]<<8|_[w++]<<16|_[w++]<<24;_=E.g[0],w=E.g[1],T=E.g[2];var A=E.g[3],v=_+(A^w&(T^A))+I[0]+3614090360&4294967295;_=w+(v<<7&4294967295|v>>>25),v=A+(T^_&(w^T))+I[1]+3905402710&4294967295,A=_+(v<<12&4294967295|v>>>20),v=T+(w^A&(_^w))+I[2]+606105819&4294967295,T=A+(v<<17&4294967295|v>>>15),v=w+(_^T&(A^_))+I[3]+3250441966&4294967295,w=T+(v<<22&4294967295|v>>>10),v=_+(A^w&(T^A))+I[4]+4118548399&4294967295,_=w+(v<<7&4294967295|v>>>25),v=A+(T^_&(w^T))+I[5]+1200080426&4294967295,A=_+(v<<12&4294967295|v>>>20),v=T+(w^A&(_^w))+I[6]+2821735955&4294967295,T=A+(v<<17&4294967295|v>>>15),v=w+(_^T&(A^_))+I[7]+4249261313&4294967295,w=T+(v<<22&4294967295|v>>>10),v=_+(A^w&(T^A))+I[8]+1770035416&4294967295,_=w+(v<<7&4294967295|v>>>25),v=A+(T^_&(w^T))+I[9]+2336552879&4294967295,A=_+(v<<12&4294967295|v>>>20),v=T+(w^A&(_^w))+I[10]+4294925233&4294967295,T=A+(v<<17&4294967295|v>>>15),v=w+(_^T&(A^_))+I[11]+2304563134&4294967295,w=T+(v<<22&4294967295|v>>>10),v=_+(A^w&(T^A))+I[12]+1804603682&4294967295,_=w+(v<<7&4294967295|v>>>25),v=A+(T^_&(w^T))+I[13]+4254626195&4294967295,A=_+(v<<12&4294967295|v>>>20),v=T+(w^A&(_^w))+I[14]+2792965006&4294967295,T=A+(v<<17&4294967295|v>>>15),v=w+(_^T&(A^_))+I[15]+1236535329&4294967295,w=T+(v<<22&4294967295|v>>>10),v=_+(T^A&(w^T))+I[1]+4129170786&4294967295,_=w+(v<<5&4294967295|v>>>27),v=A+(w^T&(_^w))+I[6]+3225465664&4294967295,A=_+(v<<9&4294967295|v>>>23),v=T+(_^w&(A^_))+I[11]+643717713&4294967295,T=A+(v<<14&4294967295|v>>>18),v=w+(A^_&(T^A))+I[0]+3921069994&4294967295,w=T+(v<<20&4294967295|v>>>12),v=_+(T^A&(w^T))+I[5]+3593408605&4294967295,_=w+(v<<5&4294967295|v>>>27),v=A+(w^T&(_^w))+I[10]+38016083&4294967295,A=_+(v<<9&4294967295|v>>>23),v=T+(_^w&(A^_))+I[15]+3634488961&4294967295,T=A+(v<<14&4294967295|v>>>18),v=w+(A^_&(T^A))+I[4]+3889429448&4294967295,w=T+(v<<20&4294967295|v>>>12),v=_+(T^A&(w^T))+I[9]+568446438&4294967295,_=w+(v<<5&4294967295|v>>>27),v=A+(w^T&(_^w))+I[14]+3275163606&4294967295,A=_+(v<<9&4294967295|v>>>23),v=T+(_^w&(A^_))+I[3]+4107603335&4294967295,T=A+(v<<14&4294967295|v>>>18),v=w+(A^_&(T^A))+I[8]+1163531501&4294967295,w=T+(v<<20&4294967295|v>>>12),v=_+(T^A&(w^T))+I[13]+2850285829&4294967295,_=w+(v<<5&4294967295|v>>>27),v=A+(w^T&(_^w))+I[2]+4243563512&4294967295,A=_+(v<<9&4294967295|v>>>23),v=T+(_^w&(A^_))+I[7]+1735328473&4294967295,T=A+(v<<14&4294967295|v>>>18),v=w+(A^_&(T^A))+I[12]+2368359562&4294967295,w=T+(v<<20&4294967295|v>>>12),v=_+(w^T^A)+I[5]+4294588738&4294967295,_=w+(v<<4&4294967295|v>>>28),v=A+(_^w^T)+I[8]+2272392833&4294967295,A=_+(v<<11&4294967295|v>>>21),v=T+(A^_^w)+I[11]+1839030562&4294967295,T=A+(v<<16&4294967295|v>>>16),v=w+(T^A^_)+I[14]+4259657740&4294967295,w=T+(v<<23&4294967295|v>>>9),v=_+(w^T^A)+I[1]+2763975236&4294967295,_=w+(v<<4&4294967295|v>>>28),v=A+(_^w^T)+I[4]+1272893353&4294967295,A=_+(v<<11&4294967295|v>>>21),v=T+(A^_^w)+I[7]+4139469664&4294967295,T=A+(v<<16&4294967295|v>>>16),v=w+(T^A^_)+I[10]+3200236656&4294967295,w=T+(v<<23&4294967295|v>>>9),v=_+(w^T^A)+I[13]+681279174&4294967295,_=w+(v<<4&4294967295|v>>>28),v=A+(_^w^T)+I[0]+3936430074&4294967295,A=_+(v<<11&4294967295|v>>>21),v=T+(A^_^w)+I[3]+3572445317&4294967295,T=A+(v<<16&4294967295|v>>>16),v=w+(T^A^_)+I[6]+76029189&4294967295,w=T+(v<<23&4294967295|v>>>9),v=_+(w^T^A)+I[9]+3654602809&4294967295,_=w+(v<<4&4294967295|v>>>28),v=A+(_^w^T)+I[12]+3873151461&4294967295,A=_+(v<<11&4294967295|v>>>21),v=T+(A^_^w)+I[15]+530742520&4294967295,T=A+(v<<16&4294967295|v>>>16),v=w+(T^A^_)+I[2]+3299628645&4294967295,w=T+(v<<23&4294967295|v>>>9),v=_+(T^(w|~A))+I[0]+4096336452&4294967295,_=w+(v<<6&4294967295|v>>>26),v=A+(w^(_|~T))+I[7]+1126891415&4294967295,A=_+(v<<10&4294967295|v>>>22),v=T+(_^(A|~w))+I[14]+2878612391&4294967295,T=A+(v<<15&4294967295|v>>>17),v=w+(A^(T|~_))+I[5]+4237533241&4294967295,w=T+(v<<21&4294967295|v>>>11),v=_+(T^(w|~A))+I[12]+1700485571&4294967295,_=w+(v<<6&4294967295|v>>>26),v=A+(w^(_|~T))+I[3]+2399980690&4294967295,A=_+(v<<10&4294967295|v>>>22),v=T+(_^(A|~w))+I[10]+4293915773&4294967295,T=A+(v<<15&4294967295|v>>>17),v=w+(A^(T|~_))+I[1]+2240044497&4294967295,w=T+(v<<21&4294967295|v>>>11),v=_+(T^(w|~A))+I[8]+1873313359&4294967295,_=w+(v<<6&4294967295|v>>>26),v=A+(w^(_|~T))+I[15]+4264355552&4294967295,A=_+(v<<10&4294967295|v>>>22),v=T+(_^(A|~w))+I[6]+2734768916&4294967295,T=A+(v<<15&4294967295|v>>>17),v=w+(A^(T|~_))+I[13]+1309151649&4294967295,w=T+(v<<21&4294967295|v>>>11),v=_+(T^(w|~A))+I[4]+4149444226&4294967295,_=w+(v<<6&4294967295|v>>>26),v=A+(w^(_|~T))+I[11]+3174756917&4294967295,A=_+(v<<10&4294967295|v>>>22),v=T+(_^(A|~w))+I[2]+718787259&4294967295,T=A+(v<<15&4294967295|v>>>17),v=w+(A^(T|~_))+I[9]+3951481745&4294967295,E.g[0]=E.g[0]+_&4294967295,E.g[1]=E.g[1]+(T+(v<<21&4294967295|v>>>11))&4294967295,E.g[2]=E.g[2]+T&4294967295,E.g[3]=E.g[3]+A&4294967295}r.prototype.u=function(E,_){_===void 0&&(_=E.length);for(var w=_-this.blockSize,I=this.B,T=this.h,A=0;A<_;){if(T==0)for(;A<=w;)i(this,E,A),A+=this.blockSize;if(typeof E=="string"){for(;A<_;)if(I[T++]=E.charCodeAt(A++),T==this.blockSize){i(this,I),T=0;break}}else for(;A<_;)if(I[T++]=E[A++],T==this.blockSize){i(this,I),T=0;break}}this.h=T,this.o+=_},r.prototype.v=function(){var E=Array((56>this.h?this.blockSize:2*this.blockSize)-this.h);E[0]=128;for(var _=1;_<E.length-8;++_)E[_]=0;var w=8*this.o;for(_=E.length-8;_<E.length;++_)E[_]=w&255,w/=256;for(this.u(E),E=Array(16),_=w=0;4>_;++_)for(var I=0;32>I;I+=8)E[w++]=this.g[_]>>>I&255;return E};function s(E,_){var w=l;return Object.prototype.hasOwnProperty.call(w,E)?w[E]:w[E]=_(E)}function o(E,_){this.h=_;for(var w=[],I=!0,T=E.length-1;0<=T;T--){var A=E[T]|0;I&&A==_||(w[T]=A,I=!1)}this.g=w}var l={};function u(E){return-128<=E&&128>E?s(E,function(_){return new o([_|0],0>_?-1:0)}):new o([E|0],0>E?-1:0)}function c(E){if(isNaN(E)||!isFinite(E))return p;if(0>E)return D(c(-E));for(var _=[],w=1,I=0;E>=w;I++)_[I]=E/w|0,w*=4294967296;return new o(_,0)}function d(E,_){if(E.length==0)throw Error("number format error: empty string");if(_=_||10,2>_||36<_)throw Error("radix out of range: "+_);if(E.charAt(0)=="-")return D(d(E.substring(1),_));if(0<=E.indexOf("-"))throw Error('number format error: interior "-" character');for(var w=c(Math.pow(_,8)),I=p,T=0;T<E.length;T+=8){var A=Math.min(8,E.length-T),v=parseInt(E.substring(T,T+A),_);8>A?(A=c(Math.pow(_,A)),I=I.j(A).add(c(v))):(I=I.j(w),I=I.add(c(v)))}return I}var p=u(0),m=u(1),y=u(16777216);n=o.prototype,n.m=function(){if(x(this))return-D(this).m();for(var E=0,_=1,w=0;w<this.g.length;w++){var I=this.i(w);E+=(0<=I?I:4294967296+I)*_,_*=4294967296}return E},n.toString=function(E){if(E=E||10,2>E||36<E)throw Error("radix out of range: "+E);if(C(this))return"0";if(x(this))return"-"+D(this).toString(E);for(var _=c(Math.pow(E,6)),w=this,I="";;){var T=Y(w,_).g;w=q(w,T.j(_));var A=((0<w.g.length?w.g[0]:w.h)>>>0).toString(E);if(w=T,C(w))return A+I;for(;6>A.length;)A="0"+A;I=A+I}},n.i=function(E){return 0>E?0:E<this.g.length?this.g[E]:this.h};function C(E){if(E.h!=0)return!1;for(var _=0;_<E.g.length;_++)if(E.g[_]!=0)return!1;return!0}function x(E){return E.h==-1}n.l=function(E){return E=q(this,E),x(E)?-1:C(E)?0:1};function D(E){for(var _=E.g.length,w=[],I=0;I<_;I++)w[I]=~E.g[I];return new o(w,~E.h).add(m)}n.abs=function(){return x(this)?D(this):this},n.add=function(E){for(var _=Math.max(this.g.length,E.g.length),w=[],I=0,T=0;T<=_;T++){var A=I+(this.i(T)&65535)+(E.i(T)&65535),v=(A>>>16)+(this.i(T)>>>16)+(E.i(T)>>>16);I=v>>>16,A&=65535,v&=65535,w[T]=v<<16|A}return new o(w,w[w.length-1]&-2147483648?-1:0)};function q(E,_){return E.add(D(_))}n.j=function(E){if(C(this)||C(E))return p;if(x(this))return x(E)?D(this).j(D(E)):D(D(this).j(E));if(x(E))return D(this.j(D(E)));if(0>this.l(y)&&0>E.l(y))return c(this.m()*E.m());for(var _=this.g.length+E.g.length,w=[],I=0;I<2*_;I++)w[I]=0;for(I=0;I<this.g.length;I++)for(var T=0;T<E.g.length;T++){var A=this.i(I)>>>16,v=this.i(I)&65535,nn=E.i(T)>>>16,cs=E.i(T)&65535;w[2*I+2*T]+=v*cs,j(w,2*I+2*T),w[2*I+2*T+1]+=A*cs,j(w,2*I+2*T+1),w[2*I+2*T+1]+=v*nn,j(w,2*I+2*T+1),w[2*I+2*T+2]+=A*nn,j(w,2*I+2*T+2)}for(I=0;I<_;I++)w[I]=w[2*I+1]<<16|w[2*I];for(I=_;I<2*_;I++)w[I]=0;return new o(w,0)};function j(E,_){for(;(E[_]&65535)!=E[_];)E[_+1]+=E[_]>>>16,E[_]&=65535,_++}function B(E,_){this.g=E,this.h=_}function Y(E,_){if(C(_))throw Error("division by zero");if(C(E))return new B(p,p);if(x(E))return _=Y(D(E),_),new B(D(_.g),D(_.h));if(x(_))return _=Y(E,D(_)),new B(D(_.g),_.h);if(30<E.g.length){if(x(E)||x(_))throw Error("slowDivide_ only works with positive integers.");for(var w=m,I=_;0>=I.l(E);)w=re(w),I=re(I);var T=Q(w,1),A=Q(I,1);for(I=Q(I,2),w=Q(w,2);!C(I);){var v=A.add(I);0>=v.l(E)&&(T=T.add(w),A=v),I=Q(I,1),w=Q(w,1)}return _=q(E,T.j(_)),new B(T,_)}for(T=p;0<=E.l(_);){for(w=Math.max(1,Math.floor(E.m()/_.m())),I=Math.ceil(Math.log(w)/Math.LN2),I=48>=I?1:Math.pow(2,I-48),A=c(w),v=A.j(_);x(v)||0<v.l(E);)w-=I,A=c(w),v=A.j(_);C(A)&&(A=m),T=T.add(A),E=q(E,v)}return new B(T,E)}n.A=function(E){return Y(this,E).h},n.and=function(E){for(var _=Math.max(this.g.length,E.g.length),w=[],I=0;I<_;I++)w[I]=this.i(I)&E.i(I);return new o(w,this.h&E.h)},n.or=function(E){for(var _=Math.max(this.g.length,E.g.length),w=[],I=0;I<_;I++)w[I]=this.i(I)|E.i(I);return new o(w,this.h|E.h)},n.xor=function(E){for(var _=Math.max(this.g.length,E.g.length),w=[],I=0;I<_;I++)w[I]=this.i(I)^E.i(I);return new o(w,this.h^E.h)};function re(E){for(var _=E.g.length+1,w=[],I=0;I<_;I++)w[I]=E.i(I)<<1|E.i(I-1)>>>31;return new o(w,E.h)}function Q(E,_){var w=_>>5;_%=32;for(var I=E.g.length-w,T=[],A=0;A<I;A++)T[A]=0<_?E.i(A+w)>>>_|E.i(A+w+1)<<32-_:E.i(A+w);return new o(T,E.h)}r.prototype.digest=r.prototype.v,r.prototype.reset=r.prototype.s,r.prototype.update=r.prototype.u,nf=Aw.Md5=r,o.prototype.add=o.prototype.add,o.prototype.multiply=o.prototype.j,o.prototype.modulo=o.prototype.A,o.prototype.compare=o.prototype.l,o.prototype.toNumber=o.prototype.m,o.prototype.toString=o.prototype.toString,o.prototype.getBits=o.prototype.i,o.fromNumber=c,o.fromString=d,Bn=Aw.Integer=o}).apply(typeof Cw<"u"?Cw:typeof self<"u"?self:typeof window<"u"?window:{});var Xl=typeof globalThis<"u"?globalThis:typeof window<"u"?window:typeof global<"u"?global:typeof self<"u"?self:{},hn={};var rf,eb,Ii,sf,yo,Zl,of,af,lf;(function(){var n,e=typeof Object.defineProperties=="function"?Object.defineProperty:function(a,h,f){return a==Array.prototype||a==Object.prototype||(a[h]=f.value),a};function t(a){a=[typeof globalThis=="object"&&globalThis,a,typeof window=="object"&&window,typeof self=="object"&&self,typeof Xl=="object"&&Xl];for(var h=0;h<a.length;++h){var f=a[h];if(f&&f.Math==Math)return f}throw Error("Cannot find global object")}var r=t(this);function i(a,h){if(h)e:{var f=r;a=a.split(".");for(var g=0;g<a.length-1;g++){var S=a[g];if(!(S in f))break e;f=f[S]}a=a[a.length-1],g=f[a],h=h(g),h!=g&&h!=null&&e(f,a,{configurable:!0,writable:!0,value:h})}}function s(a,h){a instanceof String&&(a+="");var f=0,g=!1,S={next:function(){if(!g&&f<a.length){var R=f++;return{value:h(R,a[R]),done:!1}}return g=!0,{done:!0,value:void 0}}};return S[Symbol.iterator]=function(){return S},S}i("Array.prototype.values",function(a){return a||function(){return s(this,function(h,f){return f})}});var o=o||{},l=this||self;function u(a){var h=typeof a;return h=h!="object"?h:a?Array.isArray(a)?"array":h:"null",h=="array"||h=="object"&&typeof a.length=="number"}function c(a){var h=typeof a;return h=="object"&&a!=null||h=="function"}function d(a,h,f){return a.call.apply(a.bind,arguments)}function p(a,h,f){if(!a)throw Error();if(2<arguments.length){var g=Array.prototype.slice.call(arguments,2);return function(){var S=Array.prototype.slice.call(arguments);return Array.prototype.unshift.apply(S,g),a.apply(h,S)}}return function(){return a.apply(h,arguments)}}function m(a,h,f){return m=Function.prototype.bind&&Function.prototype.bind.toString().indexOf("native code")!=-1?d:p,m.apply(null,arguments)}function y(a,h){var f=Array.prototype.slice.call(arguments,1);return function(){var g=f.slice();return g.push.apply(g,arguments),a.apply(this,g)}}function C(a,h){function f(){}f.prototype=h.prototype,a.aa=h.prototype,a.prototype=new f,a.prototype.constructor=a,a.Qb=function(g,S,R){for(var O=Array(arguments.length-2),pe=2;pe<arguments.length;pe++)O[pe-2]=arguments[pe];return h.prototype[S].apply(g,O)}}function x(a){let h=a.length;if(0<h){let f=Array(h);for(let g=0;g<h;g++)f[g]=a[g];return f}return[]}function D(a,h){for(let f=1;f<arguments.length;f++){let g=arguments[f];if(u(g)){let S=a.length||0,R=g.length||0;a.length=S+R;for(let O=0;O<R;O++)a[S+O]=g[O]}else a.push(g)}}class q{constructor(h,f){this.i=h,this.j=f,this.h=0,this.g=null}get(){let h;return 0<this.h?(this.h--,h=this.g,this.g=h.next,h.next=null):h=this.i(),h}}function j(a){return/^[\s\xa0]*$/.test(a)}function B(){var a=l.navigator;return a&&(a=a.userAgent)?a:""}function Y(a){return Y[" "](a),a}Y[" "]=function(){};var re=B().indexOf("Gecko")!=-1&&!(B().toLowerCase().indexOf("webkit")!=-1&&B().indexOf("Edge")==-1)&&!(B().indexOf("Trident")!=-1||B().indexOf("MSIE")!=-1)&&B().indexOf("Edge")==-1;function Q(a,h,f){for(let g in a)h.call(f,a[g],g,a)}function E(a,h){for(let f in a)h.call(void 0,a[f],f,a)}function _(a){let h={};for(let f in a)h[f]=a[f];return h}let w="constructor hasOwnProperty isPrototypeOf propertyIsEnumerable toLocaleString toString valueOf".split(" ");function I(a,h){let f,g;for(let S=1;S<arguments.length;S++){g=arguments[S];for(f in g)a[f]=g[f];for(let R=0;R<w.length;R++)f=w[R],Object.prototype.hasOwnProperty.call(g,f)&&(a[f]=g[f])}}function T(a){var h=1;a=a.split(":");let f=[];for(;0<h&&a.length;)f.push(a.shift()),h--;return a.length&&f.push(a.join(":")),f}function A(a){l.setTimeout(()=>{throw a},0)}function v(){var a=Ac;let h=null;return a.g&&(h=a.g,a.g=a.g.next,a.g||(a.h=null),h.next=null),h}class nn{constructor(){this.h=this.g=null}add(h,f){let g=cs.get();g.set(h,f),this.h?this.h.next=g:this.g=g,this.h=g}}var cs=new q(()=>new d0,a=>a.reset());class d0{constructor(){this.next=this.g=this.h=null}set(h,f){this.h=h,this.g=f,this.next=null}reset(){this.next=this.g=this.h=null}}let hs,ds=!1,Ac=new nn,dg=()=>{let a=l.Promise.resolve(void 0);hs=()=>{a.then(f0)}};var f0=()=>{for(var a;a=v();){try{a.h.call(a.g)}catch(f){A(f)}var h=cs;h.j(a),100>h.h&&(h.h++,a.next=h.g,h.g=a)}ds=!1};function En(){this.s=this.s,this.C=this.C}En.prototype.s=!1,En.prototype.ma=function(){this.s||(this.s=!0,this.N())},En.prototype.N=function(){if(this.C)for(;this.C.length;)this.C.shift()()};function $e(a,h){this.type=a,this.g=this.target=h,this.defaultPrevented=!1}$e.prototype.h=function(){this.defaultPrevented=!0};var p0=function(){if(!l.addEventListener||!Object.defineProperty)return!1;var a=!1,h=Object.defineProperty({},"passive",{get:function(){a=!0}});try{let f=()=>{};l.addEventListener("test",f,h),l.removeEventListener("test",f,h)}catch{}return a}();function fs(a,h){if($e.call(this,a?a.type:""),this.relatedTarget=this.g=this.target=null,this.button=this.screenY=this.screenX=this.clientY=this.clientX=0,this.key="",this.metaKey=this.shiftKey=this.altKey=this.ctrlKey=!1,this.state=null,this.pointerId=0,this.pointerType="",this.i=null,a){var f=this.type=a.type,g=a.changedTouches&&a.changedTouches.length?a.changedTouches[0]:null;if(this.target=a.target||a.srcElement,this.g=h,h=a.relatedTarget){if(re){e:{try{Y(h.nodeName);var S=!0;break e}catch{}S=!1}S||(h=null)}}else f=="mouseover"?h=a.fromElement:f=="mouseout"&&(h=a.toElement);this.relatedTarget=h,g?(this.clientX=g.clientX!==void 0?g.clientX:g.pageX,this.clientY=g.clientY!==void 0?g.clientY:g.pageY,this.screenX=g.screenX||0,this.screenY=g.screenY||0):(this.clientX=a.clientX!==void 0?a.clientX:a.pageX,this.clientY=a.clientY!==void 0?a.clientY:a.pageY,this.screenX=a.screenX||0,this.screenY=a.screenY||0),this.button=a.button,this.key=a.key||"",this.ctrlKey=a.ctrlKey,this.altKey=a.altKey,this.shiftKey=a.shiftKey,this.metaKey=a.metaKey,this.pointerId=a.pointerId||0,this.pointerType=typeof a.pointerType=="string"?a.pointerType:m0[a.pointerType]||"",this.state=a.state,this.i=a,a.defaultPrevented&&fs.aa.h.call(this)}}C(fs,$e);var m0={2:"touch",3:"pen",4:"mouse"};fs.prototype.h=function(){fs.aa.h.call(this);var a=this.i;a.preventDefault?a.preventDefault():a.returnValue=!1};var ps="closure_listenable_"+(1e6*Math.random()|0),g0=0;function _0(a,h,f,g,S){this.listener=a,this.proxy=null,this.src=h,this.type=f,this.capture=!!g,this.ha=S,this.key=++g0,this.da=this.fa=!1}function oa(a){a.da=!0,a.listener=null,a.proxy=null,a.src=null,a.ha=null}function aa(a){this.src=a,this.g={},this.h=0}aa.prototype.add=function(a,h,f,g,S){var R=a.toString();a=this.g[R],a||(a=this.g[R]=[],this.h++);var O=Rc(a,h,g,S);return-1<O?(h=a[O],f||(h.fa=!1)):(h=new _0(h,this.src,R,!!g,S),h.fa=f,a.push(h)),h};function bc(a,h){var f=h.type;if(f in a.g){var g=a.g[f],S=Array.prototype.indexOf.call(g,h,void 0),R;(R=0<=S)&&Array.prototype.splice.call(g,S,1),R&&(oa(h),a.g[f].length==0&&(delete a.g[f],a.h--))}}function Rc(a,h,f,g){for(var S=0;S<a.length;++S){var R=a[S];if(!R.da&&R.listener==h&&R.capture==!!f&&R.ha==g)return S}return-1}var Pc="closure_lm_"+(1e6*Math.random()|0),xc={};function fg(a,h,f,g,S){if(g&&g.once)return mg(a,h,f,g,S);if(Array.isArray(h)){for(var R=0;R<h.length;R++)fg(a,h[R],f,g,S);return null}return f=Vc(f),a&&a[ps]?a.K(h,f,c(g)?!!g.capture:!!g,S):pg(a,h,f,!1,g,S)}function pg(a,h,f,g,S,R){if(!h)throw Error("Invalid event type");var O=c(S)?!!S.capture:!!S,pe=Dc(a);if(pe||(a[Pc]=pe=new aa(a)),f=pe.add(h,f,g,O,R),f.proxy)return f;if(g=y0(),f.proxy=g,g.src=a,g.listener=f,a.addEventListener)p0||(S=O),S===void 0&&(S=!1),a.addEventListener(h.toString(),g,S);else if(a.attachEvent)a.attachEvent(_g(h.toString()),g);else if(a.addListener&&a.removeListener)a.addListener(g);else throw Error("addEventListener and attachEvent are unavailable.");return f}function y0(){function a(f){return h.call(a.src,a.listener,f)}let h=v0;return a}function mg(a,h,f,g,S){if(Array.isArray(h)){for(var R=0;R<h.length;R++)mg(a,h[R],f,g,S);return null}return f=Vc(f),a&&a[ps]?a.L(h,f,c(g)?!!g.capture:!!g,S):pg(a,h,f,!0,g,S)}function gg(a,h,f,g,S){if(Array.isArray(h))for(var R=0;R<h.length;R++)gg(a,h[R],f,g,S);else g=c(g)?!!g.capture:!!g,f=Vc(f),a&&a[ps]?(a=a.i,h=String(h).toString(),h in a.g&&(R=a.g[h],f=Rc(R,f,g,S),-1<f&&(oa(R[f]),Array.prototype.splice.call(R,f,1),R.length==0&&(delete a.g[h],a.h--)))):a&&(a=Dc(a))&&(h=a.g[h.toString()],a=-1,h&&(a=Rc(h,f,g,S)),(f=-1<a?h[a]:null)&&Nc(f))}function Nc(a){if(typeof a!="number"&&a&&!a.da){var h=a.src;if(h&&h[ps])bc(h.i,a);else{var f=a.type,g=a.proxy;h.removeEventListener?h.removeEventListener(f,g,a.capture):h.detachEvent?h.detachEvent(_g(f),g):h.addListener&&h.removeListener&&h.removeListener(g),(f=Dc(h))?(bc(f,a),f.h==0&&(f.src=null,h[Pc]=null)):oa(a)}}}function _g(a){return a in xc?xc[a]:xc[a]="on"+a}function v0(a,h){if(a.da)a=!0;else{h=new fs(h,this);var f=a.listener,g=a.ha||a.src;a.fa&&Nc(a),a=f.call(g,h)}return a}function Dc(a){return a=a[Pc],a instanceof aa?a:null}var kc="__closure_events_fn_"+(1e9*Math.random()>>>0);function Vc(a){return typeof a=="function"?a:(a[kc]||(a[kc]=function(h){return a.handleEvent(h)}),a[kc])}function He(){En.call(this),this.i=new aa(this),this.M=this,this.F=null}C(He,En),He.prototype[ps]=!0,He.prototype.removeEventListener=function(a,h,f,g){gg(this,a,h,f,g)};function tt(a,h){var f,g=a.F;if(g)for(f=[];g;g=g.F)f.push(g);if(a=a.M,g=h.type||h,typeof h=="string")h=new $e(h,a);else if(h instanceof $e)h.target=h.target||a;else{var S=h;h=new $e(g,a),I(h,S)}if(S=!0,f)for(var R=f.length-1;0<=R;R--){var O=h.g=f[R];S=la(O,g,!0,h)&&S}if(O=h.g=a,S=la(O,g,!0,h)&&S,S=la(O,g,!1,h)&&S,f)for(R=0;R<f.length;R++)O=h.g=f[R],S=la(O,g,!1,h)&&S}He.prototype.N=function(){if(He.aa.N.call(this),this.i){var a=this.i,h;for(h in a.g){for(var f=a.g[h],g=0;g<f.length;g++)oa(f[g]);delete a.g[h],a.h--}}this.F=null},He.prototype.K=function(a,h,f,g){return this.i.add(String(a),h,!1,f,g)},He.prototype.L=function(a,h,f,g){return this.i.add(String(a),h,!0,f,g)};function la(a,h,f,g){if(h=a.i.g[String(h)],!h)return!0;h=h.concat();for(var S=!0,R=0;R<h.length;++R){var O=h[R];if(O&&!O.da&&O.capture==f){var pe=O.listener,ze=O.ha||O.src;O.fa&&bc(a.i,O),S=pe.call(ze,g)!==!1&&S}}return S&&!g.defaultPrevented}function yg(a,h,f){if(typeof a=="function")f&&(a=m(a,f));else if(a&&typeof a.handleEvent=="function")a=m(a.handleEvent,a);else throw Error("Invalid listener argument");return 2147483647<Number(h)?-1:l.setTimeout(a,h||0)}function vg(a){a.g=yg(()=>{a.g=null,a.i&&(a.i=!1,vg(a))},a.l);let h=a.h;a.h=null,a.m.apply(null,h)}class w0 extends En{constructor(h,f){super(),this.m=h,this.l=f,this.h=null,this.i=!1,this.g=null}j(h){this.h=arguments,this.g?this.i=!0:vg(this)}N(){super.N(),this.g&&(l.clearTimeout(this.g),this.g=null,this.i=!1,this.h=null)}}function ms(a){En.call(this),this.h=a,this.g={}}C(ms,En);var wg=[];function Eg(a){Q(a.g,function(h,f){this.g.hasOwnProperty(f)&&Nc(h)},a),a.g={}}ms.prototype.N=function(){ms.aa.N.call(this),Eg(this)},ms.prototype.handleEvent=function(){throw Error("EventHandler.handleEvent not implemented")};var Fc=l.JSON.stringify,E0=l.JSON.parse,I0=class{stringify(a){return l.JSON.stringify(a,void 0)}parse(a){return l.JSON.parse(a,void 0)}};function Oc(){}Oc.prototype.h=null;function Ig(a){return a.h||(a.h=a.i())}function Tg(){}var gs={OPEN:"a",kb:"b",Ja:"c",wb:"d"};function Mc(){$e.call(this,"d")}C(Mc,$e);function Lc(){$e.call(this,"c")}C(Lc,$e);var or={},Sg=null;function ua(){return Sg=Sg||new He}or.La="serverreachability";function Cg(a){$e.call(this,or.La,a)}C(Cg,$e);function _s(a){let h=ua();tt(h,new Cg(h))}or.STAT_EVENT="statevent";function Ag(a,h){$e.call(this,or.STAT_EVENT,a),this.stat=h}C(Ag,$e);function nt(a){let h=ua();tt(h,new Ag(h,a))}or.Ma="timingevent";function bg(a,h){$e.call(this,or.Ma,a),this.size=h}C(bg,$e);function ys(a,h){if(typeof a!="function")throw Error("Fn must not be null and must be a function");return l.setTimeout(function(){a()},h)}function vs(){this.g=!0}vs.prototype.xa=function(){this.g=!1};function T0(a,h,f,g,S,R){a.info(function(){if(a.g)if(R)for(var O="",pe=R.split("&"),ze=0;ze<pe.length;ze++){var le=pe[ze].split("=");if(1<le.length){var Ye=le[0];le=le[1];var Je=Ye.split("_");O=2<=Je.length&&Je[1]=="type"?O+(Ye+"="+le+"&"):O+(Ye+"=redacted&")}}else O=null;else O=R;return"XMLHTTP REQ ("+g+") [attempt "+S+"]: "+h+`
`+f+`
`+O})}function S0(a,h,f,g,S,R,O){a.info(function(){return"XMLHTTP RESP ("+g+") [ attempt "+S+"]: "+h+`
`+f+`
`+R+" "+O})}function Yr(a,h,f,g){a.info(function(){return"XMLHTTP TEXT ("+h+"): "+A0(a,f)+(g?" "+g:"")})}function C0(a,h){a.info(function(){return"TIMEOUT: "+h})}vs.prototype.info=function(){};function A0(a,h){if(!a.g)return h;if(!h)return null;try{var f=JSON.parse(h);if(f){for(a=0;a<f.length;a++)if(Array.isArray(f[a])){var g=f[a];if(!(2>g.length)){var S=g[1];if(Array.isArray(S)&&!(1>S.length)){var R=S[0];if(R!="noop"&&R!="stop"&&R!="close")for(var O=1;O<S.length;O++)S[O]=""}}}}return Fc(f)}catch{return h}}var ca={NO_ERROR:0,gb:1,tb:2,sb:3,nb:4,rb:5,ub:6,Ia:7,TIMEOUT:8,xb:9},Rg={lb:"complete",Hb:"success",Ja:"error",Ia:"abort",zb:"ready",Ab:"readystatechange",TIMEOUT:"timeout",vb:"incrementaldata",yb:"progress",ob:"downloadprogress",Pb:"uploadprogress"},Uc;function ha(){}C(ha,Oc),ha.prototype.g=function(){return new XMLHttpRequest},ha.prototype.i=function(){return{}},Uc=new ha;function In(a,h,f,g){this.j=a,this.i=h,this.l=f,this.R=g||1,this.U=new ms(this),this.I=45e3,this.H=null,this.o=!1,this.m=this.A=this.v=this.L=this.F=this.S=this.B=null,this.D=[],this.g=null,this.C=0,this.s=this.u=null,this.X=-1,this.J=!1,this.O=0,this.M=null,this.W=this.K=this.T=this.P=!1,this.h=new Pg}function Pg(){this.i=null,this.g="",this.h=!1}var xg={},Bc={};function qc(a,h,f){a.L=1,a.v=ma(rn(h)),a.m=f,a.P=!0,Ng(a,null)}function Ng(a,h){a.F=Date.now(),da(a),a.A=rn(a.v);var f=a.A,g=a.R;Array.isArray(g)||(g=[String(g)]),Kg(f.i,"t",g),a.C=0,f=a.j.J,a.h=new Pg,a.g=u_(a.j,f?h:null,!a.m),0<a.O&&(a.M=new w0(m(a.Y,a,a.g),a.O)),h=a.U,f=a.g,g=a.ca;var S="readystatechange";Array.isArray(S)||(S&&(wg[0]=S.toString()),S=wg);for(var R=0;R<S.length;R++){var O=fg(f,S[R],g||h.handleEvent,!1,h.h||h);if(!O)break;h.g[O.key]=O}h=a.H?_(a.H):{},a.m?(a.u||(a.u="POST"),h["Content-Type"]="application/x-www-form-urlencoded",a.g.ea(a.A,a.u,a.m,h)):(a.u="GET",a.g.ea(a.A,a.u,null,h)),_s(),T0(a.i,a.u,a.A,a.l,a.R,a.m)}In.prototype.ca=function(a){a=a.target;let h=this.M;h&&sn(a)==3?h.j():this.Y(a)},In.prototype.Y=function(a){try{if(a==this.g)e:{let Je=sn(this.g);var h=this.g.Ba();let Zr=this.g.Z();if(!(3>Je)&&(Je!=3||this.g&&(this.h.h||this.g.oa()||Xg(this.g)))){this.J||Je!=4||h==7||(h==8||0>=Zr?_s(3):_s(2)),Gc(this);var f=this.g.Z();this.X=f;t:if(Dg(this)){var g=Xg(this.g);a="";var S=g.length,R=sn(this.g)==4;if(!this.h.i){if(typeof TextDecoder>"u"){ar(this),ws(this);var O="";break t}this.h.i=new l.TextDecoder}for(h=0;h<S;h++)this.h.h=!0,a+=this.h.i.decode(g[h],{stream:!(R&&h==S-1)});g.length=0,this.h.g+=a,this.C=0,O=this.h.g}else O=this.g.oa();if(this.o=f==200,S0(this.i,this.u,this.A,this.l,this.R,Je,f),this.o){if(this.T&&!this.K){t:{if(this.g){var pe,ze=this.g;if((pe=ze.g?ze.g.getResponseHeader("X-HTTP-Initial-Response"):null)&&!j(pe)){var le=pe;break t}}le=null}if(f=le)Yr(this.i,this.l,f,"Initial handshake response via X-HTTP-Initial-Response"),this.K=!0,jc(this,f);else{this.o=!1,this.s=3,nt(12),ar(this),ws(this);break e}}if(this.P){f=!0;let Rt;for(;!this.J&&this.C<O.length;)if(Rt=b0(this,O),Rt==Bc){Je==4&&(this.s=4,nt(14),f=!1),Yr(this.i,this.l,null,"[Incomplete Response]");break}else if(Rt==xg){this.s=4,nt(15),Yr(this.i,this.l,O,"[Invalid Chunk]"),f=!1;break}else Yr(this.i,this.l,Rt,null),jc(this,Rt);if(Dg(this)&&this.C!=0&&(this.h.g=this.h.g.slice(this.C),this.C=0),Je!=4||O.length!=0||this.h.h||(this.s=1,nt(16),f=!1),this.o=this.o&&f,!f)Yr(this.i,this.l,O,"[Invalid Chunked Response]"),ar(this),ws(this);else if(0<O.length&&!this.W){this.W=!0;var Ye=this.j;Ye.g==this&&Ye.ba&&!Ye.M&&(Ye.j.info("Great, no buffering proxy detected. Bytes received: "+O.length),Hc(Ye),Ye.M=!0,nt(11))}}else Yr(this.i,this.l,O,null),jc(this,O);Je==4&&ar(this),this.o&&!this.J&&(Je==4?s_(this.j,this):(this.o=!1,da(this)))}else z0(this.g),f==400&&0<O.indexOf("Unknown SID")?(this.s=3,nt(12)):(this.s=0,nt(13)),ar(this),ws(this)}}}catch{}finally{}};function Dg(a){return a.g?a.u=="GET"&&a.L!=2&&a.j.Ca:!1}function b0(a,h){var f=a.C,g=h.indexOf(`
`,f);return g==-1?Bc:(f=Number(h.substring(f,g)),isNaN(f)?xg:(g+=1,g+f>h.length?Bc:(h=h.slice(g,g+f),a.C=g+f,h)))}In.prototype.cancel=function(){this.J=!0,ar(this)};function da(a){a.S=Date.now()+a.I,kg(a,a.I)}function kg(a,h){if(a.B!=null)throw Error("WatchDog timer not null");a.B=ys(m(a.ba,a),h)}function Gc(a){a.B&&(l.clearTimeout(a.B),a.B=null)}In.prototype.ba=function(){this.B=null;let a=Date.now();0<=a-this.S?(C0(this.i,this.A),this.L!=2&&(_s(),nt(17)),ar(this),this.s=2,ws(this)):kg(this,this.S-a)};function ws(a){a.j.G==0||a.J||s_(a.j,a)}function ar(a){Gc(a);var h=a.M;h&&typeof h.ma=="function"&&h.ma(),a.M=null,Eg(a.U),a.g&&(h=a.g,a.g=null,h.abort(),h.ma())}function jc(a,h){try{var f=a.j;if(f.G!=0&&(f.g==a||zc(f.h,a))){if(!a.K&&zc(f.h,a)&&f.G==3){try{var g=f.Da.g.parse(h)}catch{g=null}if(Array.isArray(g)&&g.length==3){var S=g;if(S[0]==0){e:if(!f.u){if(f.g)if(f.g.F+3e3<a.F)wa(f),ya(f);else break e;$c(f),nt(18)}}else f.za=S[1],0<f.za-f.T&&37500>S[2]&&f.F&&f.v==0&&!f.C&&(f.C=ys(m(f.Za,f),6e3));if(1>=Og(f.h)&&f.ca){try{f.ca()}catch{}f.ca=void 0}}else ur(f,11)}else if((a.K||f.g==a)&&wa(f),!j(h))for(S=f.Da.g.parse(h),h=0;h<S.length;h++){let le=S[h];if(f.T=le[0],le=le[1],f.G==2)if(le[0]=="c"){f.K=le[1],f.ia=le[2];let Ye=le[3];Ye!=null&&(f.la=Ye,f.j.info("VER="+f.la));let Je=le[4];Je!=null&&(f.Aa=Je,f.j.info("SVER="+f.Aa));let Zr=le[5];Zr!=null&&typeof Zr=="number"&&0<Zr&&(g=1.5*Zr,f.L=g,f.j.info("backChannelRequestTimeoutMs_="+g)),g=f;let Rt=a.g;if(Rt){let Ia=Rt.g?Rt.g.getResponseHeader("X-Client-Wire-Protocol"):null;if(Ia){var R=g.h;R.g||Ia.indexOf("spdy")==-1&&Ia.indexOf("quic")==-1&&Ia.indexOf("h2")==-1||(R.j=R.l,R.g=new Set,R.h&&(Kc(R,R.h),R.h=null))}if(g.D){let Yc=Rt.g?Rt.g.getResponseHeader("X-HTTP-Session-Id"):null;Yc&&(g.ya=Yc,ve(g.I,g.D,Yc))}}f.G=3,f.l&&f.l.ua(),f.ba&&(f.R=Date.now()-a.F,f.j.info("Handshake RTT: "+f.R+"ms")),g=f;var O=a;if(g.qa=l_(g,g.J?g.ia:null,g.W),O.K){Mg(g.h,O);var pe=O,ze=g.L;ze&&(pe.I=ze),pe.B&&(Gc(pe),da(pe)),g.g=O}else r_(g);0<f.i.length&&va(f)}else le[0]!="stop"&&le[0]!="close"||ur(f,7);else f.G==3&&(le[0]=="stop"||le[0]=="close"?le[0]=="stop"?ur(f,7):Qc(f):le[0]!="noop"&&f.l&&f.l.ta(le),f.v=0)}}_s(4)}catch{}}var R0=class{constructor(a,h){this.g=a,this.map=h}};function Vg(a){this.l=a||10,l.PerformanceNavigationTiming?(a=l.performance.getEntriesByType("navigation"),a=0<a.length&&(a[0].nextHopProtocol=="hq"||a[0].nextHopProtocol=="h2")):a=!!(l.chrome&&l.chrome.loadTimes&&l.chrome.loadTimes()&&l.chrome.loadTimes().wasFetchedViaSpdy),this.j=a?this.l:1,this.g=null,1<this.j&&(this.g=new Set),this.h=null,this.i=[]}function Fg(a){return a.h?!0:a.g?a.g.size>=a.j:!1}function Og(a){return a.h?1:a.g?a.g.size:0}function zc(a,h){return a.h?a.h==h:a.g?a.g.has(h):!1}function Kc(a,h){a.g?a.g.add(h):a.h=h}function Mg(a,h){a.h&&a.h==h?a.h=null:a.g&&a.g.has(h)&&a.g.delete(h)}Vg.prototype.cancel=function(){if(this.i=Lg(this),this.h)this.h.cancel(),this.h=null;else if(this.g&&this.g.size!==0){for(let a of this.g.values())a.cancel();this.g.clear()}};function Lg(a){if(a.h!=null)return a.i.concat(a.h.D);if(a.g!=null&&a.g.size!==0){let h=a.i;for(let f of a.g.values())h=h.concat(f.D);return h}return x(a.i)}function P0(a){if(a.V&&typeof a.V=="function")return a.V();if(typeof Map<"u"&&a instanceof Map||typeof Set<"u"&&a instanceof Set)return Array.from(a.values());if(typeof a=="string")return a.split("");if(u(a)){for(var h=[],f=a.length,g=0;g<f;g++)h.push(a[g]);return h}h=[],f=0;for(g in a)h[f++]=a[g];return h}function x0(a){if(a.na&&typeof a.na=="function")return a.na();if(!a.V||typeof a.V!="function"){if(typeof Map<"u"&&a instanceof Map)return Array.from(a.keys());if(!(typeof Set<"u"&&a instanceof Set)){if(u(a)||typeof a=="string"){var h=[];a=a.length;for(var f=0;f<a;f++)h.push(f);return h}h=[],f=0;for(let g in a)h[f++]=g;return h}}}function Ug(a,h){if(a.forEach&&typeof a.forEach=="function")a.forEach(h,void 0);else if(u(a)||typeof a=="string")Array.prototype.forEach.call(a,h,void 0);else for(var f=x0(a),g=P0(a),S=g.length,R=0;R<S;R++)h.call(void 0,g[R],f&&f[R],a)}var Bg=RegExp("^(?:([^:/?#.]+):)?(?://(?:([^\\\\/?#]*)@)?([^\\\\/?#]*?)(?::([0-9]+))?(?=[\\\\/?#]|$))?([^?#]+)?(?:\\?([^#]*))?(?:#([\\s\\S]*))?$");function N0(a,h){if(a){a=a.split("&");for(var f=0;f<a.length;f++){var g=a[f].indexOf("="),S=null;if(0<=g){var R=a[f].substring(0,g);S=a[f].substring(g+1)}else R=a[f];h(R,S?decodeURIComponent(S.replace(/\+/g," ")):"")}}}function lr(a){if(this.g=this.o=this.j="",this.s=null,this.m=this.l="",this.h=!1,a instanceof lr){this.h=a.h,fa(this,a.j),this.o=a.o,this.g=a.g,pa(this,a.s),this.l=a.l;var h=a.i,f=new Ts;f.i=h.i,h.g&&(f.g=new Map(h.g),f.h=h.h),qg(this,f),this.m=a.m}else a&&(h=String(a).match(Bg))?(this.h=!1,fa(this,h[1]||"",!0),this.o=Es(h[2]||""),this.g=Es(h[3]||"",!0),pa(this,h[4]),this.l=Es(h[5]||"",!0),qg(this,h[6]||"",!0),this.m=Es(h[7]||"")):(this.h=!1,this.i=new Ts(null,this.h))}lr.prototype.toString=function(){var a=[],h=this.j;h&&a.push(Is(h,Gg,!0),":");var f=this.g;return(f||h=="file")&&(a.push("//"),(h=this.o)&&a.push(Is(h,Gg,!0),"@"),a.push(encodeURIComponent(String(f)).replace(/%25([0-9a-fA-F]{2})/g,"%$1")),f=this.s,f!=null&&a.push(":",String(f))),(f=this.l)&&(this.g&&f.charAt(0)!="/"&&a.push("/"),a.push(Is(f,f.charAt(0)=="/"?V0:k0,!0))),(f=this.i.toString())&&a.push("?",f),(f=this.m)&&a.push("#",Is(f,O0)),a.join("")};function rn(a){return new lr(a)}function fa(a,h,f){a.j=f?Es(h,!0):h,a.j&&(a.j=a.j.replace(/:$/,""))}function pa(a,h){if(h){if(h=Number(h),isNaN(h)||0>h)throw Error("Bad port number "+h);a.s=h}else a.s=null}function qg(a,h,f){h instanceof Ts?(a.i=h,M0(a.i,a.h)):(f||(h=Is(h,F0)),a.i=new Ts(h,a.h))}function ve(a,h,f){a.i.set(h,f)}function ma(a){return ve(a,"zx",Math.floor(2147483648*Math.random()).toString(36)+Math.abs(Math.floor(2147483648*Math.random())^Date.now()).toString(36)),a}function Es(a,h){return a?h?decodeURI(a.replace(/%25/g,"%2525")):decodeURIComponent(a):""}function Is(a,h,f){return typeof a=="string"?(a=encodeURI(a).replace(h,D0),f&&(a=a.replace(/%25([0-9a-fA-F]{2})/g,"%$1")),a):null}function D0(a){return a=a.charCodeAt(0),"%"+(a>>4&15).toString(16)+(a&15).toString(16)}var Gg=/[#\/\?@]/g,k0=/[#\?:]/g,V0=/[#\?]/g,F0=/[#\?@]/g,O0=/#/g;function Ts(a,h){this.h=this.g=null,this.i=a||null,this.j=!!h}function Tn(a){a.g||(a.g=new Map,a.h=0,a.i&&N0(a.i,function(h,f){a.add(decodeURIComponent(h.replace(/\+/g," ")),f)}))}n=Ts.prototype,n.add=function(a,h){Tn(this),this.i=null,a=Jr(this,a);var f=this.g.get(a);return f||this.g.set(a,f=[]),f.push(h),this.h+=1,this};function jg(a,h){Tn(a),h=Jr(a,h),a.g.has(h)&&(a.i=null,a.h-=a.g.get(h).length,a.g.delete(h))}function zg(a,h){return Tn(a),h=Jr(a,h),a.g.has(h)}n.forEach=function(a,h){Tn(this),this.g.forEach(function(f,g){f.forEach(function(S){a.call(h,S,g,this)},this)},this)},n.na=function(){Tn(this);let a=Array.from(this.g.values()),h=Array.from(this.g.keys()),f=[];for(let g=0;g<h.length;g++){let S=a[g];for(let R=0;R<S.length;R++)f.push(h[g])}return f},n.V=function(a){Tn(this);let h=[];if(typeof a=="string")zg(this,a)&&(h=h.concat(this.g.get(Jr(this,a))));else{a=Array.from(this.g.values());for(let f=0;f<a.length;f++)h=h.concat(a[f])}return h},n.set=function(a,h){return Tn(this),this.i=null,a=Jr(this,a),zg(this,a)&&(this.h-=this.g.get(a).length),this.g.set(a,[h]),this.h+=1,this},n.get=function(a,h){return a?(a=this.V(a),0<a.length?String(a[0]):h):h};function Kg(a,h,f){jg(a,h),0<f.length&&(a.i=null,a.g.set(Jr(a,h),x(f)),a.h+=f.length)}n.toString=function(){if(this.i)return this.i;if(!this.g)return"";let a=[],h=Array.from(this.g.keys());for(var f=0;f<h.length;f++){var g=h[f];let R=encodeURIComponent(String(g)),O=this.V(g);for(g=0;g<O.length;g++){var S=R;O[g]!==""&&(S+="="+encodeURIComponent(String(O[g]))),a.push(S)}}return this.i=a.join("&")};function Jr(a,h){return h=String(h),a.j&&(h=h.toLowerCase()),h}function M0(a,h){h&&!a.j&&(Tn(a),a.i=null,a.g.forEach(function(f,g){var S=g.toLowerCase();g!=S&&(jg(this,g),Kg(this,S,f))},a)),a.j=h}function L0(a,h){let f=new vs;if(l.Image){let g=new Image;g.onload=y(Sn,f,"TestLoadImage: loaded",!0,h,g),g.onerror=y(Sn,f,"TestLoadImage: error",!1,h,g),g.onabort=y(Sn,f,"TestLoadImage: abort",!1,h,g),g.ontimeout=y(Sn,f,"TestLoadImage: timeout",!1,h,g),l.setTimeout(function(){g.ontimeout&&g.ontimeout()},1e4),g.src=a}else h(!1)}function U0(a,h){let f=new vs,g=new AbortController,S=setTimeout(()=>{g.abort(),Sn(f,"TestPingServer: timeout",!1,h)},1e4);fetch(a,{signal:g.signal}).then(R=>{clearTimeout(S),R.ok?Sn(f,"TestPingServer: ok",!0,h):Sn(f,"TestPingServer: server error",!1,h)}).catch(()=>{clearTimeout(S),Sn(f,"TestPingServer: error",!1,h)})}function Sn(a,h,f,g,S){try{S&&(S.onload=null,S.onerror=null,S.onabort=null,S.ontimeout=null),g(f)}catch{}}function B0(){this.g=new I0}function q0(a,h,f){let g=f||"";try{Ug(a,function(S,R){let O=S;c(S)&&(O=Fc(S)),h.push(g+R+"="+encodeURIComponent(O))})}catch(S){throw h.push(g+"type="+encodeURIComponent("_badmap")),S}}function Ss(a){this.l=a.Ub||null,this.j=a.eb||!1}C(Ss,Oc),Ss.prototype.g=function(){return new ga(this.l,this.j)},Ss.prototype.i=function(a){return function(){return a}}({});function ga(a,h){He.call(this),this.D=a,this.o=h,this.m=void 0,this.status=this.readyState=0,this.responseType=this.responseText=this.response=this.statusText="",this.onreadystatechange=null,this.u=new Headers,this.h=null,this.B="GET",this.A="",this.g=!1,this.v=this.j=this.l=null}C(ga,He),n=ga.prototype,n.open=function(a,h){if(this.readyState!=0)throw this.abort(),Error("Error reopening a connection");this.B=a,this.A=h,this.readyState=1,As(this)},n.send=function(a){if(this.readyState!=1)throw this.abort(),Error("need to call open() first. ");this.g=!0;let h={headers:this.u,method:this.B,credentials:this.m,cache:void 0};a&&(h.body=a),(this.D||l).fetch(new Request(this.A,h)).then(this.Sa.bind(this),this.ga.bind(this))},n.abort=function(){this.response=this.responseText="",this.u=new Headers,this.status=0,this.j&&this.j.cancel("Request was aborted.").catch(()=>{}),1<=this.readyState&&this.g&&this.readyState!=4&&(this.g=!1,Cs(this)),this.readyState=0},n.Sa=function(a){if(this.g&&(this.l=a,this.h||(this.status=this.l.status,this.statusText=this.l.statusText,this.h=a.headers,this.readyState=2,As(this)),this.g&&(this.readyState=3,As(this),this.g)))if(this.responseType==="arraybuffer")a.arrayBuffer().then(this.Qa.bind(this),this.ga.bind(this));else if(typeof l.ReadableStream<"u"&&"body"in a){if(this.j=a.body.getReader(),this.o){if(this.responseType)throw Error('responseType must be empty for "streamBinaryChunks" mode responses.');this.response=[]}else this.response=this.responseText="",this.v=new TextDecoder;Wg(this)}else a.text().then(this.Ra.bind(this),this.ga.bind(this))};function Wg(a){a.j.read().then(a.Pa.bind(a)).catch(a.ga.bind(a))}n.Pa=function(a){if(this.g){if(this.o&&a.value)this.response.push(a.value);else if(!this.o){var h=a.value?a.value:new Uint8Array(0);(h=this.v.decode(h,{stream:!a.done}))&&(this.response=this.responseText+=h)}a.done?Cs(this):As(this),this.readyState==3&&Wg(this)}},n.Ra=function(a){this.g&&(this.response=this.responseText=a,Cs(this))},n.Qa=function(a){this.g&&(this.response=a,Cs(this))},n.ga=function(){this.g&&Cs(this)};function Cs(a){a.readyState=4,a.l=null,a.j=null,a.v=null,As(a)}n.setRequestHeader=function(a,h){this.u.append(a,h)},n.getResponseHeader=function(a){return this.h&&this.h.get(a.toLowerCase())||""},n.getAllResponseHeaders=function(){if(!this.h)return"";let a=[],h=this.h.entries();for(var f=h.next();!f.done;)f=f.value,a.push(f[0]+": "+f[1]),f=h.next();return a.join(`\r
`)};function As(a){a.onreadystatechange&&a.onreadystatechange.call(a)}Object.defineProperty(ga.prototype,"withCredentials",{get:function(){return this.m==="include"},set:function(a){this.m=a?"include":"same-origin"}});function Qg(a){let h="";return Q(a,function(f,g){h+=g,h+=":",h+=f,h+=`\r
`}),h}function Wc(a,h,f){e:{for(g in f){var g=!1;break e}g=!0}g||(f=Qg(f),typeof a=="string"?f!=null&&encodeURIComponent(String(f)):ve(a,h,f))}function Ae(a){He.call(this),this.headers=new Map,this.o=a||null,this.h=!1,this.v=this.g=null,this.D="",this.m=0,this.l="",this.j=this.B=this.u=this.A=!1,this.I=null,this.H="",this.J=!1}C(Ae,He);var G0=/^https?$/i,j0=["POST","PUT"];n=Ae.prototype,n.Ha=function(a){this.J=a},n.ea=function(a,h,f,g){if(this.g)throw Error("[goog.net.XhrIo] Object is active with another request="+this.D+"; newUri="+a);h=h?h.toUpperCase():"GET",this.D=a,this.l="",this.m=0,this.A=!1,this.h=!0,this.g=this.o?this.o.g():Uc.g(),this.v=this.o?Ig(this.o):Ig(Uc),this.g.onreadystatechange=m(this.Ea,this);try{this.B=!0,this.g.open(h,String(a),!0),this.B=!1}catch(R){$g(this,R);return}if(a=f||"",f=new Map(this.headers),g)if(Object.getPrototypeOf(g)===Object.prototype)for(var S in g)f.set(S,g[S]);else if(typeof g.keys=="function"&&typeof g.get=="function")for(let R of g.keys())f.set(R,g.get(R));else throw Error("Unknown input type for opt_headers: "+String(g));g=Array.from(f.keys()).find(R=>R.toLowerCase()=="content-type"),S=l.FormData&&a instanceof l.FormData,!(0<=Array.prototype.indexOf.call(j0,h,void 0))||g||S||f.set("Content-Type","application/x-www-form-urlencoded;charset=utf-8");for(let[R,O]of f)this.g.setRequestHeader(R,O);this.H&&(this.g.responseType=this.H),"withCredentials"in this.g&&this.g.withCredentials!==this.J&&(this.g.withCredentials=this.J);try{Jg(this),this.u=!0,this.g.send(a),this.u=!1}catch(R){$g(this,R)}};function $g(a,h){a.h=!1,a.g&&(a.j=!0,a.g.abort(),a.j=!1),a.l=h,a.m=5,Hg(a),_a(a)}function Hg(a){a.A||(a.A=!0,tt(a,"complete"),tt(a,"error"))}n.abort=function(a){this.g&&this.h&&(this.h=!1,this.j=!0,this.g.abort(),this.j=!1,this.m=a||7,tt(this,"complete"),tt(this,"abort"),_a(this))},n.N=function(){this.g&&(this.h&&(this.h=!1,this.j=!0,this.g.abort(),this.j=!1),_a(this,!0)),Ae.aa.N.call(this)},n.Ea=function(){this.s||(this.B||this.u||this.j?Yg(this):this.bb())},n.bb=function(){Yg(this)};function Yg(a){if(a.h&&typeof o<"u"&&(!a.v[1]||sn(a)!=4||a.Z()!=2)){if(a.u&&sn(a)==4)yg(a.Ea,0,a);else if(tt(a,"readystatechange"),sn(a)==4){a.h=!1;try{let O=a.Z();e:switch(O){case 200:case 201:case 202:case 204:case 206:case 304:case 1223:var h=!0;break e;default:h=!1}var f;if(!(f=h)){var g;if(g=O===0){var S=String(a.D).match(Bg)[1]||null;!S&&l.self&&l.self.location&&(S=l.self.location.protocol.slice(0,-1)),g=!G0.test(S?S.toLowerCase():"")}f=g}if(f)tt(a,"complete"),tt(a,"success");else{a.m=6;try{var R=2<sn(a)?a.g.statusText:""}catch{R=""}a.l=R+" ["+a.Z()+"]",Hg(a)}}finally{_a(a)}}}}function _a(a,h){if(a.g){Jg(a);let f=a.g,g=a.v[0]?()=>{}:null;a.g=null,a.v=null,h||tt(a,"ready");try{f.onreadystatechange=g}catch{}}}function Jg(a){a.I&&(l.clearTimeout(a.I),a.I=null)}n.isActive=function(){return!!this.g};function sn(a){return a.g?a.g.readyState:0}n.Z=function(){try{return 2<sn(this)?this.g.status:-1}catch{return-1}},n.oa=function(){try{return this.g?this.g.responseText:""}catch{return""}},n.Oa=function(a){if(this.g){var h=this.g.responseText;return a&&h.indexOf(a)==0&&(h=h.substring(a.length)),E0(h)}};function Xg(a){try{if(!a.g)return null;if("response"in a.g)return a.g.response;switch(a.H){case"":case"text":return a.g.responseText;case"arraybuffer":if("mozResponseArrayBuffer"in a.g)return a.g.mozResponseArrayBuffer}return null}catch{return null}}function z0(a){let h={};a=(a.g&&2<=sn(a)&&a.g.getAllResponseHeaders()||"").split(`\r
`);for(let g=0;g<a.length;g++){if(j(a[g]))continue;var f=T(a[g]);let S=f[0];if(f=f[1],typeof f!="string")continue;f=f.trim();let R=h[S]||[];h[S]=R,R.push(f)}E(h,function(g){return g.join(", ")})}n.Ba=function(){return this.m},n.Ka=function(){return typeof this.l=="string"?this.l:String(this.l)};function bs(a,h,f){return f&&f.internalChannelParams&&f.internalChannelParams[a]||h}function Zg(a){this.Aa=0,this.i=[],this.j=new vs,this.ia=this.qa=this.I=this.W=this.g=this.ya=this.D=this.H=this.m=this.S=this.o=null,this.Ya=this.U=0,this.Va=bs("failFast",!1,a),this.F=this.C=this.u=this.s=this.l=null,this.X=!0,this.za=this.T=-1,this.Y=this.v=this.B=0,this.Ta=bs("baseRetryDelayMs",5e3,a),this.cb=bs("retryDelaySeedMs",1e4,a),this.Wa=bs("forwardChannelMaxRetries",2,a),this.wa=bs("forwardChannelRequestTimeoutMs",2e4,a),this.pa=a&&a.xmlHttpFactory||void 0,this.Xa=a&&a.Tb||void 0,this.Ca=a&&a.useFetchStreams||!1,this.L=void 0,this.J=a&&a.supportsCrossDomainXhr||!1,this.K="",this.h=new Vg(a&&a.concurrentRequestLimit),this.Da=new B0,this.P=a&&a.fastHandshake||!1,this.O=a&&a.encodeInitMessageHeaders||!1,this.P&&this.O&&(this.O=!1),this.Ua=a&&a.Rb||!1,a&&a.xa&&this.j.xa(),a&&a.forceLongPolling&&(this.X=!1),this.ba=!this.P&&this.X&&a&&a.detectBufferingProxy||!1,this.ja=void 0,a&&a.longPollingTimeout&&0<a.longPollingTimeout&&(this.ja=a.longPollingTimeout),this.ca=void 0,this.R=0,this.M=!1,this.ka=this.A=null}n=Zg.prototype,n.la=8,n.G=1,n.connect=function(a,h,f,g){nt(0),this.W=a,this.H=h||{},f&&g!==void 0&&(this.H.OSID=f,this.H.OAID=g),this.F=this.X,this.I=l_(this,null,this.W),va(this)};function Qc(a){if(e_(a),a.G==3){var h=a.U++,f=rn(a.I);if(ve(f,"SID",a.K),ve(f,"RID",h),ve(f,"TYPE","terminate"),Rs(a,f),h=new In(a,a.j,h),h.L=2,h.v=ma(rn(f)),f=!1,l.navigator&&l.navigator.sendBeacon)try{f=l.navigator.sendBeacon(h.v.toString(),"")}catch{}!f&&l.Image&&(new Image().src=h.v,f=!0),f||(h.g=u_(h.j,null),h.g.ea(h.v)),h.F=Date.now(),da(h)}a_(a)}function ya(a){a.g&&(Hc(a),a.g.cancel(),a.g=null)}function e_(a){ya(a),a.u&&(l.clearTimeout(a.u),a.u=null),wa(a),a.h.cancel(),a.s&&(typeof a.s=="number"&&l.clearTimeout(a.s),a.s=null)}function va(a){if(!Fg(a.h)&&!a.s){a.s=!0;var h=a.Ga;hs||dg(),ds||(hs(),ds=!0),Ac.add(h,a),a.B=0}}function K0(a,h){return Og(a.h)>=a.h.j-(a.s?1:0)?!1:a.s?(a.i=h.D.concat(a.i),!0):a.G==1||a.G==2||a.B>=(a.Va?0:a.Wa)?!1:(a.s=ys(m(a.Ga,a,h),o_(a,a.B)),a.B++,!0)}n.Ga=function(a){if(this.s)if(this.s=null,this.G==1){if(!a){this.U=Math.floor(1e5*Math.random()),a=this.U++;let S=new In(this,this.j,a),R=this.o;if(this.S&&(R?(R=_(R),I(R,this.S)):R=this.S),this.m!==null||this.O||(S.H=R,R=null),this.P)e:{for(var h=0,f=0;f<this.i.length;f++){t:{var g=this.i[f];if("__data__"in g.map&&(g=g.map.__data__,typeof g=="string")){g=g.length;break t}g=void 0}if(g===void 0)break;if(h+=g,4096<h){h=f;break e}if(h===4096||f===this.i.length-1){h=f+1;break e}}h=1e3}else h=1e3;h=n_(this,S,h),f=rn(this.I),ve(f,"RID",a),ve(f,"CVER",22),this.D&&ve(f,"X-HTTP-Session-Id",this.D),Rs(this,f),R&&(this.O?h="headers="+encodeURIComponent(String(Qg(R)))+"&"+h:this.m&&Wc(f,this.m,R)),Kc(this.h,S),this.Ua&&ve(f,"TYPE","init"),this.P?(ve(f,"$req",h),ve(f,"SID","null"),S.T=!0,qc(S,f,null)):qc(S,f,h),this.G=2}}else this.G==3&&(a?t_(this,a):this.i.length==0||Fg(this.h)||t_(this))};function t_(a,h){var f;h?f=h.l:f=a.U++;let g=rn(a.I);ve(g,"SID",a.K),ve(g,"RID",f),ve(g,"AID",a.T),Rs(a,g),a.m&&a.o&&Wc(g,a.m,a.o),f=new In(a,a.j,f,a.B+1),a.m===null&&(f.H=a.o),h&&(a.i=h.D.concat(a.i)),h=n_(a,f,1e3),f.I=Math.round(.5*a.wa)+Math.round(.5*a.wa*Math.random()),Kc(a.h,f),qc(f,g,h)}function Rs(a,h){a.H&&Q(a.H,function(f,g){ve(h,g,f)}),a.l&&Ug({},function(f,g){ve(h,g,f)})}function n_(a,h,f){f=Math.min(a.i.length,f);var g=a.l?m(a.l.Na,a.l,a):null;e:{var S=a.i;let R=-1;for(;;){let O=["count="+f];R==-1?0<f?(R=S[0].g,O.push("ofs="+R)):R=0:O.push("ofs="+R);let pe=!0;for(let ze=0;ze<f;ze++){let le=S[ze].g,Ye=S[ze].map;if(le-=R,0>le)R=Math.max(0,S[ze].g-100),pe=!1;else try{q0(Ye,O,"req"+le+"_")}catch{g&&g(Ye)}}if(pe){g=O.join("&");break e}}}return a=a.i.splice(0,f),h.D=a,g}function r_(a){if(!a.g&&!a.u){a.Y=1;var h=a.Fa;hs||dg(),ds||(hs(),ds=!0),Ac.add(h,a),a.v=0}}function $c(a){return a.g||a.u||3<=a.v?!1:(a.Y++,a.u=ys(m(a.Fa,a),o_(a,a.v)),a.v++,!0)}n.Fa=function(){if(this.u=null,i_(this),this.ba&&!(this.M||this.g==null||0>=this.R)){var a=2*this.R;this.j.info("BP detection timer enabled: "+a),this.A=ys(m(this.ab,this),a)}},n.ab=function(){this.A&&(this.A=null,this.j.info("BP detection timeout reached."),this.j.info("Buffering proxy detected and switch to long-polling!"),this.F=!1,this.M=!0,nt(10),ya(this),i_(this))};function Hc(a){a.A!=null&&(l.clearTimeout(a.A),a.A=null)}function i_(a){a.g=new In(a,a.j,"rpc",a.Y),a.m===null&&(a.g.H=a.o),a.g.O=0;var h=rn(a.qa);ve(h,"RID","rpc"),ve(h,"SID",a.K),ve(h,"AID",a.T),ve(h,"CI",a.F?"0":"1"),!a.F&&a.ja&&ve(h,"TO",a.ja),ve(h,"TYPE","xmlhttp"),Rs(a,h),a.m&&a.o&&Wc(h,a.m,a.o),a.L&&(a.g.I=a.L);var f=a.g;a=a.ia,f.L=1,f.v=ma(rn(h)),f.m=null,f.P=!0,Ng(f,a)}n.Za=function(){this.C!=null&&(this.C=null,ya(this),$c(this),nt(19))};function wa(a){a.C!=null&&(l.clearTimeout(a.C),a.C=null)}function s_(a,h){var f=null;if(a.g==h){wa(a),Hc(a),a.g=null;var g=2}else if(zc(a.h,h))f=h.D,Mg(a.h,h),g=1;else return;if(a.G!=0){if(h.o)if(g==1){f=h.m?h.m.length:0,h=Date.now()-h.F;var S=a.B;g=ua(),tt(g,new bg(g,f)),va(a)}else r_(a);else if(S=h.s,S==3||S==0&&0<h.X||!(g==1&&K0(a,h)||g==2&&$c(a)))switch(f&&0<f.length&&(h=a.h,h.i=h.i.concat(f)),S){case 1:ur(a,5);break;case 4:ur(a,10);break;case 3:ur(a,6);break;default:ur(a,2)}}}function o_(a,h){let f=a.Ta+Math.floor(Math.random()*a.cb);return a.isActive()||(f*=2),f*h}function ur(a,h){if(a.j.info("Error code "+h),h==2){var f=m(a.fb,a),g=a.Xa;let S=!g;g=new lr(g||"//www.google.com/images/cleardot.gif"),l.location&&l.location.protocol=="http"||fa(g,"https"),ma(g),S?L0(g.toString(),f):U0(g.toString(),f)}else nt(2);a.G=0,a.l&&a.l.sa(h),a_(a),e_(a)}n.fb=function(a){a?(this.j.info("Successfully pinged google.com"),nt(2)):(this.j.info("Failed to ping google.com"),nt(1))};function a_(a){if(a.G=0,a.ka=[],a.l){let h=Lg(a.h);(h.length!=0||a.i.length!=0)&&(D(a.ka,h),D(a.ka,a.i),a.h.i.length=0,x(a.i),a.i.length=0),a.l.ra()}}function l_(a,h,f){var g=f instanceof lr?rn(f):new lr(f);if(g.g!="")h&&(g.g=h+"."+g.g),pa(g,g.s);else{var S=l.location;g=S.protocol,h=h?h+"."+S.hostname:S.hostname,S=+S.port;var R=new lr(null);g&&fa(R,g),h&&(R.g=h),S&&pa(R,S),f&&(R.l=f),g=R}return f=a.D,h=a.ya,f&&h&&ve(g,f,h),ve(g,"VER",a.la),Rs(a,g),g}function u_(a,h,f){if(h&&!a.J)throw Error("Can't create secondary domain capable XhrIo object.");return h=a.Ca&&!a.pa?new Ae(new Ss({eb:f})):new Ae(a.pa),h.Ha(a.J),h}n.isActive=function(){return!!this.l&&this.l.isActive(this)};function c_(){}n=c_.prototype,n.ua=function(){},n.ta=function(){},n.sa=function(){},n.ra=function(){},n.isActive=function(){return!0},n.Na=function(){};function Ea(){}Ea.prototype.g=function(a,h){return new dt(a,h)};function dt(a,h){He.call(this),this.g=new Zg(h),this.l=a,this.h=h&&h.messageUrlParams||null,a=h&&h.messageHeaders||null,h&&h.clientProtocolHeaderRequired&&(a?a["X-Client-Protocol"]="webchannel":a={"X-Client-Protocol":"webchannel"}),this.g.o=a,a=h&&h.initMessageHeaders||null,h&&h.messageContentType&&(a?a["X-WebChannel-Content-Type"]=h.messageContentType:a={"X-WebChannel-Content-Type":h.messageContentType}),h&&h.va&&(a?a["X-WebChannel-Client-Profile"]=h.va:a={"X-WebChannel-Client-Profile":h.va}),this.g.S=a,(a=h&&h.Sb)&&!j(a)&&(this.g.m=a),this.v=h&&h.supportsCrossDomainXhr||!1,this.u=h&&h.sendRawJson||!1,(h=h&&h.httpSessionIdParam)&&!j(h)&&(this.g.D=h,a=this.h,a!==null&&h in a&&(a=this.h,h in a&&delete a[h])),this.j=new Xr(this)}C(dt,He),dt.prototype.m=function(){this.g.l=this.j,this.v&&(this.g.J=!0),this.g.connect(this.l,this.h||void 0)},dt.prototype.close=function(){Qc(this.g)},dt.prototype.o=function(a){var h=this.g;if(typeof a=="string"){var f={};f.__data__=a,a=f}else this.u&&(f={},f.__data__=Fc(a),a=f);h.i.push(new R0(h.Ya++,a)),h.G==3&&va(h)},dt.prototype.N=function(){this.g.l=null,delete this.j,Qc(this.g),delete this.g,dt.aa.N.call(this)};function h_(a){Mc.call(this),a.__headers__&&(this.headers=a.__headers__,this.statusCode=a.__status__,delete a.__headers__,delete a.__status__);var h=a.__sm__;if(h){e:{for(let f in h){a=f;break e}a=void 0}(this.i=a)&&(a=this.i,h=h!==null&&a in h?h[a]:void 0),this.data=h}else this.data=a}C(h_,Mc);function d_(){Lc.call(this),this.status=1}C(d_,Lc);function Xr(a){this.g=a}C(Xr,c_),Xr.prototype.ua=function(){tt(this.g,"a")},Xr.prototype.ta=function(a){tt(this.g,new h_(a))},Xr.prototype.sa=function(a){tt(this.g,new d_)},Xr.prototype.ra=function(){tt(this.g,"b")},Ea.prototype.createWebChannel=Ea.prototype.g,dt.prototype.send=dt.prototype.o,dt.prototype.open=dt.prototype.m,dt.prototype.close=dt.prototype.close,lf=hn.createWebChannelTransport=function(){return new Ea},af=hn.getStatEventTarget=function(){return ua()},of=hn.Event=or,Zl=hn.Stat={mb:0,pb:1,qb:2,Jb:3,Ob:4,Lb:5,Mb:6,Kb:7,Ib:8,Nb:9,PROXY:10,NOPROXY:11,Gb:12,Cb:13,Db:14,Bb:15,Eb:16,Fb:17,ib:18,hb:19,jb:20},ca.NO_ERROR=0,ca.TIMEOUT=8,ca.HTTP_ERROR=6,yo=hn.ErrorCode=ca,Rg.COMPLETE="complete",sf=hn.EventType=Rg,Tg.EventType=gs,gs.OPEN="a",gs.CLOSE="b",gs.ERROR="c",gs.MESSAGE="d",He.prototype.listen=He.prototype.K,Ii=hn.WebChannel=Tg,eb=hn.FetchXmlHttpFactory=Ss,Ae.prototype.listenOnce=Ae.prototype.L,Ae.prototype.getLastError=Ae.prototype.Ka,Ae.prototype.getLastErrorCode=Ae.prototype.Ba,Ae.prototype.getStatus=Ae.prototype.Z,Ae.prototype.getResponseJson=Ae.prototype.Oa,Ae.prototype.getResponseText=Ae.prototype.oa,Ae.prototype.send=Ae.prototype.ea,Ae.prototype.setWithCredentials=Ae.prototype.Ha,rf=hn.XhrIo=Ae}).apply(typeof Xl<"u"?Xl:typeof self<"u"?self:typeof window<"u"?window:{});var bw="@firebase/firestore";var Oe=class{constructor(e){this.uid=e}isAuthenticated(){return this.uid!=null}toKey(){return this.isAuthenticated()?"uid:"+this.uid:"anonymous-user"}isEqual(e){return e.uid===this.uid}};Oe.UNAUTHENTICATED=new Oe(null),Oe.GOOGLE_CREDENTIALS=new Oe("google-credentials-uid"),Oe.FIRST_PARTY=new Oe("first-party-uid"),Oe.MOCK_USER=new Oe("mock-user");var Zi="10.14.0";var Qn=new ri("@firebase/firestore");function bi(){return Qn.logLevel}function xE(n){Qn.setLogLevel(n)}function V(n,...e){if(Qn.logLevel<=Et.DEBUG){let t=e.map(fm);Qn.debug(`Firestore (${Zi}): ${n}`,...t)}}function Re(n,...e){if(Qn.logLevel<=Et.ERROR){let t=e.map(fm);Qn.error(`Firestore (${Zi}): ${n}`,...t)}}function Dt(n,...e){if(Qn.logLevel<=Et.WARN){let t=e.map(fm);Qn.warn(`Firestore (${Zi}): ${n}`,...t)}}function fm(n){if(typeof n=="string")return n;try{return function(t){return JSON.stringify(t)}(n)}catch{return n}}function U(n="Unexpected state"){let e=`FIRESTORE (${Zi}) INTERNAL ASSERTION FAILED: `+n;throw Re(e),new Error(e)}function G(n,e){n||U()}function NE(n,e){n||U()}function M(n,e){return n}var P={OK:"ok",CANCELLED:"cancelled",UNKNOWN:"unknown",INVALID_ARGUMENT:"invalid-argument",DEADLINE_EXCEEDED:"deadline-exceeded",NOT_FOUND:"not-found",ALREADY_EXISTS:"already-exists",PERMISSION_DENIED:"permission-denied",UNAUTHENTICATED:"unauthenticated",RESOURCE_EXHAUSTED:"resource-exhausted",FAILED_PRECONDITION:"failed-precondition",ABORTED:"aborted",OUT_OF_RANGE:"out-of-range",UNIMPLEMENTED:"unimplemented",INTERNAL:"internal",UNAVAILABLE:"unavailable",DATA_LOSS:"data-loss"},k=class extends L_{constructor(e,t){super(e,t),this.code=e,this.message=t,this.toString=()=>`${this.name}: [code=${this.code}]: ${this.message}`}};var Be=class{constructor(){this.promise=new Promise((e,t)=>{this.resolve=e,this.reject=t})}};var uu=class{constructor(e,t){this.user=t,this.type="OAuth",this.headers=new Map,this.headers.set("Authorization",`Bearer ${e}`)}},pf=class{getToken(){return Promise.resolve(null)}invalidateToken(){}start(e,t){e.enqueueRetryable(()=>t(Oe.UNAUTHENTICATED))}shutdown(){}},mf=class{constructor(e){this.token=e,this.changeListener=null}getToken(){return Promise.resolve(this.token)}invalidateToken(){}start(e,t){this.changeListener=t,e.enqueueRetryable(()=>t(this.token.user))}shutdown(){this.changeListener=null}},gf=class{constructor(e){this.t=e,this.currentUser=Oe.UNAUTHENTICATED,this.i=0,this.forceRefresh=!1,this.auth=null}start(e,t){G(this.o===void 0);let r=this.i,i=u=>this.i!==r?(r=this.i,t(u)):Promise.resolve(),s=new Be;this.o=()=>{this.i++,this.currentUser=this.u(),s.resolve(),s=new Be,e.enqueueRetryable(()=>i(this.currentUser))};let o=()=>{let u=s;e.enqueueRetryable(()=>N(this,null,function*(){yield u.promise,yield i(this.currentUser)}))},l=u=>{V("FirebaseAuthCredentialsProvider","Auth detected"),this.auth=u,this.o&&(this.auth.addAuthTokenListener(this.o),o())};this.t.onInit(u=>l(u)),setTimeout(()=>{if(!this.auth){let u=this.t.getImmediate({optional:!0});u?l(u):(V("FirebaseAuthCredentialsProvider","Auth not yet detected"),s.resolve(),s=new Be)}},0),o()}getToken(){let e=this.i,t=this.forceRefresh;return this.forceRefresh=!1,this.auth?this.auth.getToken(t).then(r=>this.i!==e?(V("FirebaseAuthCredentialsProvider","getToken aborted due to token change."),this.getToken()):r?(G(typeof r.accessToken=="string"),new uu(r.accessToken,this.currentUser)):null):Promise.resolve(null)}invalidateToken(){this.forceRefresh=!0}shutdown(){this.auth&&this.o&&this.auth.removeAuthTokenListener(this.o),this.o=void 0}u(){let e=this.auth&&this.auth.getUid();return G(e===null||typeof e=="string"),new Oe(e)}},_f=class{constructor(e,t,r){this.l=e,this.h=t,this.P=r,this.type="FirstParty",this.user=Oe.FIRST_PARTY,this.I=new Map}T(){return this.P?this.P():null}get headers(){this.I.set("X-Goog-AuthUser",this.l);let e=this.T();return e&&this.I.set("Authorization",e),this.h&&this.I.set("X-Goog-Iam-Authorization-Token",this.h),this.I}},yf=class{constructor(e,t,r){this.l=e,this.h=t,this.P=r}getToken(){return Promise.resolve(new _f(this.l,this.h,this.P))}start(e,t){e.enqueueRetryable(()=>t(Oe.FIRST_PARTY))}shutdown(){}invalidateToken(){}},vf=class{constructor(e){this.value=e,this.type="AppCheck",this.headers=new Map,e&&e.length>0&&this.headers.set("x-firebase-appcheck",this.value)}},wf=class{constructor(e){this.A=e,this.forceRefresh=!1,this.appCheck=null,this.R=null}start(e,t){G(this.o===void 0);let r=s=>{s.error!=null&&V("FirebaseAppCheckTokenProvider",`Error getting App Check token; using placeholder token instead. Error: ${s.error.message}`);let o=s.token!==this.R;return this.R=s.token,V("FirebaseAppCheckTokenProvider",`Received ${o?"new":"existing"} token.`),o?t(s.token):Promise.resolve()};this.o=s=>{e.enqueueRetryable(()=>r(s))};let i=s=>{V("FirebaseAppCheckTokenProvider","AppCheck detected"),this.appCheck=s,this.o&&this.appCheck.addTokenListener(this.o)};this.A.onInit(s=>i(s)),setTimeout(()=>{if(!this.appCheck){let s=this.A.getImmediate({optional:!0});s?i(s):V("FirebaseAppCheckTokenProvider","AppCheck not yet detected")}},0)}getToken(){let e=this.forceRefresh;return this.forceRefresh=!1,this.appCheck?this.appCheck.getToken(e).then(t=>t?(G(typeof t.token=="string"),this.R=t.token,new vf(t.token)):null):Promise.resolve(null)}invalidateToken(){this.forceRefresh=!0}shutdown(){this.appCheck&&this.o&&this.appCheck.removeTokenListener(this.o),this.o=void 0}};function tb(n){let e=typeof self<"u"&&(self.crypto||self.msCrypto),t=new Uint8Array(n);if(e&&typeof e.getRandomValues=="function")e.getRandomValues(t);else for(let r=0;r<n;r++)t[r]=Math.floor(256*Math.random());return t}var cu=class{static newId(){let e="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789",t=Math.floor(256/e.length)*e.length,r="";for(;r.length<20;){let i=tb(40);for(let s=0;s<i.length;++s)r.length<20&&i[s]<t&&(r+=e.charAt(i[s]%e.length))}return r}};function W(n,e){return n<e?-1:n>e?1:0}function Oi(n,e,t){return n.length===e.length&&n.every((r,i)=>t(r,e[i]))}function DE(n){return n+"\0"}var Se=class n{constructor(e,t){if(this.seconds=e,this.nanoseconds=t,t<0)throw new k(P.INVALID_ARGUMENT,"Timestamp nanoseconds out of range: "+t);if(t>=1e9)throw new k(P.INVALID_ARGUMENT,"Timestamp nanoseconds out of range: "+t);if(e<-62135596800)throw new k(P.INVALID_ARGUMENT,"Timestamp seconds out of range: "+e);if(e>=253402300800)throw new k(P.INVALID_ARGUMENT,"Timestamp seconds out of range: "+e)}static now(){return n.fromMillis(Date.now())}static fromDate(e){return n.fromMillis(e.getTime())}static fromMillis(e){let t=Math.floor(e/1e3),r=Math.floor(1e6*(e-1e3*t));return new n(t,r)}toDate(){return new Date(this.toMillis())}toMillis(){return 1e3*this.seconds+this.nanoseconds/1e6}_compareTo(e){return this.seconds===e.seconds?W(this.nanoseconds,e.nanoseconds):W(this.seconds,e.seconds)}isEqual(e){return e.seconds===this.seconds&&e.nanoseconds===this.nanoseconds}toString(){return"Timestamp(seconds="+this.seconds+", nanoseconds="+this.nanoseconds+")"}toJSON(){return{seconds:this.seconds,nanoseconds:this.nanoseconds}}valueOf(){let e=this.seconds- -62135596800;return String(e).padStart(12,"0")+"."+String(this.nanoseconds).padStart(9,"0")}};var z=class n{constructor(e){this.timestamp=e}static fromTimestamp(e){return new n(e)}static min(){return new n(new Se(0,0))}static max(){return new n(new Se(253402300799,999999999))}compareTo(e){return this.timestamp._compareTo(e.timestamp)}isEqual(e){return this.timestamp.isEqual(e.timestamp)}toMicroseconds(){return 1e6*this.timestamp.seconds+this.timestamp.nanoseconds/1e3}toString(){return"SnapshotVersion("+this.timestamp.toString()+")"}toTimestamp(){return this.timestamp}};var hu=class n{constructor(e,t,r){t===void 0?t=0:t>e.length&&U(),r===void 0?r=e.length-t:r>e.length-t&&U(),this.segments=e,this.offset=t,this.len=r}get length(){return this.len}isEqual(e){return n.comparator(this,e)===0}child(e){let t=this.segments.slice(this.offset,this.limit());return e instanceof n?e.forEach(r=>{t.push(r)}):t.push(e),this.construct(t)}limit(){return this.offset+this.length}popFirst(e){return e=e===void 0?1:e,this.construct(this.segments,this.offset+e,this.length-e)}popLast(){return this.construct(this.segments,this.offset,this.length-1)}firstSegment(){return this.segments[this.offset]}lastSegment(){return this.get(this.length-1)}get(e){return this.segments[this.offset+e]}isEmpty(){return this.length===0}isPrefixOf(e){if(e.length<this.length)return!1;for(let t=0;t<this.length;t++)if(this.get(t)!==e.get(t))return!1;return!0}isImmediateParentOf(e){if(this.length+1!==e.length)return!1;for(let t=0;t<this.length;t++)if(this.get(t)!==e.get(t))return!1;return!0}forEach(e){for(let t=this.offset,r=this.limit();t<r;t++)e(this.segments[t])}toArray(){return this.segments.slice(this.offset,this.limit())}static comparator(e,t){let r=Math.min(e.length,t.length);for(let i=0;i<r;i++){let s=e.get(i),o=t.get(i);if(s<o)return-1;if(s>o)return 1}return e.length<t.length?-1:e.length>t.length?1:0}},oe=class n extends hu{construct(e,t,r){return new n(e,t,r)}canonicalString(){return this.toArray().join("/")}toString(){return this.canonicalString()}toUriEncodedString(){return this.toArray().map(encodeURIComponent).join("/")}static fromString(...e){let t=[];for(let r of e){if(r.indexOf("//")>=0)throw new k(P.INVALID_ARGUMENT,`Invalid segment (${r}). Paths must not contain // in them.`);t.push(...r.split("/").filter(i=>i.length>0))}return new n(t)}static emptyPath(){return new n([])}},nb=/^[_a-zA-Z][_a-zA-Z0-9]*$/,Pe=class n extends hu{construct(e,t,r){return new n(e,t,r)}static isValidIdentifier(e){return nb.test(e)}canonicalString(){return this.toArray().map(e=>(e=e.replace(/\\/g,"\\\\").replace(/`/g,"\\`"),n.isValidIdentifier(e)||(e="`"+e+"`"),e)).join(".")}toString(){return this.canonicalString()}isKeyField(){return this.length===1&&this.get(0)==="__name__"}static keyField(){return new n(["__name__"])}static fromServerFormat(e){let t=[],r="",i=0,s=()=>{if(r.length===0)throw new k(P.INVALID_ARGUMENT,`Invalid field path (${e}). Paths must not be empty, begin with '.', end with '.', or contain '..'`);t.push(r),r=""},o=!1;for(;i<e.length;){let l=e[i];if(l==="\\"){if(i+1===e.length)throw new k(P.INVALID_ARGUMENT,"Path has trailing escape character: "+e);let u=e[i+1];if(u!=="\\"&&u!=="."&&u!=="`")throw new k(P.INVALID_ARGUMENT,"Path has invalid escape sequence: "+e);r+=u,i+=2}else l==="`"?(o=!o,i++):l!=="."||o?(r+=l,i++):(s(),i++)}if(s(),o)throw new k(P.INVALID_ARGUMENT,"Unterminated ` in path: "+e);return new n(t)}static emptyPath(){return new n([])}};var L=class n{constructor(e){this.path=e}static fromPath(e){return new n(oe.fromString(e))}static fromName(e){return new n(oe.fromString(e).popFirst(5))}static empty(){return new n(oe.emptyPath())}get collectionGroup(){return this.path.popLast().lastSegment()}hasCollectionId(e){return this.path.length>=2&&this.path.get(this.path.length-2)===e}getCollectionGroup(){return this.path.get(this.path.length-2)}getCollectionPath(){return this.path.popLast()}isEqual(e){return e!==null&&oe.comparator(this.path,e.path)===0}toString(){return this.path.toString()}static comparator(e,t){return oe.comparator(e.path,t.path)}static isDocumentKey(e){return e.length%2==0}static fromSegments(e){return new n(new oe(e.slice()))}};var Mi=class{constructor(e,t,r,i){this.indexId=e,this.collectionGroup=t,this.fields=r,this.indexState=i}};function Ef(n){return n.fields.find(e=>e.kind===2)}function Cr(n){return n.fields.filter(e=>e.kind!==2)}Mi.UNKNOWN_ID=-1;var ki=class{constructor(e,t){this.fieldPath=e,this.kind=t}};var xo=class n{constructor(e,t){this.sequenceNumber=e,this.offset=t}static empty(){return new n(0,At.min())}};function kE(n,e){let t=n.toTimestamp().seconds,r=n.toTimestamp().nanoseconds+1,i=z.fromTimestamp(r===1e9?new Se(t+1,0):new Se(t,r));return new At(i,L.empty(),e)}function VE(n){return new At(n.readTime,n.key,-1)}var At=class n{constructor(e,t,r){this.readTime=e,this.documentKey=t,this.largestBatchId=r}static min(){return new n(z.min(),L.empty(),-1)}static max(){return new n(z.max(),L.empty(),-1)}};function pm(n,e){let t=n.readTime.compareTo(e.readTime);return t!==0?t:(t=L.comparator(n.documentKey,e.documentKey),t!==0?t:W(n.largestBatchId,e.largestBatchId))}var FE="The current tab is not in the required state to perform this operation. It might be necessary to refresh the browser tab.",du=class{constructor(){this.onCommittedListeners=[]}addOnCommittedListener(e){this.onCommittedListeners.push(e)}raiseOnCommittedEvent(){this.onCommittedListeners.forEach(e=>e())}};function rr(n){return N(this,null,function*(){if(n.code!==P.FAILED_PRECONDITION||n.message!==FE)throw n;V("LocalStore","Unexpectedly lost primary lease")})}var b=class n{constructor(e){this.nextCallback=null,this.catchCallback=null,this.result=void 0,this.error=void 0,this.isDone=!1,this.callbackAttached=!1,e(t=>{this.isDone=!0,this.result=t,this.nextCallback&&this.nextCallback(t)},t=>{this.isDone=!0,this.error=t,this.catchCallback&&this.catchCallback(t)})}catch(e){return this.next(void 0,e)}next(e,t){return this.callbackAttached&&U(),this.callbackAttached=!0,this.isDone?this.error?this.wrapFailure(t,this.error):this.wrapSuccess(e,this.result):new n((r,i)=>{this.nextCallback=s=>{this.wrapSuccess(e,s).next(r,i)},this.catchCallback=s=>{this.wrapFailure(t,s).next(r,i)}})}toPromise(){return new Promise((e,t)=>{this.next(e,t)})}wrapUserFunction(e){try{let t=e();return t instanceof n?t:n.resolve(t)}catch(t){return n.reject(t)}}wrapSuccess(e,t){return e?this.wrapUserFunction(()=>e(t)):n.resolve(t)}wrapFailure(e,t){return e?this.wrapUserFunction(()=>e(t)):n.reject(t)}static resolve(e){return new n((t,r)=>{t(e)})}static reject(e){return new n((t,r)=>{r(e)})}static waitFor(e){return new n((t,r)=>{let i=0,s=0,o=!1;e.forEach(l=>{++i,l.next(()=>{++s,o&&s===i&&t()},u=>r(u))}),o=!0,s===i&&t()})}static or(e){let t=n.resolve(!1);for(let r of e)t=t.next(i=>i?n.resolve(i):r());return t}static forEach(e,t){let r=[];return e.forEach((i,s)=>{r.push(t.call(this,i,s))}),this.waitFor(r)}static mapArray(e,t){return new n((r,i)=>{let s=e.length,o=new Array(s),l=0;for(let u=0;u<s;u++){let c=u;t(e[c]).next(d=>{o[c]=d,++l,l===s&&r(o)},d=>i(d))}})}static doWhile(e,t){return new n((r,i)=>{let s=()=>{e()===!0?t().next(()=>{s()},i):r()};s()})}};var fu=class n{constructor(e,t){this.action=e,this.transaction=t,this.aborted=!1,this.V=new Be,this.transaction.oncomplete=()=>{this.V.resolve()},this.transaction.onabort=()=>{t.error?this.V.reject(new Nr(e,t.error)):this.V.resolve()},this.transaction.onerror=r=>{let i=mm(r.target.error);this.V.reject(new Nr(e,i))}}static open(e,t,r,i){try{return new n(t,e.transaction(i,r))}catch(s){throw new Nr(t,s)}}get m(){return this.V.promise}abort(e){e&&this.V.reject(e),this.aborted||(V("SimpleDb","Aborting transaction:",e?e.message:"Client-initiated abort"),this.aborted=!0,this.transaction.abort())}g(){let e=this.transaction;this.aborted||typeof e.commit!="function"||e.commit()}store(e){let t=this.transaction.objectStore(e);return new Tf(t)}},$n=class n{constructor(e,t,r){this.name=e,this.version=t,this.p=r,n.S(Fs())===12.2&&Re("Firestore persistence suffers from a bug in iOS 12.2 Safari that may cause your app to stop working. See https://stackoverflow.com/q/56496296/110915 for details and a potential workaround.")}static delete(e){return V("SimpleDb","Removing database:",e),Ar(window.indexedDB.deleteDatabase(e)).toPromise()}static D(){if(!M_())return!1;if(n.v())return!0;let e=Fs(),t=n.S(e),r=0<t&&t<10,i=OE(e),s=0<i&&i<4.5;return!(e.indexOf("MSIE ")>0||e.indexOf("Trident/")>0||e.indexOf("Edge/")>0||r||s)}static v(){var e;return typeof process<"u"&&((e=process.__PRIVATE_env)===null||e===void 0?void 0:e.C)==="YES"}static F(e,t){return e.store(t)}static S(e){let t=e.match(/i(?:phone|pad|pod) os ([\d_]+)/i),r=t?t[1].split("_").slice(0,2).join("."):"-1";return Number(r)}M(e){return N(this,null,function*(){return this.db||(V("SimpleDb","Opening database:",this.name),this.db=yield new Promise((t,r)=>{let i=indexedDB.open(this.name,this.version);i.onsuccess=s=>{let o=s.target.result;t(o)},i.onblocked=()=>{r(new Nr(e,"Cannot upgrade IndexedDB schema while another tab is open. Close all tabs that access Firestore and reload this page to proceed."))},i.onerror=s=>{let o=s.target.error;o.name==="VersionError"?r(new k(P.FAILED_PRECONDITION,"A newer version of the Firestore SDK was previously used and so the persisted data is not compatible with the version of the SDK you are now using. The SDK will operate with persistence disabled. If you need persistence, please re-upgrade to a newer version of the SDK or else clear the persisted IndexedDB data for your app to start fresh.")):o.name==="InvalidStateError"?r(new k(P.FAILED_PRECONDITION,"Unable to open an IndexedDB connection. This could be due to running in a private browsing session on a browser whose private browsing sessions do not support IndexedDB: "+o)):r(new Nr(e,o))},i.onupgradeneeded=s=>{V("SimpleDb",'Database "'+this.name+'" requires upgrade from version:',s.oldVersion);let o=s.target.result;this.p.O(o,i.transaction,s.oldVersion,this.version).next(()=>{V("SimpleDb","Database upgrade to version "+this.version+" complete")})}})),this.N&&(this.db.onversionchange=t=>this.N(t)),this.db})}L(e){this.N=e,this.db&&(this.db.onversionchange=t=>e(t))}runTransaction(e,t,r,i){return N(this,null,function*(){let s=t==="readonly",o=0;for(;;){++o;try{this.db=yield this.M(e);let l=fu.open(this.db,e,s?"readonly":"readwrite",r),u=i(l).next(c=>(l.g(),c)).catch(c=>(l.abort(c),b.reject(c))).toPromise();return u.catch(()=>{}),yield l.m,u}catch(l){let u=l,c=u.name!=="FirebaseError"&&o<3;if(V("SimpleDb","Transaction failed with error:",u.message,"Retrying:",c),this.close(),!c)return Promise.reject(u)}}})}close(){this.db&&this.db.close(),this.db=void 0}};function OE(n){let e=n.match(/Android ([\d.]+)/i),t=e?e[1].split(".").slice(0,2).join("."):"-1";return Number(t)}var If=class{constructor(e){this.B=e,this.k=!1,this.q=null}get isDone(){return this.k}get K(){return this.q}set cursor(e){this.B=e}done(){this.k=!0}$(e){this.q=e}delete(){return Ar(this.B.delete())}},Nr=class extends k{constructor(e,t){super(P.UNAVAILABLE,`IndexedDB transaction '${e}' failed: ${t}`),this.name="IndexedDbTransactionError"}};function ir(n){return n.name==="IndexedDbTransactionError"}var Tf=class{constructor(e){this.store=e}put(e,t){let r;return t!==void 0?(V("SimpleDb","PUT",this.store.name,e,t),r=this.store.put(t,e)):(V("SimpleDb","PUT",this.store.name,"<auto-key>",e),r=this.store.put(e)),Ar(r)}add(e){return V("SimpleDb","ADD",this.store.name,e,e),Ar(this.store.add(e))}get(e){return Ar(this.store.get(e)).next(t=>(t===void 0&&(t=null),V("SimpleDb","GET",this.store.name,e,t),t))}delete(e){return V("SimpleDb","DELETE",this.store.name,e),Ar(this.store.delete(e))}count(){return V("SimpleDb","COUNT",this.store.name),Ar(this.store.count())}U(e,t){let r=this.options(e,t),i=r.index?this.store.index(r.index):this.store;if(typeof i.getAll=="function"){let s=i.getAll(r.range);return new b((o,l)=>{s.onerror=u=>{l(u.target.error)},s.onsuccess=u=>{o(u.target.result)}})}{let s=this.cursor(r),o=[];return this.W(s,(l,u)=>{o.push(u)}).next(()=>o)}}G(e,t){let r=this.store.getAll(e,t===null?void 0:t);return new b((i,s)=>{r.onerror=o=>{s(o.target.error)},r.onsuccess=o=>{i(o.target.result)}})}j(e,t){V("SimpleDb","DELETE ALL",this.store.name);let r=this.options(e,t);r.H=!1;let i=this.cursor(r);return this.W(i,(s,o,l)=>l.delete())}J(e,t){let r;t?r=e:(r={},t=e);let i=this.cursor(r);return this.W(i,t)}Y(e){let t=this.cursor({});return new b((r,i)=>{t.onerror=s=>{let o=mm(s.target.error);i(o)},t.onsuccess=s=>{let o=s.target.result;o?e(o.primaryKey,o.value).next(l=>{l?o.continue():r()}):r()}})}W(e,t){let r=[];return new b((i,s)=>{e.onerror=o=>{s(o.target.error)},e.onsuccess=o=>{let l=o.target.result;if(!l)return void i();let u=new If(l),c=t(l.primaryKey,l.value,u);if(c instanceof b){let d=c.catch(p=>(u.done(),b.reject(p)));r.push(d)}u.isDone?i():u.K===null?l.continue():l.continue(u.K)}}).next(()=>b.waitFor(r))}options(e,t){let r;return e!==void 0&&(typeof e=="string"?r=e:t=e),{index:r,range:t}}cursor(e){let t="next";if(e.reverse&&(t="prev"),e.index){let r=this.store.index(e.index);return e.H?r.openKeyCursor(e.range,t):r.openCursor(e.range,t)}return this.store.openCursor(e.range,t)}};function Ar(n){return new b((e,t)=>{n.onsuccess=r=>{let i=r.target.result;e(i)},n.onerror=r=>{let i=mm(r.target.error);t(i)}})}var Rw=!1;function mm(n){let e=$n.S(Fs());if(e>=12.2&&e<13){let t="An internal error was encountered in the Indexed Database server";if(n.message.indexOf(t)>=0){let r=new k("internal",`IOS_INDEXEDDB_BUG1: IndexedDb has thrown '${t}'. This is likely due to an unavoidable bug in iOS. See https://stackoverflow.com/q/56496296/110915 for details and a potential workaround.`);return Rw||(Rw=!0,setTimeout(()=>{throw r},0)),r}}return n}var Sf=class{constructor(e,t){this.asyncQueue=e,this.Z=t,this.task=null}start(){this.X(15e3)}stop(){this.task&&(this.task.cancel(),this.task=null)}get started(){return this.task!==null}X(e){V("IndexBackfiller",`Scheduled in ${e}ms`),this.task=this.asyncQueue.enqueueAfterDelay("index_backfill",e,()=>N(this,null,function*(){this.task=null;try{V("IndexBackfiller",`Documents written: ${yield this.Z.ee()}`)}catch(t){ir(t)?V("IndexBackfiller","Ignoring IndexedDB error during index backfill: ",t):yield rr(t)}yield this.X(6e4)}))}},Cf=class{constructor(e,t){this.localStore=e,this.persistence=t}ee(e=50){return N(this,null,function*(){return this.persistence.runTransaction("Backfill Indexes","readwrite-primary",t=>this.te(t,e))})}te(e,t){let r=new Set,i=t,s=!0;return b.doWhile(()=>s===!0&&i>0,()=>this.localStore.indexManager.getNextCollectionGroupToUpdate(e).next(o=>{if(o!==null&&!r.has(o))return V("IndexBackfiller",`Processing collection: ${o}`),this.ne(e,o,i).next(l=>{i-=l,r.add(o)});s=!1})).next(()=>t-i)}ne(e,t,r){return this.localStore.indexManager.getMinOffsetFromCollectionGroup(e,t).next(i=>this.localStore.localDocuments.getNextDocuments(e,t,i,r).next(s=>{let o=s.changes;return this.localStore.indexManager.updateIndexEntries(e,o).next(()=>this.re(i,s)).next(l=>(V("IndexBackfiller",`Updating offset: ${l}`),this.localStore.indexManager.updateCollectionGroup(e,t,l))).next(()=>o.size)}))}re(e,t){let r=e;return t.changes.forEach((i,s)=>{let o=VE(s);pm(o,r)>0&&(r=o)}),new At(r.readTime,r.documentKey,Math.max(t.batchId,e.largestBatchId))}};var _t=(()=>{class n{constructor(t,r){this.previousValue=t,r&&(r.sequenceNumberHandler=i=>this.ie(i),this.se=i=>r.writeSequenceNumber(i))}ie(t){return this.previousValue=Math.max(t,this.previousValue),this.previousValue}next(){let t=++this.previousValue;return this.se&&this.se(t),t}}return n.oe=-1,n})();function Jo(n){return n==null}function No(n){return n===0&&1/n==-1/0}function ME(n){return typeof n=="number"&&Number.isInteger(n)&&!No(n)&&n<=Number.MAX_SAFE_INTEGER&&n>=Number.MIN_SAFE_INTEGER}function at(n){let e="";for(let t=0;t<n.length;t++)e.length>0&&(e=Pw(e)),e=rb(n.get(t),e);return Pw(e)}function rb(n,e){let t=e,r=n.length;for(let i=0;i<r;i++){let s=n.charAt(i);switch(s){case"\0":t+="";break;case"":t+="";break;default:t+=s}}return t}function Pw(n){return n+""}function Wt(n){let e=n.length;if(G(e>=2),e===2)return G(n.charAt(0)===""&&n.charAt(1)===""),oe.emptyPath();let t=e-2,r=[],i="";for(let s=0;s<e;){let o=n.indexOf("",s);switch((o<0||o>t)&&U(),n.charAt(o+1)){case"":let l=n.substring(s,o),u;i.length===0?u=l:(i+=l,u=i,i=""),r.push(u);break;case"":i+=n.substring(s,o),i+="\0";break;case"":i+=n.substring(s,o+1);break;default:U()}s=o+2}return new oe(r)}var xw=["userId","batchId"];function iu(n,e){return[n,at(e)]}function LE(n,e,t){return[n,at(e),t]}var ib={},sb=["prefixPath","collectionGroup","readTime","documentId"],ob=["prefixPath","collectionGroup","documentId"],ab=["collectionGroup","readTime","prefixPath","documentId"],lb=["canonicalId","targetId"],ub=["targetId","path"],cb=["path","targetId"],hb=["collectionId","parent"],db=["indexId","uid"],fb=["uid","sequenceNumber"],pb=["indexId","uid","arrayValue","directionalValue","orderedDocumentKey","documentKey"],mb=["indexId","uid","orderedDocumentKey"],gb=["userId","collectionPath","documentId"],_b=["userId","collectionPath","largestBatchId"],yb=["userId","collectionGroup","largestBatchId"],UE=["mutationQueues","mutations","documentMutations","remoteDocuments","targets","owner","targetGlobal","targetDocuments","clientMetadata","remoteDocumentGlobal","collectionParents","bundles","namedQueries"],vb=[...UE,"documentOverlays"],BE=["mutationQueues","mutations","documentMutations","remoteDocumentsV14","targets","owner","targetGlobal","targetDocuments","clientMetadata","remoteDocumentGlobal","collectionParents","bundles","namedQueries","documentOverlays"],qE=BE,gm=[...qE,"indexConfiguration","indexState","indexEntries"],wb=gm,Eb=[...gm,"globals"];var Do=class extends du{constructor(e,t){super(),this._e=e,this.currentSequenceNumber=t}};function qe(n,e){let t=M(n);return $n.F(t._e,e)}function Nw(n){let e=0;for(let t in n)Object.prototype.hasOwnProperty.call(n,t)&&e++;return e}function jr(n,e){for(let t in n)Object.prototype.hasOwnProperty.call(n,t)&&e(t,n[t])}function GE(n){for(let e in n)if(Object.prototype.hasOwnProperty.call(n,e))return!1;return!0}var we=class n{constructor(e,t){this.comparator=e,this.root=t||$t.EMPTY}insert(e,t){return new n(this.comparator,this.root.insert(e,t,this.comparator).copy(null,null,$t.BLACK,null,null))}remove(e){return new n(this.comparator,this.root.remove(e,this.comparator).copy(null,null,$t.BLACK,null,null))}get(e){let t=this.root;for(;!t.isEmpty();){let r=this.comparator(e,t.key);if(r===0)return t.value;r<0?t=t.left:r>0&&(t=t.right)}return null}indexOf(e){let t=0,r=this.root;for(;!r.isEmpty();){let i=this.comparator(e,r.key);if(i===0)return t+r.left.size;i<0?r=r.left:(t+=r.left.size+1,r=r.right)}return-1}isEmpty(){return this.root.isEmpty()}get size(){return this.root.size}minKey(){return this.root.minKey()}maxKey(){return this.root.maxKey()}inorderTraversal(e){return this.root.inorderTraversal(e)}forEach(e){this.inorderTraversal((t,r)=>(e(t,r),!1))}toString(){let e=[];return this.inorderTraversal((t,r)=>(e.push(`${t}:${r}`),!1)),`{${e.join(", ")}}`}reverseTraversal(e){return this.root.reverseTraversal(e)}getIterator(){return new Di(this.root,null,this.comparator,!1)}getIteratorFrom(e){return new Di(this.root,e,this.comparator,!1)}getReverseIterator(){return new Di(this.root,null,this.comparator,!0)}getReverseIteratorFrom(e){return new Di(this.root,e,this.comparator,!0)}},Di=class{constructor(e,t,r,i){this.isReverse=i,this.nodeStack=[];let s=1;for(;!e.isEmpty();)if(s=t?r(e.key,t):1,t&&i&&(s*=-1),s<0)e=this.isReverse?e.left:e.right;else{if(s===0){this.nodeStack.push(e);break}this.nodeStack.push(e),e=this.isReverse?e.right:e.left}}getNext(){let e=this.nodeStack.pop(),t={key:e.key,value:e.value};if(this.isReverse)for(e=e.left;!e.isEmpty();)this.nodeStack.push(e),e=e.right;else for(e=e.right;!e.isEmpty();)this.nodeStack.push(e),e=e.left;return t}hasNext(){return this.nodeStack.length>0}peek(){if(this.nodeStack.length===0)return null;let e=this.nodeStack[this.nodeStack.length-1];return{key:e.key,value:e.value}}},$t=class n{constructor(e,t,r,i,s){this.key=e,this.value=t,this.color=r??n.RED,this.left=i??n.EMPTY,this.right=s??n.EMPTY,this.size=this.left.size+1+this.right.size}copy(e,t,r,i,s){return new n(e??this.key,t??this.value,r??this.color,i??this.left,s??this.right)}isEmpty(){return!1}inorderTraversal(e){return this.left.inorderTraversal(e)||e(this.key,this.value)||this.right.inorderTraversal(e)}reverseTraversal(e){return this.right.reverseTraversal(e)||e(this.key,this.value)||this.left.reverseTraversal(e)}min(){return this.left.isEmpty()?this:this.left.min()}minKey(){return this.min().key}maxKey(){return this.right.isEmpty()?this.key:this.right.maxKey()}insert(e,t,r){let i=this,s=r(e,i.key);return i=s<0?i.copy(null,null,null,i.left.insert(e,t,r),null):s===0?i.copy(null,t,null,null,null):i.copy(null,null,null,null,i.right.insert(e,t,r)),i.fixUp()}removeMin(){if(this.left.isEmpty())return n.EMPTY;let e=this;return e.left.isRed()||e.left.left.isRed()||(e=e.moveRedLeft()),e=e.copy(null,null,null,e.left.removeMin(),null),e.fixUp()}remove(e,t){let r,i=this;if(t(e,i.key)<0)i.left.isEmpty()||i.left.isRed()||i.left.left.isRed()||(i=i.moveRedLeft()),i=i.copy(null,null,null,i.left.remove(e,t),null);else{if(i.left.isRed()&&(i=i.rotateRight()),i.right.isEmpty()||i.right.isRed()||i.right.left.isRed()||(i=i.moveRedRight()),t(e,i.key)===0){if(i.right.isEmpty())return n.EMPTY;r=i.right.min(),i=i.copy(r.key,r.value,null,null,i.right.removeMin())}i=i.copy(null,null,null,null,i.right.remove(e,t))}return i.fixUp()}isRed(){return this.color}fixUp(){let e=this;return e.right.isRed()&&!e.left.isRed()&&(e=e.rotateLeft()),e.left.isRed()&&e.left.left.isRed()&&(e=e.rotateRight()),e.left.isRed()&&e.right.isRed()&&(e=e.colorFlip()),e}moveRedLeft(){let e=this.colorFlip();return e.right.left.isRed()&&(e=e.copy(null,null,null,null,e.right.rotateRight()),e=e.rotateLeft(),e=e.colorFlip()),e}moveRedRight(){let e=this.colorFlip();return e.left.left.isRed()&&(e=e.rotateRight(),e=e.colorFlip()),e}rotateLeft(){let e=this.copy(null,null,n.RED,null,this.right.left);return this.right.copy(null,null,this.color,e,null)}rotateRight(){let e=this.copy(null,null,n.RED,this.left.right,null);return this.left.copy(null,null,this.color,null,e)}colorFlip(){let e=this.left.copy(null,null,!this.left.color,null,null),t=this.right.copy(null,null,!this.right.color,null,null);return this.copy(null,null,!this.color,e,t)}checkMaxDepth(){let e=this.check();return Math.pow(2,e)<=this.size+1}check(){if(this.isRed()&&this.left.isRed()||this.right.isRed())throw U();let e=this.left.check();if(e!==this.right.check())throw U();return e+(this.isRed()?0:1)}};$t.EMPTY=null,$t.RED=!0,$t.BLACK=!1;$t.EMPTY=new class{constructor(){this.size=0}get key(){throw U()}get value(){throw U()}get color(){throw U()}get left(){throw U()}get right(){throw U()}copy(e,t,r,i,s){return this}insert(e,t,r){return new $t(e,t)}remove(e,t){return this}isEmpty(){return!0}inorderTraversal(e){return!1}reverseTraversal(e){return!1}minKey(){return null}maxKey(){return null}isRed(){return!1}checkMaxDepth(){return!0}check(){return 0}};var ge=class n{constructor(e){this.comparator=e,this.data=new we(this.comparator)}has(e){return this.data.get(e)!==null}first(){return this.data.minKey()}last(){return this.data.maxKey()}get size(){return this.data.size}indexOf(e){return this.data.indexOf(e)}forEach(e){this.data.inorderTraversal((t,r)=>(e(t),!1))}forEachInRange(e,t){let r=this.data.getIteratorFrom(e[0]);for(;r.hasNext();){let i=r.getNext();if(this.comparator(i.key,e[1])>=0)return;t(i.key)}}forEachWhile(e,t){let r;for(r=t!==void 0?this.data.getIteratorFrom(t):this.data.getIterator();r.hasNext();)if(!e(r.getNext().key))return}firstAfterOrEqual(e){let t=this.data.getIteratorFrom(e);return t.hasNext()?t.getNext().key:null}getIterator(){return new pu(this.data.getIterator())}getIteratorFrom(e){return new pu(this.data.getIteratorFrom(e))}add(e){return this.copy(this.data.remove(e).insert(e,!0))}delete(e){return this.has(e)?this.copy(this.data.remove(e)):this}isEmpty(){return this.data.isEmpty()}unionWith(e){let t=this;return t.size<e.size&&(t=e,e=this),e.forEach(r=>{t=t.add(r)}),t}isEqual(e){if(!(e instanceof n)||this.size!==e.size)return!1;let t=this.data.getIterator(),r=e.data.getIterator();for(;t.hasNext();){let i=t.getNext().key,s=r.getNext().key;if(this.comparator(i,s)!==0)return!1}return!0}toArray(){let e=[];return this.forEach(t=>{e.push(t)}),e}toString(){let e=[];return this.forEach(t=>e.push(t)),"SortedSet("+e.toString()+")"}copy(e){let t=new n(this.comparator);return t.data=e,t}},pu=class{constructor(e){this.iter=e}getNext(){return this.iter.getNext().key}hasNext(){return this.iter.hasNext()}};function Ti(n){return n.hasNext()?n.getNext():void 0}var yt=class n{constructor(e){this.fields=e,e.sort(Pe.comparator)}static empty(){return new n([])}unionWith(e){let t=new ge(Pe.comparator);for(let r of this.fields)t=t.add(r);for(let r of e)t=t.add(r);return new n(t.toArray())}covers(e){for(let t of this.fields)if(t.isPrefixOf(e))return!0;return!1}isEqual(e){return Oi(this.fields,e.fields,(t,r)=>t.isEqual(r))}};var mu=class extends Error{constructor(){super(...arguments),this.name="Base64DecodeError"}};function jE(){return typeof atob<"u"}var Ne=class n{constructor(e){this.binaryString=e}static fromBase64String(e){let t=function(i){try{return atob(i)}catch(s){throw typeof DOMException<"u"&&s instanceof DOMException?new mu("Invalid base64 string: "+s):s}}(e);return new n(t)}static fromUint8Array(e){let t=function(i){let s="";for(let o=0;o<i.length;++o)s+=String.fromCharCode(i[o]);return s}(e);return new n(t)}[Symbol.iterator](){let e=0;return{next:()=>e<this.binaryString.length?{value:this.binaryString.charCodeAt(e++),done:!1}:{value:void 0,done:!0}}}toBase64(){return function(t){return btoa(t)}(this.binaryString)}toUint8Array(){return function(t){let r=new Uint8Array(t.length);for(let i=0;i<t.length;i++)r[i]=t.charCodeAt(i);return r}(this.binaryString)}approximateByteSize(){return 2*this.binaryString.length}compareTo(e){return W(this.binaryString,e.binaryString)}isEqual(e){return this.binaryString===e.binaryString}};Ne.EMPTY_BYTE_STRING=new Ne("");var Ib=new RegExp(/^\d{4}-\d\d-\d\dT\d\d:\d\d:\d\d(?:\.(\d+))?Z$/);function pn(n){if(G(!!n),typeof n=="string"){let e=0,t=Ib.exec(n);if(G(!!t),t[1]){let i=t[1];i=(i+"000000000").substr(0,9),e=Number(i)}let r=new Date(n);return{seconds:Math.floor(r.getTime()/1e3),nanos:e}}return{seconds:Ie(n.seconds),nanos:Ie(n.nanos)}}function Ie(n){return typeof n=="number"?n:typeof n=="string"?Number(n):0}function Hn(n){return typeof n=="string"?Ne.fromBase64String(n):Ne.fromUint8Array(n)}function oc(n){var e,t;return((t=(((e=n?.mapValue)===null||e===void 0?void 0:e.fields)||{}).__type__)===null||t===void 0?void 0:t.stringValue)==="server_timestamp"}function _m(n){let e=n.mapValue.fields.__previous_value__;return oc(e)?_m(e):e}function ko(n){let e=pn(n.mapValue.fields.__local_write_time__.timestampValue);return new Se(e.seconds,e.nanos)}var Af=class{constructor(e,t,r,i,s,o,l,u,c){this.databaseId=e,this.appId=t,this.persistenceKey=r,this.host=i,this.ssl=s,this.forceLongPolling=o,this.autoDetectLongPolling=l,this.longPollingOptions=u,this.useFetchStreams=c}},Yn=class n{constructor(e,t){this.projectId=e,this.database=t||"(default)"}static empty(){return new n("","")}get isDefaultDatabase(){return this.database==="(default)"}isEqual(e){return e instanceof n&&e.projectId===this.projectId&&e.database===this.database}};var Kn={mapValue:{fields:{__type__:{stringValue:"__max__"}}}},su={nullValue:"NULL_VALUE"};function Dr(n){return"nullValue"in n?0:"booleanValue"in n?1:"integerValue"in n||"doubleValue"in n?2:"timestampValue"in n?3:"stringValue"in n?5:"bytesValue"in n?6:"referenceValue"in n?7:"geoPointValue"in n?8:"arrayValue"in n?9:"mapValue"in n?oc(n)?4:zE(n)?9007199254740991:ac(n)?10:11:U()}function Jt(n,e){if(n===e)return!0;let t=Dr(n);if(t!==Dr(e))return!1;switch(t){case 0:case 9007199254740991:return!0;case 1:return n.booleanValue===e.booleanValue;case 4:return ko(n).isEqual(ko(e));case 3:return function(i,s){if(typeof i.timestampValue=="string"&&typeof s.timestampValue=="string"&&i.timestampValue.length===s.timestampValue.length)return i.timestampValue===s.timestampValue;let o=pn(i.timestampValue),l=pn(s.timestampValue);return o.seconds===l.seconds&&o.nanos===l.nanos}(n,e);case 5:return n.stringValue===e.stringValue;case 6:return function(i,s){return Hn(i.bytesValue).isEqual(Hn(s.bytesValue))}(n,e);case 7:return n.referenceValue===e.referenceValue;case 8:return function(i,s){return Ie(i.geoPointValue.latitude)===Ie(s.geoPointValue.latitude)&&Ie(i.geoPointValue.longitude)===Ie(s.geoPointValue.longitude)}(n,e);case 2:return function(i,s){if("integerValue"in i&&"integerValue"in s)return Ie(i.integerValue)===Ie(s.integerValue);if("doubleValue"in i&&"doubleValue"in s){let o=Ie(i.doubleValue),l=Ie(s.doubleValue);return o===l?No(o)===No(l):isNaN(o)&&isNaN(l)}return!1}(n,e);case 9:return Oi(n.arrayValue.values||[],e.arrayValue.values||[],Jt);case 10:case 11:return function(i,s){let o=i.mapValue.fields||{},l=s.mapValue.fields||{};if(Nw(o)!==Nw(l))return!1;for(let u in o)if(o.hasOwnProperty(u)&&(l[u]===void 0||!Jt(o[u],l[u])))return!1;return!0}(n,e);default:return U()}}function Vo(n,e){return(n.values||[]).find(t=>Jt(t,e))!==void 0}function Jn(n,e){if(n===e)return 0;let t=Dr(n),r=Dr(e);if(t!==r)return W(t,r);switch(t){case 0:case 9007199254740991:return 0;case 1:return W(n.booleanValue,e.booleanValue);case 2:return function(s,o){let l=Ie(s.integerValue||s.doubleValue),u=Ie(o.integerValue||o.doubleValue);return l<u?-1:l>u?1:l===u?0:isNaN(l)?isNaN(u)?0:-1:1}(n,e);case 3:return Dw(n.timestampValue,e.timestampValue);case 4:return Dw(ko(n),ko(e));case 5:return W(n.stringValue,e.stringValue);case 6:return function(s,o){let l=Hn(s),u=Hn(o);return l.compareTo(u)}(n.bytesValue,e.bytesValue);case 7:return function(s,o){let l=s.split("/"),u=o.split("/");for(let c=0;c<l.length&&c<u.length;c++){let d=W(l[c],u[c]);if(d!==0)return d}return W(l.length,u.length)}(n.referenceValue,e.referenceValue);case 8:return function(s,o){let l=W(Ie(s.latitude),Ie(o.latitude));return l!==0?l:W(Ie(s.longitude),Ie(o.longitude))}(n.geoPointValue,e.geoPointValue);case 9:return kw(n.arrayValue,e.arrayValue);case 10:return function(s,o){var l,u,c,d;let p=s.fields||{},m=o.fields||{},y=(l=p.value)===null||l===void 0?void 0:l.arrayValue,C=(u=m.value)===null||u===void 0?void 0:u.arrayValue,x=W(((c=y?.values)===null||c===void 0?void 0:c.length)||0,((d=C?.values)===null||d===void 0?void 0:d.length)||0);return x!==0?x:kw(y,C)}(n.mapValue,e.mapValue);case 11:return function(s,o){if(s===Kn.mapValue&&o===Kn.mapValue)return 0;if(s===Kn.mapValue)return 1;if(o===Kn.mapValue)return-1;let l=s.fields||{},u=Object.keys(l),c=o.fields||{},d=Object.keys(c);u.sort(),d.sort();for(let p=0;p<u.length&&p<d.length;++p){let m=W(u[p],d[p]);if(m!==0)return m;let y=Jn(l[u[p]],c[d[p]]);if(y!==0)return y}return W(u.length,d.length)}(n.mapValue,e.mapValue);default:throw U()}}function Dw(n,e){if(typeof n=="string"&&typeof e=="string"&&n.length===e.length)return W(n,e);let t=pn(n),r=pn(e),i=W(t.seconds,r.seconds);return i!==0?i:W(t.nanos,r.nanos)}function kw(n,e){let t=n.values||[],r=e.values||[];for(let i=0;i<t.length&&i<r.length;++i){let s=Jn(t[i],r[i]);if(s)return s}return W(t.length,r.length)}function Li(n){return bf(n)}function bf(n){return"nullValue"in n?"null":"booleanValue"in n?""+n.booleanValue:"integerValue"in n?""+n.integerValue:"doubleValue"in n?""+n.doubleValue:"timestampValue"in n?function(t){let r=pn(t);return`time(${r.seconds},${r.nanos})`}(n.timestampValue):"stringValue"in n?n.stringValue:"bytesValue"in n?function(t){return Hn(t).toBase64()}(n.bytesValue):"referenceValue"in n?function(t){return L.fromName(t).toString()}(n.referenceValue):"geoPointValue"in n?function(t){return`geo(${t.latitude},${t.longitude})`}(n.geoPointValue):"arrayValue"in n?function(t){let r="[",i=!0;for(let s of t.values||[])i?i=!1:r+=",",r+=bf(s);return r+"]"}(n.arrayValue):"mapValue"in n?function(t){let r=Object.keys(t.fields||{}).sort(),i="{",s=!0;for(let o of r)s?s=!1:i+=",",i+=`${o}:${bf(t.fields[o])}`;return i+"}"}(n.mapValue):U()}function kr(n,e){return{referenceValue:`projects/${n.projectId}/databases/${n.database}/documents/${e.path.canonicalString()}`}}function Rf(n){return!!n&&"integerValue"in n}function Fo(n){return!!n&&"arrayValue"in n}function Vw(n){return!!n&&"nullValue"in n}function Fw(n){return!!n&&"doubleValue"in n&&isNaN(Number(n.doubleValue))}function ou(n){return!!n&&"mapValue"in n}function ac(n){var e,t;return((t=(((e=n?.mapValue)===null||e===void 0?void 0:e.fields)||{}).__type__)===null||t===void 0?void 0:t.stringValue)==="__vector__"}function Co(n){if(n.geoPointValue)return{geoPointValue:Object.assign({},n.geoPointValue)};if(n.timestampValue&&typeof n.timestampValue=="object")return{timestampValue:Object.assign({},n.timestampValue)};if(n.mapValue){let e={mapValue:{fields:{}}};return jr(n.mapValue.fields,(t,r)=>e.mapValue.fields[t]=Co(r)),e}if(n.arrayValue){let e={arrayValue:{values:[]}};for(let t=0;t<(n.arrayValue.values||[]).length;++t)e.arrayValue.values[t]=Co(n.arrayValue.values[t]);return e}return Object.assign({},n)}function zE(n){return(((n.mapValue||{}).fields||{}).__type__||{}).stringValue==="__max__"}var KE={mapValue:{fields:{__type__:{stringValue:"__vector__"},value:{arrayValue:{}}}}};function Tb(n){return"nullValue"in n?su:"booleanValue"in n?{booleanValue:!1}:"integerValue"in n||"doubleValue"in n?{doubleValue:NaN}:"timestampValue"in n?{timestampValue:{seconds:Number.MIN_SAFE_INTEGER}}:"stringValue"in n?{stringValue:""}:"bytesValue"in n?{bytesValue:""}:"referenceValue"in n?kr(Yn.empty(),L.empty()):"geoPointValue"in n?{geoPointValue:{latitude:-90,longitude:-180}}:"arrayValue"in n?{arrayValue:{}}:"mapValue"in n?ac(n)?KE:{mapValue:{}}:U()}function Sb(n){return"nullValue"in n?{booleanValue:!1}:"booleanValue"in n?{doubleValue:NaN}:"integerValue"in n||"doubleValue"in n?{timestampValue:{seconds:Number.MIN_SAFE_INTEGER}}:"timestampValue"in n?{stringValue:""}:"stringValue"in n?{bytesValue:""}:"bytesValue"in n?kr(Yn.empty(),L.empty()):"referenceValue"in n?{geoPointValue:{latitude:-90,longitude:-180}}:"geoPointValue"in n?{arrayValue:{}}:"arrayValue"in n?KE:"mapValue"in n?ac(n)?{mapValue:{}}:Kn:U()}function Ow(n,e){let t=Jn(n.value,e.value);return t!==0?t:n.inclusive&&!e.inclusive?-1:!n.inclusive&&e.inclusive?1:0}function Mw(n,e){let t=Jn(n.value,e.value);return t!==0?t:n.inclusive&&!e.inclusive?1:!n.inclusive&&e.inclusive?-1:0}var et=class n{constructor(e){this.value=e}static empty(){return new n({mapValue:{}})}field(e){if(e.isEmpty())return this.value;{let t=this.value;for(let r=0;r<e.length-1;++r)if(t=(t.mapValue.fields||{})[e.get(r)],!ou(t))return null;return t=(t.mapValue.fields||{})[e.lastSegment()],t||null}}set(e,t){this.getFieldsMap(e.popLast())[e.lastSegment()]=Co(t)}setAll(e){let t=Pe.emptyPath(),r={},i=[];e.forEach((o,l)=>{if(!t.isImmediateParentOf(l)){let u=this.getFieldsMap(t);this.applyChanges(u,r,i),r={},i=[],t=l.popLast()}o?r[l.lastSegment()]=Co(o):i.push(l.lastSegment())});let s=this.getFieldsMap(t);this.applyChanges(s,r,i)}delete(e){let t=this.field(e.popLast());ou(t)&&t.mapValue.fields&&delete t.mapValue.fields[e.lastSegment()]}isEqual(e){return Jt(this.value,e.value)}getFieldsMap(e){let t=this.value;t.mapValue.fields||(t.mapValue={fields:{}});for(let r=0;r<e.length;++r){let i=t.mapValue.fields[e.get(r)];ou(i)&&i.mapValue.fields||(i={mapValue:{fields:{}}},t.mapValue.fields[e.get(r)]=i),t=i}return t.mapValue.fields}applyChanges(e,t,r){jr(t,(i,s)=>e[i]=s);for(let i of r)delete e[i]}clone(){return new n(Co(this.value))}};function WE(n){let e=[];return jr(n.fields,(t,r)=>{let i=new Pe([t]);if(ou(r)){let s=WE(r.mapValue).fields;if(s.length===0)e.push(i);else for(let o of s)e.push(i.child(o))}else e.push(i)}),new yt(e)}var Me=class n{constructor(e,t,r,i,s,o,l){this.key=e,this.documentType=t,this.version=r,this.readTime=i,this.createTime=s,this.data=o,this.documentState=l}static newInvalidDocument(e){return new n(e,0,z.min(),z.min(),z.min(),et.empty(),0)}static newFoundDocument(e,t,r,i){return new n(e,1,t,z.min(),r,i,0)}static newNoDocument(e,t){return new n(e,2,t,z.min(),z.min(),et.empty(),0)}static newUnknownDocument(e,t){return new n(e,3,t,z.min(),z.min(),et.empty(),2)}convertToFoundDocument(e,t){return!this.createTime.isEqual(z.min())||this.documentType!==2&&this.documentType!==0||(this.createTime=e),this.version=e,this.documentType=1,this.data=t,this.documentState=0,this}convertToNoDocument(e){return this.version=e,this.documentType=2,this.data=et.empty(),this.documentState=0,this}convertToUnknownDocument(e){return this.version=e,this.documentType=3,this.data=et.empty(),this.documentState=2,this}setHasCommittedMutations(){return this.documentState=2,this}setHasLocalMutations(){return this.documentState=1,this.version=z.min(),this}setReadTime(e){return this.readTime=e,this}get hasLocalMutations(){return this.documentState===1}get hasCommittedMutations(){return this.documentState===2}get hasPendingWrites(){return this.hasLocalMutations||this.hasCommittedMutations}isValidDocument(){return this.documentType!==0}isFoundDocument(){return this.documentType===1}isNoDocument(){return this.documentType===2}isUnknownDocument(){return this.documentType===3}isEqual(e){return e instanceof n&&this.key.isEqual(e.key)&&this.version.isEqual(e.version)&&this.documentType===e.documentType&&this.documentState===e.documentState&&this.data.isEqual(e.data)}mutableCopy(){return new n(this.key,this.documentType,this.version,this.readTime,this.createTime,this.data.clone(),this.documentState)}toString(){return`Document(${this.key}, ${this.version}, ${JSON.stringify(this.data.value)}, {createTime: ${this.createTime}}), {documentType: ${this.documentType}}), {documentState: ${this.documentState}})`}};var Xt=class{constructor(e,t){this.position=e,this.inclusive=t}};function Lw(n,e,t){let r=0;for(let i=0;i<n.position.length;i++){let s=e[i],o=n.position[i];if(s.field.isKeyField()?r=L.comparator(L.fromName(o.referenceValue),t.key):r=Jn(o,t.data.field(s.field)),s.dir==="desc"&&(r*=-1),r!==0)break}return r}function Uw(n,e){if(n===null)return e===null;if(e===null||n.inclusive!==e.inclusive||n.position.length!==e.position.length)return!1;for(let t=0;t<n.position.length;t++)if(!Jt(n.position[t],e.position[t]))return!1;return!0}var Vr=class{constructor(e,t="asc"){this.field=e,this.dir=t}};function Cb(n,e){return n.dir===e.dir&&n.field.isEqual(e.field)}var gu=class{},ne=class n extends gu{constructor(e,t,r){super(),this.field=e,this.op=t,this.value=r}static create(e,t,r){return e.isKeyField()?t==="in"||t==="not-in"?this.createKeyFieldInFilter(e,t,r):new Nf(e,t,r):t==="array-contains"?new Vf(e,r):t==="in"?new _u(e,r):t==="not-in"?new Ff(e,r):t==="array-contains-any"?new Of(e,r):new n(e,t,r)}static createKeyFieldInFilter(e,t,r){return t==="in"?new Df(e,r):new kf(e,r)}matches(e){let t=e.data.field(this.field);return this.op==="!="?t!==null&&this.matchesComparison(Jn(t,this.value)):t!==null&&Dr(this.value)===Dr(t)&&this.matchesComparison(Jn(t,this.value))}matchesComparison(e){switch(this.op){case"<":return e<0;case"<=":return e<=0;case"==":return e===0;case"!=":return e!==0;case">":return e>0;case">=":return e>=0;default:return U()}}isInequality(){return["<","<=",">",">=","!=","not-in"].indexOf(this.op)>=0}getFlattenedFilters(){return[this]}getFilters(){return[this]}},de=class n extends gu{constructor(e,t){super(),this.filters=e,this.op=t,this.ae=null}static create(e,t){return new n(e,t)}matches(e){return Ui(this)?this.filters.find(t=>!t.matches(e))===void 0:this.filters.find(t=>t.matches(e))!==void 0}getFlattenedFilters(){return this.ae!==null||(this.ae=this.filters.reduce((e,t)=>e.concat(t.getFlattenedFilters()),[])),this.ae}getFilters(){return Object.assign([],this.filters)}};function Ui(n){return n.op==="and"}function Pf(n){return n.op==="or"}function ym(n){return QE(n)&&Ui(n)}function QE(n){for(let e of n.filters)if(e instanceof de)return!1;return!0}function xf(n){if(n instanceof ne)return n.field.canonicalString()+n.op.toString()+Li(n.value);if(ym(n))return n.filters.map(e=>xf(e)).join(",");{let e=n.filters.map(t=>xf(t)).join(",");return`${n.op}(${e})`}}function $E(n,e){return n instanceof ne?function(r,i){return i instanceof ne&&r.op===i.op&&r.field.isEqual(i.field)&&Jt(r.value,i.value)}(n,e):n instanceof de?function(r,i){return i instanceof de&&r.op===i.op&&r.filters.length===i.filters.length?r.filters.reduce((s,o,l)=>s&&$E(o,i.filters[l]),!0):!1}(n,e):void U()}function HE(n,e){let t=n.filters.concat(e);return de.create(t,n.op)}function YE(n){return n instanceof ne?function(t){return`${t.field.canonicalString()} ${t.op} ${Li(t.value)}`}(n):n instanceof de?function(t){return t.op.toString()+" {"+t.getFilters().map(YE).join(" ,")+"}"}(n):"Filter"}var Nf=class extends ne{constructor(e,t,r){super(e,t,r),this.key=L.fromName(r.referenceValue)}matches(e){let t=L.comparator(e.key,this.key);return this.matchesComparison(t)}},Df=class extends ne{constructor(e,t){super(e,"in",t),this.keys=JE("in",t)}matches(e){return this.keys.some(t=>t.isEqual(e.key))}},kf=class extends ne{constructor(e,t){super(e,"not-in",t),this.keys=JE("not-in",t)}matches(e){return!this.keys.some(t=>t.isEqual(e.key))}};function JE(n,e){var t;return(((t=e.arrayValue)===null||t===void 0?void 0:t.values)||[]).map(r=>L.fromName(r.referenceValue))}var Vf=class extends ne{constructor(e,t){super(e,"array-contains",t)}matches(e){let t=e.data.field(this.field);return Fo(t)&&Vo(t.arrayValue,this.value)}},_u=class extends ne{constructor(e,t){super(e,"in",t)}matches(e){let t=e.data.field(this.field);return t!==null&&Vo(this.value.arrayValue,t)}},Ff=class extends ne{constructor(e,t){super(e,"not-in",t)}matches(e){if(Vo(this.value.arrayValue,{nullValue:"NULL_VALUE"}))return!1;let t=e.data.field(this.field);return t!==null&&!Vo(this.value.arrayValue,t)}},Of=class extends ne{constructor(e,t){super(e,"array-contains-any",t)}matches(e){let t=e.data.field(this.field);return!(!Fo(t)||!t.arrayValue.values)&&t.arrayValue.values.some(r=>Vo(this.value.arrayValue,r))}};var Mf=class{constructor(e,t=null,r=[],i=[],s=null,o=null,l=null){this.path=e,this.collectionGroup=t,this.orderBy=r,this.filters=i,this.limit=s,this.startAt=o,this.endAt=l,this.ue=null}};function Lf(n,e=null,t=[],r=[],i=null,s=null,o=null){return new Mf(n,e,t,r,i,s,o)}function Fr(n){let e=M(n);if(e.ue===null){let t=e.path.canonicalString();e.collectionGroup!==null&&(t+="|cg:"+e.collectionGroup),t+="|f:",t+=e.filters.map(r=>xf(r)).join(","),t+="|ob:",t+=e.orderBy.map(r=>function(s){return s.field.canonicalString()+s.dir}(r)).join(","),Jo(e.limit)||(t+="|l:",t+=e.limit),e.startAt&&(t+="|lb:",t+=e.startAt.inclusive?"b:":"a:",t+=e.startAt.position.map(r=>Li(r)).join(",")),e.endAt&&(t+="|ub:",t+=e.endAt.inclusive?"a:":"b:",t+=e.endAt.position.map(r=>Li(r)).join(",")),e.ue=t}return e.ue}function Xo(n,e){if(n.limit!==e.limit||n.orderBy.length!==e.orderBy.length)return!1;for(let t=0;t<n.orderBy.length;t++)if(!Cb(n.orderBy[t],e.orderBy[t]))return!1;if(n.filters.length!==e.filters.length)return!1;for(let t=0;t<n.filters.length;t++)if(!$E(n.filters[t],e.filters[t]))return!1;return n.collectionGroup===e.collectionGroup&&!!n.path.isEqual(e.path)&&!!Uw(n.startAt,e.startAt)&&Uw(n.endAt,e.endAt)}function yu(n){return L.isDocumentKey(n.path)&&n.collectionGroup===null&&n.filters.length===0}function vu(n,e){return n.filters.filter(t=>t instanceof ne&&t.field.isEqual(e))}function Bw(n,e,t){let r=su,i=!0;for(let s of vu(n,e)){let o=su,l=!0;switch(s.op){case"<":case"<=":o=Tb(s.value);break;case"==":case"in":case">=":o=s.value;break;case">":o=s.value,l=!1;break;case"!=":case"not-in":o=su}Ow({value:r,inclusive:i},{value:o,inclusive:l})<0&&(r=o,i=l)}if(t!==null){for(let s=0;s<n.orderBy.length;++s)if(n.orderBy[s].field.isEqual(e)){let o=t.position[s];Ow({value:r,inclusive:i},{value:o,inclusive:t.inclusive})<0&&(r=o,i=t.inclusive);break}}return{value:r,inclusive:i}}function qw(n,e,t){let r=Kn,i=!0;for(let s of vu(n,e)){let o=Kn,l=!0;switch(s.op){case">=":case">":o=Sb(s.value),l=!1;break;case"==":case"in":case"<=":o=s.value;break;case"<":o=s.value,l=!1;break;case"!=":case"not-in":o=Kn}Mw({value:r,inclusive:i},{value:o,inclusive:l})>0&&(r=o,i=l)}if(t!==null){for(let s=0;s<n.orderBy.length;++s)if(n.orderBy[s].field.isEqual(e)){let o=t.position[s];Mw({value:r,inclusive:i},{value:o,inclusive:t.inclusive})>0&&(r=o,i=t.inclusive);break}}return{value:r,inclusive:i}}var kt=class{constructor(e,t=null,r=[],i=[],s=null,o="F",l=null,u=null){this.path=e,this.collectionGroup=t,this.explicitOrderBy=r,this.filters=i,this.limit=s,this.limitType=o,this.startAt=l,this.endAt=u,this.ce=null,this.le=null,this.he=null,this.startAt,this.endAt}};function XE(n,e,t,r,i,s,o,l){return new kt(n,e,t,r,i,s,o,l)}function es(n){return new kt(n)}function Gw(n){return n.filters.length===0&&n.limit===null&&n.startAt==null&&n.endAt==null&&(n.explicitOrderBy.length===0||n.explicitOrderBy.length===1&&n.explicitOrderBy[0].field.isKeyField())}function vm(n){return n.collectionGroup!==null}function Vi(n){let e=M(n);if(e.ce===null){e.ce=[];let t=new Set;for(let s of e.explicitOrderBy)e.ce.push(s),t.add(s.field.canonicalString());let r=e.explicitOrderBy.length>0?e.explicitOrderBy[e.explicitOrderBy.length-1].dir:"asc";(function(o){let l=new ge(Pe.comparator);return o.filters.forEach(u=>{u.getFlattenedFilters().forEach(c=>{c.isInequality()&&(l=l.add(c.field))})}),l})(e).forEach(s=>{t.has(s.canonicalString())||s.isKeyField()||e.ce.push(new Vr(s,r))}),t.has(Pe.keyField().canonicalString())||e.ce.push(new Vr(Pe.keyField(),r))}return e.ce}function lt(n){let e=M(n);return e.le||(e.le=Ab(e,Vi(n))),e.le}function Ab(n,e){if(n.limitType==="F")return Lf(n.path,n.collectionGroup,e,n.filters,n.limit,n.startAt,n.endAt);{e=e.map(i=>{let s=i.dir==="desc"?"asc":"desc";return new Vr(i.field,s)});let t=n.endAt?new Xt(n.endAt.position,n.endAt.inclusive):null,r=n.startAt?new Xt(n.startAt.position,n.startAt.inclusive):null;return Lf(n.path,n.collectionGroup,e,n.filters,n.limit,t,r)}}function Uf(n,e){let t=n.filters.concat([e]);return new kt(n.path,n.collectionGroup,n.explicitOrderBy.slice(),t,n.limit,n.limitType,n.startAt,n.endAt)}function wu(n,e,t){return new kt(n.path,n.collectionGroup,n.explicitOrderBy.slice(),n.filters.slice(),e,t,n.startAt,n.endAt)}function Zo(n,e){return Xo(lt(n),lt(e))&&n.limitType===e.limitType}function ZE(n){return`${Fr(lt(n))}|lt:${n.limitType}`}function Ri(n){return`Query(target=${function(t){let r=t.path.canonicalString();return t.collectionGroup!==null&&(r+=" collectionGroup="+t.collectionGroup),t.filters.length>0&&(r+=`, filters: [${t.filters.map(i=>YE(i)).join(", ")}]`),Jo(t.limit)||(r+=", limit: "+t.limit),t.orderBy.length>0&&(r+=`, orderBy: [${t.orderBy.map(i=>function(o){return`${o.field.canonicalString()} (${o.dir})`}(i)).join(", ")}]`),t.startAt&&(r+=", startAt: ",r+=t.startAt.inclusive?"b:":"a:",r+=t.startAt.position.map(i=>Li(i)).join(",")),t.endAt&&(r+=", endAt: ",r+=t.endAt.inclusive?"a:":"b:",r+=t.endAt.position.map(i=>Li(i)).join(",")),`Target(${r})`}(lt(n))}; limitType=${n.limitType})`}function ea(n,e){return e.isFoundDocument()&&function(r,i){let s=i.key.path;return r.collectionGroup!==null?i.key.hasCollectionId(r.collectionGroup)&&r.path.isPrefixOf(s):L.isDocumentKey(r.path)?r.path.isEqual(s):r.path.isImmediateParentOf(s)}(n,e)&&function(r,i){for(let s of Vi(r))if(!s.field.isKeyField()&&i.data.field(s.field)===null)return!1;return!0}(n,e)&&function(r,i){for(let s of r.filters)if(!s.matches(i))return!1;return!0}(n,e)&&function(r,i){return!(r.startAt&&!function(o,l,u){let c=Lw(o,l,u);return o.inclusive?c<=0:c<0}(r.startAt,Vi(r),i)||r.endAt&&!function(o,l,u){let c=Lw(o,l,u);return o.inclusive?c>=0:c>0}(r.endAt,Vi(r),i))}(n,e)}function eI(n){return n.collectionGroup||(n.path.length%2==1?n.path.lastSegment():n.path.get(n.path.length-2))}function tI(n){return(e,t)=>{let r=!1;for(let i of Vi(n)){let s=bb(i,e,t);if(s!==0)return s;r=r||i.field.isKeyField()}return 0}}function bb(n,e,t){let r=n.field.isKeyField()?L.comparator(e.key,t.key):function(s,o,l){let u=o.data.field(s),c=l.data.field(s);return u!==null&&c!==null?Jn(u,c):U()}(n.field,e,t);switch(n.dir){case"asc":return r;case"desc":return-1*r;default:return U()}}var Zt=class{constructor(e,t){this.mapKeyFn=e,this.equalsFn=t,this.inner={},this.innerSize=0}get(e){let t=this.mapKeyFn(e),r=this.inner[t];if(r!==void 0){for(let[i,s]of r)if(this.equalsFn(i,e))return s}}has(e){return this.get(e)!==void 0}set(e,t){let r=this.mapKeyFn(e),i=this.inner[r];if(i===void 0)return this.inner[r]=[[e,t]],void this.innerSize++;for(let s=0;s<i.length;s++)if(this.equalsFn(i[s][0],e))return void(i[s]=[e,t]);i.push([e,t]),this.innerSize++}delete(e){let t=this.mapKeyFn(e),r=this.inner[t];if(r===void 0)return!1;for(let i=0;i<r.length;i++)if(this.equalsFn(r[i][0],e))return r.length===1?delete this.inner[t]:r.splice(i,1),this.innerSize--,!0;return!1}forEach(e){jr(this.inner,(t,r)=>{for(let[i,s]of r)e(i,s)})}isEmpty(){return GE(this.inner)}size(){return this.innerSize}};var Rb=new we(L.comparator);function ht(){return Rb}var nI=new we(L.comparator);function To(...n){let e=nI;for(let t of n)e=e.insert(t.key,t);return e}function rI(n){let e=nI;return n.forEach((t,r)=>e=e.insert(t,r.overlayedDocument)),e}function Qt(){return Ao()}function iI(){return Ao()}function Ao(){return new Zt(n=>n.toString(),(n,e)=>n.isEqual(e))}var Pb=new we(L.comparator),xb=new ge(L.comparator);function H(...n){let e=xb;for(let t of n)e=e.add(t);return e}var Nb=new ge(W);function wm(){return Nb}function Em(n,e){if(n.useProto3Json){if(isNaN(e))return{doubleValue:"NaN"};if(e===1/0)return{doubleValue:"Infinity"};if(e===-1/0)return{doubleValue:"-Infinity"}}return{doubleValue:No(e)?"-0":e}}function sI(n){return{integerValue:""+n}}function oI(n,e){return ME(e)?sI(e):Em(n,e)}var Bi=class{constructor(){this._=void 0}};function Db(n,e,t){return n instanceof Xn?function(i,s){let o={fields:{__type__:{stringValue:"server_timestamp"},__local_write_time__:{timestampValue:{seconds:i.seconds,nanos:i.nanoseconds}}}};return s&&oc(s)&&(s=_m(s)),s&&(o.fields.__previous_value__=s),{mapValue:o}}(t,e):n instanceof mn?lI(n,e):n instanceof gn?uI(n,e):function(i,s){let o=aI(i,s),l=jw(o)+jw(i.Pe);return Rf(o)&&Rf(i.Pe)?sI(l):Em(i.serializer,l)}(n,e)}function kb(n,e,t){return n instanceof mn?lI(n,e):n instanceof gn?uI(n,e):t}function aI(n,e){return n instanceof Zn?function(r){return Rf(r)||function(s){return!!s&&"doubleValue"in s}(r)}(e)?e:{integerValue:0}:null}var Xn=class extends Bi{},mn=class extends Bi{constructor(e){super(),this.elements=e}};function lI(n,e){let t=cI(e);for(let r of n.elements)t.some(i=>Jt(i,r))||t.push(r);return{arrayValue:{values:t}}}var gn=class extends Bi{constructor(e){super(),this.elements=e}};function uI(n,e){let t=cI(e);for(let r of n.elements)t=t.filter(i=>!Jt(i,r));return{arrayValue:{values:t}}}var Zn=class extends Bi{constructor(e,t){super(),this.serializer=e,this.Pe=t}};function jw(n){return Ie(n.integerValue||n.doubleValue)}function cI(n){return Fo(n)&&n.arrayValue.values?n.arrayValue.values.slice():[]}var Or=class{constructor(e,t){this.field=e,this.transform=t}};function Vb(n,e){return n.field.isEqual(e.field)&&function(r,i){return r instanceof mn&&i instanceof mn||r instanceof gn&&i instanceof gn?Oi(r.elements,i.elements,Jt):r instanceof Zn&&i instanceof Zn?Jt(r.Pe,i.Pe):r instanceof Xn&&i instanceof Xn}(n.transform,e.transform)}var Bf=class{constructor(e,t){this.version=e,this.transformResults=t}},be=class n{constructor(e,t){this.updateTime=e,this.exists=t}static none(){return new n}static exists(e){return new n(void 0,e)}static updateTime(e){return new n(e)}get isNone(){return this.updateTime===void 0&&this.exists===void 0}isEqual(e){return this.exists===e.exists&&(this.updateTime?!!e.updateTime&&this.updateTime.isEqual(e.updateTime):!e.updateTime)}};function au(n,e){return n.updateTime!==void 0?e.isFoundDocument()&&e.version.isEqual(n.updateTime):n.exists===void 0||n.exists===e.isFoundDocument()}var qi=class{};function hI(n,e){if(!n.hasLocalMutations||e&&e.fields.length===0)return null;if(e===null)return n.isNoDocument()?new tr(n.key,be.none()):new er(n.key,n.data,be.none());{let t=n.data,r=et.empty(),i=new ge(Pe.comparator);for(let s of e.fields)if(!i.has(s)){let o=t.field(s);o===null&&s.length>1&&(s=s.popLast(),o=t.field(s)),o===null?r.delete(s):r.set(s,o),i=i.add(s)}return new Vt(n.key,r,new yt(i.toArray()),be.none())}}function Fb(n,e,t){n instanceof er?function(i,s,o){let l=i.value.clone(),u=Kw(i.fieldTransforms,s,o.transformResults);l.setAll(u),s.convertToFoundDocument(o.version,l).setHasCommittedMutations()}(n,e,t):n instanceof Vt?function(i,s,o){if(!au(i.precondition,s))return void s.convertToUnknownDocument(o.version);let l=Kw(i.fieldTransforms,s,o.transformResults),u=s.data;u.setAll(dI(i)),u.setAll(l),s.convertToFoundDocument(o.version,u).setHasCommittedMutations()}(n,e,t):function(i,s,o){s.convertToNoDocument(o.version).setHasCommittedMutations()}(0,e,t)}function bo(n,e,t,r){return n instanceof er?function(s,o,l,u){if(!au(s.precondition,o))return l;let c=s.value.clone(),d=Ww(s.fieldTransforms,u,o);return c.setAll(d),o.convertToFoundDocument(o.version,c).setHasLocalMutations(),null}(n,e,t,r):n instanceof Vt?function(s,o,l,u){if(!au(s.precondition,o))return l;let c=Ww(s.fieldTransforms,u,o),d=o.data;return d.setAll(dI(s)),d.setAll(c),o.convertToFoundDocument(o.version,d).setHasLocalMutations(),l===null?null:l.unionWith(s.fieldMask.fields).unionWith(s.fieldTransforms.map(p=>p.field))}(n,e,t,r):function(s,o,l){return au(s.precondition,o)?(o.convertToNoDocument(o.version).setHasLocalMutations(),null):l}(n,e,t)}function Ob(n,e){let t=null;for(let r of n.fieldTransforms){let i=e.data.field(r.field),s=aI(r.transform,i||null);s!=null&&(t===null&&(t=et.empty()),t.set(r.field,s))}return t||null}function zw(n,e){return n.type===e.type&&!!n.key.isEqual(e.key)&&!!n.precondition.isEqual(e.precondition)&&!!function(r,i){return r===void 0&&i===void 0||!(!r||!i)&&Oi(r,i,(s,o)=>Vb(s,o))}(n.fieldTransforms,e.fieldTransforms)&&(n.type===0?n.value.isEqual(e.value):n.type!==1||n.data.isEqual(e.data)&&n.fieldMask.isEqual(e.fieldMask))}var er=class extends qi{constructor(e,t,r,i=[]){super(),this.key=e,this.value=t,this.precondition=r,this.fieldTransforms=i,this.type=0}getFieldMask(){return null}},Vt=class extends qi{constructor(e,t,r,i,s=[]){super(),this.key=e,this.data=t,this.fieldMask=r,this.precondition=i,this.fieldTransforms=s,this.type=1}getFieldMask(){return this.fieldMask}};function dI(n){let e=new Map;return n.fieldMask.fields.forEach(t=>{if(!t.isEmpty()){let r=n.data.field(t);e.set(t,r)}}),e}function Kw(n,e,t){let r=new Map;G(n.length===t.length);for(let i=0;i<t.length;i++){let s=n[i],o=s.transform,l=e.data.field(s.field);r.set(s.field,kb(o,l,t[i]))}return r}function Ww(n,e,t){let r=new Map;for(let i of n){let s=i.transform,o=t.data.field(i.field);r.set(i.field,Db(s,o,e))}return r}var tr=class extends qi{constructor(e,t){super(),this.key=e,this.precondition=t,this.type=2,this.fieldTransforms=[]}getFieldMask(){return null}},Oo=class extends qi{constructor(e,t){super(),this.key=e,this.precondition=t,this.type=3,this.fieldTransforms=[]}getFieldMask(){return null}};var Mo=class{constructor(e,t,r,i){this.batchId=e,this.localWriteTime=t,this.baseMutations=r,this.mutations=i}applyToRemoteDocument(e,t){let r=t.mutationResults;for(let i=0;i<this.mutations.length;i++){let s=this.mutations[i];s.key.isEqual(e.key)&&Fb(s,e,r[i])}}applyToLocalView(e,t){for(let r of this.baseMutations)r.key.isEqual(e.key)&&(t=bo(r,e,t,this.localWriteTime));for(let r of this.mutations)r.key.isEqual(e.key)&&(t=bo(r,e,t,this.localWriteTime));return t}applyToLocalDocumentSet(e,t){let r=iI();return this.mutations.forEach(i=>{let s=e.get(i.key),o=s.overlayedDocument,l=this.applyToLocalView(o,s.mutatedFields);l=t.has(i.key)?null:l;let u=hI(o,l);u!==null&&r.set(i.key,u),o.isValidDocument()||o.convertToNoDocument(z.min())}),r}keys(){return this.mutations.reduce((e,t)=>e.add(t.key),H())}isEqual(e){return this.batchId===e.batchId&&Oi(this.mutations,e.mutations,(t,r)=>zw(t,r))&&Oi(this.baseMutations,e.baseMutations,(t,r)=>zw(t,r))}},qf=class n{constructor(e,t,r,i){this.batch=e,this.commitVersion=t,this.mutationResults=r,this.docVersions=i}static from(e,t,r){G(e.mutations.length===r.length);let i=function(){return Pb}(),s=e.mutations;for(let o=0;o<s.length;o++)i=i.insert(s[o].key,r[o].version);return new n(e,t,r,i)}};var Lo=class{constructor(e,t){this.largestBatchId=e,this.mutation=t}getKey(){return this.mutation.key}isEqual(e){return e!==null&&this.mutation===e.mutation}toString(){return`Overlay{
      largestBatchId: ${this.largestBatchId},
      mutation: ${this.mutation.toString()}
    }`}};var Gf=class{constructor(e,t){this.count=e,this.unchangedNames=t}};var Ve,se;function fI(n){switch(n){default:return U();case P.CANCELLED:case P.UNKNOWN:case P.DEADLINE_EXCEEDED:case P.RESOURCE_EXHAUSTED:case P.INTERNAL:case P.UNAVAILABLE:case P.UNAUTHENTICATED:return!1;case P.INVALID_ARGUMENT:case P.NOT_FOUND:case P.ALREADY_EXISTS:case P.PERMISSION_DENIED:case P.FAILED_PRECONDITION:case P.ABORTED:case P.OUT_OF_RANGE:case P.UNIMPLEMENTED:case P.DATA_LOSS:return!0}}function pI(n){if(n===void 0)return Re("GRPC error has no .code"),P.UNKNOWN;switch(n){case Ve.OK:return P.OK;case Ve.CANCELLED:return P.CANCELLED;case Ve.UNKNOWN:return P.UNKNOWN;case Ve.DEADLINE_EXCEEDED:return P.DEADLINE_EXCEEDED;case Ve.RESOURCE_EXHAUSTED:return P.RESOURCE_EXHAUSTED;case Ve.INTERNAL:return P.INTERNAL;case Ve.UNAVAILABLE:return P.UNAVAILABLE;case Ve.UNAUTHENTICATED:return P.UNAUTHENTICATED;case Ve.INVALID_ARGUMENT:return P.INVALID_ARGUMENT;case Ve.NOT_FOUND:return P.NOT_FOUND;case Ve.ALREADY_EXISTS:return P.ALREADY_EXISTS;case Ve.PERMISSION_DENIED:return P.PERMISSION_DENIED;case Ve.FAILED_PRECONDITION:return P.FAILED_PRECONDITION;case Ve.ABORTED:return P.ABORTED;case Ve.OUT_OF_RANGE:return P.OUT_OF_RANGE;case Ve.UNIMPLEMENTED:return P.UNIMPLEMENTED;case Ve.DATA_LOSS:return P.DATA_LOSS;default:return U()}}(se=Ve||(Ve={}))[se.OK=0]="OK",se[se.CANCELLED=1]="CANCELLED",se[se.UNKNOWN=2]="UNKNOWN",se[se.INVALID_ARGUMENT=3]="INVALID_ARGUMENT",se[se.DEADLINE_EXCEEDED=4]="DEADLINE_EXCEEDED",se[se.NOT_FOUND=5]="NOT_FOUND",se[se.ALREADY_EXISTS=6]="ALREADY_EXISTS",se[se.PERMISSION_DENIED=7]="PERMISSION_DENIED",se[se.UNAUTHENTICATED=16]="UNAUTHENTICATED",se[se.RESOURCE_EXHAUSTED=8]="RESOURCE_EXHAUSTED",se[se.FAILED_PRECONDITION=9]="FAILED_PRECONDITION",se[se.ABORTED=10]="ABORTED",se[se.OUT_OF_RANGE=11]="OUT_OF_RANGE",se[se.UNIMPLEMENTED=12]="UNIMPLEMENTED",se[se.INTERNAL=13]="INTERNAL",se[se.UNAVAILABLE=14]="UNAVAILABLE",se[se.DATA_LOSS=15]="DATA_LOSS";var Qw=null;function mI(){return new TextEncoder}var Mb=new Bn([4294967295,4294967295],0);function $w(n){let e=mI().encode(n),t=new nf;return t.update(e),new Uint8Array(t.digest())}function Hw(n){let e=new DataView(n.buffer),t=e.getUint32(0,!0),r=e.getUint32(4,!0),i=e.getUint32(8,!0),s=e.getUint32(12,!0);return[new Bn([t,r],0),new Bn([i,s],0)]}var jf=class n{constructor(e,t,r){if(this.bitmap=e,this.padding=t,this.hashCount=r,t<0||t>=8)throw new xr(`Invalid padding: ${t}`);if(r<0)throw new xr(`Invalid hash count: ${r}`);if(e.length>0&&this.hashCount===0)throw new xr(`Invalid hash count: ${r}`);if(e.length===0&&t!==0)throw new xr(`Invalid padding when bitmap length is 0: ${t}`);this.Ie=8*e.length-t,this.Te=Bn.fromNumber(this.Ie)}Ee(e,t,r){let i=e.add(t.multiply(Bn.fromNumber(r)));return i.compare(Mb)===1&&(i=new Bn([i.getBits(0),i.getBits(1)],0)),i.modulo(this.Te).toNumber()}de(e){return(this.bitmap[Math.floor(e/8)]&1<<e%8)!=0}mightContain(e){if(this.Ie===0)return!1;let t=$w(e),[r,i]=Hw(t);for(let s=0;s<this.hashCount;s++){let o=this.Ee(r,i,s);if(!this.de(o))return!1}return!0}static create(e,t,r){let i=e%8==0?0:8-e%8,s=new Uint8Array(Math.ceil(e/8)),o=new n(s,i,t);return r.forEach(l=>o.insert(l)),o}insert(e){if(this.Ie===0)return;let t=$w(e),[r,i]=Hw(t);for(let s=0;s<this.hashCount;s++){let o=this.Ee(r,i,s);this.Ae(o)}}Ae(e){let t=Math.floor(e/8),r=e%8;this.bitmap[t]|=1<<r}},xr=class extends Error{constructor(){super(...arguments),this.name="BloomFilterError"}};var Uo=class n{constructor(e,t,r,i,s){this.snapshotVersion=e,this.targetChanges=t,this.targetMismatches=r,this.documentUpdates=i,this.resolvedLimboDocuments=s}static createSynthesizedRemoteEventForCurrentChange(e,t,r){let i=new Map;return i.set(e,Bo.createSynthesizedTargetChangeForCurrentChange(e,t,r)),new n(z.min(),i,new we(W),ht(),H())}},Bo=class n{constructor(e,t,r,i,s){this.resumeToken=e,this.current=t,this.addedDocuments=r,this.modifiedDocuments=i,this.removedDocuments=s}static createSynthesizedTargetChangeForCurrentChange(e,t,r){return new n(r,t,H(),H(),H())}};var Fi=class{constructor(e,t,r,i){this.Re=e,this.removedTargetIds=t,this.key=r,this.Ve=i}},Eu=class{constructor(e,t){this.targetId=e,this.me=t}},Iu=class{constructor(e,t,r=Ne.EMPTY_BYTE_STRING,i=null){this.state=e,this.targetIds=t,this.resumeToken=r,this.cause=i}},Tu=class{constructor(){this.fe=0,this.ge=Jw(),this.pe=Ne.EMPTY_BYTE_STRING,this.ye=!1,this.we=!0}get current(){return this.ye}get resumeToken(){return this.pe}get Se(){return this.fe!==0}get be(){return this.we}De(e){e.approximateByteSize()>0&&(this.we=!0,this.pe=e)}ve(){let e=H(),t=H(),r=H();return this.ge.forEach((i,s)=>{switch(s){case 0:e=e.add(i);break;case 2:t=t.add(i);break;case 1:r=r.add(i);break;default:U()}}),new Bo(this.pe,this.ye,e,t,r)}Ce(){this.we=!1,this.ge=Jw()}Fe(e,t){this.we=!0,this.ge=this.ge.insert(e,t)}Me(e){this.we=!0,this.ge=this.ge.remove(e)}xe(){this.fe+=1}Oe(){this.fe-=1,G(this.fe>=0)}Ne(){this.we=!0,this.ye=!0}},zf=class{constructor(e){this.Le=e,this.Be=new Map,this.ke=ht(),this.qe=Yw(),this.Qe=new we(W)}Ke(e){for(let t of e.Re)e.Ve&&e.Ve.isFoundDocument()?this.$e(t,e.Ve):this.Ue(t,e.key,e.Ve);for(let t of e.removedTargetIds)this.Ue(t,e.key,e.Ve)}We(e){this.forEachTarget(e,t=>{let r=this.Ge(t);switch(e.state){case 0:this.ze(t)&&r.De(e.resumeToken);break;case 1:r.Oe(),r.Se||r.Ce(),r.De(e.resumeToken);break;case 2:r.Oe(),r.Se||this.removeTarget(t);break;case 3:this.ze(t)&&(r.Ne(),r.De(e.resumeToken));break;case 4:this.ze(t)&&(this.je(t),r.De(e.resumeToken));break;default:U()}})}forEachTarget(e,t){e.targetIds.length>0?e.targetIds.forEach(t):this.Be.forEach((r,i)=>{this.ze(i)&&t(i)})}He(e){let t=e.targetId,r=e.me.count,i=this.Je(t);if(i){let s=i.target;if(yu(s))if(r===0){let o=new L(s.path);this.Ue(t,o,Me.newNoDocument(o,z.min()))}else G(r===1);else{let o=this.Ye(t);if(o!==r){let l=this.Ze(e),u=l?this.Xe(l,e,o):1;if(u!==0){this.je(t);let c=u===2?"TargetPurposeExistenceFilterMismatchBloom":"TargetPurposeExistenceFilterMismatch";this.Qe=this.Qe.insert(t,c)}Qw?.et(function(d,p,m,y,C){var x,D,q,j,B,Y;let re={localCacheCount:d,existenceFilterCount:p.count,databaseId:m.database,projectId:m.projectId},Q=p.unchangedNames;return Q&&(re.bloomFilter={applied:C===0,hashCount:(x=Q?.hashCount)!==null&&x!==void 0?x:0,bitmapLength:(j=(q=(D=Q?.bits)===null||D===void 0?void 0:D.bitmap)===null||q===void 0?void 0:q.length)!==null&&j!==void 0?j:0,padding:(Y=(B=Q?.bits)===null||B===void 0?void 0:B.padding)!==null&&Y!==void 0?Y:0,mightContain:E=>{var _;return(_=y?.mightContain(E))!==null&&_!==void 0&&_}}),re}(o,e.me,this.Le.tt(),l,u))}}}}Ze(e){let t=e.me.unchangedNames;if(!t||!t.bits)return null;let{bits:{bitmap:r="",padding:i=0},hashCount:s=0}=t,o,l;try{o=Hn(r).toUint8Array()}catch(u){if(u instanceof mu)return Dt("Decoding the base64 bloom filter in existence filter failed ("+u.message+"); ignoring the bloom filter and falling back to full re-query."),null;throw u}try{l=new jf(o,i,s)}catch(u){return Dt(u instanceof xr?"BloomFilter error: ":"Applying bloom filter failed: ",u),null}return l.Ie===0?null:l}Xe(e,t,r){return t.me.count===r-this.nt(e,t.targetId)?0:2}nt(e,t){let r=this.Le.getRemoteKeysForTarget(t),i=0;return r.forEach(s=>{let o=this.Le.tt(),l=`projects/${o.projectId}/databases/${o.database}/documents/${s.path.canonicalString()}`;e.mightContain(l)||(this.Ue(t,s,null),i++)}),i}rt(e){let t=new Map;this.Be.forEach((s,o)=>{let l=this.Je(o);if(l){if(s.current&&yu(l.target)){let u=new L(l.target.path);this.ke.get(u)!==null||this.it(o,u)||this.Ue(o,u,Me.newNoDocument(u,e))}s.be&&(t.set(o,s.ve()),s.Ce())}});let r=H();this.qe.forEach((s,o)=>{let l=!0;o.forEachWhile(u=>{let c=this.Je(u);return!c||c.purpose==="TargetPurposeLimboResolution"||(l=!1,!1)}),l&&(r=r.add(s))}),this.ke.forEach((s,o)=>o.setReadTime(e));let i=new Uo(e,t,this.Qe,this.ke,r);return this.ke=ht(),this.qe=Yw(),this.Qe=new we(W),i}$e(e,t){if(!this.ze(e))return;let r=this.it(e,t.key)?2:0;this.Ge(e).Fe(t.key,r),this.ke=this.ke.insert(t.key,t),this.qe=this.qe.insert(t.key,this.st(t.key).add(e))}Ue(e,t,r){if(!this.ze(e))return;let i=this.Ge(e);this.it(e,t)?i.Fe(t,1):i.Me(t),this.qe=this.qe.insert(t,this.st(t).delete(e)),r&&(this.ke=this.ke.insert(t,r))}removeTarget(e){this.Be.delete(e)}Ye(e){let t=this.Ge(e).ve();return this.Le.getRemoteKeysForTarget(e).size+t.addedDocuments.size-t.removedDocuments.size}xe(e){this.Ge(e).xe()}Ge(e){let t=this.Be.get(e);return t||(t=new Tu,this.Be.set(e,t)),t}st(e){let t=this.qe.get(e);return t||(t=new ge(W),this.qe=this.qe.insert(e,t)),t}ze(e){let t=this.Je(e)!==null;return t||V("WatchChangeAggregator","Detected inactive target",e),t}Je(e){let t=this.Be.get(e);return t&&t.Se?null:this.Le.ot(e)}je(e){this.Be.set(e,new Tu),this.Le.getRemoteKeysForTarget(e).forEach(t=>{this.Ue(e,t,null)})}it(e,t){return this.Le.getRemoteKeysForTarget(e).has(t)}};function Yw(){return new we(L.comparator)}function Jw(){return new we(L.comparator)}var Lb={asc:"ASCENDING",desc:"DESCENDING"},Ub={"<":"LESS_THAN","<=":"LESS_THAN_OR_EQUAL",">":"GREATER_THAN",">=":"GREATER_THAN_OR_EQUAL","==":"EQUAL","!=":"NOT_EQUAL","array-contains":"ARRAY_CONTAINS",in:"IN","not-in":"NOT_IN","array-contains-any":"ARRAY_CONTAINS_ANY"},Bb={and:"AND",or:"OR"},Kf=class{constructor(e,t){this.databaseId=e,this.useProto3Json=t}};function Wf(n,e){return n.useProto3Json||Jo(e)?e:{value:e}}function Gi(n,e){return n.useProto3Json?`${new Date(1e3*e.seconds).toISOString().replace(/\.\d*/,"").replace("Z","")}.${("000000000"+e.nanoseconds).slice(-9)}Z`:{seconds:""+e.seconds,nanos:e.nanoseconds}}function gI(n,e){return n.useProto3Json?e.toBase64():e.toUint8Array()}function qb(n,e){return Gi(n,e.toTimestamp())}function xe(n){return G(!!n),z.fromTimestamp(function(t){let r=pn(t);return new Se(r.seconds,r.nanos)}(n))}function Im(n,e){return Qf(n,e).canonicalString()}function Qf(n,e){let t=function(i){return new oe(["projects",i.projectId,"databases",i.database])}(n).child("documents");return e===void 0?t:t.child(e)}function _I(n){let e=oe.fromString(n);return G(bI(e)),e}function qo(n,e){return Im(n.databaseId,e.path)}function Ht(n,e){let t=_I(e);if(t.get(1)!==n.databaseId.projectId)throw new k(P.INVALID_ARGUMENT,"Tried to deserialize key from different project: "+t.get(1)+" vs "+n.databaseId.projectId);if(t.get(3)!==n.databaseId.database)throw new k(P.INVALID_ARGUMENT,"Tried to deserialize key from different database: "+t.get(3)+" vs "+n.databaseId.database);return new L(wI(t))}function yI(n,e){return Im(n.databaseId,e)}function vI(n){let e=_I(n);return e.length===4?oe.emptyPath():wI(e)}function $f(n){return new oe(["projects",n.databaseId.projectId,"databases",n.databaseId.database]).canonicalString()}function wI(n){return G(n.length>4&&n.get(4)==="documents"),n.popFirst(5)}function Xw(n,e,t){return{name:qo(n,e),fields:t.value.mapValue.fields}}function EI(n,e,t){let r=Ht(n,e.name),i=xe(e.updateTime),s=e.createTime?xe(e.createTime):z.min(),o=new et({mapValue:{fields:e.fields}}),l=Me.newFoundDocument(r,i,s,o);return t&&l.setHasCommittedMutations(),t?l.setHasCommittedMutations():l}function Gb(n,e){return"found"in e?function(r,i){G(!!i.found),i.found.name,i.found.updateTime;let s=Ht(r,i.found.name),o=xe(i.found.updateTime),l=i.found.createTime?xe(i.found.createTime):z.min(),u=new et({mapValue:{fields:i.found.fields}});return Me.newFoundDocument(s,o,l,u)}(n,e):"missing"in e?function(r,i){G(!!i.missing),G(!!i.readTime);let s=Ht(r,i.missing),o=xe(i.readTime);return Me.newNoDocument(s,o)}(n,e):U()}function jb(n,e){let t;if("targetChange"in e){e.targetChange;let r=function(c){return c==="NO_CHANGE"?0:c==="ADD"?1:c==="REMOVE"?2:c==="CURRENT"?3:c==="RESET"?4:U()}(e.targetChange.targetChangeType||"NO_CHANGE"),i=e.targetChange.targetIds||[],s=function(c,d){return c.useProto3Json?(G(d===void 0||typeof d=="string"),Ne.fromBase64String(d||"")):(G(d===void 0||d instanceof Buffer||d instanceof Uint8Array),Ne.fromUint8Array(d||new Uint8Array))}(n,e.targetChange.resumeToken),o=e.targetChange.cause,l=o&&function(c){let d=c.code===void 0?P.UNKNOWN:pI(c.code);return new k(d,c.message||"")}(o);t=new Iu(r,i,s,l||null)}else if("documentChange"in e){e.documentChange;let r=e.documentChange;r.document,r.document.name,r.document.updateTime;let i=Ht(n,r.document.name),s=xe(r.document.updateTime),o=r.document.createTime?xe(r.document.createTime):z.min(),l=new et({mapValue:{fields:r.document.fields}}),u=Me.newFoundDocument(i,s,o,l),c=r.targetIds||[],d=r.removedTargetIds||[];t=new Fi(c,d,u.key,u)}else if("documentDelete"in e){e.documentDelete;let r=e.documentDelete;r.document;let i=Ht(n,r.document),s=r.readTime?xe(r.readTime):z.min(),o=Me.newNoDocument(i,s),l=r.removedTargetIds||[];t=new Fi([],l,o.key,o)}else if("documentRemove"in e){e.documentRemove;let r=e.documentRemove;r.document;let i=Ht(n,r.document),s=r.removedTargetIds||[];t=new Fi([],s,i,null)}else{if(!("filter"in e))return U();{e.filter;let r=e.filter;r.targetId;let{count:i=0,unchangedNames:s}=r,o=new Gf(i,s),l=r.targetId;t=new Eu(l,o)}}return t}function Go(n,e){let t;if(e instanceof er)t={update:Xw(n,e.key,e.value)};else if(e instanceof tr)t={delete:qo(n,e.key)};else if(e instanceof Vt)t={update:Xw(n,e.key,e.data),updateMask:Hb(e.fieldMask)};else{if(!(e instanceof Oo))return U();t={verify:qo(n,e.key)}}return e.fieldTransforms.length>0&&(t.updateTransforms=e.fieldTransforms.map(r=>function(s,o){let l=o.transform;if(l instanceof Xn)return{fieldPath:o.field.canonicalString(),setToServerValue:"REQUEST_TIME"};if(l instanceof mn)return{fieldPath:o.field.canonicalString(),appendMissingElements:{values:l.elements}};if(l instanceof gn)return{fieldPath:o.field.canonicalString(),removeAllFromArray:{values:l.elements}};if(l instanceof Zn)return{fieldPath:o.field.canonicalString(),increment:l.Pe};throw U()}(0,r))),e.precondition.isNone||(t.currentDocument=function(i,s){return s.updateTime!==void 0?{updateTime:qb(i,s.updateTime)}:s.exists!==void 0?{exists:s.exists}:U()}(n,e.precondition)),t}function Hf(n,e){let t=e.currentDocument?function(s){return s.updateTime!==void 0?be.updateTime(xe(s.updateTime)):s.exists!==void 0?be.exists(s.exists):be.none()}(e.currentDocument):be.none(),r=e.updateTransforms?e.updateTransforms.map(i=>function(o,l){let u=null;if("setToServerValue"in l)G(l.setToServerValue==="REQUEST_TIME"),u=new Xn;else if("appendMissingElements"in l){let d=l.appendMissingElements.values||[];u=new mn(d)}else if("removeAllFromArray"in l){let d=l.removeAllFromArray.values||[];u=new gn(d)}else"increment"in l?u=new Zn(o,l.increment):U();let c=Pe.fromServerFormat(l.fieldPath);return new Or(c,u)}(n,i)):[];if(e.update){e.update.name;let i=Ht(n,e.update.name),s=new et({mapValue:{fields:e.update.fields}});if(e.updateMask){let o=function(u){let c=u.fieldPaths||[];return new yt(c.map(d=>Pe.fromServerFormat(d)))}(e.updateMask);return new Vt(i,s,o,t,r)}return new er(i,s,t,r)}if(e.delete){let i=Ht(n,e.delete);return new tr(i,t)}if(e.verify){let i=Ht(n,e.verify);return new Oo(i,t)}return U()}function zb(n,e){return n&&n.length>0?(G(e!==void 0),n.map(t=>function(i,s){let o=i.updateTime?xe(i.updateTime):xe(s);return o.isEqual(z.min())&&(o=xe(s)),new Bf(o,i.transformResults||[])}(t,e))):[]}function II(n,e){return{documents:[yI(n,e.path)]}}function TI(n,e){let t={structuredQuery:{}},r=e.path,i;e.collectionGroup!==null?(i=r,t.structuredQuery.from=[{collectionId:e.collectionGroup,allDescendants:!0}]):(i=r.popLast(),t.structuredQuery.from=[{collectionId:r.lastSegment()}]),t.parent=yI(n,i);let s=function(c){if(c.length!==0)return AI(de.create(c,"and"))}(e.filters);s&&(t.structuredQuery.where=s);let o=function(c){if(c.length!==0)return c.map(d=>function(m){return{field:Pi(m.field),direction:Wb(m.dir)}}(d))}(e.orderBy);o&&(t.structuredQuery.orderBy=o);let l=Wf(n,e.limit);return l!==null&&(t.structuredQuery.limit=l),e.startAt&&(t.structuredQuery.startAt=function(c){return{before:c.inclusive,values:c.position}}(e.startAt)),e.endAt&&(t.structuredQuery.endAt=function(c){return{before:!c.inclusive,values:c.position}}(e.endAt)),{_t:t,parent:i}}function SI(n){let e=vI(n.parent),t=n.structuredQuery,r=t.from?t.from.length:0,i=null;if(r>0){G(r===1);let d=t.from[0];d.allDescendants?i=d.collectionId:e=e.child(d.collectionId)}let s=[];t.where&&(s=function(p){let m=CI(p);return m instanceof de&&ym(m)?m.getFilters():[m]}(t.where));let o=[];t.orderBy&&(o=function(p){return p.map(m=>function(C){return new Vr(xi(C.field),function(D){switch(D){case"ASCENDING":return"asc";case"DESCENDING":return"desc";default:return}}(C.direction))}(m))}(t.orderBy));let l=null;t.limit&&(l=function(p){let m;return m=typeof p=="object"?p.value:p,Jo(m)?null:m}(t.limit));let u=null;t.startAt&&(u=function(p){let m=!!p.before,y=p.values||[];return new Xt(y,m)}(t.startAt));let c=null;return t.endAt&&(c=function(p){let m=!p.before,y=p.values||[];return new Xt(y,m)}(t.endAt)),XE(e,i,o,s,l,"F",u,c)}function Kb(n,e){let t=function(i){switch(i){case"TargetPurposeListen":return null;case"TargetPurposeExistenceFilterMismatch":return"existence-filter-mismatch";case"TargetPurposeExistenceFilterMismatchBloom":return"existence-filter-mismatch-bloom";case"TargetPurposeLimboResolution":return"limbo-document";default:return U()}}(e.purpose);return t==null?null:{"goog-listen-tags":t}}function CI(n){return n.unaryFilter!==void 0?function(t){switch(t.unaryFilter.op){case"IS_NAN":let r=xi(t.unaryFilter.field);return ne.create(r,"==",{doubleValue:NaN});case"IS_NULL":let i=xi(t.unaryFilter.field);return ne.create(i,"==",{nullValue:"NULL_VALUE"});case"IS_NOT_NAN":let s=xi(t.unaryFilter.field);return ne.create(s,"!=",{doubleValue:NaN});case"IS_NOT_NULL":let o=xi(t.unaryFilter.field);return ne.create(o,"!=",{nullValue:"NULL_VALUE"});default:return U()}}(n):n.fieldFilter!==void 0?function(t){return ne.create(xi(t.fieldFilter.field),function(i){switch(i){case"EQUAL":return"==";case"NOT_EQUAL":return"!=";case"GREATER_THAN":return">";case"GREATER_THAN_OR_EQUAL":return">=";case"LESS_THAN":return"<";case"LESS_THAN_OR_EQUAL":return"<=";case"ARRAY_CONTAINS":return"array-contains";case"IN":return"in";case"NOT_IN":return"not-in";case"ARRAY_CONTAINS_ANY":return"array-contains-any";default:return U()}}(t.fieldFilter.op),t.fieldFilter.value)}(n):n.compositeFilter!==void 0?function(t){return de.create(t.compositeFilter.filters.map(r=>CI(r)),function(i){switch(i){case"AND":return"and";case"OR":return"or";default:return U()}}(t.compositeFilter.op))}(n):U()}function Wb(n){return Lb[n]}function Qb(n){return Ub[n]}function $b(n){return Bb[n]}function Pi(n){return{fieldPath:n.canonicalString()}}function xi(n){return Pe.fromServerFormat(n.fieldPath)}function AI(n){return n instanceof ne?function(t){if(t.op==="=="){if(Fw(t.value))return{unaryFilter:{field:Pi(t.field),op:"IS_NAN"}};if(Vw(t.value))return{unaryFilter:{field:Pi(t.field),op:"IS_NULL"}}}else if(t.op==="!="){if(Fw(t.value))return{unaryFilter:{field:Pi(t.field),op:"IS_NOT_NAN"}};if(Vw(t.value))return{unaryFilter:{field:Pi(t.field),op:"IS_NOT_NULL"}}}return{fieldFilter:{field:Pi(t.field),op:Qb(t.op),value:t.value}}}(n):n instanceof de?function(t){let r=t.getFilters().map(i=>AI(i));return r.length===1?r[0]:{compositeFilter:{op:$b(t.op),filters:r}}}(n):U()}function Hb(n){let e=[];return n.fields.forEach(t=>e.push(t.canonicalString())),{fieldPaths:e}}function bI(n){return n.length>=4&&n.get(0)==="projects"&&n.get(2)==="databases"}var ji=class n{constructor(e,t,r,i,s=z.min(),o=z.min(),l=Ne.EMPTY_BYTE_STRING,u=null){this.target=e,this.targetId=t,this.purpose=r,this.sequenceNumber=i,this.snapshotVersion=s,this.lastLimboFreeSnapshotVersion=o,this.resumeToken=l,this.expectedCount=u}withSequenceNumber(e){return new n(this.target,this.targetId,this.purpose,e,this.snapshotVersion,this.lastLimboFreeSnapshotVersion,this.resumeToken,this.expectedCount)}withResumeToken(e,t){return new n(this.target,this.targetId,this.purpose,this.sequenceNumber,t,this.lastLimboFreeSnapshotVersion,e,null)}withExpectedCount(e){return new n(this.target,this.targetId,this.purpose,this.sequenceNumber,this.snapshotVersion,this.lastLimboFreeSnapshotVersion,this.resumeToken,e)}withLastLimboFreeSnapshotVersion(e){return new n(this.target,this.targetId,this.purpose,this.sequenceNumber,this.snapshotVersion,e,this.resumeToken,this.expectedCount)}};var Su=class{constructor(e){this.ct=e}};function Yb(n,e){let t;if(e.document)t=EI(n.ct,e.document,!!e.hasCommittedMutations);else if(e.noDocument){let r=L.fromSegments(e.noDocument.path),i=Lr(e.noDocument.readTime);t=Me.newNoDocument(r,i),e.hasCommittedMutations&&t.setHasCommittedMutations()}else{if(!e.unknownDocument)return U();{let r=L.fromSegments(e.unknownDocument.path),i=Lr(e.unknownDocument.version);t=Me.newUnknownDocument(r,i)}}return e.readTime&&t.setReadTime(function(i){let s=new Se(i[0],i[1]);return z.fromTimestamp(s)}(e.readTime)),t}function Zw(n,e){let t=e.key,r={prefixPath:t.getCollectionPath().popLast().toArray(),collectionGroup:t.collectionGroup,documentId:t.path.lastSegment(),readTime:Cu(e.readTime),hasCommittedMutations:e.hasCommittedMutations};if(e.isFoundDocument())r.document=function(s,o){return{name:qo(s,o.key),fields:o.data.value.mapValue.fields,updateTime:Gi(s,o.version.toTimestamp()),createTime:Gi(s,o.createTime.toTimestamp())}}(n.ct,e);else if(e.isNoDocument())r.noDocument={path:t.path.toArray(),readTime:Mr(e.version)};else{if(!e.isUnknownDocument())return U();r.unknownDocument={path:t.path.toArray(),version:Mr(e.version)}}return r}function Cu(n){let e=n.toTimestamp();return[e.seconds,e.nanoseconds]}function Mr(n){let e=n.toTimestamp();return{seconds:e.seconds,nanoseconds:e.nanoseconds}}function Lr(n){let e=new Se(n.seconds,n.nanoseconds);return z.fromTimestamp(e)}function br(n,e){let t=(e.baseMutations||[]).map(s=>Hf(n.ct,s));for(let s=0;s<e.mutations.length-1;++s){let o=e.mutations[s];if(s+1<e.mutations.length&&e.mutations[s+1].transform!==void 0){let l=e.mutations[s+1];o.updateTransforms=l.transform.fieldTransforms,e.mutations.splice(s+1,1),++s}}let r=e.mutations.map(s=>Hf(n.ct,s)),i=Se.fromMillis(e.localWriteTimeMs);return new Mo(e.batchId,i,t,r)}function So(n){let e=Lr(n.readTime),t=n.lastLimboFreeSnapshotVersion!==void 0?Lr(n.lastLimboFreeSnapshotVersion):z.min(),r;return r=function(s){return s.documents!==void 0}(n.query)?function(s){return G(s.documents.length===1),lt(es(vI(s.documents[0])))}(n.query):function(s){return lt(SI(s))}(n.query),new ji(r,n.targetId,"TargetPurposeListen",n.lastListenSequenceNumber,e,t,Ne.fromBase64String(n.resumeToken))}function RI(n,e){let t=Mr(e.snapshotVersion),r=Mr(e.lastLimboFreeSnapshotVersion),i;i=yu(e.target)?II(n.ct,e.target):TI(n.ct,e.target)._t;let s=e.resumeToken.toBase64();return{targetId:e.targetId,canonicalId:Fr(e.target),readTime:t,resumeToken:s,lastListenSequenceNumber:e.sequenceNumber,lastLimboFreeSnapshotVersion:r,query:i}}function Tm(n){let e=SI({parent:n.parent,structuredQuery:n.structuredQuery});return n.limitType==="LAST"?wu(e,e.limit,"L"):e}function uf(n,e){return new Lo(e.largestBatchId,Hf(n.ct,e.overlayMutation))}function eE(n,e){let t=e.path.lastSegment();return[n,at(e.path.popLast()),t]}function tE(n,e,t,r){return{indexId:n,uid:e,sequenceNumber:t,readTime:Mr(r.readTime),documentKey:at(r.documentKey.path),largestBatchId:r.largestBatchId}}var Yf=class{getBundleMetadata(e,t){return nE(e).get(t).next(r=>{if(r)return function(s){return{id:s.bundleId,createTime:Lr(s.createTime),version:s.version}}(r)})}saveBundleMetadata(e,t){return nE(e).put(function(i){return{bundleId:i.id,createTime:Mr(xe(i.createTime)),version:i.version}}(t))}getNamedQuery(e,t){return rE(e).get(t).next(r=>{if(r)return function(s){return{name:s.name,query:Tm(s.bundledQuery),readTime:Lr(s.readTime)}}(r)})}saveNamedQuery(e,t){return rE(e).put(function(i){return{name:i.name,readTime:Mr(xe(i.readTime)),bundledQuery:i.bundledQuery}}(t))}};function nE(n){return qe(n,"bundles")}function rE(n){return qe(n,"namedQueries")}var Au=class n{constructor(e,t){this.serializer=e,this.userId=t}static lt(e,t){let r=t.uid||"";return new n(e,r)}getOverlay(e,t){return vo(e).get(eE(this.userId,t)).next(r=>r?uf(this.serializer,r):null)}getOverlays(e,t){let r=Qt();return b.forEach(t,i=>this.getOverlay(e,i).next(s=>{s!==null&&r.set(i,s)})).next(()=>r)}saveOverlays(e,t,r){let i=[];return r.forEach((s,o)=>{let l=new Lo(t,o);i.push(this.ht(e,l))}),b.waitFor(i)}removeOverlaysForBatchId(e,t,r){let i=new Set;t.forEach(o=>i.add(at(o.getCollectionPath())));let s=[];return i.forEach(o=>{let l=IDBKeyRange.bound([this.userId,o,r],[this.userId,o,r+1],!1,!0);s.push(vo(e).j("collectionPathOverlayIndex",l))}),b.waitFor(s)}getOverlaysForCollection(e,t,r){let i=Qt(),s=at(t),o=IDBKeyRange.bound([this.userId,s,r],[this.userId,s,Number.POSITIVE_INFINITY],!0);return vo(e).U("collectionPathOverlayIndex",o).next(l=>{for(let u of l){let c=uf(this.serializer,u);i.set(c.getKey(),c)}return i})}getOverlaysForCollectionGroup(e,t,r,i){let s=Qt(),o,l=IDBKeyRange.bound([this.userId,t,r],[this.userId,t,Number.POSITIVE_INFINITY],!0);return vo(e).J({index:"collectionGroupOverlayIndex",range:l},(u,c,d)=>{let p=uf(this.serializer,c);s.size()<i||p.largestBatchId===o?(s.set(p.getKey(),p),o=p.largestBatchId):d.done()}).next(()=>s)}ht(e,t){return vo(e).put(function(i,s,o){let[l,u,c]=eE(s,o.mutation.key);return{userId:s,collectionPath:u,documentId:c,collectionGroup:o.mutation.key.getCollectionGroup(),largestBatchId:o.largestBatchId,overlayMutation:Go(i.ct,o.mutation)}}(this.serializer,this.userId,t))}};function vo(n){return qe(n,"documentOverlays")}var Jf=class{Pt(e){return qe(e,"globals")}getSessionToken(e){return this.Pt(e).get("sessionToken").next(t=>{let r=t?.value;return r?Ne.fromUint8Array(r):Ne.EMPTY_BYTE_STRING})}setSessionToken(e,t){return this.Pt(e).put({name:"sessionToken",value:t.toUint8Array()})}};var dn=class{constructor(){}It(e,t){this.Tt(e,t),t.Et()}Tt(e,t){if("nullValue"in e)this.dt(t,5);else if("booleanValue"in e)this.dt(t,10),t.At(e.booleanValue?1:0);else if("integerValue"in e)this.dt(t,15),t.At(Ie(e.integerValue));else if("doubleValue"in e){let r=Ie(e.doubleValue);isNaN(r)?this.dt(t,13):(this.dt(t,15),No(r)?t.At(0):t.At(r))}else if("timestampValue"in e){let r=e.timestampValue;this.dt(t,20),typeof r=="string"&&(r=pn(r)),t.Rt(`${r.seconds||""}`),t.At(r.nanos||0)}else if("stringValue"in e)this.Vt(e.stringValue,t),this.ft(t);else if("bytesValue"in e)this.dt(t,30),t.gt(Hn(e.bytesValue)),this.ft(t);else if("referenceValue"in e)this.yt(e.referenceValue,t);else if("geoPointValue"in e){let r=e.geoPointValue;this.dt(t,45),t.At(r.latitude||0),t.At(r.longitude||0)}else"mapValue"in e?zE(e)?this.dt(t,Number.MAX_SAFE_INTEGER):ac(e)?this.wt(e.mapValue,t):(this.St(e.mapValue,t),this.ft(t)):"arrayValue"in e?(this.bt(e.arrayValue,t),this.ft(t)):U()}Vt(e,t){this.dt(t,25),this.Dt(e,t)}Dt(e,t){t.Rt(e)}St(e,t){let r=e.fields||{};this.dt(t,55);for(let i of Object.keys(r))this.Vt(i,t),this.Tt(r[i],t)}wt(e,t){var r,i;let s=e.fields||{};this.dt(t,53);let o="value",l=((i=(r=s[o].arrayValue)===null||r===void 0?void 0:r.values)===null||i===void 0?void 0:i.length)||0;this.dt(t,15),t.At(Ie(l)),this.Vt(o,t),this.Tt(s[o],t)}bt(e,t){let r=e.values||[];this.dt(t,50);for(let i of r)this.Tt(i,t)}yt(e,t){this.dt(t,37),L.fromName(e).path.forEach(r=>{this.dt(t,60),this.Dt(r,t)})}dt(e,t){e.At(t)}ft(e){e.At(2)}};dn.vt=new dn;function Jb(n){if(n===0)return 8;let e=0;return!(n>>4)&&(e+=4,n<<=4),!(n>>6)&&(e+=2,n<<=2),!(n>>7)&&(e+=1),e}function iE(n){let e=64-function(r){let i=0;for(let s=0;s<8;++s){let o=Jb(255&r[s]);if(i+=o,o!==8)break}return i}(n);return Math.ceil(e/8)}var Xf=class{constructor(){this.buffer=new Uint8Array(1024),this.position=0}Ct(e){let t=e[Symbol.iterator](),r=t.next();for(;!r.done;)this.Ft(r.value),r=t.next();this.Mt()}xt(e){let t=e[Symbol.iterator](),r=t.next();for(;!r.done;)this.Ot(r.value),r=t.next();this.Nt()}Lt(e){for(let t of e){let r=t.charCodeAt(0);if(r<128)this.Ft(r);else if(r<2048)this.Ft(960|r>>>6),this.Ft(128|63&r);else if(t<"\uD800"||"\uDBFF"<t)this.Ft(480|r>>>12),this.Ft(128|63&r>>>6),this.Ft(128|63&r);else{let i=t.codePointAt(0);this.Ft(240|i>>>18),this.Ft(128|63&i>>>12),this.Ft(128|63&i>>>6),this.Ft(128|63&i)}}this.Mt()}Bt(e){for(let t of e){let r=t.charCodeAt(0);if(r<128)this.Ot(r);else if(r<2048)this.Ot(960|r>>>6),this.Ot(128|63&r);else if(t<"\uD800"||"\uDBFF"<t)this.Ot(480|r>>>12),this.Ot(128|63&r>>>6),this.Ot(128|63&r);else{let i=t.codePointAt(0);this.Ot(240|i>>>18),this.Ot(128|63&i>>>12),this.Ot(128|63&i>>>6),this.Ot(128|63&i)}}this.Nt()}kt(e){let t=this.qt(e),r=iE(t);this.Qt(1+r),this.buffer[this.position++]=255&r;for(let i=t.length-r;i<t.length;++i)this.buffer[this.position++]=255&t[i]}Kt(e){let t=this.qt(e),r=iE(t);this.Qt(1+r),this.buffer[this.position++]=~(255&r);for(let i=t.length-r;i<t.length;++i)this.buffer[this.position++]=~(255&t[i])}$t(){this.Ut(255),this.Ut(255)}Wt(){this.Gt(255),this.Gt(255)}reset(){this.position=0}seed(e){this.Qt(e.length),this.buffer.set(e,this.position),this.position+=e.length}zt(){return this.buffer.slice(0,this.position)}qt(e){let t=function(s){let o=new DataView(new ArrayBuffer(8));return o.setFloat64(0,s,!1),new Uint8Array(o.buffer)}(e),r=(128&t[0])!=0;t[0]^=r?255:128;for(let i=1;i<t.length;++i)t[i]^=r?255:0;return t}Ft(e){let t=255&e;t===0?(this.Ut(0),this.Ut(255)):t===255?(this.Ut(255),this.Ut(0)):this.Ut(t)}Ot(e){let t=255&e;t===0?(this.Gt(0),this.Gt(255)):t===255?(this.Gt(255),this.Gt(0)):this.Gt(e)}Mt(){this.Ut(0),this.Ut(1)}Nt(){this.Gt(0),this.Gt(1)}Ut(e){this.Qt(1),this.buffer[this.position++]=e}Gt(e){this.Qt(1),this.buffer[this.position++]=~e}Qt(e){let t=e+this.position;if(t<=this.buffer.length)return;let r=2*this.buffer.length;r<t&&(r=t);let i=new Uint8Array(r);i.set(this.buffer),this.buffer=i}},Zf=class{constructor(e){this.jt=e}gt(e){this.jt.Ct(e)}Rt(e){this.jt.Lt(e)}At(e){this.jt.kt(e)}Et(){this.jt.$t()}},ep=class{constructor(e){this.jt=e}gt(e){this.jt.xt(e)}Rt(e){this.jt.Bt(e)}At(e){this.jt.Kt(e)}Et(){this.jt.Wt()}},Rr=class{constructor(){this.jt=new Xf,this.Ht=new Zf(this.jt),this.Jt=new ep(this.jt)}seed(e){this.jt.seed(e)}Yt(e){return e===0?this.Ht:this.Jt}zt(){return this.jt.zt()}reset(){this.jt.reset()}};var Pr=class n{constructor(e,t,r,i){this.indexId=e,this.documentKey=t,this.arrayValue=r,this.directionalValue=i}Zt(){let e=this.directionalValue.length,t=e===0||this.directionalValue[e-1]===255?e+1:e,r=new Uint8Array(t);return r.set(this.directionalValue,0),t!==e?r.set([0],this.directionalValue.length):++r[r.length-1],new n(this.indexId,this.documentKey,this.arrayValue,r)}};function qn(n,e){let t=n.indexId-e.indexId;return t!==0?t:(t=sE(n.arrayValue,e.arrayValue),t!==0?t:(t=sE(n.directionalValue,e.directionalValue),t!==0?t:L.comparator(n.documentKey,e.documentKey)))}function sE(n,e){for(let t=0;t<n.length&&t<e.length;++t){let r=n[t]-e[t];if(r!==0)return r}return n.length-e.length}var bu=class{constructor(e){this.Xt=new ge((t,r)=>Pe.comparator(t.field,r.field)),this.collectionId=e.collectionGroup!=null?e.collectionGroup:e.path.lastSegment(),this.en=e.orderBy,this.tn=[];for(let t of e.filters){let r=t;r.isInequality()?this.Xt=this.Xt.add(r):this.tn.push(r)}}get nn(){return this.Xt.size>1}rn(e){if(G(e.collectionGroup===this.collectionId),this.nn)return!1;let t=Ef(e);if(t!==void 0&&!this.sn(t))return!1;let r=Cr(e),i=new Set,s=0,o=0;for(;s<r.length&&this.sn(r[s]);++s)i=i.add(r[s].fieldPath.canonicalString());if(s===r.length)return!0;if(this.Xt.size>0){let l=this.Xt.getIterator().getNext();if(!i.has(l.field.canonicalString())){let u=r[s];if(!this.on(l,u)||!this._n(this.en[o++],u))return!1}++s}for(;s<r.length;++s){let l=r[s];if(o>=this.en.length||!this._n(this.en[o++],l))return!1}return!0}an(){if(this.nn)return null;let e=new ge(Pe.comparator),t=[];for(let r of this.tn)if(!r.field.isKeyField())if(r.op==="array-contains"||r.op==="array-contains-any")t.push(new ki(r.field,2));else{if(e.has(r.field))continue;e=e.add(r.field),t.push(new ki(r.field,0))}for(let r of this.en)r.field.isKeyField()||e.has(r.field)||(e=e.add(r.field),t.push(new ki(r.field,r.dir==="asc"?0:1)));return new Mi(Mi.UNKNOWN_ID,this.collectionId,t,xo.empty())}sn(e){for(let t of this.tn)if(this.on(t,e))return!0;return!1}on(e,t){if(e===void 0||!e.field.isEqual(t.fieldPath))return!1;let r=e.op==="array-contains"||e.op==="array-contains-any";return t.kind===2===r}_n(e,t){return!!e.field.isEqual(t.fieldPath)&&(t.kind===0&&e.dir==="asc"||t.kind===1&&e.dir==="desc")}};function PI(n){var e,t;if(G(n instanceof ne||n instanceof de),n instanceof ne){if(n instanceof _u){let i=((t=(e=n.value.arrayValue)===null||e===void 0?void 0:e.values)===null||t===void 0?void 0:t.map(s=>ne.create(n.field,"==",s)))||[];return de.create(i,"or")}return n}let r=n.filters.map(i=>PI(i));return de.create(r,n.op)}function Xb(n){if(n.getFilters().length===0)return[];let e=rp(PI(n));return G(xI(e)),tp(e)||np(e)?[e]:e.getFilters()}function tp(n){return n instanceof ne}function np(n){return n instanceof de&&ym(n)}function xI(n){return tp(n)||np(n)||function(t){if(t instanceof de&&Pf(t)){for(let r of t.getFilters())if(!tp(r)&&!np(r))return!1;return!0}return!1}(n)}function rp(n){if(G(n instanceof ne||n instanceof de),n instanceof ne)return n;if(n.filters.length===1)return rp(n.filters[0]);let e=n.filters.map(r=>rp(r)),t=de.create(e,n.op);return t=Ru(t),xI(t)?t:(G(t instanceof de),G(Ui(t)),G(t.filters.length>1),t.filters.reduce((r,i)=>Sm(r,i)))}function Sm(n,e){let t;return G(n instanceof ne||n instanceof de),G(e instanceof ne||e instanceof de),t=n instanceof ne?e instanceof ne?function(i,s){return de.create([i,s],"and")}(n,e):oE(n,e):e instanceof ne?oE(e,n):function(i,s){if(G(i.filters.length>0&&s.filters.length>0),Ui(i)&&Ui(s))return HE(i,s.getFilters());let o=Pf(i)?i:s,l=Pf(i)?s:i,u=o.filters.map(c=>Sm(c,l));return de.create(u,"or")}(n,e),Ru(t)}function oE(n,e){if(Ui(e))return HE(e,n.getFilters());{let t=e.filters.map(r=>Sm(n,r));return de.create(t,"or")}}function Ru(n){if(G(n instanceof ne||n instanceof de),n instanceof ne)return n;let e=n.getFilters();if(e.length===1)return Ru(e[0]);if(QE(n))return n;let t=e.map(i=>Ru(i)),r=[];return t.forEach(i=>{i instanceof ne?r.push(i):i instanceof de&&(i.op===n.op?r.push(...i.filters):r.push(i))}),r.length===1?r[0]:de.create(r,n.op)}var ip=class{constructor(){this.un=new jo}addToCollectionParentIndex(e,t){return this.un.add(t),b.resolve()}getCollectionParents(e,t){return b.resolve(this.un.getEntries(t))}addFieldIndex(e,t){return b.resolve()}deleteFieldIndex(e,t){return b.resolve()}deleteAllFieldIndexes(e){return b.resolve()}createTargetIndexes(e,t){return b.resolve()}getDocumentsMatchingTarget(e,t){return b.resolve(null)}getIndexType(e,t){return b.resolve(0)}getFieldIndexes(e,t){return b.resolve([])}getNextCollectionGroupToUpdate(e){return b.resolve(null)}getMinOffset(e,t){return b.resolve(At.min())}getMinOffsetFromCollectionGroup(e,t){return b.resolve(At.min())}updateCollectionGroup(e,t,r){return b.resolve()}updateIndexEntries(e,t){return b.resolve()}},jo=class{constructor(){this.index={}}add(e){let t=e.lastSegment(),r=e.popLast(),i=this.index[t]||new ge(oe.comparator),s=!i.has(r);return this.index[t]=i.add(r),s}has(e){let t=e.lastSegment(),r=e.popLast(),i=this.index[t];return i&&i.has(r)}getEntries(e){return(this.index[e]||new ge(oe.comparator)).toArray()}};var eu=new Uint8Array(0),sp=class{constructor(e,t){this.databaseId=t,this.cn=new jo,this.ln=new Zt(r=>Fr(r),(r,i)=>Xo(r,i)),this.uid=e.uid||""}addToCollectionParentIndex(e,t){if(!this.cn.has(t)){let r=t.lastSegment(),i=t.popLast();e.addOnCommittedListener(()=>{this.cn.add(t)});let s={collectionId:r,parent:at(i)};return aE(e).put(s)}return b.resolve()}getCollectionParents(e,t){let r=[],i=IDBKeyRange.bound([t,""],[DE(t),""],!1,!0);return aE(e).U(i).next(s=>{for(let o of s){if(o.collectionId!==t)break;r.push(Wt(o.parent))}return r})}addFieldIndex(e,t){let r=wo(e),i=function(l){return{indexId:l.indexId,collectionGroup:l.collectionGroup,fields:l.fields.map(u=>[u.fieldPath.canonicalString(),u.kind])}}(t);delete i.indexId;let s=r.add(i);if(t.indexState){let o=Ci(e);return s.next(l=>{o.put(tE(l,this.uid,t.indexState.sequenceNumber,t.indexState.offset))})}return s.next()}deleteFieldIndex(e,t){let r=wo(e),i=Ci(e),s=Si(e);return r.delete(t.indexId).next(()=>i.delete(IDBKeyRange.bound([t.indexId],[t.indexId+1],!1,!0))).next(()=>s.delete(IDBKeyRange.bound([t.indexId],[t.indexId+1],!1,!0)))}deleteAllFieldIndexes(e){let t=wo(e),r=Si(e),i=Ci(e);return t.j().next(()=>r.j()).next(()=>i.j())}createTargetIndexes(e,t){return b.forEach(this.hn(t),r=>this.getIndexType(e,r).next(i=>{if(i===0||i===1){let s=new bu(r).an();if(s!=null)return this.addFieldIndex(e,s)}}))}getDocumentsMatchingTarget(e,t){let r=Si(e),i=!0,s=new Map;return b.forEach(this.hn(t),o=>this.Pn(e,o).next(l=>{i&&(i=!!l),s.set(o,l)})).next(()=>{if(i){let o=H(),l=[];return b.forEach(s,(u,c)=>{V("IndexedDbIndexManager",`Using index ${function(B){return`id=${B.indexId}|cg=${B.collectionGroup}|f=${B.fields.map(Y=>`${Y.fieldPath}:${Y.kind}`).join(",")}`}(u)} to execute ${Fr(t)}`);let d=function(B,Y){let re=Ef(Y);if(re===void 0)return null;for(let Q of vu(B,re.fieldPath))switch(Q.op){case"array-contains-any":return Q.value.arrayValue.values||[];case"array-contains":return[Q.value]}return null}(c,u),p=function(B,Y){let re=new Map;for(let Q of Cr(Y))for(let E of vu(B,Q.fieldPath))switch(E.op){case"==":case"in":re.set(Q.fieldPath.canonicalString(),E.value);break;case"not-in":case"!=":return re.set(Q.fieldPath.canonicalString(),E.value),Array.from(re.values())}return null}(c,u),m=function(B,Y){let re=[],Q=!0;for(let E of Cr(Y)){let _=E.kind===0?Bw(B,E.fieldPath,B.startAt):qw(B,E.fieldPath,B.startAt);re.push(_.value),Q&&(Q=_.inclusive)}return new Xt(re,Q)}(c,u),y=function(B,Y){let re=[],Q=!0;for(let E of Cr(Y)){let _=E.kind===0?qw(B,E.fieldPath,B.endAt):Bw(B,E.fieldPath,B.endAt);re.push(_.value),Q&&(Q=_.inclusive)}return new Xt(re,Q)}(c,u),C=this.In(u,c,m),x=this.In(u,c,y),D=this.Tn(u,c,p),q=this.En(u.indexId,d,C,m.inclusive,x,y.inclusive,D);return b.forEach(q,j=>r.G(j,t.limit).next(B=>{B.forEach(Y=>{let re=L.fromSegments(Y.documentKey);o.has(re)||(o=o.add(re),l.push(re))})}))}).next(()=>l)}return b.resolve(null)})}hn(e){let t=this.ln.get(e);return t||(e.filters.length===0?t=[e]:t=Xb(de.create(e.filters,"and")).map(r=>Lf(e.path,e.collectionGroup,e.orderBy,r.getFilters(),e.limit,e.startAt,e.endAt)),this.ln.set(e,t),t)}En(e,t,r,i,s,o,l){let u=(t!=null?t.length:1)*Math.max(r.length,s.length),c=u/(t!=null?t.length:1),d=[];for(let p=0;p<u;++p){let m=t?this.dn(t[p/c]):eu,y=this.An(e,m,r[p%c],i),C=this.Rn(e,m,s[p%c],o),x=l.map(D=>this.An(e,m,D,!0));d.push(...this.createRange(y,C,x))}return d}An(e,t,r,i){let s=new Pr(e,L.empty(),t,r);return i?s:s.Zt()}Rn(e,t,r,i){let s=new Pr(e,L.empty(),t,r);return i?s.Zt():s}Pn(e,t){let r=new bu(t),i=t.collectionGroup!=null?t.collectionGroup:t.path.lastSegment();return this.getFieldIndexes(e,i).next(s=>{let o=null;for(let l of s)r.rn(l)&&(!o||l.fields.length>o.fields.length)&&(o=l);return o})}getIndexType(e,t){let r=2,i=this.hn(t);return b.forEach(i,s=>this.Pn(e,s).next(o=>{o?r!==0&&o.fields.length<function(u){let c=new ge(Pe.comparator),d=!1;for(let p of u.filters)for(let m of p.getFlattenedFilters())m.field.isKeyField()||(m.op==="array-contains"||m.op==="array-contains-any"?d=!0:c=c.add(m.field));for(let p of u.orderBy)p.field.isKeyField()||(c=c.add(p.field));return c.size+(d?1:0)}(s)&&(r=1):r=0})).next(()=>function(o){return o.limit!==null}(t)&&i.length>1&&r===2?1:r)}Vn(e,t){let r=new Rr;for(let i of Cr(e)){let s=t.data.field(i.fieldPath);if(s==null)return null;let o=r.Yt(i.kind);dn.vt.It(s,o)}return r.zt()}dn(e){let t=new Rr;return dn.vt.It(e,t.Yt(0)),t.zt()}mn(e,t){let r=new Rr;return dn.vt.It(kr(this.databaseId,t),r.Yt(function(s){let o=Cr(s);return o.length===0?0:o[o.length-1].kind}(e))),r.zt()}Tn(e,t,r){if(r===null)return[];let i=[];i.push(new Rr);let s=0;for(let o of Cr(e)){let l=r[s++];for(let u of i)if(this.fn(t,o.fieldPath)&&Fo(l))i=this.gn(i,o,l);else{let c=u.Yt(o.kind);dn.vt.It(l,c)}}return this.pn(i)}In(e,t,r){return this.Tn(e,t,r.position)}pn(e){let t=[];for(let r=0;r<e.length;++r)t[r]=e[r].zt();return t}gn(e,t,r){let i=[...e],s=[];for(let o of r.arrayValue.values||[])for(let l of i){let u=new Rr;u.seed(l.zt()),dn.vt.It(o,u.Yt(t.kind)),s.push(u)}return s}fn(e,t){return!!e.filters.find(r=>r instanceof ne&&r.field.isEqual(t)&&(r.op==="in"||r.op==="not-in"))}getFieldIndexes(e,t){let r=wo(e),i=Ci(e);return(t?r.U("collectionGroupIndex",IDBKeyRange.bound(t,t)):r.U()).next(s=>{let o=[];return b.forEach(s,l=>i.get([l.indexId,this.uid]).next(u=>{o.push(function(d,p){let m=p?new xo(p.sequenceNumber,new At(Lr(p.readTime),new L(Wt(p.documentKey)),p.largestBatchId)):xo.empty(),y=d.fields.map(([C,x])=>new ki(Pe.fromServerFormat(C),x));return new Mi(d.indexId,d.collectionGroup,y,m)}(l,u))})).next(()=>o)})}getNextCollectionGroupToUpdate(e){return this.getFieldIndexes(e).next(t=>t.length===0?null:(t.sort((r,i)=>{let s=r.indexState.sequenceNumber-i.indexState.sequenceNumber;return s!==0?s:W(r.collectionGroup,i.collectionGroup)}),t[0].collectionGroup))}updateCollectionGroup(e,t,r){let i=wo(e),s=Ci(e);return this.yn(e).next(o=>i.U("collectionGroupIndex",IDBKeyRange.bound(t,t)).next(l=>b.forEach(l,u=>s.put(tE(u.indexId,this.uid,o,r)))))}updateIndexEntries(e,t){let r=new Map;return b.forEach(t,(i,s)=>{let o=r.get(i.collectionGroup);return(o?b.resolve(o):this.getFieldIndexes(e,i.collectionGroup)).next(l=>(r.set(i.collectionGroup,l),b.forEach(l,u=>this.wn(e,i,u).next(c=>{let d=this.Sn(s,u);return c.isEqual(d)?b.resolve():this.bn(e,s,u,c,d)}))))})}Dn(e,t,r,i){return Si(e).put({indexId:i.indexId,uid:this.uid,arrayValue:i.arrayValue,directionalValue:i.directionalValue,orderedDocumentKey:this.mn(r,t.key),documentKey:t.key.path.toArray()})}vn(e,t,r,i){return Si(e).delete([i.indexId,this.uid,i.arrayValue,i.directionalValue,this.mn(r,t.key),t.key.path.toArray()])}wn(e,t,r){let i=Si(e),s=new ge(qn);return i.J({index:"documentKeyIndex",range:IDBKeyRange.only([r.indexId,this.uid,this.mn(r,t)])},(o,l)=>{s=s.add(new Pr(r.indexId,t,l.arrayValue,l.directionalValue))}).next(()=>s)}Sn(e,t){let r=new ge(qn),i=this.Vn(t,e);if(i==null)return r;let s=Ef(t);if(s!=null){let o=e.data.field(s.fieldPath);if(Fo(o))for(let l of o.arrayValue.values||[])r=r.add(new Pr(t.indexId,e.key,this.dn(l),i))}else r=r.add(new Pr(t.indexId,e.key,eu,i));return r}bn(e,t,r,i,s){V("IndexedDbIndexManager","Updating index entries for document '%s'",t.key);let o=[];return function(u,c,d,p,m){let y=u.getIterator(),C=c.getIterator(),x=Ti(y),D=Ti(C);for(;x||D;){let q=!1,j=!1;if(x&&D){let B=d(x,D);B<0?j=!0:B>0&&(q=!0)}else x!=null?j=!0:q=!0;q?(p(D),D=Ti(C)):j?(m(x),x=Ti(y)):(x=Ti(y),D=Ti(C))}}(i,s,qn,l=>{o.push(this.Dn(e,t,r,l))},l=>{o.push(this.vn(e,t,r,l))}),b.waitFor(o)}yn(e){let t=1;return Ci(e).J({index:"sequenceNumberIndex",reverse:!0,range:IDBKeyRange.upperBound([this.uid,Number.MAX_SAFE_INTEGER])},(r,i,s)=>{s.done(),t=i.sequenceNumber+1}).next(()=>t)}createRange(e,t,r){r=r.sort((o,l)=>qn(o,l)).filter((o,l,u)=>!l||qn(o,u[l-1])!==0);let i=[];i.push(e);for(let o of r){let l=qn(o,e),u=qn(o,t);if(l===0)i[0]=e.Zt();else if(l>0&&u<0)i.push(o),i.push(o.Zt());else if(u>0)break}i.push(t);let s=[];for(let o=0;o<i.length;o+=2){if(this.Cn(i[o],i[o+1]))return[];let l=[i[o].indexId,this.uid,i[o].arrayValue,i[o].directionalValue,eu,[]],u=[i[o+1].indexId,this.uid,i[o+1].arrayValue,i[o+1].directionalValue,eu,[]];s.push(IDBKeyRange.bound(l,u))}return s}Cn(e,t){return qn(e,t)>0}getMinOffsetFromCollectionGroup(e,t){return this.getFieldIndexes(e,t).next(lE)}getMinOffset(e,t){return b.mapArray(this.hn(t),r=>this.Pn(e,r).next(i=>i||U())).next(lE)}};function aE(n){return qe(n,"collectionParents")}function Si(n){return qe(n,"indexEntries")}function wo(n){return qe(n,"indexConfiguration")}function Ci(n){return qe(n,"indexState")}function lE(n){G(n.length!==0);let e=n[0].indexState.offset,t=e.largestBatchId;for(let r=1;r<n.length;r++){let i=n[r].indexState.offset;pm(i,e)<0&&(e=i),t<i.largestBatchId&&(t=i.largestBatchId)}return new At(e.readTime,e.documentKey,t)}var uE={didRun:!1,sequenceNumbersCollected:0,targetsRemoved:0,documentsRemoved:0},Ct=class n{constructor(e,t,r){this.cacheSizeCollectionThreshold=e,this.percentileToCollect=t,this.maximumSequenceNumbersToCollect=r}static withCacheSize(e){return new n(e,n.DEFAULT_COLLECTION_PERCENTILE,n.DEFAULT_MAX_SEQUENCE_NUMBERS_TO_COLLECT)}};function NI(n,e,t){let r=n.store("mutations"),i=n.store("documentMutations"),s=[],o=IDBKeyRange.only(t.batchId),l=0,u=r.J({range:o},(d,p,m)=>(l++,m.delete()));s.push(u.next(()=>{G(l===1)}));let c=[];for(let d of t.mutations){let p=LE(e,d.key.path,t.batchId);s.push(i.delete(p)),c.push(d.key)}return b.waitFor(s).next(()=>c)}function Pu(n){if(!n)return 0;let e;if(n.document)e=n.document;else if(n.unknownDocument)e=n.unknownDocument;else{if(!n.noDocument)throw U();e=n.noDocument}return JSON.stringify(e).length}Ct.DEFAULT_COLLECTION_PERCENTILE=10,Ct.DEFAULT_MAX_SEQUENCE_NUMBERS_TO_COLLECT=1e3,Ct.DEFAULT=new Ct(41943040,Ct.DEFAULT_COLLECTION_PERCENTILE,Ct.DEFAULT_MAX_SEQUENCE_NUMBERS_TO_COLLECT),Ct.DISABLED=new Ct(-1,0,0);var xu=class n{constructor(e,t,r,i){this.userId=e,this.serializer=t,this.indexManager=r,this.referenceDelegate=i,this.Fn={}}static lt(e,t,r,i){G(e.uid!=="");let s=e.isAuthenticated()?e.uid:"";return new n(s,t,r,i)}checkEmpty(e){let t=!0,r=IDBKeyRange.bound([this.userId,Number.NEGATIVE_INFINITY],[this.userId,Number.POSITIVE_INFINITY]);return Gn(e).J({index:"userMutationsIndex",range:r},(i,s,o)=>{t=!1,o.done()}).next(()=>t)}addMutationBatch(e,t,r,i){let s=Ni(e),o=Gn(e);return o.add({}).next(l=>{G(typeof l=="number");let u=new Mo(l,t,r,i),c=function(y,C,x){let D=x.baseMutations.map(j=>Go(y.ct,j)),q=x.mutations.map(j=>Go(y.ct,j));return{userId:C,batchId:x.batchId,localWriteTimeMs:x.localWriteTime.toMillis(),baseMutations:D,mutations:q}}(this.serializer,this.userId,u),d=[],p=new ge((m,y)=>W(m.canonicalString(),y.canonicalString()));for(let m of i){let y=LE(this.userId,m.key.path,l);p=p.add(m.key.path.popLast()),d.push(o.put(c)),d.push(s.put(y,ib))}return p.forEach(m=>{d.push(this.indexManager.addToCollectionParentIndex(e,m))}),e.addOnCommittedListener(()=>{this.Fn[l]=u.keys()}),b.waitFor(d).next(()=>u)})}lookupMutationBatch(e,t){return Gn(e).get(t).next(r=>r?(G(r.userId===this.userId),br(this.serializer,r)):null)}Mn(e,t){return this.Fn[t]?b.resolve(this.Fn[t]):this.lookupMutationBatch(e,t).next(r=>{if(r){let i=r.keys();return this.Fn[t]=i,i}return null})}getNextMutationBatchAfterBatchId(e,t){let r=t+1,i=IDBKeyRange.lowerBound([this.userId,r]),s=null;return Gn(e).J({index:"userMutationsIndex",range:i},(o,l,u)=>{l.userId===this.userId&&(G(l.batchId>=r),s=br(this.serializer,l)),u.done()}).next(()=>s)}getHighestUnacknowledgedBatchId(e){let t=IDBKeyRange.upperBound([this.userId,Number.POSITIVE_INFINITY]),r=-1;return Gn(e).J({index:"userMutationsIndex",range:t,reverse:!0},(i,s,o)=>{r=s.batchId,o.done()}).next(()=>r)}getAllMutationBatches(e){let t=IDBKeyRange.bound([this.userId,-1],[this.userId,Number.POSITIVE_INFINITY]);return Gn(e).U("userMutationsIndex",t).next(r=>r.map(i=>br(this.serializer,i)))}getAllMutationBatchesAffectingDocumentKey(e,t){let r=iu(this.userId,t.path),i=IDBKeyRange.lowerBound(r),s=[];return Ni(e).J({range:i},(o,l,u)=>{let[c,d,p]=o,m=Wt(d);if(c===this.userId&&t.path.isEqual(m))return Gn(e).get(p).next(y=>{if(!y)throw U();G(y.userId===this.userId),s.push(br(this.serializer,y))});u.done()}).next(()=>s)}getAllMutationBatchesAffectingDocumentKeys(e,t){let r=new ge(W),i=[];return t.forEach(s=>{let o=iu(this.userId,s.path),l=IDBKeyRange.lowerBound(o),u=Ni(e).J({range:l},(c,d,p)=>{let[m,y,C]=c,x=Wt(y);m===this.userId&&s.path.isEqual(x)?r=r.add(C):p.done()});i.push(u)}),b.waitFor(i).next(()=>this.xn(e,r))}getAllMutationBatchesAffectingQuery(e,t){let r=t.path,i=r.length+1,s=iu(this.userId,r),o=IDBKeyRange.lowerBound(s),l=new ge(W);return Ni(e).J({range:o},(u,c,d)=>{let[p,m,y]=u,C=Wt(m);p===this.userId&&r.isPrefixOf(C)?C.length===i&&(l=l.add(y)):d.done()}).next(()=>this.xn(e,l))}xn(e,t){let r=[],i=[];return t.forEach(s=>{i.push(Gn(e).get(s).next(o=>{if(o===null)throw U();G(o.userId===this.userId),r.push(br(this.serializer,o))}))}),b.waitFor(i).next(()=>r)}removeMutationBatch(e,t){return NI(e._e,this.userId,t).next(r=>(e.addOnCommittedListener(()=>{this.On(t.batchId)}),b.forEach(r,i=>this.referenceDelegate.markPotentiallyOrphaned(e,i))))}On(e){delete this.Fn[e]}performConsistencyCheck(e){return this.checkEmpty(e).next(t=>{if(!t)return b.resolve();let r=IDBKeyRange.lowerBound(function(o){return[o]}(this.userId)),i=[];return Ni(e).J({range:r},(s,o,l)=>{if(s[0]===this.userId){let u=Wt(s[1]);i.push(u)}else l.done()}).next(()=>{G(i.length===0)})})}containsKey(e,t){return DI(e,this.userId,t)}Nn(e){return kI(e).get(this.userId).next(t=>t||{userId:this.userId,lastAcknowledgedBatchId:-1,lastStreamToken:""})}};function DI(n,e,t){let r=iu(e,t.path),i=r[1],s=IDBKeyRange.lowerBound(r),o=!1;return Ni(n).J({range:s,H:!0},(l,u,c)=>{let[d,p,m]=l;d===e&&p===i&&(o=!0),c.done()}).next(()=>o)}function Gn(n){return qe(n,"mutations")}function Ni(n){return qe(n,"documentMutations")}function kI(n){return qe(n,"mutationQueues")}var zi=class n{constructor(e){this.Ln=e}next(){return this.Ln+=2,this.Ln}static Bn(){return new n(0)}static kn(){return new n(-1)}};var op=class{constructor(e,t){this.referenceDelegate=e,this.serializer=t}allocateTargetId(e){return this.qn(e).next(t=>{let r=new zi(t.highestTargetId);return t.highestTargetId=r.next(),this.Qn(e,t).next(()=>t.highestTargetId)})}getLastRemoteSnapshotVersion(e){return this.qn(e).next(t=>z.fromTimestamp(new Se(t.lastRemoteSnapshotVersion.seconds,t.lastRemoteSnapshotVersion.nanoseconds)))}getHighestSequenceNumber(e){return this.qn(e).next(t=>t.highestListenSequenceNumber)}setTargetsMetadata(e,t,r){return this.qn(e).next(i=>(i.highestListenSequenceNumber=t,r&&(i.lastRemoteSnapshotVersion=r.toTimestamp()),t>i.highestListenSequenceNumber&&(i.highestListenSequenceNumber=t),this.Qn(e,i)))}addTargetData(e,t){return this.Kn(e,t).next(()=>this.qn(e).next(r=>(r.targetCount+=1,this.$n(t,r),this.Qn(e,r))))}updateTargetData(e,t){return this.Kn(e,t)}removeTargetData(e,t){return this.removeMatchingKeysForTargetId(e,t.targetId).next(()=>Ai(e).delete(t.targetId)).next(()=>this.qn(e)).next(r=>(G(r.targetCount>0),r.targetCount-=1,this.Qn(e,r)))}removeTargets(e,t,r){let i=0,s=[];return Ai(e).J((o,l)=>{let u=So(l);u.sequenceNumber<=t&&r.get(u.targetId)===null&&(i++,s.push(this.removeTargetData(e,u)))}).next(()=>b.waitFor(s)).next(()=>i)}forEachTarget(e,t){return Ai(e).J((r,i)=>{let s=So(i);t(s)})}qn(e){return cE(e).get("targetGlobalKey").next(t=>(G(t!==null),t))}Qn(e,t){return cE(e).put("targetGlobalKey",t)}Kn(e,t){return Ai(e).put(RI(this.serializer,t))}$n(e,t){let r=!1;return e.targetId>t.highestTargetId&&(t.highestTargetId=e.targetId,r=!0),e.sequenceNumber>t.highestListenSequenceNumber&&(t.highestListenSequenceNumber=e.sequenceNumber,r=!0),r}getTargetCount(e){return this.qn(e).next(t=>t.targetCount)}getTargetData(e,t){let r=Fr(t),i=IDBKeyRange.bound([r,Number.NEGATIVE_INFINITY],[r,Number.POSITIVE_INFINITY]),s=null;return Ai(e).J({range:i,index:"queryTargetsIndex"},(o,l,u)=>{let c=So(l);Xo(t,c.target)&&(s=c,u.done())}).next(()=>s)}addMatchingKeys(e,t,r){let i=[],s=jn(e);return t.forEach(o=>{let l=at(o.path);i.push(s.put({targetId:r,path:l})),i.push(this.referenceDelegate.addReference(e,r,o))}),b.waitFor(i)}removeMatchingKeys(e,t,r){let i=jn(e);return b.forEach(t,s=>{let o=at(s.path);return b.waitFor([i.delete([r,o]),this.referenceDelegate.removeReference(e,r,s)])})}removeMatchingKeysForTargetId(e,t){let r=jn(e),i=IDBKeyRange.bound([t],[t+1],!1,!0);return r.delete(i)}getMatchingKeysForTargetId(e,t){let r=IDBKeyRange.bound([t],[t+1],!1,!0),i=jn(e),s=H();return i.J({range:r,H:!0},(o,l,u)=>{let c=Wt(o[1]),d=new L(c);s=s.add(d)}).next(()=>s)}containsKey(e,t){let r=at(t.path),i=IDBKeyRange.bound([r],[DE(r)],!1,!0),s=0;return jn(e).J({index:"documentTargetsIndex",H:!0,range:i},([o,l],u,c)=>{o!==0&&(s++,c.done())}).next(()=>s>0)}ot(e,t){return Ai(e).get(t).next(r=>r?So(r):null)}};function Ai(n){return qe(n,"targets")}function cE(n){return qe(n,"targetGlobal")}function jn(n){return qe(n,"targetDocuments")}function hE([n,e],[t,r]){let i=W(n,t);return i===0?W(e,r):i}var ap=class{constructor(e){this.Un=e,this.buffer=new ge(hE),this.Wn=0}Gn(){return++this.Wn}zn(e){let t=[e,this.Gn()];if(this.buffer.size<this.Un)this.buffer=this.buffer.add(t);else{let r=this.buffer.last();hE(t,r)<0&&(this.buffer=this.buffer.delete(r).add(t))}}get maxValue(){return this.buffer.last()[0]}},lp=class{constructor(e,t,r){this.garbageCollector=e,this.asyncQueue=t,this.localStore=r,this.jn=null}start(){this.garbageCollector.params.cacheSizeCollectionThreshold!==-1&&this.Hn(6e4)}stop(){this.jn&&(this.jn.cancel(),this.jn=null)}get started(){return this.jn!==null}Hn(e){V("LruGarbageCollector",`Garbage collection scheduled in ${e}ms`),this.jn=this.asyncQueue.enqueueAfterDelay("lru_garbage_collection",e,()=>N(this,null,function*(){this.jn=null;try{yield this.localStore.collectGarbage(this.garbageCollector)}catch(t){ir(t)?V("LruGarbageCollector","Ignoring IndexedDB error during garbage collection: ",t):yield rr(t)}yield this.Hn(3e5)}))}},up=class{constructor(e,t){this.Jn=e,this.params=t}calculateTargetCount(e,t){return this.Jn.Yn(e).next(r=>Math.floor(t/100*r))}nthSequenceNumber(e,t){if(t===0)return b.resolve(_t.oe);let r=new ap(t);return this.Jn.forEachTarget(e,i=>r.zn(i.sequenceNumber)).next(()=>this.Jn.Zn(e,i=>r.zn(i))).next(()=>r.maxValue)}removeTargets(e,t,r){return this.Jn.removeTargets(e,t,r)}removeOrphanedDocuments(e,t){return this.Jn.removeOrphanedDocuments(e,t)}collect(e,t){return this.params.cacheSizeCollectionThreshold===-1?(V("LruGarbageCollector","Garbage collection skipped; disabled"),b.resolve(uE)):this.getCacheSize(e).next(r=>r<this.params.cacheSizeCollectionThreshold?(V("LruGarbageCollector",`Garbage collection skipped; Cache size ${r} is lower than threshold ${this.params.cacheSizeCollectionThreshold}`),uE):this.Xn(e,t))}getCacheSize(e){return this.Jn.getCacheSize(e)}Xn(e,t){let r,i,s,o,l,u,c,d=Date.now();return this.calculateTargetCount(e,this.params.percentileToCollect).next(p=>(p>this.params.maximumSequenceNumbersToCollect?(V("LruGarbageCollector",`Capping sequence numbers to collect down to the maximum of ${this.params.maximumSequenceNumbersToCollect} from ${p}`),i=this.params.maximumSequenceNumbersToCollect):i=p,o=Date.now(),this.nthSequenceNumber(e,i))).next(p=>(r=p,l=Date.now(),this.removeTargets(e,r,t))).next(p=>(s=p,u=Date.now(),this.removeOrphanedDocuments(e,r))).next(p=>(c=Date.now(),bi()<=Et.DEBUG&&V("LruGarbageCollector",`LRU Garbage Collection
	Counted targets in ${o-d}ms
	Determined least recently used ${i} in `+(l-o)+`ms
	Removed ${s} targets in `+(u-l)+`ms
	Removed ${p} documents in `+(c-u)+`ms
Total Duration: ${c-d}ms`),b.resolve({didRun:!0,sequenceNumbersCollected:i,targetsRemoved:s,documentsRemoved:p})))}};function Zb(n,e){return new up(n,e)}var cp=class{constructor(e,t){this.db=e,this.garbageCollector=Zb(this,t)}Yn(e){let t=this.er(e);return this.db.getTargetCache().getTargetCount(e).next(r=>t.next(i=>r+i))}er(e){let t=0;return this.Zn(e,r=>{t++}).next(()=>t)}forEachTarget(e,t){return this.db.getTargetCache().forEachTarget(e,t)}Zn(e,t){return this.tr(e,(r,i)=>t(i))}addReference(e,t,r){return tu(e,r)}removeReference(e,t,r){return tu(e,r)}removeTargets(e,t,r){return this.db.getTargetCache().removeTargets(e,t,r)}markPotentiallyOrphaned(e,t){return tu(e,t)}nr(e,t){return function(i,s){let o=!1;return kI(i).Y(l=>DI(i,l,s).next(u=>(u&&(o=!0),b.resolve(!u)))).next(()=>o)}(e,t)}removeOrphanedDocuments(e,t){let r=this.db.getRemoteDocumentCache().newChangeBuffer(),i=[],s=0;return this.tr(e,(o,l)=>{if(l<=t){let u=this.nr(e,o).next(c=>{if(!c)return s++,r.getEntry(e,o).next(()=>(r.removeEntry(o,z.min()),jn(e).delete(function(p){return[0,at(p.path)]}(o))))});i.push(u)}}).next(()=>b.waitFor(i)).next(()=>r.apply(e)).next(()=>s)}removeTarget(e,t){let r=t.withSequenceNumber(e.currentSequenceNumber);return this.db.getTargetCache().updateTargetData(e,r)}updateLimboDocument(e,t){return tu(e,t)}tr(e,t){let r=jn(e),i,s=_t.oe;return r.J({index:"documentTargetsIndex"},([o,l],{path:u,sequenceNumber:c})=>{o===0?(s!==_t.oe&&t(new L(Wt(i)),s),s=c,i=u):s=_t.oe}).next(()=>{s!==_t.oe&&t(new L(Wt(i)),s)})}getCacheSize(e){return this.db.getRemoteDocumentCache().getSize(e)}};function tu(n,e){return jn(n).put(function(r,i){return{targetId:0,path:at(r.path),sequenceNumber:i}}(e,n.currentSequenceNumber))}var Nu=class{constructor(){this.changes=new Zt(e=>e.toString(),(e,t)=>e.isEqual(t)),this.changesApplied=!1}addEntry(e){this.assertNotApplied(),this.changes.set(e.key,e)}removeEntry(e,t){this.assertNotApplied(),this.changes.set(e,Me.newInvalidDocument(e).setReadTime(t))}getEntry(e,t){this.assertNotApplied();let r=this.changes.get(t);return r!==void 0?b.resolve(r):this.getFromCache(e,t)}getEntries(e,t){return this.getAllFromCache(e,t)}apply(e){return this.assertNotApplied(),this.changesApplied=!0,this.applyChanges(e)}assertNotApplied(){}};var hp=class{constructor(e){this.serializer=e}setIndexManager(e){this.indexManager=e}addEntry(e,t,r){return Sr(e).put(r)}removeEntry(e,t,r){return Sr(e).delete(function(s,o){let l=s.path.toArray();return[l.slice(0,l.length-2),l[l.length-2],Cu(o),l[l.length-1]]}(t,r))}updateMetadata(e,t){return this.getMetadata(e).next(r=>(r.byteSize+=t,this.rr(e,r)))}getEntry(e,t){let r=Me.newInvalidDocument(t);return Sr(e).J({index:"documentKeyIndex",range:IDBKeyRange.only(Eo(t))},(i,s)=>{r=this.ir(t,s)}).next(()=>r)}sr(e,t){let r={size:0,document:Me.newInvalidDocument(t)};return Sr(e).J({index:"documentKeyIndex",range:IDBKeyRange.only(Eo(t))},(i,s)=>{r={document:this.ir(t,s),size:Pu(s)}}).next(()=>r)}getEntries(e,t){let r=ht();return this._r(e,t,(i,s)=>{let o=this.ir(i,s);r=r.insert(i,o)}).next(()=>r)}ar(e,t){let r=ht(),i=new we(L.comparator);return this._r(e,t,(s,o)=>{let l=this.ir(s,o);r=r.insert(s,l),i=i.insert(s,Pu(o))}).next(()=>({documents:r,ur:i}))}_r(e,t,r){if(t.isEmpty())return b.resolve();let i=new ge(pE);t.forEach(u=>i=i.add(u));let s=IDBKeyRange.bound(Eo(i.first()),Eo(i.last())),o=i.getIterator(),l=o.getNext();return Sr(e).J({index:"documentKeyIndex",range:s},(u,c,d)=>{let p=L.fromSegments([...c.prefixPath,c.collectionGroup,c.documentId]);for(;l&&pE(l,p)<0;)r(l,null),l=o.getNext();l&&l.isEqual(p)&&(r(l,c),l=o.hasNext()?o.getNext():null),l?d.$(Eo(l)):d.done()}).next(()=>{for(;l;)r(l,null),l=o.hasNext()?o.getNext():null})}getDocumentsMatchingQuery(e,t,r,i,s){let o=t.path,l=[o.popLast().toArray(),o.lastSegment(),Cu(r.readTime),r.documentKey.path.isEmpty()?"":r.documentKey.path.lastSegment()],u=[o.popLast().toArray(),o.lastSegment(),[Number.MAX_SAFE_INTEGER,Number.MAX_SAFE_INTEGER],""];return Sr(e).U(IDBKeyRange.bound(l,u,!0)).next(c=>{s?.incrementDocumentReadCount(c.length);let d=ht();for(let p of c){let m=this.ir(L.fromSegments(p.prefixPath.concat(p.collectionGroup,p.documentId)),p);m.isFoundDocument()&&(ea(t,m)||i.has(m.key))&&(d=d.insert(m.key,m))}return d})}getAllFromCollectionGroup(e,t,r,i){let s=ht(),o=fE(t,r),l=fE(t,At.max());return Sr(e).J({index:"collectionGroupIndex",range:IDBKeyRange.bound(o,l,!0)},(u,c,d)=>{let p=this.ir(L.fromSegments(c.prefixPath.concat(c.collectionGroup,c.documentId)),c);s=s.insert(p.key,p),s.size===i&&d.done()}).next(()=>s)}newChangeBuffer(e){return new dp(this,!!e&&e.trackRemovals)}getSize(e){return this.getMetadata(e).next(t=>t.byteSize)}getMetadata(e){return dE(e).get("remoteDocumentGlobalKey").next(t=>(G(!!t),t))}rr(e,t){return dE(e).put("remoteDocumentGlobalKey",t)}ir(e,t){if(t){let r=Yb(this.serializer,t);if(!(r.isNoDocument()&&r.version.isEqual(z.min())))return r}return Me.newInvalidDocument(e)}};function VI(n){return new hp(n)}var dp=class extends Nu{constructor(e,t){super(),this.cr=e,this.trackRemovals=t,this.lr=new Zt(r=>r.toString(),(r,i)=>r.isEqual(i))}applyChanges(e){let t=[],r=0,i=new ge((s,o)=>W(s.canonicalString(),o.canonicalString()));return this.changes.forEach((s,o)=>{let l=this.lr.get(s);if(t.push(this.cr.removeEntry(e,s,l.readTime)),o.isValidDocument()){let u=Zw(this.cr.serializer,o);i=i.add(s.path.popLast());let c=Pu(u);r+=c-l.size,t.push(this.cr.addEntry(e,s,u))}else if(r-=l.size,this.trackRemovals){let u=Zw(this.cr.serializer,o.convertToNoDocument(z.min()));t.push(this.cr.addEntry(e,s,u))}}),i.forEach(s=>{t.push(this.cr.indexManager.addToCollectionParentIndex(e,s))}),t.push(this.cr.updateMetadata(e,r)),b.waitFor(t)}getFromCache(e,t){return this.cr.sr(e,t).next(r=>(this.lr.set(t,{size:r.size,readTime:r.document.readTime}),r.document))}getAllFromCache(e,t){return this.cr.ar(e,t).next(({documents:r,ur:i})=>(i.forEach((s,o)=>{this.lr.set(s,{size:o,readTime:r.get(s).readTime})}),r))}};function dE(n){return qe(n,"remoteDocumentGlobal")}function Sr(n){return qe(n,"remoteDocumentsV14")}function Eo(n){let e=n.path.toArray();return[e.slice(0,e.length-2),e[e.length-2],e[e.length-1]]}function fE(n,e){let t=e.documentKey.path.toArray();return[n,Cu(e.readTime),t.slice(0,t.length-2),t.length>0?t[t.length-1]:""]}function pE(n,e){let t=n.path.toArray(),r=e.path.toArray(),i=0;for(let s=0;s<t.length-2&&s<r.length-2;++s)if(i=W(t[s],r[s]),i)return i;return i=W(t.length,r.length),i||(i=W(t[t.length-2],r[r.length-2]),i||W(t[t.length-1],r[r.length-1]))}var fp=class{constructor(e,t){this.overlayedDocument=e,this.mutatedFields=t}};var Du=class{constructor(e,t,r,i){this.remoteDocumentCache=e,this.mutationQueue=t,this.documentOverlayCache=r,this.indexManager=i}getDocument(e,t){let r=null;return this.documentOverlayCache.getOverlay(e,t).next(i=>(r=i,this.remoteDocumentCache.getEntry(e,t))).next(i=>(r!==null&&bo(r.mutation,i,yt.empty(),Se.now()),i))}getDocuments(e,t){return this.remoteDocumentCache.getEntries(e,t).next(r=>this.getLocalViewOfDocuments(e,r,H()).next(()=>r))}getLocalViewOfDocuments(e,t,r=H()){let i=Qt();return this.populateOverlays(e,i,t).next(()=>this.computeViews(e,t,i,r).next(s=>{let o=To();return s.forEach((l,u)=>{o=o.insert(l,u.overlayedDocument)}),o}))}getOverlayedDocuments(e,t){let r=Qt();return this.populateOverlays(e,r,t).next(()=>this.computeViews(e,t,r,H()))}populateOverlays(e,t,r){let i=[];return r.forEach(s=>{t.has(s)||i.push(s)}),this.documentOverlayCache.getOverlays(e,i).next(s=>{s.forEach((o,l)=>{t.set(o,l)})})}computeViews(e,t,r,i){let s=ht(),o=Ao(),l=function(){return Ao()}();return t.forEach((u,c)=>{let d=r.get(c.key);i.has(c.key)&&(d===void 0||d.mutation instanceof Vt)?s=s.insert(c.key,c):d!==void 0?(o.set(c.key,d.mutation.getFieldMask()),bo(d.mutation,c,d.mutation.getFieldMask(),Se.now())):o.set(c.key,yt.empty())}),this.recalculateAndSaveOverlays(e,s).next(u=>(u.forEach((c,d)=>o.set(c,d)),t.forEach((c,d)=>{var p;return l.set(c,new fp(d,(p=o.get(c))!==null&&p!==void 0?p:null))}),l))}recalculateAndSaveOverlays(e,t){let r=Ao(),i=new we((o,l)=>o-l),s=H();return this.mutationQueue.getAllMutationBatchesAffectingDocumentKeys(e,t).next(o=>{for(let l of o)l.keys().forEach(u=>{let c=t.get(u);if(c===null)return;let d=r.get(u)||yt.empty();d=l.applyToLocalView(c,d),r.set(u,d);let p=(i.get(l.batchId)||H()).add(u);i=i.insert(l.batchId,p)})}).next(()=>{let o=[],l=i.getReverseIterator();for(;l.hasNext();){let u=l.getNext(),c=u.key,d=u.value,p=iI();d.forEach(m=>{if(!s.has(m)){let y=hI(t.get(m),r.get(m));y!==null&&p.set(m,y),s=s.add(m)}}),o.push(this.documentOverlayCache.saveOverlays(e,c,p))}return b.waitFor(o)}).next(()=>r)}recalculateAndSaveOverlaysForDocumentKeys(e,t){return this.remoteDocumentCache.getEntries(e,t).next(r=>this.recalculateAndSaveOverlays(e,r))}getDocumentsMatchingQuery(e,t,r,i){return function(o){return L.isDocumentKey(o.path)&&o.collectionGroup===null&&o.filters.length===0}(t)?this.getDocumentsMatchingDocumentQuery(e,t.path):vm(t)?this.getDocumentsMatchingCollectionGroupQuery(e,t,r,i):this.getDocumentsMatchingCollectionQuery(e,t,r,i)}getNextDocuments(e,t,r,i){return this.remoteDocumentCache.getAllFromCollectionGroup(e,t,r,i).next(s=>{let o=i-s.size>0?this.documentOverlayCache.getOverlaysForCollectionGroup(e,t,r.largestBatchId,i-s.size):b.resolve(Qt()),l=-1,u=s;return o.next(c=>b.forEach(c,(d,p)=>(l<p.largestBatchId&&(l=p.largestBatchId),s.get(d)?b.resolve():this.remoteDocumentCache.getEntry(e,d).next(m=>{u=u.insert(d,m)}))).next(()=>this.populateOverlays(e,c,s)).next(()=>this.computeViews(e,u,c,H())).next(d=>({batchId:l,changes:rI(d)})))})}getDocumentsMatchingDocumentQuery(e,t){return this.getDocument(e,new L(t)).next(r=>{let i=To();return r.isFoundDocument()&&(i=i.insert(r.key,r)),i})}getDocumentsMatchingCollectionGroupQuery(e,t,r,i){let s=t.collectionGroup,o=To();return this.indexManager.getCollectionParents(e,s).next(l=>b.forEach(l,u=>{let c=function(p,m){return new kt(m,null,p.explicitOrderBy.slice(),p.filters.slice(),p.limit,p.limitType,p.startAt,p.endAt)}(t,u.child(s));return this.getDocumentsMatchingCollectionQuery(e,c,r,i).next(d=>{d.forEach((p,m)=>{o=o.insert(p,m)})})}).next(()=>o))}getDocumentsMatchingCollectionQuery(e,t,r,i){let s;return this.documentOverlayCache.getOverlaysForCollection(e,t.path,r.largestBatchId).next(o=>(s=o,this.remoteDocumentCache.getDocumentsMatchingQuery(e,t,r,s,i))).next(o=>{s.forEach((u,c)=>{let d=c.getKey();o.get(d)===null&&(o=o.insert(d,Me.newInvalidDocument(d)))});let l=To();return o.forEach((u,c)=>{let d=s.get(u);d!==void 0&&bo(d.mutation,c,yt.empty(),Se.now()),ea(t,c)&&(l=l.insert(u,c))}),l})}};var pp=class{constructor(e){this.serializer=e,this.hr=new Map,this.Pr=new Map}getBundleMetadata(e,t){return b.resolve(this.hr.get(t))}saveBundleMetadata(e,t){return this.hr.set(t.id,function(i){return{id:i.id,version:i.version,createTime:xe(i.createTime)}}(t)),b.resolve()}getNamedQuery(e,t){return b.resolve(this.Pr.get(t))}saveNamedQuery(e,t){return this.Pr.set(t.name,function(i){return{name:i.name,query:Tm(i.bundledQuery),readTime:xe(i.readTime)}}(t)),b.resolve()}};var mp=class{constructor(){this.overlays=new we(L.comparator),this.Ir=new Map}getOverlay(e,t){return b.resolve(this.overlays.get(t))}getOverlays(e,t){let r=Qt();return b.forEach(t,i=>this.getOverlay(e,i).next(s=>{s!==null&&r.set(i,s)})).next(()=>r)}saveOverlays(e,t,r){return r.forEach((i,s)=>{this.ht(e,t,s)}),b.resolve()}removeOverlaysForBatchId(e,t,r){let i=this.Ir.get(r);return i!==void 0&&(i.forEach(s=>this.overlays=this.overlays.remove(s)),this.Ir.delete(r)),b.resolve()}getOverlaysForCollection(e,t,r){let i=Qt(),s=t.length+1,o=new L(t.child("")),l=this.overlays.getIteratorFrom(o);for(;l.hasNext();){let u=l.getNext().value,c=u.getKey();if(!t.isPrefixOf(c.path))break;c.path.length===s&&u.largestBatchId>r&&i.set(u.getKey(),u)}return b.resolve(i)}getOverlaysForCollectionGroup(e,t,r,i){let s=new we((c,d)=>c-d),o=this.overlays.getIterator();for(;o.hasNext();){let c=o.getNext().value;if(c.getKey().getCollectionGroup()===t&&c.largestBatchId>r){let d=s.get(c.largestBatchId);d===null&&(d=Qt(),s=s.insert(c.largestBatchId,d)),d.set(c.getKey(),c)}}let l=Qt(),u=s.getIterator();for(;u.hasNext()&&(u.getNext().value.forEach((c,d)=>l.set(c,d)),!(l.size()>=i)););return b.resolve(l)}ht(e,t,r){let i=this.overlays.get(r.key);if(i!==null){let o=this.Ir.get(i.largestBatchId).delete(r.key);this.Ir.set(i.largestBatchId,o)}this.overlays=this.overlays.insert(r.key,new Lo(t,r));let s=this.Ir.get(t);s===void 0&&(s=H(),this.Ir.set(t,s)),this.Ir.set(t,s.add(r.key))}};var gp=class{constructor(){this.sessionToken=Ne.EMPTY_BYTE_STRING}getSessionToken(e){return b.resolve(this.sessionToken)}setSessionToken(e,t){return this.sessionToken=t,b.resolve()}};var zo=class{constructor(){this.Tr=new ge(Fe.Er),this.dr=new ge(Fe.Ar)}isEmpty(){return this.Tr.isEmpty()}addReference(e,t){let r=new Fe(e,t);this.Tr=this.Tr.add(r),this.dr=this.dr.add(r)}Rr(e,t){e.forEach(r=>this.addReference(r,t))}removeReference(e,t){this.Vr(new Fe(e,t))}mr(e,t){e.forEach(r=>this.removeReference(r,t))}gr(e){let t=new L(new oe([])),r=new Fe(t,e),i=new Fe(t,e+1),s=[];return this.dr.forEachInRange([r,i],o=>{this.Vr(o),s.push(o.key)}),s}pr(){this.Tr.forEach(e=>this.Vr(e))}Vr(e){this.Tr=this.Tr.delete(e),this.dr=this.dr.delete(e)}yr(e){let t=new L(new oe([])),r=new Fe(t,e),i=new Fe(t,e+1),s=H();return this.dr.forEachInRange([r,i],o=>{s=s.add(o.key)}),s}containsKey(e){let t=new Fe(e,0),r=this.Tr.firstAfterOrEqual(t);return r!==null&&e.isEqual(r.key)}},Fe=class{constructor(e,t){this.key=e,this.wr=t}static Er(e,t){return L.comparator(e.key,t.key)||W(e.wr,t.wr)}static Ar(e,t){return W(e.wr,t.wr)||L.comparator(e.key,t.key)}};var _p=class{constructor(e,t){this.indexManager=e,this.referenceDelegate=t,this.mutationQueue=[],this.Sr=1,this.br=new ge(Fe.Er)}checkEmpty(e){return b.resolve(this.mutationQueue.length===0)}addMutationBatch(e,t,r,i){let s=this.Sr;this.Sr++,this.mutationQueue.length>0&&this.mutationQueue[this.mutationQueue.length-1];let o=new Mo(s,t,r,i);this.mutationQueue.push(o);for(let l of i)this.br=this.br.add(new Fe(l.key,s)),this.indexManager.addToCollectionParentIndex(e,l.key.path.popLast());return b.resolve(o)}lookupMutationBatch(e,t){return b.resolve(this.Dr(t))}getNextMutationBatchAfterBatchId(e,t){let r=t+1,i=this.vr(r),s=i<0?0:i;return b.resolve(this.mutationQueue.length>s?this.mutationQueue[s]:null)}getHighestUnacknowledgedBatchId(){return b.resolve(this.mutationQueue.length===0?-1:this.Sr-1)}getAllMutationBatches(e){return b.resolve(this.mutationQueue.slice())}getAllMutationBatchesAffectingDocumentKey(e,t){let r=new Fe(t,0),i=new Fe(t,Number.POSITIVE_INFINITY),s=[];return this.br.forEachInRange([r,i],o=>{let l=this.Dr(o.wr);s.push(l)}),b.resolve(s)}getAllMutationBatchesAffectingDocumentKeys(e,t){let r=new ge(W);return t.forEach(i=>{let s=new Fe(i,0),o=new Fe(i,Number.POSITIVE_INFINITY);this.br.forEachInRange([s,o],l=>{r=r.add(l.wr)})}),b.resolve(this.Cr(r))}getAllMutationBatchesAffectingQuery(e,t){let r=t.path,i=r.length+1,s=r;L.isDocumentKey(s)||(s=s.child(""));let o=new Fe(new L(s),0),l=new ge(W);return this.br.forEachWhile(u=>{let c=u.key.path;return!!r.isPrefixOf(c)&&(c.length===i&&(l=l.add(u.wr)),!0)},o),b.resolve(this.Cr(l))}Cr(e){let t=[];return e.forEach(r=>{let i=this.Dr(r);i!==null&&t.push(i)}),t}removeMutationBatch(e,t){G(this.Fr(t.batchId,"removed")===0),this.mutationQueue.shift();let r=this.br;return b.forEach(t.mutations,i=>{let s=new Fe(i.key,t.batchId);return r=r.delete(s),this.referenceDelegate.markPotentiallyOrphaned(e,i.key)}).next(()=>{this.br=r})}On(e){}containsKey(e,t){let r=new Fe(t,0),i=this.br.firstAfterOrEqual(r);return b.resolve(t.isEqual(i&&i.key))}performConsistencyCheck(e){return this.mutationQueue.length,b.resolve()}Fr(e,t){return this.vr(e)}vr(e){return this.mutationQueue.length===0?0:e-this.mutationQueue[0].batchId}Dr(e){let t=this.vr(e);return t<0||t>=this.mutationQueue.length?null:this.mutationQueue[t]}};var yp=class{constructor(e){this.Mr=e,this.docs=function(){return new we(L.comparator)}(),this.size=0}setIndexManager(e){this.indexManager=e}addEntry(e,t){let r=t.key,i=this.docs.get(r),s=i?i.size:0,o=this.Mr(t);return this.docs=this.docs.insert(r,{document:t.mutableCopy(),size:o}),this.size+=o-s,this.indexManager.addToCollectionParentIndex(e,r.path.popLast())}removeEntry(e){let t=this.docs.get(e);t&&(this.docs=this.docs.remove(e),this.size-=t.size)}getEntry(e,t){let r=this.docs.get(t);return b.resolve(r?r.document.mutableCopy():Me.newInvalidDocument(t))}getEntries(e,t){let r=ht();return t.forEach(i=>{let s=this.docs.get(i);r=r.insert(i,s?s.document.mutableCopy():Me.newInvalidDocument(i))}),b.resolve(r)}getDocumentsMatchingQuery(e,t,r,i){let s=ht(),o=t.path,l=new L(o.child("")),u=this.docs.getIteratorFrom(l);for(;u.hasNext();){let{key:c,value:{document:d}}=u.getNext();if(!o.isPrefixOf(c.path))break;c.path.length>o.length+1||pm(VE(d),r)<=0||(i.has(d.key)||ea(t,d))&&(s=s.insert(d.key,d.mutableCopy()))}return b.resolve(s)}getAllFromCollectionGroup(e,t,r,i){U()}Or(e,t){return b.forEach(this.docs,r=>t(r))}newChangeBuffer(e){return new vp(this)}getSize(e){return b.resolve(this.size)}},vp=class extends Nu{constructor(e){super(),this.cr=e}applyChanges(e){let t=[];return this.changes.forEach((r,i)=>{i.isValidDocument()?t.push(this.cr.addEntry(e,i)):this.cr.removeEntry(r)}),b.waitFor(t)}getFromCache(e,t){return this.cr.getEntry(e,t)}getAllFromCache(e,t){return this.cr.getEntries(e,t)}};var wp=class{constructor(e){this.persistence=e,this.Nr=new Zt(t=>Fr(t),Xo),this.lastRemoteSnapshotVersion=z.min(),this.highestTargetId=0,this.Lr=0,this.Br=new zo,this.targetCount=0,this.kr=zi.Bn()}forEachTarget(e,t){return this.Nr.forEach((r,i)=>t(i)),b.resolve()}getLastRemoteSnapshotVersion(e){return b.resolve(this.lastRemoteSnapshotVersion)}getHighestSequenceNumber(e){return b.resolve(this.Lr)}allocateTargetId(e){return this.highestTargetId=this.kr.next(),b.resolve(this.highestTargetId)}setTargetsMetadata(e,t,r){return r&&(this.lastRemoteSnapshotVersion=r),t>this.Lr&&(this.Lr=t),b.resolve()}Kn(e){this.Nr.set(e.target,e);let t=e.targetId;t>this.highestTargetId&&(this.kr=new zi(t),this.highestTargetId=t),e.sequenceNumber>this.Lr&&(this.Lr=e.sequenceNumber)}addTargetData(e,t){return this.Kn(t),this.targetCount+=1,b.resolve()}updateTargetData(e,t){return this.Kn(t),b.resolve()}removeTargetData(e,t){return this.Nr.delete(t.target),this.Br.gr(t.targetId),this.targetCount-=1,b.resolve()}removeTargets(e,t,r){let i=0,s=[];return this.Nr.forEach((o,l)=>{l.sequenceNumber<=t&&r.get(l.targetId)===null&&(this.Nr.delete(o),s.push(this.removeMatchingKeysForTargetId(e,l.targetId)),i++)}),b.waitFor(s).next(()=>i)}getTargetCount(e){return b.resolve(this.targetCount)}getTargetData(e,t){let r=this.Nr.get(t)||null;return b.resolve(r)}addMatchingKeys(e,t,r){return this.Br.Rr(t,r),b.resolve()}removeMatchingKeys(e,t,r){this.Br.mr(t,r);let i=this.persistence.referenceDelegate,s=[];return i&&t.forEach(o=>{s.push(i.markPotentiallyOrphaned(e,o))}),b.waitFor(s)}removeMatchingKeysForTargetId(e,t){return this.Br.gr(t),b.resolve()}getMatchingKeysForTargetId(e,t){let r=this.Br.yr(t);return b.resolve(r)}containsKey(e,t){return b.resolve(this.Br.containsKey(t))}};var ku=class{constructor(e,t){this.qr={},this.overlays={},this.Qr=new _t(0),this.Kr=!1,this.Kr=!0,this.$r=new gp,this.referenceDelegate=e(this),this.Ur=new wp(this),this.indexManager=new ip,this.remoteDocumentCache=function(i){return new yp(i)}(r=>this.referenceDelegate.Wr(r)),this.serializer=new Su(t),this.Gr=new pp(this.serializer)}start(){return Promise.resolve()}shutdown(){return this.Kr=!1,Promise.resolve()}get started(){return this.Kr}setDatabaseDeletedListener(){}setNetworkEnabled(){}getIndexManager(e){return this.indexManager}getDocumentOverlayCache(e){let t=this.overlays[e.toKey()];return t||(t=new mp,this.overlays[e.toKey()]=t),t}getMutationQueue(e,t){let r=this.qr[e.toKey()];return r||(r=new _p(t,this.referenceDelegate),this.qr[e.toKey()]=r),r}getGlobalsCache(){return this.$r}getTargetCache(){return this.Ur}getRemoteDocumentCache(){return this.remoteDocumentCache}getBundleCache(){return this.Gr}runTransaction(e,t,r){V("MemoryPersistence","Starting transaction:",e);let i=new Ep(this.Qr.next());return this.referenceDelegate.zr(),r(i).next(s=>this.referenceDelegate.jr(i).next(()=>s)).toPromise().then(s=>(i.raiseOnCommittedEvent(),s))}Hr(e,t){return b.or(Object.values(this.qr).map(r=>()=>r.containsKey(e,t)))}},Ep=class extends du{constructor(e){super(),this.currentSequenceNumber=e}},Vu=class n{constructor(e){this.persistence=e,this.Jr=new zo,this.Yr=null}static Zr(e){return new n(e)}get Xr(){if(this.Yr)return this.Yr;throw U()}addReference(e,t,r){return this.Jr.addReference(r,t),this.Xr.delete(r.toString()),b.resolve()}removeReference(e,t,r){return this.Jr.removeReference(r,t),this.Xr.add(r.toString()),b.resolve()}markPotentiallyOrphaned(e,t){return this.Xr.add(t.toString()),b.resolve()}removeTarget(e,t){this.Jr.gr(t.targetId).forEach(i=>this.Xr.add(i.toString()));let r=this.persistence.getTargetCache();return r.getMatchingKeysForTargetId(e,t.targetId).next(i=>{i.forEach(s=>this.Xr.add(s.toString()))}).next(()=>r.removeTargetData(e,t))}zr(){this.Yr=new Set}jr(e){let t=this.persistence.getRemoteDocumentCache().newChangeBuffer();return b.forEach(this.Xr,r=>{let i=L.fromPath(r);return this.ei(e,i).next(s=>{s||t.removeEntry(i,z.min())})}).next(()=>(this.Yr=null,t.apply(e)))}updateLimboDocument(e,t){return this.ei(e,t).next(r=>{r?this.Xr.delete(t.toString()):this.Xr.add(t.toString())})}Wr(e){return 0}ei(e,t){return b.or([()=>b.resolve(this.Jr.containsKey(t)),()=>this.persistence.getTargetCache().containsKey(e,t),()=>this.persistence.Hr(e,t)])}};var Ip=class{constructor(e){this.serializer=e}O(e,t,r,i){let s=new fu("createOrUpgrade",t);r<1&&i>=1&&(function(u){u.createObjectStore("owner")}(e),function(u){u.createObjectStore("mutationQueues",{keyPath:"userId"}),u.createObjectStore("mutations",{keyPath:"batchId",autoIncrement:!0}).createIndex("userMutationsIndex",xw,{unique:!0}),u.createObjectStore("documentMutations")}(e),mE(e),function(u){u.createObjectStore("remoteDocuments")}(e));let o=b.resolve();return r<3&&i>=3&&(r!==0&&(function(u){u.deleteObjectStore("targetDocuments"),u.deleteObjectStore("targets"),u.deleteObjectStore("targetGlobal")}(e),mE(e)),o=o.next(()=>function(u){let c=u.store("targetGlobal"),d={highestTargetId:0,highestListenSequenceNumber:0,lastRemoteSnapshotVersion:z.min().toTimestamp(),targetCount:0};return c.put("targetGlobalKey",d)}(s))),r<4&&i>=4&&(r!==0&&(o=o.next(()=>function(u,c){return c.store("mutations").U().next(d=>{u.deleteObjectStore("mutations"),u.createObjectStore("mutations",{keyPath:"batchId",autoIncrement:!0}).createIndex("userMutationsIndex",xw,{unique:!0});let p=c.store("mutations"),m=d.map(y=>p.put(y));return b.waitFor(m)})}(e,s))),o=o.next(()=>{(function(u){u.createObjectStore("clientMetadata",{keyPath:"clientId"})})(e)})),r<5&&i>=5&&(o=o.next(()=>this.ni(s))),r<6&&i>=6&&(o=o.next(()=>(function(u){u.createObjectStore("remoteDocumentGlobal")}(e),this.ri(s)))),r<7&&i>=7&&(o=o.next(()=>this.ii(s))),r<8&&i>=8&&(o=o.next(()=>this.si(e,s))),r<9&&i>=9&&(o=o.next(()=>{(function(u){u.objectStoreNames.contains("remoteDocumentChanges")&&u.deleteObjectStore("remoteDocumentChanges")})(e)})),r<10&&i>=10&&(o=o.next(()=>this.oi(s))),r<11&&i>=11&&(o=o.next(()=>{(function(u){u.createObjectStore("bundles",{keyPath:"bundleId"})})(e),function(u){u.createObjectStore("namedQueries",{keyPath:"name"})}(e)})),r<12&&i>=12&&(o=o.next(()=>{(function(u){let c=u.createObjectStore("documentOverlays",{keyPath:gb});c.createIndex("collectionPathOverlayIndex",_b,{unique:!1}),c.createIndex("collectionGroupOverlayIndex",yb,{unique:!1})})(e)})),r<13&&i>=13&&(o=o.next(()=>function(u){let c=u.createObjectStore("remoteDocumentsV14",{keyPath:sb});c.createIndex("documentKeyIndex",ob),c.createIndex("collectionGroupIndex",ab)}(e)).next(()=>this._i(e,s)).next(()=>e.deleteObjectStore("remoteDocuments"))),r<14&&i>=14&&(o=o.next(()=>this.ai(e,s))),r<15&&i>=15&&(o=o.next(()=>function(u){u.createObjectStore("indexConfiguration",{keyPath:"indexId",autoIncrement:!0}).createIndex("collectionGroupIndex","collectionGroup",{unique:!1}),u.createObjectStore("indexState",{keyPath:db}).createIndex("sequenceNumberIndex",fb,{unique:!1}),u.createObjectStore("indexEntries",{keyPath:pb}).createIndex("documentKeyIndex",mb,{unique:!1})}(e))),r<16&&i>=16&&(o=o.next(()=>{t.objectStore("indexState").clear()}).next(()=>{t.objectStore("indexEntries").clear()})),r<17&&i>=17&&(o=o.next(()=>{(function(u){u.createObjectStore("globals",{keyPath:"name"})})(e)})),o}ri(e){let t=0;return e.store("remoteDocuments").J((r,i)=>{t+=Pu(i)}).next(()=>{let r={byteSize:t};return e.store("remoteDocumentGlobal").put("remoteDocumentGlobalKey",r)})}ni(e){let t=e.store("mutationQueues"),r=e.store("mutations");return t.U().next(i=>b.forEach(i,s=>{let o=IDBKeyRange.bound([s.userId,-1],[s.userId,s.lastAcknowledgedBatchId]);return r.U("userMutationsIndex",o).next(l=>b.forEach(l,u=>{G(u.userId===s.userId);let c=br(this.serializer,u);return NI(e,s.userId,c).next(()=>{})}))}))}ii(e){let t=e.store("targetDocuments"),r=e.store("remoteDocuments");return e.store("targetGlobal").get("targetGlobalKey").next(i=>{let s=[];return r.J((o,l)=>{let u=new oe(o),c=function(p){return[0,at(p)]}(u);s.push(t.get(c).next(d=>d?b.resolve():(p=>t.put({targetId:0,path:at(p),sequenceNumber:i.highestListenSequenceNumber}))(u)))}).next(()=>b.waitFor(s))})}si(e,t){e.createObjectStore("collectionParents",{keyPath:hb});let r=t.store("collectionParents"),i=new jo,s=o=>{if(i.add(o)){let l=o.lastSegment(),u=o.popLast();return r.put({collectionId:l,parent:at(u)})}};return t.store("remoteDocuments").J({H:!0},(o,l)=>{let u=new oe(o);return s(u.popLast())}).next(()=>t.store("documentMutations").J({H:!0},([o,l,u],c)=>{let d=Wt(l);return s(d.popLast())}))}oi(e){let t=e.store("targets");return t.J((r,i)=>{let s=So(i),o=RI(this.serializer,s);return t.put(o)})}_i(e,t){let r=t.store("remoteDocuments"),i=[];return r.J((s,o)=>{let l=t.store("remoteDocumentsV14"),u=function(p){return p.document?new L(oe.fromString(p.document.name).popFirst(5)):p.noDocument?L.fromSegments(p.noDocument.path):p.unknownDocument?L.fromSegments(p.unknownDocument.path):U()}(o).path.toArray(),c={prefixPath:u.slice(0,u.length-2),collectionGroup:u[u.length-2],documentId:u[u.length-1],readTime:o.readTime||[0,0],unknownDocument:o.unknownDocument,noDocument:o.noDocument,document:o.document,hasCommittedMutations:!!o.hasCommittedMutations};i.push(l.put(c))}).next(()=>b.waitFor(i))}ai(e,t){let r=t.store("mutations"),i=VI(this.serializer),s=new ku(Vu.Zr,this.serializer.ct);return r.U().next(o=>{let l=new Map;return o.forEach(u=>{var c;let d=(c=l.get(u.userId))!==null&&c!==void 0?c:H();br(this.serializer,u).keys().forEach(p=>d=d.add(p)),l.set(u.userId,d)}),b.forEach(l,(u,c)=>{let d=new Oe(c),p=Au.lt(this.serializer,d),m=s.getIndexManager(d),y=xu.lt(d,this.serializer,m,s.referenceDelegate);return new Du(i,y,p,m).recalculateAndSaveOverlaysForDocumentKeys(new Do(t,_t.oe),u).next()})})}};function mE(n){n.createObjectStore("targetDocuments",{keyPath:ub}).createIndex("documentTargetsIndex",cb,{unique:!0}),n.createObjectStore("targets",{keyPath:"targetId"}).createIndex("queryTargetsIndex",lb,{unique:!0}),n.createObjectStore("targetGlobal")}var cf="Failed to obtain exclusive access to the persistence layer. To allow shared access, multi-tab synchronization has to be enabled in all tabs. If you are using `experimentalForceOwningTab:true`, make sure that only one tab has persistence enabled at any given time.",Tp=class n{constructor(e,t,r,i,s,o,l,u,c,d,p=17){if(this.allowTabSynchronization=e,this.persistenceKey=t,this.clientId=r,this.ui=s,this.window=o,this.document=l,this.ci=c,this.li=d,this.hi=p,this.Qr=null,this.Kr=!1,this.isPrimary=!1,this.networkEnabled=!0,this.Pi=null,this.inForeground=!1,this.Ii=null,this.Ti=null,this.Ei=Number.NEGATIVE_INFINITY,this.di=m=>Promise.resolve(),!n.D())throw new k(P.UNIMPLEMENTED,"This platform is either missing IndexedDB or is known to have an incomplete implementation. Offline persistence has been disabled.");this.referenceDelegate=new cp(this,i),this.Ai=t+"main",this.serializer=new Su(u),this.Ri=new $n(this.Ai,this.hi,new Ip(this.serializer)),this.$r=new Jf,this.Ur=new op(this.referenceDelegate,this.serializer),this.remoteDocumentCache=VI(this.serializer),this.Gr=new Yf,this.window&&this.window.localStorage?this.Vi=this.window.localStorage:(this.Vi=null,d===!1&&Re("IndexedDbPersistence","LocalStorage is unavailable. As a result, persistence may not work reliably. In particular enablePersistence() could fail immediately after refreshing the page."))}start(){return this.mi().then(()=>{if(!this.isPrimary&&!this.allowTabSynchronization)throw new k(P.FAILED_PRECONDITION,cf);return this.fi(),this.gi(),this.pi(),this.runTransaction("getHighestListenSequenceNumber","readonly",e=>this.Ur.getHighestSequenceNumber(e))}).then(e=>{this.Qr=new _t(e,this.ci)}).then(()=>{this.Kr=!0}).catch(e=>(this.Ri&&this.Ri.close(),Promise.reject(e)))}yi(e){return this.di=t=>N(this,null,function*(){if(this.started)return e(t)}),e(this.isPrimary)}setDatabaseDeletedListener(e){this.Ri.L(t=>N(this,null,function*(){t.newVersion===null&&(yield e())}))}setNetworkEnabled(e){this.networkEnabled!==e&&(this.networkEnabled=e,this.ui.enqueueAndForget(()=>N(this,null,function*(){this.started&&(yield this.mi())})))}mi(){return this.runTransaction("updateClientMetadataAndTryBecomePrimary","readwrite",e=>nu(e).put({clientId:this.clientId,updateTimeMs:Date.now(),networkEnabled:this.networkEnabled,inForeground:this.inForeground}).next(()=>{if(this.isPrimary)return this.wi(e).next(t=>{t||(this.isPrimary=!1,this.ui.enqueueRetryable(()=>this.di(!1)))})}).next(()=>this.Si(e)).next(t=>this.isPrimary&&!t?this.bi(e).next(()=>!1):!!t&&this.Di(e).next(()=>!0))).catch(e=>{if(ir(e))return V("IndexedDbPersistence","Failed to extend owner lease: ",e),this.isPrimary;if(!this.allowTabSynchronization)throw e;return V("IndexedDbPersistence","Releasing owner lease after error during lease refresh",e),!1}).then(e=>{this.isPrimary!==e&&this.ui.enqueueRetryable(()=>this.di(e)),this.isPrimary=e})}wi(e){return Io(e).get("owner").next(t=>b.resolve(this.vi(t)))}Ci(e){return nu(e).delete(this.clientId)}Fi(){return N(this,null,function*(){if(this.isPrimary&&!this.Mi(this.Ei,18e5)){this.Ei=Date.now();let e=yield this.runTransaction("maybeGarbageCollectMultiClientState","readwrite-primary",t=>{let r=qe(t,"clientMetadata");return r.U().next(i=>{let s=this.xi(i,18e5),o=i.filter(l=>s.indexOf(l)===-1);return b.forEach(o,l=>r.delete(l.clientId)).next(()=>o)})}).catch(()=>[]);if(this.Vi)for(let t of e)this.Vi.removeItem(this.Oi(t.clientId))}})}pi(){this.Ti=this.ui.enqueueAfterDelay("client_metadata_refresh",4e3,()=>this.mi().then(()=>this.Fi()).then(()=>this.pi()))}vi(e){return!!e&&e.ownerId===this.clientId}Si(e){return this.li?b.resolve(!0):Io(e).get("owner").next(t=>{if(t!==null&&this.Mi(t.leaseTimestampMs,5e3)&&!this.Ni(t.ownerId)){if(this.vi(t)&&this.networkEnabled)return!0;if(!this.vi(t)){if(!t.allowTabSynchronization)throw new k(P.FAILED_PRECONDITION,cf);return!1}}return!(!this.networkEnabled||!this.inForeground)||nu(e).U().next(r=>this.xi(r,5e3).find(i=>{if(this.clientId!==i.clientId){let s=!this.networkEnabled&&i.networkEnabled,o=!this.inForeground&&i.inForeground,l=this.networkEnabled===i.networkEnabled;if(s||o&&l)return!0}return!1})===void 0)}).next(t=>(this.isPrimary!==t&&V("IndexedDbPersistence",`Client ${t?"is":"is not"} eligible for a primary lease.`),t))}shutdown(){return N(this,null,function*(){this.Kr=!1,this.Li(),this.Ti&&(this.Ti.cancel(),this.Ti=null),this.Bi(),this.ki(),yield this.Ri.runTransaction("shutdown","readwrite",["owner","clientMetadata"],e=>{let t=new Do(e,_t.oe);return this.bi(t).next(()=>this.Ci(t))}),this.Ri.close(),this.qi()})}xi(e,t){return e.filter(r=>this.Mi(r.updateTimeMs,t)&&!this.Ni(r.clientId))}Qi(){return this.runTransaction("getActiveClients","readonly",e=>nu(e).U().next(t=>this.xi(t,18e5).map(r=>r.clientId)))}get started(){return this.Kr}getGlobalsCache(){return this.$r}getMutationQueue(e,t){return xu.lt(e,this.serializer,t,this.referenceDelegate)}getTargetCache(){return this.Ur}getRemoteDocumentCache(){return this.remoteDocumentCache}getIndexManager(e){return new sp(e,this.serializer.ct.databaseId)}getDocumentOverlayCache(e){return Au.lt(this.serializer,e)}getBundleCache(){return this.Gr}runTransaction(e,t,r){V("IndexedDbPersistence","Starting transaction:",e);let i=t==="readonly"?"readonly":"readwrite",s=function(u){return u===17?Eb:u===16?wb:u===15?gm:u===14?qE:u===13?BE:u===12?vb:u===11?UE:void U()}(this.hi),o;return this.Ri.runTransaction(e,i,s,l=>(o=new Do(l,this.Qr?this.Qr.next():_t.oe),t==="readwrite-primary"?this.wi(o).next(u=>!!u||this.Si(o)).next(u=>{if(!u)throw Re(`Failed to obtain primary lease for action '${e}'.`),this.isPrimary=!1,this.ui.enqueueRetryable(()=>this.di(!1)),new k(P.FAILED_PRECONDITION,FE);return r(o)}).next(u=>this.Di(o).next(()=>u)):this.Ki(o).next(()=>r(o)))).then(l=>(o.raiseOnCommittedEvent(),l))}Ki(e){return Io(e).get("owner").next(t=>{if(t!==null&&this.Mi(t.leaseTimestampMs,5e3)&&!this.Ni(t.ownerId)&&!this.vi(t)&&!(this.li||this.allowTabSynchronization&&t.allowTabSynchronization))throw new k(P.FAILED_PRECONDITION,cf)})}Di(e){let t={ownerId:this.clientId,allowTabSynchronization:this.allowTabSynchronization,leaseTimestampMs:Date.now()};return Io(e).put("owner",t)}static D(){return $n.D()}bi(e){let t=Io(e);return t.get("owner").next(r=>this.vi(r)?(V("IndexedDbPersistence","Releasing primary lease."),t.delete("owner")):b.resolve())}Mi(e,t){let r=Date.now();return!(e<r-t)&&(!(e>r)||(Re(`Detected an update time that is in the future: ${e} > ${r}`),!1))}fi(){this.document!==null&&typeof this.document.addEventListener=="function"&&(this.Ii=()=>{this.ui.enqueueAndForget(()=>(this.inForeground=this.document.visibilityState==="visible",this.mi()))},this.document.addEventListener("visibilitychange",this.Ii),this.inForeground=this.document.visibilityState==="visible")}Bi(){this.Ii&&(this.document.removeEventListener("visibilitychange",this.Ii),this.Ii=null)}gi(){var e;typeof((e=this.window)===null||e===void 0?void 0:e.addEventListener)=="function"&&(this.Pi=()=>{this.Li();let t=/(?:Version|Mobile)\/1[456]/;rh()&&(navigator.appVersion.match(t)||navigator.userAgent.match(t))&&this.ui.enterRestrictedMode(!0),this.ui.enqueueAndForget(()=>this.shutdown())},this.window.addEventListener("pagehide",this.Pi))}ki(){this.Pi&&(this.window.removeEventListener("pagehide",this.Pi),this.Pi=null)}Ni(e){var t;try{let r=((t=this.Vi)===null||t===void 0?void 0:t.getItem(this.Oi(e)))!==null;return V("IndexedDbPersistence",`Client '${e}' ${r?"is":"is not"} zombied in LocalStorage`),r}catch(r){return Re("IndexedDbPersistence","Failed to get zombied client id.",r),!1}}Li(){if(this.Vi)try{this.Vi.setItem(this.Oi(this.clientId),String(Date.now()))}catch(e){Re("Failed to set zombie client id.",e)}}qi(){if(this.Vi)try{this.Vi.removeItem(this.Oi(this.clientId))}catch{}}Oi(e){return`firestore_zombie_${this.persistenceKey}_${e}`}};function Io(n){return qe(n,"owner")}function nu(n){return qe(n,"clientMetadata")}function Cm(n,e){let t=n.projectId;return n.isDefaultDatabase||(t+="."+n.database),"firestore/"+e+"/"+t+"/"}var Sp=class n{constructor(e,t,r,i){this.targetId=e,this.fromCache=t,this.$i=r,this.Ui=i}static Wi(e,t){let r=H(),i=H();for(let s of t.docChanges)switch(s.type){case 0:r=r.add(s.doc.key);break;case 1:i=i.add(s.doc.key)}return new n(e,t.fromCache,r,i)}};var Cp=class{constructor(){this._documentReadCount=0}get documentReadCount(){return this._documentReadCount}incrementDocumentReadCount(e){this._documentReadCount+=e}};var Fu=class{constructor(){this.Gi=!1,this.zi=!1,this.ji=100,this.Hi=function(){return rh()?8:OE(Fs())>0?6:4}()}initialize(e,t){this.Ji=e,this.indexManager=t,this.Gi=!0}getDocumentsMatchingQuery(e,t,r,i){let s={result:null};return this.Yi(e,t).next(o=>{s.result=o}).next(()=>{if(!s.result)return this.Zi(e,t,i,r).next(o=>{s.result=o})}).next(()=>{if(s.result)return;let o=new Cp;return this.Xi(e,t,o).next(l=>{if(s.result=l,this.zi)return this.es(e,t,o,l.size)})}).next(()=>s.result)}es(e,t,r,i){return r.documentReadCount<this.ji?(bi()<=Et.DEBUG&&V("QueryEngine","SDK will not create cache indexes for query:",Ri(t),"since it only creates cache indexes for collection contains","more than or equal to",this.ji,"documents"),b.resolve()):(bi()<=Et.DEBUG&&V("QueryEngine","Query:",Ri(t),"scans",r.documentReadCount,"local documents and returns",i,"documents as results."),r.documentReadCount>this.Hi*i?(bi()<=Et.DEBUG&&V("QueryEngine","The SDK decides to create cache indexes for query:",Ri(t),"as using cache indexes may help improve performance."),this.indexManager.createTargetIndexes(e,lt(t))):b.resolve())}Yi(e,t){if(Gw(t))return b.resolve(null);let r=lt(t);return this.indexManager.getIndexType(e,r).next(i=>i===0?null:(t.limit!==null&&i===1&&(t=wu(t,null,"F"),r=lt(t)),this.indexManager.getDocumentsMatchingTarget(e,r).next(s=>{let o=H(...s);return this.Ji.getDocuments(e,o).next(l=>this.indexManager.getMinOffset(e,r).next(u=>{let c=this.ts(t,l);return this.ns(t,c,o,u.readTime)?this.Yi(e,wu(t,null,"F")):this.rs(e,c,t,u)}))})))}Zi(e,t,r,i){return Gw(t)||i.isEqual(z.min())?b.resolve(null):this.Ji.getDocuments(e,r).next(s=>{let o=this.ts(t,s);return this.ns(t,o,r,i)?b.resolve(null):(bi()<=Et.DEBUG&&V("QueryEngine","Re-using previous result from %s to execute query: %s",i.toString(),Ri(t)),this.rs(e,o,t,kE(i,-1)).next(l=>l))})}ts(e,t){let r=new ge(tI(e));return t.forEach((i,s)=>{ea(e,s)&&(r=r.add(s))}),r}ns(e,t,r,i){if(e.limit===null)return!1;if(r.size!==t.size)return!0;let s=e.limitType==="F"?t.last():t.first();return!!s&&(s.hasPendingWrites||s.version.compareTo(i)>0)}Xi(e,t,r){return bi()<=Et.DEBUG&&V("QueryEngine","Using full collection scan to execute query:",Ri(t)),this.Ji.getDocumentsMatchingQuery(e,t,At.min(),r)}rs(e,t,r,i){return this.Ji.getDocumentsMatchingQuery(e,r,i).next(s=>(t.forEach(o=>{s=s.insert(o.key,o)}),s))}};var Ap=class{constructor(e,t,r,i){this.persistence=e,this.ss=t,this.serializer=i,this.os=new we(W),this._s=new Zt(s=>Fr(s),Xo),this.us=new Map,this.cs=e.getRemoteDocumentCache(),this.Ur=e.getTargetCache(),this.Gr=e.getBundleCache(),this.ls(r)}ls(e){this.documentOverlayCache=this.persistence.getDocumentOverlayCache(e),this.indexManager=this.persistence.getIndexManager(e),this.mutationQueue=this.persistence.getMutationQueue(e,this.indexManager),this.localDocuments=new Du(this.cs,this.mutationQueue,this.documentOverlayCache,this.indexManager),this.cs.setIndexManager(this.indexManager),this.ss.initialize(this.localDocuments,this.indexManager)}collectGarbage(e){return this.persistence.runTransaction("Collect garbage","readwrite-primary",t=>e.collect(t,this.os))}};function FI(n,e,t,r){return new Ap(n,e,t,r)}function OI(n,e){return N(this,null,function*(){let t=M(n);return yield t.persistence.runTransaction("Handle user change","readonly",r=>{let i;return t.mutationQueue.getAllMutationBatches(r).next(s=>(i=s,t.ls(e),t.mutationQueue.getAllMutationBatches(r))).next(s=>{let o=[],l=[],u=H();for(let c of i){o.push(c.batchId);for(let d of c.mutations)u=u.add(d.key)}for(let c of s){l.push(c.batchId);for(let d of c.mutations)u=u.add(d.key)}return t.localDocuments.getDocuments(r,u).next(c=>({hs:c,removedBatchIds:o,addedBatchIds:l}))})})})}function eR(n,e){let t=M(n);return t.persistence.runTransaction("Acknowledge batch","readwrite-primary",r=>{let i=e.batch.keys(),s=t.cs.newChangeBuffer({trackRemovals:!0});return function(l,u,c,d){let p=c.batch,m=p.keys(),y=b.resolve();return m.forEach(C=>{y=y.next(()=>d.getEntry(u,C)).next(x=>{let D=c.docVersions.get(C);G(D!==null),x.version.compareTo(D)<0&&(p.applyToRemoteDocument(x,c),x.isValidDocument()&&(x.setReadTime(c.commitVersion),d.addEntry(x)))})}),y.next(()=>l.mutationQueue.removeMutationBatch(u,p))}(t,r,e,s).next(()=>s.apply(r)).next(()=>t.mutationQueue.performConsistencyCheck(r)).next(()=>t.documentOverlayCache.removeOverlaysForBatchId(r,i,e.batch.batchId)).next(()=>t.localDocuments.recalculateAndSaveOverlaysForDocumentKeys(r,function(l){let u=H();for(let c=0;c<l.mutationResults.length;++c)l.mutationResults[c].transformResults.length>0&&(u=u.add(l.batch.mutations[c].key));return u}(e))).next(()=>t.localDocuments.getDocuments(r,i))})}function MI(n){let e=M(n);return e.persistence.runTransaction("Get last remote snapshot version","readonly",t=>e.Ur.getLastRemoteSnapshotVersion(t))}function tR(n,e){let t=M(n),r=e.snapshotVersion,i=t.os;return t.persistence.runTransaction("Apply remote event","readwrite-primary",s=>{let o=t.cs.newChangeBuffer({trackRemovals:!0});i=t.os;let l=[];e.targetChanges.forEach((d,p)=>{let m=i.get(p);if(!m)return;l.push(t.Ur.removeMatchingKeys(s,d.removedDocuments,p).next(()=>t.Ur.addMatchingKeys(s,d.addedDocuments,p)));let y=m.withSequenceNumber(s.currentSequenceNumber);e.targetMismatches.get(p)!==null?y=y.withResumeToken(Ne.EMPTY_BYTE_STRING,z.min()).withLastLimboFreeSnapshotVersion(z.min()):d.resumeToken.approximateByteSize()>0&&(y=y.withResumeToken(d.resumeToken,r)),i=i.insert(p,y),function(x,D,q){return x.resumeToken.approximateByteSize()===0||D.snapshotVersion.toMicroseconds()-x.snapshotVersion.toMicroseconds()>=3e8?!0:q.addedDocuments.size+q.modifiedDocuments.size+q.removedDocuments.size>0}(m,y,d)&&l.push(t.Ur.updateTargetData(s,y))});let u=ht(),c=H();if(e.documentUpdates.forEach(d=>{e.resolvedLimboDocuments.has(d)&&l.push(t.persistence.referenceDelegate.updateLimboDocument(s,d))}),l.push(LI(s,o,e.documentUpdates).next(d=>{u=d.Ps,c=d.Is})),!r.isEqual(z.min())){let d=t.Ur.getLastRemoteSnapshotVersion(s).next(p=>t.Ur.setTargetsMetadata(s,s.currentSequenceNumber,r));l.push(d)}return b.waitFor(l).next(()=>o.apply(s)).next(()=>t.localDocuments.getLocalViewOfDocuments(s,u,c)).next(()=>u)}).then(s=>(t.os=i,s))}function LI(n,e,t){let r=H(),i=H();return t.forEach(s=>r=r.add(s)),e.getEntries(n,r).next(s=>{let o=ht();return t.forEach((l,u)=>{let c=s.get(l);u.isFoundDocument()!==c.isFoundDocument()&&(i=i.add(l)),u.isNoDocument()&&u.version.isEqual(z.min())?(e.removeEntry(l,u.readTime),o=o.insert(l,u)):!c.isValidDocument()||u.version.compareTo(c.version)>0||u.version.compareTo(c.version)===0&&c.hasPendingWrites?(e.addEntry(u),o=o.insert(l,u)):V("LocalStore","Ignoring outdated watch update for ",l,". Current version:",c.version," Watch version:",u.version)}),{Ps:o,Is:i}})}function nR(n,e){let t=M(n);return t.persistence.runTransaction("Get next mutation batch","readonly",r=>(e===void 0&&(e=-1),t.mutationQueue.getNextMutationBatchAfterBatchId(r,e)))}function Ki(n,e){let t=M(n);return t.persistence.runTransaction("Allocate target","readwrite",r=>{let i;return t.Ur.getTargetData(r,e).next(s=>s?(i=s,b.resolve(i)):t.Ur.allocateTargetId(r).next(o=>(i=new ji(e,o,"TargetPurposeListen",r.currentSequenceNumber),t.Ur.addTargetData(r,i).next(()=>i))))}).then(r=>{let i=t.os.get(r.targetId);return(i===null||r.snapshotVersion.compareTo(i.snapshotVersion)>0)&&(t.os=t.os.insert(r.targetId,r),t._s.set(e,r.targetId)),r})}function Wi(n,e,t){return N(this,null,function*(){let r=M(n),i=r.os.get(e),s=t?"readwrite":"readwrite-primary";try{t||(yield r.persistence.runTransaction("Release target",s,o=>r.persistence.referenceDelegate.removeTarget(o,i)))}catch(o){if(!ir(o))throw o;V("LocalStore",`Failed to update sequence numbers for target ${e}: ${o}`)}r.os=r.os.remove(e),r._s.delete(i.target)})}function Ou(n,e,t){let r=M(n),i=z.min(),s=H();return r.persistence.runTransaction("Execute query","readwrite",o=>function(u,c,d){let p=M(u),m=p._s.get(d);return m!==void 0?b.resolve(p.os.get(m)):p.Ur.getTargetData(c,d)}(r,o,lt(e)).next(l=>{if(l)return i=l.lastLimboFreeSnapshotVersion,r.Ur.getMatchingKeysForTargetId(o,l.targetId).next(u=>{s=u})}).next(()=>r.ss.getDocumentsMatchingQuery(o,e,t?i:z.min(),t?s:H())).next(l=>(qI(r,eI(e),l),{documents:l,Ts:s})))}function UI(n,e){let t=M(n),r=M(t.Ur),i=t.os.get(e);return i?Promise.resolve(i.target):t.persistence.runTransaction("Get target data","readonly",s=>r.ot(s,e).next(o=>o?o.target:null))}function BI(n,e){let t=M(n),r=t.us.get(e)||z.min();return t.persistence.runTransaction("Get new document changes","readonly",i=>t.cs.getAllFromCollectionGroup(i,e,kE(r,-1),Number.MAX_SAFE_INTEGER)).then(i=>(qI(t,e,i),i))}function qI(n,e,t){let r=n.us.get(e)||z.min();t.forEach((i,s)=>{s.readTime.compareTo(r)>0&&(r=s.readTime)}),n.us.set(e,r)}function rR(n,e,t,r){return N(this,null,function*(){let i=M(n),s=H(),o=ht();for(let c of t){let d=e.Es(c.metadata.name);c.document&&(s=s.add(d));let p=e.ds(c);p.setReadTime(e.As(c.metadata.readTime)),o=o.insert(d,p)}let l=i.cs.newChangeBuffer({trackRemovals:!0}),u=yield Ki(i,function(d){return lt(es(oe.fromString(`__bundle__/docs/${d}`)))}(r));return i.persistence.runTransaction("Apply bundle documents","readwrite",c=>LI(c,l,o).next(d=>(l.apply(c),d)).next(d=>i.Ur.removeMatchingKeysForTargetId(c,u.targetId).next(()=>i.Ur.addMatchingKeys(c,s,u.targetId)).next(()=>i.localDocuments.getLocalViewOfDocuments(c,d.Ps,d.Is)).next(()=>d.Ps)))})}function iR(r,i){return N(this,arguments,function*(n,e,t=H()){let s=yield Ki(n,lt(Tm(e.bundledQuery))),o=M(n);return o.persistence.runTransaction("Save named query","readwrite",l=>{let u=xe(e.readTime);if(s.snapshotVersion.compareTo(u)>=0)return o.Gr.saveNamedQuery(l,e);let c=s.withResumeToken(Ne.EMPTY_BYTE_STRING,u);return o.os=o.os.insert(c.targetId,c),o.Ur.updateTargetData(l,c).next(()=>o.Ur.removeMatchingKeysForTargetId(l,s.targetId)).next(()=>o.Ur.addMatchingKeys(l,t,s.targetId)).next(()=>o.Gr.saveNamedQuery(l,e))})})}function gE(n,e){return`firestore_clients_${n}_${e}`}function _E(n,e,t){let r=`firestore_mutations_${n}_${t}`;return e.isAuthenticated()&&(r+=`_${e.uid}`),r}function hf(n,e){return`firestore_targets_${n}_${e}`}var Mu=class n{constructor(e,t,r,i){this.user=e,this.batchId=t,this.state=r,this.error=i}static Rs(e,t,r){let i=JSON.parse(r),s,o=typeof i=="object"&&["pending","acknowledged","rejected"].indexOf(i.state)!==-1&&(i.error===void 0||typeof i.error=="object");return o&&i.error&&(o=typeof i.error.message=="string"&&typeof i.error.code=="string",o&&(s=new k(i.error.code,i.error.message))),o?new n(e,t,i.state,s):(Re("SharedClientState",`Failed to parse mutation state for ID '${t}': ${r}`),null)}Vs(){let e={state:this.state,updateTimeMs:Date.now()};return this.error&&(e.error={code:this.error.code,message:this.error.message}),JSON.stringify(e)}},Ro=class n{constructor(e,t,r){this.targetId=e,this.state=t,this.error=r}static Rs(e,t){let r=JSON.parse(t),i,s=typeof r=="object"&&["not-current","current","rejected"].indexOf(r.state)!==-1&&(r.error===void 0||typeof r.error=="object");return s&&r.error&&(s=typeof r.error.message=="string"&&typeof r.error.code=="string",s&&(i=new k(r.error.code,r.error.message))),s?new n(e,r.state,i):(Re("SharedClientState",`Failed to parse target state for ID '${e}': ${t}`),null)}Vs(){let e={state:this.state,updateTimeMs:Date.now()};return this.error&&(e.error={code:this.error.code,message:this.error.message}),JSON.stringify(e)}},Lu=class n{constructor(e,t){this.clientId=e,this.activeTargetIds=t}static Rs(e,t){let r=JSON.parse(t),i=typeof r=="object"&&r.activeTargetIds instanceof Array,s=wm();for(let o=0;i&&o<r.activeTargetIds.length;++o)i=ME(r.activeTargetIds[o]),s=s.add(r.activeTargetIds[o]);return i?new n(e,s):(Re("SharedClientState",`Failed to parse client data for instance '${e}': ${t}`),null)}},bp=class n{constructor(e,t){this.clientId=e,this.onlineState=t}static Rs(e){let t=JSON.parse(e);return typeof t=="object"&&["Unknown","Online","Offline"].indexOf(t.onlineState)!==-1&&typeof t.clientId=="string"?new n(t.clientId,t.onlineState):(Re("SharedClientState",`Failed to parse online state: ${e}`),null)}},Ko=class{constructor(){this.activeTargetIds=wm()}fs(e){this.activeTargetIds=this.activeTargetIds.add(e)}gs(e){this.activeTargetIds=this.activeTargetIds.delete(e)}Vs(){let e={activeTargetIds:this.activeTargetIds.toArray(),updateTimeMs:Date.now()};return JSON.stringify(e)}},Po=class{constructor(e,t,r,i,s){this.window=e,this.ui=t,this.persistenceKey=r,this.ps=i,this.syncEngine=null,this.onlineStateHandler=null,this.sequenceNumberHandler=null,this.ys=this.ws.bind(this),this.Ss=new we(W),this.started=!1,this.bs=[];let o=r.replace(/[.*+?^${}()|[\]\\]/g,"\\$&");this.storage=this.window.localStorage,this.currentUser=s,this.Ds=gE(this.persistenceKey,this.ps),this.vs=function(u){return`firestore_sequence_number_${u}`}(this.persistenceKey),this.Ss=this.Ss.insert(this.ps,new Ko),this.Cs=new RegExp(`^firestore_clients_${o}_([^_]*)$`),this.Fs=new RegExp(`^firestore_mutations_${o}_(\\d+)(?:_(.*))?$`),this.Ms=new RegExp(`^firestore_targets_${o}_(\\d+)$`),this.xs=function(u){return`firestore_online_state_${u}`}(this.persistenceKey),this.Os=function(u){return`firestore_bundle_loaded_v2_${u}`}(this.persistenceKey),this.window.addEventListener("storage",this.ys)}static D(e){return!(!e||!e.localStorage)}start(){return N(this,null,function*(){let e=yield this.syncEngine.Qi();for(let r of e){if(r===this.ps)continue;let i=this.getItem(gE(this.persistenceKey,r));if(i){let s=Lu.Rs(r,i);s&&(this.Ss=this.Ss.insert(s.clientId,s))}}this.Ns();let t=this.storage.getItem(this.xs);if(t){let r=this.Ls(t);r&&this.Bs(r)}for(let r of this.bs)this.ws(r);this.bs=[],this.window.addEventListener("pagehide",()=>this.shutdown()),this.started=!0})}writeSequenceNumber(e){this.setItem(this.vs,JSON.stringify(e))}getAllActiveQueryTargets(){return this.ks(this.Ss)}isActiveQueryTarget(e){let t=!1;return this.Ss.forEach((r,i)=>{i.activeTargetIds.has(e)&&(t=!0)}),t}addPendingMutation(e){this.qs(e,"pending")}updateMutationState(e,t,r){this.qs(e,t,r),this.Qs(e)}addLocalQueryTarget(e,t=!0){let r="not-current";if(this.isActiveQueryTarget(e)){let i=this.storage.getItem(hf(this.persistenceKey,e));if(i){let s=Ro.Rs(e,i);s&&(r=s.state)}}return t&&this.Ks.fs(e),this.Ns(),r}removeLocalQueryTarget(e){this.Ks.gs(e),this.Ns()}isLocalQueryTarget(e){return this.Ks.activeTargetIds.has(e)}clearQueryState(e){this.removeItem(hf(this.persistenceKey,e))}updateQueryState(e,t,r){this.$s(e,t,r)}handleUserChange(e,t,r){t.forEach(i=>{this.Qs(i)}),this.currentUser=e,r.forEach(i=>{this.addPendingMutation(i)})}setOnlineState(e){this.Us(e)}notifyBundleLoaded(e){this.Ws(e)}shutdown(){this.started&&(this.window.removeEventListener("storage",this.ys),this.removeItem(this.Ds),this.started=!1)}getItem(e){let t=this.storage.getItem(e);return V("SharedClientState","READ",e,t),t}setItem(e,t){V("SharedClientState","SET",e,t),this.storage.setItem(e,t)}removeItem(e){V("SharedClientState","REMOVE",e),this.storage.removeItem(e)}ws(e){let t=e;if(t.storageArea===this.storage){if(V("SharedClientState","EVENT",t.key,t.newValue),t.key===this.Ds)return void Re("Received WebStorage notification for local change. Another client might have garbage-collected our state");this.ui.enqueueRetryable(()=>N(this,null,function*(){if(this.started){if(t.key!==null){if(this.Cs.test(t.key)){if(t.newValue==null){let r=this.Gs(t.key);return this.zs(r,null)}{let r=this.js(t.key,t.newValue);if(r)return this.zs(r.clientId,r)}}else if(this.Fs.test(t.key)){if(t.newValue!==null){let r=this.Hs(t.key,t.newValue);if(r)return this.Js(r)}}else if(this.Ms.test(t.key)){if(t.newValue!==null){let r=this.Ys(t.key,t.newValue);if(r)return this.Zs(r)}}else if(t.key===this.xs){if(t.newValue!==null){let r=this.Ls(t.newValue);if(r)return this.Bs(r)}}else if(t.key===this.vs){let r=function(s){let o=_t.oe;if(s!=null)try{let l=JSON.parse(s);G(typeof l=="number"),o=l}catch(l){Re("SharedClientState","Failed to read sequence number from WebStorage",l)}return o}(t.newValue);r!==_t.oe&&this.sequenceNumberHandler(r)}else if(t.key===this.Os){let r=this.Xs(t.newValue);yield Promise.all(r.map(i=>this.syncEngine.eo(i)))}}}else this.bs.push(t)}))}}get Ks(){return this.Ss.get(this.ps)}Ns(){this.setItem(this.Ds,this.Ks.Vs())}qs(e,t,r){let i=new Mu(this.currentUser,e,t,r),s=_E(this.persistenceKey,this.currentUser,e);this.setItem(s,i.Vs())}Qs(e){let t=_E(this.persistenceKey,this.currentUser,e);this.removeItem(t)}Us(e){let t={clientId:this.ps,onlineState:e};this.storage.setItem(this.xs,JSON.stringify(t))}$s(e,t,r){let i=hf(this.persistenceKey,e),s=new Ro(e,t,r);this.setItem(i,s.Vs())}Ws(e){let t=JSON.stringify(Array.from(e));this.setItem(this.Os,t)}Gs(e){let t=this.Cs.exec(e);return t?t[1]:null}js(e,t){let r=this.Gs(e);return Lu.Rs(r,t)}Hs(e,t){let r=this.Fs.exec(e),i=Number(r[1]),s=r[2]!==void 0?r[2]:null;return Mu.Rs(new Oe(s),i,t)}Ys(e,t){let r=this.Ms.exec(e),i=Number(r[1]);return Ro.Rs(i,t)}Ls(e){return bp.Rs(e)}Xs(e){return JSON.parse(e)}Js(e){return N(this,null,function*(){if(e.user.uid===this.currentUser.uid)return this.syncEngine.no(e.batchId,e.state,e.error);V("SharedClientState",`Ignoring mutation for non-active user ${e.user.uid}`)})}Zs(e){return this.syncEngine.ro(e.targetId,e.state,e.error)}zs(e,t){let r=t?this.Ss.insert(e,t):this.Ss.remove(e),i=this.ks(this.Ss),s=this.ks(r),o=[],l=[];return s.forEach(u=>{i.has(u)||o.push(u)}),i.forEach(u=>{s.has(u)||l.push(u)}),this.syncEngine.io(o,l).then(()=>{this.Ss=r})}Bs(e){this.Ss.get(e.clientId)&&this.onlineStateHandler(e.onlineState)}ks(e){let t=wm();return e.forEach((r,i)=>{t=t.unionWith(i.activeTargetIds)}),t}},Uu=class{constructor(){this.so=new Ko,this.oo={},this.onlineStateHandler=null,this.sequenceNumberHandler=null}addPendingMutation(e){}updateMutationState(e,t,r){}addLocalQueryTarget(e,t=!0){return t&&this.so.fs(e),this.oo[e]||"not-current"}updateQueryState(e,t,r){this.oo[e]=t}removeLocalQueryTarget(e){this.so.gs(e)}isLocalQueryTarget(e){return this.so.activeTargetIds.has(e)}clearQueryState(e){delete this.oo[e]}getAllActiveQueryTargets(){return this.so.activeTargetIds}isActiveQueryTarget(e){return this.so.activeTargetIds.has(e)}start(){return this.so=new Ko,Promise.resolve()}handleUserChange(e,t,r){}setOnlineState(e){}shutdown(){}writeSequenceNumber(e){}notifyBundleLoaded(e){}};var Rp=class{_o(e){}shutdown(){}};var Bu=class{constructor(){this.ao=()=>this.uo(),this.co=()=>this.lo(),this.ho=[],this.Po()}_o(e){this.ho.push(e)}shutdown(){window.removeEventListener("online",this.ao),window.removeEventListener("offline",this.co)}Po(){window.addEventListener("online",this.ao),window.addEventListener("offline",this.co)}uo(){V("ConnectivityMonitor","Network connectivity changed: AVAILABLE");for(let e of this.ho)e(0)}lo(){V("ConnectivityMonitor","Network connectivity changed: UNAVAILABLE");for(let e of this.ho)e(1)}static D(){return typeof window<"u"&&window.addEventListener!==void 0&&window.removeEventListener!==void 0}};var ru=null;function df(){return ru===null?ru=function(){return 268435456+Math.round(2147483648*Math.random())}():ru++,"0x"+ru.toString(16)}var sR={BatchGetDocuments:"batchGet",Commit:"commit",RunQuery:"runQuery",RunAggregationQuery:"runAggregationQuery"};var Pp=class{constructor(e){this.Io=e.Io,this.To=e.To}Eo(e){this.Ao=e}Ro(e){this.Vo=e}mo(e){this.fo=e}onMessage(e){this.po=e}close(){this.To()}send(e){this.Io(e)}yo(){this.Ao()}wo(){this.Vo()}So(e){this.fo(e)}bo(e){this.po(e)}};var Ze="WebChannelConnection",xp=class extends class{constructor(t){this.databaseInfo=t,this.databaseId=t.databaseId;let r=t.ssl?"https":"http",i=encodeURIComponent(this.databaseId.projectId),s=encodeURIComponent(this.databaseId.database);this.Do=r+"://"+t.host,this.vo=`projects/${i}/databases/${s}`,this.Co=this.databaseId.database==="(default)"?`project_id=${i}`:`project_id=${i}&database_id=${s}`}get Fo(){return!1}Mo(t,r,i,s,o){let l=df(),u=this.xo(t,r.toUriEncodedString());V("RestConnection",`Sending RPC '${t}' ${l}:`,u,i);let c={"google-cloud-resource-prefix":this.vo,"x-goog-request-params":this.Co};return this.Oo(c,s,o),this.No(t,u,c,i).then(d=>(V("RestConnection",`Received RPC '${t}' ${l}: `,d),d),d=>{throw Dt("RestConnection",`RPC '${t}' ${l} failed with error: `,d,"url: ",u,"request:",i),d})}Lo(t,r,i,s,o,l){return this.Mo(t,r,i,s,o)}Oo(t,r,i){t["X-Goog-Api-Client"]=function(){return"gl-js/ fire/"+Zi}(),t["Content-Type"]="text/plain",this.databaseInfo.appId&&(t["X-Firebase-GMPID"]=this.databaseInfo.appId),r&&r.headers.forEach((s,o)=>t[o]=s),i&&i.headers.forEach((s,o)=>t[o]=s)}xo(t,r){let i=sR[t];return`${this.Do}/v1/${r}:${i}`}terminate(){}}{constructor(e){super(e),this.forceLongPolling=e.forceLongPolling,this.autoDetectLongPolling=e.autoDetectLongPolling,this.useFetchStreams=e.useFetchStreams,this.longPollingOptions=e.longPollingOptions}No(e,t,r,i){let s=df();return new Promise((o,l)=>{let u=new rf;u.setWithCredentials(!0),u.listenOnce(sf.COMPLETE,()=>{try{switch(u.getLastErrorCode()){case yo.NO_ERROR:let d=u.getResponseJson();V(Ze,`XHR for RPC '${e}' ${s} received:`,JSON.stringify(d)),o(d);break;case yo.TIMEOUT:V(Ze,`RPC '${e}' ${s} timed out`),l(new k(P.DEADLINE_EXCEEDED,"Request time out"));break;case yo.HTTP_ERROR:let p=u.getStatus();if(V(Ze,`RPC '${e}' ${s} failed with status:`,p,"response text:",u.getResponseText()),p>0){let m=u.getResponseJson();Array.isArray(m)&&(m=m[0]);let y=m?.error;if(y&&y.status&&y.message){let C=function(D){let q=D.toLowerCase().replace(/_/g,"-");return Object.values(P).indexOf(q)>=0?q:P.UNKNOWN}(y.status);l(new k(C,y.message))}else l(new k(P.UNKNOWN,"Server responded with status "+u.getStatus()))}else l(new k(P.UNAVAILABLE,"Connection failed."));break;default:U()}}finally{V(Ze,`RPC '${e}' ${s} completed.`)}});let c=JSON.stringify(i);V(Ze,`RPC '${e}' ${s} sending request:`,i),u.send(t,"POST",c,r,15)})}Bo(e,t,r){let i=df(),s=[this.Do,"/","google.firestore.v1.Firestore","/",e,"/channel"],o=lf(),l=af(),u={httpSessionIdParam:"gsessionid",initMessageHeaders:{},messageUrlParams:{database:`projects/${this.databaseId.projectId}/databases/${this.databaseId.database}`},sendRawJson:!0,supportsCrossDomainXhr:!0,internalChannelParams:{forwardChannelRequestTimeoutMs:6e5},forceLongPolling:this.forceLongPolling,detectBufferingProxy:this.autoDetectLongPolling},c=this.longPollingOptions.timeoutSeconds;c!==void 0&&(u.longPollingTimeout=Math.round(1e3*c)),this.useFetchStreams&&(u.useFetchStreams=!0),this.Oo(u.initMessageHeaders,t,r),u.encodeInitMessageHeaders=!0;let d=s.join("");V(Ze,`Creating RPC '${e}' stream ${i}: ${d}`,u);let p=o.createWebChannel(d,u),m=!1,y=!1,C=new Pp({Io:D=>{y?V(Ze,`Not sending because RPC '${e}' stream ${i} is closed:`,D):(m||(V(Ze,`Opening RPC '${e}' stream ${i} transport.`),p.open(),m=!0),V(Ze,`RPC '${e}' stream ${i} sending:`,D),p.send(D))},To:()=>p.close()}),x=(D,q,j)=>{D.listen(q,B=>{try{j(B)}catch(Y){setTimeout(()=>{throw Y},0)}})};return x(p,Ii.EventType.OPEN,()=>{y||(V(Ze,`RPC '${e}' stream ${i} transport opened.`),C.yo())}),x(p,Ii.EventType.CLOSE,()=>{y||(y=!0,V(Ze,`RPC '${e}' stream ${i} transport closed`),C.So())}),x(p,Ii.EventType.ERROR,D=>{y||(y=!0,Dt(Ze,`RPC '${e}' stream ${i} transport errored:`,D),C.So(new k(P.UNAVAILABLE,"The operation could not be completed")))}),x(p,Ii.EventType.MESSAGE,D=>{var q;if(!y){let j=D.data[0];G(!!j);let B=j,Y=B.error||((q=B[0])===null||q===void 0?void 0:q.error);if(Y){V(Ze,`RPC '${e}' stream ${i} received error:`,Y);let re=Y.status,Q=function(w){let I=Ve[w];if(I!==void 0)return pI(I)}(re),E=Y.message;Q===void 0&&(Q=P.INTERNAL,E="Unknown error status: "+re+" with message "+Y.message),y=!0,C.So(new k(Q,E)),p.close()}else V(Ze,`RPC '${e}' stream ${i} received:`,j),C.bo(j)}}),x(l,of.STAT_EVENT,D=>{D.stat===Zl.PROXY?V(Ze,`RPC '${e}' stream ${i} detected buffering proxy`):D.stat===Zl.NOPROXY&&V(Ze,`RPC '${e}' stream ${i} detected no buffering proxy`)}),setTimeout(()=>{C.wo()},0),C}};function GI(){return typeof window<"u"?window:null}function lu(){return typeof document<"u"?document:null}function ta(n){return new Kf(n,!0)}var Wo=class{constructor(e,t,r=1e3,i=1.5,s=6e4){this.ui=e,this.timerId=t,this.ko=r,this.qo=i,this.Qo=s,this.Ko=0,this.$o=null,this.Uo=Date.now(),this.reset()}reset(){this.Ko=0}Wo(){this.Ko=this.Qo}Go(e){this.cancel();let t=Math.floor(this.Ko+this.zo()),r=Math.max(0,Date.now()-this.Uo),i=Math.max(0,t-r);i>0&&V("ExponentialBackoff",`Backing off for ${i} ms (base delay: ${this.Ko} ms, delay with jitter: ${t} ms, last attempt: ${r} ms ago)`),this.$o=this.ui.enqueueAfterDelay(this.timerId,i,()=>(this.Uo=Date.now(),e())),this.Ko*=this.qo,this.Ko<this.ko&&(this.Ko=this.ko),this.Ko>this.Qo&&(this.Ko=this.Qo)}jo(){this.$o!==null&&(this.$o.skipDelay(),this.$o=null)}cancel(){this.$o!==null&&(this.$o.cancel(),this.$o=null)}zo(){return(Math.random()-.5)*this.Ko}};var qu=class{constructor(e,t,r,i,s,o,l,u){this.ui=e,this.Ho=r,this.Jo=i,this.connection=s,this.authCredentialsProvider=o,this.appCheckCredentialsProvider=l,this.listener=u,this.state=0,this.Yo=0,this.Zo=null,this.Xo=null,this.stream=null,this.e_=0,this.t_=new Wo(e,t)}n_(){return this.state===1||this.state===5||this.r_()}r_(){return this.state===2||this.state===3}start(){this.e_=0,this.state!==4?this.auth():this.i_()}stop(){return N(this,null,function*(){this.n_()&&(yield this.close(0))})}s_(){this.state=0,this.t_.reset()}o_(){this.r_()&&this.Zo===null&&(this.Zo=this.ui.enqueueAfterDelay(this.Ho,6e4,()=>this.__()))}a_(e){this.u_(),this.stream.send(e)}__(){return N(this,null,function*(){if(this.r_())return this.close(0)})}u_(){this.Zo&&(this.Zo.cancel(),this.Zo=null)}c_(){this.Xo&&(this.Xo.cancel(),this.Xo=null)}close(e,t){return N(this,null,function*(){this.u_(),this.c_(),this.t_.cancel(),this.Yo++,e!==4?this.t_.reset():t&&t.code===P.RESOURCE_EXHAUSTED?(Re(t.toString()),Re("Using maximum backoff delay to prevent overloading the backend."),this.t_.Wo()):t&&t.code===P.UNAUTHENTICATED&&this.state!==3&&(this.authCredentialsProvider.invalidateToken(),this.appCheckCredentialsProvider.invalidateToken()),this.stream!==null&&(this.l_(),this.stream.close(),this.stream=null),this.state=e,yield this.listener.mo(t)})}l_(){}auth(){this.state=1;let e=this.h_(this.Yo),t=this.Yo;Promise.all([this.authCredentialsProvider.getToken(),this.appCheckCredentialsProvider.getToken()]).then(([r,i])=>{this.Yo===t&&this.P_(r,i)},r=>{e(()=>{let i=new k(P.UNKNOWN,"Fetching auth token failed: "+r.message);return this.I_(i)})})}P_(e,t){let r=this.h_(this.Yo);this.stream=this.T_(e,t),this.stream.Eo(()=>{r(()=>this.listener.Eo())}),this.stream.Ro(()=>{r(()=>(this.state=2,this.Xo=this.ui.enqueueAfterDelay(this.Jo,1e4,()=>(this.r_()&&(this.state=3),Promise.resolve())),this.listener.Ro()))}),this.stream.mo(i=>{r(()=>this.I_(i))}),this.stream.onMessage(i=>{r(()=>++this.e_==1?this.E_(i):this.onNext(i))})}i_(){this.state=5,this.t_.Go(()=>N(this,null,function*(){this.state=0,this.start()}))}I_(e){return V("PersistentStream",`close with error: ${e}`),this.stream=null,this.close(4,e)}h_(e){return t=>{this.ui.enqueueAndForget(()=>this.Yo===e?t():(V("PersistentStream","stream callback skipped by getCloseGuardedDispatcher."),Promise.resolve()))}}},Np=class extends qu{constructor(e,t,r,i,s,o){super(e,"listen_stream_connection_backoff","listen_stream_idle","health_check_timeout",t,r,i,o),this.serializer=s}T_(e,t){return this.connection.Bo("Listen",e,t)}E_(e){return this.onNext(e)}onNext(e){this.t_.reset();let t=jb(this.serializer,e),r=function(s){if(!("targetChange"in s))return z.min();let o=s.targetChange;return o.targetIds&&o.targetIds.length?z.min():o.readTime?xe(o.readTime):z.min()}(e);return this.listener.d_(t,r)}A_(e){let t={};t.database=$f(this.serializer),t.addTarget=function(s,o){let l,u=o.target;if(l=yu(u)?{documents:II(s,u)}:{query:TI(s,u)._t},l.targetId=o.targetId,o.resumeToken.approximateByteSize()>0){l.resumeToken=gI(s,o.resumeToken);let c=Wf(s,o.expectedCount);c!==null&&(l.expectedCount=c)}else if(o.snapshotVersion.compareTo(z.min())>0){l.readTime=Gi(s,o.snapshotVersion.toTimestamp());let c=Wf(s,o.expectedCount);c!==null&&(l.expectedCount=c)}return l}(this.serializer,e);let r=Kb(this.serializer,e);r&&(t.labels=r),this.a_(t)}R_(e){let t={};t.database=$f(this.serializer),t.removeTarget=e,this.a_(t)}},Dp=class extends qu{constructor(e,t,r,i,s,o){super(e,"write_stream_connection_backoff","write_stream_idle","health_check_timeout",t,r,i,o),this.serializer=s}get V_(){return this.e_>0}start(){this.lastStreamToken=void 0,super.start()}l_(){this.V_&&this.m_([])}T_(e,t){return this.connection.Bo("Write",e,t)}E_(e){return G(!!e.streamToken),this.lastStreamToken=e.streamToken,G(!e.writeResults||e.writeResults.length===0),this.listener.f_()}onNext(e){G(!!e.streamToken),this.lastStreamToken=e.streamToken,this.t_.reset();let t=zb(e.writeResults,e.commitTime),r=xe(e.commitTime);return this.listener.g_(r,t)}p_(){let e={};e.database=$f(this.serializer),this.a_(e)}m_(e){let t={streamToken:this.lastStreamToken,writes:e.map(r=>Go(this.serializer,r))};this.a_(t)}};var kp=class extends class{}{constructor(e,t,r,i){super(),this.authCredentials=e,this.appCheckCredentials=t,this.connection=r,this.serializer=i,this.y_=!1}w_(){if(this.y_)throw new k(P.FAILED_PRECONDITION,"The client has already been terminated.")}Mo(e,t,r,i){return this.w_(),Promise.all([this.authCredentials.getToken(),this.appCheckCredentials.getToken()]).then(([s,o])=>this.connection.Mo(e,Qf(t,r),i,s,o)).catch(s=>{throw s.name==="FirebaseError"?(s.code===P.UNAUTHENTICATED&&(this.authCredentials.invalidateToken(),this.appCheckCredentials.invalidateToken()),s):new k(P.UNKNOWN,s.toString())})}Lo(e,t,r,i,s){return this.w_(),Promise.all([this.authCredentials.getToken(),this.appCheckCredentials.getToken()]).then(([o,l])=>this.connection.Lo(e,Qf(t,r),i,o,l,s)).catch(o=>{throw o.name==="FirebaseError"?(o.code===P.UNAUTHENTICATED&&(this.authCredentials.invalidateToken(),this.appCheckCredentials.invalidateToken()),o):new k(P.UNKNOWN,o.toString())})}terminate(){this.y_=!0,this.connection.terminate()}},Vp=class{constructor(e,t){this.asyncQueue=e,this.onlineStateHandler=t,this.state="Unknown",this.S_=0,this.b_=null,this.D_=!0}v_(){this.S_===0&&(this.C_("Unknown"),this.b_=this.asyncQueue.enqueueAfterDelay("online_state_timeout",1e4,()=>(this.b_=null,this.F_("Backend didn't respond within 10 seconds."),this.C_("Offline"),Promise.resolve())))}M_(e){this.state==="Online"?this.C_("Unknown"):(this.S_++,this.S_>=1&&(this.x_(),this.F_(`Connection failed 1 times. Most recent error: ${e.toString()}`),this.C_("Offline")))}set(e){this.x_(),this.S_=0,e==="Online"&&(this.D_=!1),this.C_(e)}C_(e){e!==this.state&&(this.state=e,this.onlineStateHandler(e))}F_(e){let t=`Could not reach Cloud Firestore backend. ${e}
This typically indicates that your device does not have a healthy Internet connection at the moment. The client will operate in offline mode until it is able to successfully connect to the backend.`;this.D_?(Re(t),this.D_=!1):V("OnlineStateTracker",t)}x_(){this.b_!==null&&(this.b_.cancel(),this.b_=null)}};var Fp=class{constructor(e,t,r,i,s){this.localStore=e,this.datastore=t,this.asyncQueue=r,this.remoteSyncer={},this.O_=[],this.N_=new Map,this.L_=new Set,this.B_=[],this.k_=s,this.k_._o(o=>{r.enqueueAndForget(()=>N(this,null,function*(){sr(this)&&(V("RemoteStore","Restarting streams for network reachability change."),yield function(u){return N(this,null,function*(){let c=M(u);c.L_.add(4),yield ts(c),c.q_.set("Unknown"),c.L_.delete(4),yield na(c)})}(this))}))}),this.q_=new Vp(r,i)}};function na(n){return N(this,null,function*(){if(sr(n))for(let e of n.B_)yield e(!0)})}function ts(n){return N(this,null,function*(){for(let e of n.B_)yield e(!1)})}function lc(n,e){let t=M(n);t.N_.has(e.targetId)||(t.N_.set(e.targetId,e),Rm(t)?bm(t):rs(t).r_()&&Am(t,e))}function Qi(n,e){let t=M(n),r=rs(t);t.N_.delete(e),r.r_()&&jI(t,e),t.N_.size===0&&(r.r_()?r.o_():sr(t)&&t.q_.set("Unknown"))}function Am(n,e){if(n.Q_.xe(e.targetId),e.resumeToken.approximateByteSize()>0||e.snapshotVersion.compareTo(z.min())>0){let t=n.remoteSyncer.getRemoteKeysForTarget(e.targetId).size;e=e.withExpectedCount(t)}rs(n).A_(e)}function jI(n,e){n.Q_.xe(e),rs(n).R_(e)}function bm(n){n.Q_=new zf({getRemoteKeysForTarget:e=>n.remoteSyncer.getRemoteKeysForTarget(e),ot:e=>n.N_.get(e)||null,tt:()=>n.datastore.serializer.databaseId}),rs(n).start(),n.q_.v_()}function Rm(n){return sr(n)&&!rs(n).n_()&&n.N_.size>0}function sr(n){return M(n).L_.size===0}function zI(n){n.Q_=void 0}function oR(n){return N(this,null,function*(){n.q_.set("Online")})}function aR(n){return N(this,null,function*(){n.N_.forEach((e,t)=>{Am(n,e)})})}function lR(n,e){return N(this,null,function*(){zI(n),Rm(n)?(n.q_.M_(e),bm(n)):n.q_.set("Unknown")})}function uR(n,e,t){return N(this,null,function*(){if(n.q_.set("Online"),e instanceof Iu&&e.state===2&&e.cause)try{yield function(i,s){return N(this,null,function*(){let o=s.cause;for(let l of s.targetIds)i.N_.has(l)&&(yield i.remoteSyncer.rejectListen(l,o),i.N_.delete(l),i.Q_.removeTarget(l))})}(n,e)}catch(r){V("RemoteStore","Failed to remove targets %s: %s ",e.targetIds.join(","),r),yield Gu(n,r)}else if(e instanceof Fi?n.Q_.Ke(e):e instanceof Eu?n.Q_.He(e):n.Q_.We(e),!t.isEqual(z.min()))try{let r=yield MI(n.localStore);t.compareTo(r)>=0&&(yield function(s,o){let l=s.Q_.rt(o);return l.targetChanges.forEach((u,c)=>{if(u.resumeToken.approximateByteSize()>0){let d=s.N_.get(c);d&&s.N_.set(c,d.withResumeToken(u.resumeToken,o))}}),l.targetMismatches.forEach((u,c)=>{let d=s.N_.get(u);if(!d)return;s.N_.set(u,d.withResumeToken(Ne.EMPTY_BYTE_STRING,d.snapshotVersion)),jI(s,u);let p=new ji(d.target,u,c,d.sequenceNumber);Am(s,p)}),s.remoteSyncer.applyRemoteEvent(l)}(n,t))}catch(r){V("RemoteStore","Failed to raise snapshot:",r),yield Gu(n,r)}})}function Gu(n,e,t){return N(this,null,function*(){if(!ir(e))throw e;n.L_.add(1),yield ts(n),n.q_.set("Offline"),t||(t=()=>MI(n.localStore)),n.asyncQueue.enqueueRetryable(()=>N(this,null,function*(){V("RemoteStore","Retrying IndexedDB access"),yield t(),n.L_.delete(1),yield na(n)}))})}function KI(n,e){return e().catch(t=>Gu(n,t,e))}function ns(n){return N(this,null,function*(){let e=M(n),t=nr(e),r=e.O_.length>0?e.O_[e.O_.length-1].batchId:-1;for(;cR(e);)try{let i=yield nR(e.localStore,r);if(i===null){e.O_.length===0&&t.o_();break}r=i.batchId,hR(e,i)}catch(i){yield Gu(e,i)}WI(e)&&QI(e)})}function cR(n){return sr(n)&&n.O_.length<10}function hR(n,e){n.O_.push(e);let t=nr(n);t.r_()&&t.V_&&t.m_(e.mutations)}function WI(n){return sr(n)&&!nr(n).n_()&&n.O_.length>0}function QI(n){nr(n).start()}function dR(n){return N(this,null,function*(){nr(n).p_()})}function fR(n){return N(this,null,function*(){let e=nr(n);for(let t of n.O_)e.m_(t.mutations)})}function pR(n,e,t){return N(this,null,function*(){let r=n.O_.shift(),i=qf.from(r,e,t);yield KI(n,()=>n.remoteSyncer.applySuccessfulWrite(i)),yield ns(n)})}function mR(n,e){return N(this,null,function*(){e&&nr(n).V_&&(yield function(r,i){return N(this,null,function*(){if(function(o){return fI(o)&&o!==P.ABORTED}(i.code)){let s=r.O_.shift();nr(r).s_(),yield KI(r,()=>r.remoteSyncer.rejectFailedWrite(s.batchId,i)),yield ns(r)}})}(n,e)),WI(n)&&QI(n)})}function yE(n,e){return N(this,null,function*(){let t=M(n);t.asyncQueue.verifyOperationInProgress(),V("RemoteStore","RemoteStore received new credentials");let r=sr(t);t.L_.add(3),yield ts(t),r&&t.q_.set("Unknown"),yield t.remoteSyncer.handleCredentialChange(e),t.L_.delete(3),yield na(t)})}function Op(n,e){return N(this,null,function*(){let t=M(n);e?(t.L_.delete(2),yield na(t)):e||(t.L_.add(2),yield ts(t),t.q_.set("Unknown"))})}function rs(n){return n.K_||(n.K_=function(t,r,i){let s=M(t);return s.w_(),new Np(r,s.connection,s.authCredentials,s.appCheckCredentials,s.serializer,i)}(n.datastore,n.asyncQueue,{Eo:oR.bind(null,n),Ro:aR.bind(null,n),mo:lR.bind(null,n),d_:uR.bind(null,n)}),n.B_.push(e=>N(this,null,function*(){e?(n.K_.s_(),Rm(n)?bm(n):n.q_.set("Unknown")):(yield n.K_.stop(),zI(n))}))),n.K_}function nr(n){return n.U_||(n.U_=function(t,r,i){let s=M(t);return s.w_(),new Dp(r,s.connection,s.authCredentials,s.appCheckCredentials,s.serializer,i)}(n.datastore,n.asyncQueue,{Eo:()=>Promise.resolve(),Ro:dR.bind(null,n),mo:mR.bind(null,n),f_:fR.bind(null,n),g_:pR.bind(null,n)}),n.B_.push(e=>N(this,null,function*(){e?(n.U_.s_(),yield ns(n)):(yield n.U_.stop(),n.O_.length>0&&(V("RemoteStore",`Stopping write stream with ${n.O_.length} pending writes`),n.O_=[]))}))),n.U_}var Mp=class n{constructor(e,t,r,i,s){this.asyncQueue=e,this.timerId=t,this.targetTimeMs=r,this.op=i,this.removalCallback=s,this.deferred=new Be,this.then=this.deferred.promise.then.bind(this.deferred.promise),this.deferred.promise.catch(o=>{})}get promise(){return this.deferred.promise}static createAndSchedule(e,t,r,i,s){let o=Date.now()+r,l=new n(e,t,o,i,s);return l.start(r),l}start(e){this.timerHandle=setTimeout(()=>this.handleDelayElapsed(),e)}skipDelay(){return this.handleDelayElapsed()}cancel(e){this.timerHandle!==null&&(this.clearTimeout(),this.deferred.reject(new k(P.CANCELLED,"Operation cancelled"+(e?": "+e:""))))}handleDelayElapsed(){this.asyncQueue.enqueueAndForget(()=>this.timerHandle!==null?(this.clearTimeout(),this.op().then(e=>this.deferred.resolve(e))):Promise.resolve())}clearTimeout(){this.timerHandle!==null&&(this.removalCallback(this),clearTimeout(this.timerHandle),this.timerHandle=null)}};function is(n,e){if(Re("AsyncQueue",`${e}: ${n}`),ir(n))return new k(P.UNAVAILABLE,`${e}: ${n}`);throw n}var ju=class n{constructor(e){this.comparator=e?(t,r)=>e(t,r)||L.comparator(t.key,r.key):(t,r)=>L.comparator(t.key,r.key),this.keyedMap=To(),this.sortedSet=new we(this.comparator)}static emptySet(e){return new n(e.comparator)}has(e){return this.keyedMap.get(e)!=null}get(e){return this.keyedMap.get(e)}first(){return this.sortedSet.minKey()}last(){return this.sortedSet.maxKey()}isEmpty(){return this.sortedSet.isEmpty()}indexOf(e){let t=this.keyedMap.get(e);return t?this.sortedSet.indexOf(t):-1}get size(){return this.sortedSet.size}forEach(e){this.sortedSet.inorderTraversal((t,r)=>(e(t),!1))}add(e){let t=this.delete(e.key);return t.copy(t.keyedMap.insert(e.key,e),t.sortedSet.insert(e,null))}delete(e){let t=this.get(e);return t?this.copy(this.keyedMap.remove(e),this.sortedSet.remove(t)):this}isEqual(e){if(!(e instanceof n)||this.size!==e.size)return!1;let t=this.sortedSet.getIterator(),r=e.sortedSet.getIterator();for(;t.hasNext();){let i=t.getNext().key,s=r.getNext().key;if(!i.isEqual(s))return!1}return!0}toString(){let e=[];return this.forEach(t=>{e.push(t.toString())}),e.length===0?"DocumentSet ()":`DocumentSet (
  `+e.join(`  
`)+`
)`}copy(e,t){let r=new n;return r.comparator=this.comparator,r.keyedMap=e,r.sortedSet=t,r}};var zu=class{constructor(){this.W_=new we(L.comparator)}track(e){let t=e.doc.key,r=this.W_.get(t);r?e.type!==0&&r.type===3?this.W_=this.W_.insert(t,e):e.type===3&&r.type!==1?this.W_=this.W_.insert(t,{type:r.type,doc:e.doc}):e.type===2&&r.type===2?this.W_=this.W_.insert(t,{type:2,doc:e.doc}):e.type===2&&r.type===0?this.W_=this.W_.insert(t,{type:0,doc:e.doc}):e.type===1&&r.type===0?this.W_=this.W_.remove(t):e.type===1&&r.type===2?this.W_=this.W_.insert(t,{type:1,doc:r.doc}):e.type===0&&r.type===1?this.W_=this.W_.insert(t,{type:2,doc:e.doc}):U():this.W_=this.W_.insert(t,e)}G_(){let e=[];return this.W_.inorderTraversal((t,r)=>{e.push(r)}),e}},$i=class n{constructor(e,t,r,i,s,o,l,u,c){this.query=e,this.docs=t,this.oldDocs=r,this.docChanges=i,this.mutatedKeys=s,this.fromCache=o,this.syncStateChanged=l,this.excludesMetadataChanges=u,this.hasCachedResults=c}static fromInitialDocuments(e,t,r,i,s){let o=[];return t.forEach(l=>{o.push({type:0,doc:l})}),new n(e,t,ju.emptySet(t),o,r,i,!0,!1,s)}get hasPendingWrites(){return!this.mutatedKeys.isEmpty()}isEqual(e){if(!(this.fromCache===e.fromCache&&this.hasCachedResults===e.hasCachedResults&&this.syncStateChanged===e.syncStateChanged&&this.mutatedKeys.isEqual(e.mutatedKeys)&&Zo(this.query,e.query)&&this.docs.isEqual(e.docs)&&this.oldDocs.isEqual(e.oldDocs)))return!1;let t=this.docChanges,r=e.docChanges;if(t.length!==r.length)return!1;for(let i=0;i<t.length;i++)if(t[i].type!==r[i].type||!t[i].doc.isEqual(r[i].doc))return!1;return!0}};var Lp=class{constructor(){this.z_=void 0,this.j_=[]}H_(){return this.j_.some(e=>e.J_())}},Up=class{constructor(){this.queries=vE(),this.onlineState="Unknown",this.Y_=new Set}terminate(){(function(t,r){let i=M(t),s=i.queries;i.queries=vE(),s.forEach((o,l)=>{for(let u of l.j_)u.onError(r)})})(this,new k(P.ABORTED,"Firestore shutting down"))}};function vE(){return new Zt(n=>ZE(n),Zo)}function Pm(n,e){return N(this,null,function*(){let t=M(n),r=3,i=e.query,s=t.queries.get(i);s?!s.H_()&&e.J_()&&(r=2):(s=new Lp,r=e.J_()?0:1);try{switch(r){case 0:s.z_=yield t.onListen(i,!0);break;case 1:s.z_=yield t.onListen(i,!1);break;case 2:yield t.onFirstRemoteStoreListen(i)}}catch(o){let l=is(o,`Initialization of query '${Ri(e.query)}' failed`);return void e.onError(l)}t.queries.set(i,s),s.j_.push(e),e.Z_(t.onlineState),s.z_&&e.X_(s.z_)&&Nm(t)})}function xm(n,e){return N(this,null,function*(){let t=M(n),r=e.query,i=3,s=t.queries.get(r);if(s){let o=s.j_.indexOf(e);o>=0&&(s.j_.splice(o,1),s.j_.length===0?i=e.J_()?0:1:!s.H_()&&e.J_()&&(i=2))}switch(i){case 0:return t.queries.delete(r),t.onUnlisten(r,!0);case 1:return t.queries.delete(r),t.onUnlisten(r,!1);case 2:return t.onLastRemoteStoreUnlisten(r);default:return}})}function gR(n,e){let t=M(n),r=!1;for(let i of e){let s=i.query,o=t.queries.get(s);if(o){for(let l of o.j_)l.X_(i)&&(r=!0);o.z_=i}}r&&Nm(t)}function _R(n,e,t){let r=M(n),i=r.queries.get(e);if(i)for(let s of i.j_)s.onError(t);r.queries.delete(e)}function Nm(n){n.Y_.forEach(e=>{e.next()})}var Bp,wE;(wE=Bp||(Bp={})).ea="default",wE.Cache="cache";var Qo=class{constructor(e,t,r){this.query=e,this.ta=t,this.na=!1,this.ra=null,this.onlineState="Unknown",this.options=r||{}}X_(e){if(!this.options.includeMetadataChanges){let r=[];for(let i of e.docChanges)i.type!==3&&r.push(i);e=new $i(e.query,e.docs,e.oldDocs,r,e.mutatedKeys,e.fromCache,e.syncStateChanged,!0,e.hasCachedResults)}let t=!1;return this.na?this.ia(e)&&(this.ta.next(e),t=!0):this.sa(e,this.onlineState)&&(this.oa(e),t=!0),this.ra=e,t}onError(e){this.ta.error(e)}Z_(e){this.onlineState=e;let t=!1;return this.ra&&!this.na&&this.sa(this.ra,e)&&(this.oa(this.ra),t=!0),t}sa(e,t){if(!e.fromCache||!this.J_())return!0;let r=t!=="Offline";return(!this.options._a||!r)&&(!e.docs.isEmpty()||e.hasCachedResults||t==="Offline")}ia(e){if(e.docChanges.length>0)return!0;let t=this.ra&&this.ra.hasPendingWrites!==e.hasPendingWrites;return!(!e.syncStateChanged&&!t)&&this.options.includeMetadataChanges===!0}oa(e){e=$i.fromInitialDocuments(e.query,e.docs,e.mutatedKeys,e.fromCache,e.hasCachedResults),this.na=!0,this.ta.next(e)}J_(){return this.options.source!==Bp.Cache}};var qp=class{constructor(e,t){this.aa=e,this.byteLength=t}ua(){return"metadata"in this.aa}};var Ku=class{constructor(e){this.serializer=e}Es(e){return Ht(this.serializer,e)}ds(e){return e.metadata.exists?EI(this.serializer,e.document,!1):Me.newNoDocument(this.Es(e.metadata.name),this.As(e.metadata.readTime))}As(e){return xe(e)}},Gp=class{constructor(e,t,r){this.ca=e,this.localStore=t,this.serializer=r,this.queries=[],this.documents=[],this.collectionGroups=new Set,this.progress=$I(e)}la(e){this.progress.bytesLoaded+=e.byteLength;let t=this.progress.documentsLoaded;if(e.aa.namedQuery)this.queries.push(e.aa.namedQuery);else if(e.aa.documentMetadata){this.documents.push({metadata:e.aa.documentMetadata}),e.aa.documentMetadata.exists||++t;let r=oe.fromString(e.aa.documentMetadata.name);this.collectionGroups.add(r.get(r.length-2))}else e.aa.document&&(this.documents[this.documents.length-1].document=e.aa.document,++t);return t!==this.progress.documentsLoaded?(this.progress.documentsLoaded=t,Object.assign({},this.progress)):null}ha(e){let t=new Map,r=new Ku(this.serializer);for(let i of e)if(i.metadata.queries){let s=r.Es(i.metadata.name);for(let o of i.metadata.queries){let l=(t.get(o)||H()).add(s);t.set(o,l)}}return t}complete(){return N(this,null,function*(){let e=yield rR(this.localStore,new Ku(this.serializer),this.documents,this.ca.id),t=this.ha(this.documents);for(let r of this.queries)yield iR(this.localStore,r,t.get(r.name));return this.progress.taskState="Success",{progress:this.progress,Pa:this.collectionGroups,Ia:e}})}};function $I(n){return{taskState:"Running",documentsLoaded:0,bytesLoaded:0,totalDocuments:n.totalDocuments,totalBytes:n.totalBytes}}var Wu=class{constructor(e){this.key=e}},Qu=class{constructor(e){this.key=e}},$u=class{constructor(e,t){this.query=e,this.Ta=t,this.Ea=null,this.hasCachedResults=!1,this.current=!1,this.da=H(),this.mutatedKeys=H(),this.Aa=tI(e),this.Ra=new ju(this.Aa)}get Va(){return this.Ta}ma(e,t){let r=t?t.fa:new zu,i=t?t.Ra:this.Ra,s=t?t.mutatedKeys:this.mutatedKeys,o=i,l=!1,u=this.query.limitType==="F"&&i.size===this.query.limit?i.last():null,c=this.query.limitType==="L"&&i.size===this.query.limit?i.first():null;if(e.inorderTraversal((d,p)=>{let m=i.get(d),y=ea(this.query,p)?p:null,C=!!m&&this.mutatedKeys.has(m.key),x=!!y&&(y.hasLocalMutations||this.mutatedKeys.has(y.key)&&y.hasCommittedMutations),D=!1;m&&y?m.data.isEqual(y.data)?C!==x&&(r.track({type:3,doc:y}),D=!0):this.ga(m,y)||(r.track({type:2,doc:y}),D=!0,(u&&this.Aa(y,u)>0||c&&this.Aa(y,c)<0)&&(l=!0)):!m&&y?(r.track({type:0,doc:y}),D=!0):m&&!y&&(r.track({type:1,doc:m}),D=!0,(u||c)&&(l=!0)),D&&(y?(o=o.add(y),s=x?s.add(d):s.delete(d)):(o=o.delete(d),s=s.delete(d)))}),this.query.limit!==null)for(;o.size>this.query.limit;){let d=this.query.limitType==="F"?o.last():o.first();o=o.delete(d.key),s=s.delete(d.key),r.track({type:1,doc:d})}return{Ra:o,fa:r,ns:l,mutatedKeys:s}}ga(e,t){return e.hasLocalMutations&&t.hasCommittedMutations&&!t.hasLocalMutations}applyChanges(e,t,r,i){let s=this.Ra;this.Ra=e.Ra,this.mutatedKeys=e.mutatedKeys;let o=e.fa.G_();o.sort((d,p)=>function(y,C){let x=D=>{switch(D){case 0:return 1;case 2:case 3:return 2;case 1:return 0;default:return U()}};return x(y)-x(C)}(d.type,p.type)||this.Aa(d.doc,p.doc)),this.pa(r),i=i!=null&&i;let l=t&&!i?this.ya():[],u=this.da.size===0&&this.current&&!i?1:0,c=u!==this.Ea;return this.Ea=u,o.length!==0||c?{snapshot:new $i(this.query,e.Ra,s,o,e.mutatedKeys,u===0,c,!1,!!r&&r.resumeToken.approximateByteSize()>0),wa:l}:{wa:l}}Z_(e){return this.current&&e==="Offline"?(this.current=!1,this.applyChanges({Ra:this.Ra,fa:new zu,mutatedKeys:this.mutatedKeys,ns:!1},!1)):{wa:[]}}Sa(e){return!this.Ta.has(e)&&!!this.Ra.has(e)&&!this.Ra.get(e).hasLocalMutations}pa(e){e&&(e.addedDocuments.forEach(t=>this.Ta=this.Ta.add(t)),e.modifiedDocuments.forEach(t=>{}),e.removedDocuments.forEach(t=>this.Ta=this.Ta.delete(t)),this.current=e.current)}ya(){if(!this.current)return[];let e=this.da;this.da=H(),this.Ra.forEach(r=>{this.Sa(r.key)&&(this.da=this.da.add(r.key))});let t=[];return e.forEach(r=>{this.da.has(r)||t.push(new Qu(r))}),this.da.forEach(r=>{e.has(r)||t.push(new Wu(r))}),t}ba(e){this.Ta=e.Ts,this.da=H();let t=this.ma(e.documents);return this.applyChanges(t,!0)}Da(){return $i.fromInitialDocuments(this.query,this.Ra,this.mutatedKeys,this.Ea===0,this.hasCachedResults)}},jp=class{constructor(e,t,r){this.query=e,this.targetId=t,this.view=r}},zp=class{constructor(e){this.key=e,this.va=!1}},Kp=class{constructor(e,t,r,i,s,o){this.localStore=e,this.remoteStore=t,this.eventManager=r,this.sharedClientState=i,this.currentUser=s,this.maxConcurrentLimboResolutions=o,this.Ca={},this.Fa=new Zt(l=>ZE(l),Zo),this.Ma=new Map,this.xa=new Set,this.Oa=new we(L.comparator),this.Na=new Map,this.La=new zo,this.Ba={},this.ka=new Map,this.qa=zi.kn(),this.onlineState="Unknown",this.Qa=void 0}get isPrimaryClient(){return this.Qa===!0}};function yR(n,e,t=!0){return N(this,null,function*(){let r=uc(n),i,s=r.Fa.get(e);return s?(r.sharedClientState.addLocalQueryTarget(s.targetId),i=s.view.Da()):i=yield HI(r,e,t,!0),i})}function vR(n,e){return N(this,null,function*(){let t=uc(n);yield HI(t,e,!0,!1)})}function HI(n,e,t,r){return N(this,null,function*(){let i=yield Ki(n.localStore,lt(e)),s=i.targetId,o=n.sharedClientState.addLocalQueryTarget(s,t),l;return r&&(l=yield Dm(n,e,s,o==="current",i.resumeToken)),n.isPrimaryClient&&t&&lc(n.remoteStore,i),l})}function Dm(n,e,t,r,i){return N(this,null,function*(){n.Ka=(p,m,y)=>function(x,D,q,j){return N(this,null,function*(){let B=D.view.ma(q);B.ns&&(B=yield Ou(x.localStore,D.query,!1).then(({documents:E})=>D.view.ma(E,B)));let Y=j&&j.targetChanges.get(D.targetId),re=j&&j.targetMismatches.get(D.targetId)!=null,Q=D.view.applyChanges(B,x.isPrimaryClient,Y,re);return Wp(x,D.targetId,Q.wa),Q.snapshot})}(n,p,m,y);let s=yield Ou(n.localStore,e,!0),o=new $u(e,s.Ts),l=o.ma(s.documents),u=Bo.createSynthesizedTargetChangeForCurrentChange(t,r&&n.onlineState!=="Offline",i),c=o.applyChanges(l,n.isPrimaryClient,u);Wp(n,t,c.wa);let d=new jp(e,t,o);return n.Fa.set(e,d),n.Ma.has(t)?n.Ma.get(t).push(e):n.Ma.set(t,[e]),c.snapshot})}function wR(n,e,t){return N(this,null,function*(){let r=M(n),i=r.Fa.get(e),s=r.Ma.get(i.targetId);if(s.length>1)return r.Ma.set(i.targetId,s.filter(o=>!Zo(o,e))),void r.Fa.delete(e);r.isPrimaryClient?(r.sharedClientState.removeLocalQueryTarget(i.targetId),r.sharedClientState.isActiveQueryTarget(i.targetId)||(yield Wi(r.localStore,i.targetId,!1).then(()=>{r.sharedClientState.clearQueryState(i.targetId),t&&Qi(r.remoteStore,i.targetId),Hi(r,i.targetId)}).catch(rr))):(Hi(r,i.targetId),yield Wi(r.localStore,i.targetId,!0))})}function ER(n,e){return N(this,null,function*(){let t=M(n),r=t.Fa.get(e),i=t.Ma.get(r.targetId);t.isPrimaryClient&&i.length===1&&(t.sharedClientState.removeLocalQueryTarget(r.targetId),Qi(t.remoteStore,r.targetId))})}function IR(n,e,t){return N(this,null,function*(){let r=Om(n);try{let i=yield function(o,l){let u=M(o),c=Se.now(),d=l.reduce((y,C)=>y.add(C.key),H()),p,m;return u.persistence.runTransaction("Locally write mutations","readwrite",y=>{let C=ht(),x=H();return u.cs.getEntries(y,d).next(D=>{C=D,C.forEach((q,j)=>{j.isValidDocument()||(x=x.add(q))})}).next(()=>u.localDocuments.getOverlayedDocuments(y,C)).next(D=>{p=D;let q=[];for(let j of l){let B=Ob(j,p.get(j.key).overlayedDocument);B!=null&&q.push(new Vt(j.key,B,WE(B.value.mapValue),be.exists(!0)))}return u.mutationQueue.addMutationBatch(y,c,q,l)}).next(D=>{m=D;let q=D.applyToLocalDocumentSet(p,x);return u.documentOverlayCache.saveOverlays(y,D.batchId,q)})}).then(()=>({batchId:m.batchId,changes:rI(p)}))}(r.localStore,e);r.sharedClientState.addPendingMutation(i.batchId),function(o,l,u){let c=o.Ba[o.currentUser.toKey()];c||(c=new we(W)),c=c.insert(l,u),o.Ba[o.currentUser.toKey()]=c}(r,i.batchId,t),yield vn(r,i.changes),yield ns(r.remoteStore)}catch(i){let s=is(i,"Failed to persist write");t.reject(s)}})}function YI(n,e){return N(this,null,function*(){let t=M(n);try{let r=yield tR(t.localStore,e);e.targetChanges.forEach((i,s)=>{let o=t.Na.get(s);o&&(G(i.addedDocuments.size+i.modifiedDocuments.size+i.removedDocuments.size<=1),i.addedDocuments.size>0?o.va=!0:i.modifiedDocuments.size>0?G(o.va):i.removedDocuments.size>0&&(G(o.va),o.va=!1))}),yield vn(t,r,e)}catch(r){yield rr(r)}})}function EE(n,e,t){let r=M(n);if(r.isPrimaryClient&&t===0||!r.isPrimaryClient&&t===1){let i=[];r.Fa.forEach((s,o)=>{let l=o.view.Z_(e);l.snapshot&&i.push(l.snapshot)}),function(o,l){let u=M(o);u.onlineState=l;let c=!1;u.queries.forEach((d,p)=>{for(let m of p.j_)m.Z_(l)&&(c=!0)}),c&&Nm(u)}(r.eventManager,e),i.length&&r.Ca.d_(i),r.onlineState=e,r.isPrimaryClient&&r.sharedClientState.setOnlineState(e)}}function TR(n,e,t){return N(this,null,function*(){let r=M(n);r.sharedClientState.updateQueryState(e,"rejected",t);let i=r.Na.get(e),s=i&&i.key;if(s){let o=new we(L.comparator);o=o.insert(s,Me.newNoDocument(s,z.min()));let l=H().add(s),u=new Uo(z.min(),new Map,new we(W),o,l);yield YI(r,u),r.Oa=r.Oa.remove(s),r.Na.delete(e),Fm(r)}else yield Wi(r.localStore,e,!1).then(()=>Hi(r,e,t)).catch(rr)})}function SR(n,e){return N(this,null,function*(){let t=M(n),r=e.batch.batchId;try{let i=yield eR(t.localStore,e);Vm(t,r,null),km(t,r),t.sharedClientState.updateMutationState(r,"acknowledged"),yield vn(t,i)}catch(i){yield rr(i)}})}function CR(n,e,t){return N(this,null,function*(){let r=M(n);try{let i=yield function(o,l){let u=M(o);return u.persistence.runTransaction("Reject batch","readwrite-primary",c=>{let d;return u.mutationQueue.lookupMutationBatch(c,l).next(p=>(G(p!==null),d=p.keys(),u.mutationQueue.removeMutationBatch(c,p))).next(()=>u.mutationQueue.performConsistencyCheck(c)).next(()=>u.documentOverlayCache.removeOverlaysForBatchId(c,d,l)).next(()=>u.localDocuments.recalculateAndSaveOverlaysForDocumentKeys(c,d)).next(()=>u.localDocuments.getDocuments(c,d))})}(r.localStore,e);Vm(r,e,t),km(r,e),r.sharedClientState.updateMutationState(e,"rejected",t),yield vn(r,i)}catch(i){yield rr(i)}})}function AR(n,e){return N(this,null,function*(){let t=M(n);sr(t.remoteStore)||V("SyncEngine","The network is disabled. The task returned by 'awaitPendingWrites()' will not complete until the network is enabled.");try{let r=yield function(o){let l=M(o);return l.persistence.runTransaction("Get highest unacknowledged batch id","readonly",u=>l.mutationQueue.getHighestUnacknowledgedBatchId(u))}(t.localStore);if(r===-1)return void e.resolve();let i=t.ka.get(r)||[];i.push(e),t.ka.set(r,i)}catch(r){let i=is(r,"Initialization of waitForPendingWrites() operation failed");e.reject(i)}})}function km(n,e){(n.ka.get(e)||[]).forEach(t=>{t.resolve()}),n.ka.delete(e)}function Vm(n,e,t){let r=M(n),i=r.Ba[r.currentUser.toKey()];if(i){let s=i.get(e);s&&(t?s.reject(t):s.resolve(),i=i.remove(e)),r.Ba[r.currentUser.toKey()]=i}}function Hi(n,e,t=null){n.sharedClientState.removeLocalQueryTarget(e);for(let r of n.Ma.get(e))n.Fa.delete(r),t&&n.Ca.$a(r,t);n.Ma.delete(e),n.isPrimaryClient&&n.La.gr(e).forEach(r=>{n.La.containsKey(r)||JI(n,r)})}function JI(n,e){n.xa.delete(e.path.canonicalString());let t=n.Oa.get(e);t!==null&&(Qi(n.remoteStore,t),n.Oa=n.Oa.remove(e),n.Na.delete(t),Fm(n))}function Wp(n,e,t){for(let r of t)r instanceof Wu?(n.La.addReference(r.key,e),bR(n,r)):r instanceof Qu?(V("SyncEngine","Document no longer in limbo: "+r.key),n.La.removeReference(r.key,e),n.La.containsKey(r.key)||JI(n,r.key)):U()}function bR(n,e){let t=e.key,r=t.path.canonicalString();n.Oa.get(t)||n.xa.has(r)||(V("SyncEngine","New document in limbo: "+t),n.xa.add(r),Fm(n))}function Fm(n){for(;n.xa.size>0&&n.Oa.size<n.maxConcurrentLimboResolutions;){let e=n.xa.values().next().value;n.xa.delete(e);let t=new L(oe.fromString(e)),r=n.qa.next();n.Na.set(r,new zp(t)),n.Oa=n.Oa.insert(t,r),lc(n.remoteStore,new ji(lt(es(t.path)),r,"TargetPurposeLimboResolution",_t.oe))}}function vn(n,e,t){return N(this,null,function*(){let r=M(n),i=[],s=[],o=[];r.Fa.isEmpty()||(r.Fa.forEach((l,u)=>{o.push(r.Ka(u,e,t).then(c=>{var d;if((c||t)&&r.isPrimaryClient){let p=c?!c.fromCache:(d=t?.targetChanges.get(u.targetId))===null||d===void 0?void 0:d.current;r.sharedClientState.updateQueryState(u.targetId,p?"current":"not-current")}if(c){i.push(c);let p=Sp.Wi(u.targetId,c);s.push(p)}}))}),yield Promise.all(o),r.Ca.d_(i),yield function(u,c){return N(this,null,function*(){let d=M(u);try{yield d.persistence.runTransaction("notifyLocalViewChanges","readwrite",p=>b.forEach(c,m=>b.forEach(m.$i,y=>d.persistence.referenceDelegate.addReference(p,m.targetId,y)).next(()=>b.forEach(m.Ui,y=>d.persistence.referenceDelegate.removeReference(p,m.targetId,y)))))}catch(p){if(!ir(p))throw p;V("LocalStore","Failed to update sequence numbers: "+p)}for(let p of c){let m=p.targetId;if(!p.fromCache){let y=d.os.get(m),C=y.snapshotVersion,x=y.withLastLimboFreeSnapshotVersion(C);d.os=d.os.insert(m,x)}}})}(r.localStore,s))})}function RR(n,e){return N(this,null,function*(){let t=M(n);if(!t.currentUser.isEqual(e)){V("SyncEngine","User change. New user:",e.toKey());let r=yield OI(t.localStore,e);t.currentUser=e,function(s,o){s.ka.forEach(l=>{l.forEach(u=>{u.reject(new k(P.CANCELLED,o))})}),s.ka.clear()}(t,"'waitForPendingWrites' promise is rejected due to a user change."),t.sharedClientState.handleUserChange(e,r.removedBatchIds,r.addedBatchIds),yield vn(t,r.hs)}})}function PR(n,e){let t=M(n),r=t.Na.get(e);if(r&&r.va)return H().add(r.key);{let i=H(),s=t.Ma.get(e);if(!s)return i;for(let o of s){let l=t.Fa.get(o);i=i.unionWith(l.view.Va)}return i}}function xR(n,e){return N(this,null,function*(){let t=M(n),r=yield Ou(t.localStore,e.query,!0),i=e.view.ba(r);return t.isPrimaryClient&&Wp(t,e.targetId,i.wa),i})}function NR(n,e){return N(this,null,function*(){let t=M(n);return BI(t.localStore,e).then(r=>vn(t,r))})}function DR(n,e,t,r){return N(this,null,function*(){let i=M(n),s=yield function(l,u){let c=M(l),d=M(c.mutationQueue);return c.persistence.runTransaction("Lookup mutation documents","readonly",p=>d.Mn(p,u).next(m=>m?c.localDocuments.getDocuments(p,m):b.resolve(null)))}(i.localStore,e);s!==null?(t==="pending"?yield ns(i.remoteStore):t==="acknowledged"||t==="rejected"?(Vm(i,e,r||null),km(i,e),function(l,u){M(M(l).mutationQueue).On(u)}(i.localStore,e)):U(),yield vn(i,s)):V("SyncEngine","Cannot apply mutation batch with id: "+e)})}function kR(n,e){return N(this,null,function*(){let t=M(n);if(uc(t),Om(t),e===!0&&t.Qa!==!0){let r=t.sharedClientState.getAllActiveQueryTargets(),i=yield IE(t,r.toArray());t.Qa=!0,yield Op(t.remoteStore,!0);for(let s of i)lc(t.remoteStore,s)}else if(e===!1&&t.Qa!==!1){let r=[],i=Promise.resolve();t.Ma.forEach((s,o)=>{t.sharedClientState.isLocalQueryTarget(o)?r.push(o):i=i.then(()=>(Hi(t,o),Wi(t.localStore,o,!0))),Qi(t.remoteStore,o)}),yield i,yield IE(t,r),function(o){let l=M(o);l.Na.forEach((u,c)=>{Qi(l.remoteStore,c)}),l.La.pr(),l.Na=new Map,l.Oa=new we(L.comparator)}(t),t.Qa=!1,yield Op(t.remoteStore,!1)}})}function IE(n,e,t){return N(this,null,function*(){let r=M(n),i=[],s=[];for(let o of e){let l,u=r.Ma.get(o);if(u&&u.length!==0){l=yield Ki(r.localStore,lt(u[0]));for(let c of u){let d=r.Fa.get(c),p=yield xR(r,d);p.snapshot&&s.push(p.snapshot)}}else{let c=yield UI(r.localStore,o);l=yield Ki(r.localStore,c),yield Dm(r,XI(c),o,!1,l.resumeToken)}i.push(l)}return r.Ca.d_(s),i})}function XI(n){return XE(n.path,n.collectionGroup,n.orderBy,n.filters,n.limit,"F",n.startAt,n.endAt)}function VR(n){return function(t){return M(M(t).persistence).Qi()}(M(n).localStore)}function FR(n,e,t,r){return N(this,null,function*(){let i=M(n);if(i.Qa)return void V("SyncEngine","Ignoring unexpected query state notification.");let s=i.Ma.get(e);if(s&&s.length>0)switch(t){case"current":case"not-current":{let o=yield BI(i.localStore,eI(s[0])),l=Uo.createSynthesizedRemoteEventForCurrentChange(e,t==="current",Ne.EMPTY_BYTE_STRING);yield vn(i,o,l);break}case"rejected":yield Wi(i.localStore,e,!0),Hi(i,e,r);break;default:U()}})}function OR(n,e,t){return N(this,null,function*(){let r=uc(n);if(r.Qa){for(let i of e){if(r.Ma.has(i)&&r.sharedClientState.isActiveQueryTarget(i)){V("SyncEngine","Adding an already active target "+i);continue}let s=yield UI(r.localStore,i),o=yield Ki(r.localStore,s);yield Dm(r,XI(s),o.targetId,!1,o.resumeToken),lc(r.remoteStore,o)}for(let i of t)r.Ma.has(i)&&(yield Wi(r.localStore,i,!1).then(()=>{Qi(r.remoteStore,i),Hi(r,i)}).catch(rr))}})}function uc(n){let e=M(n);return e.remoteStore.remoteSyncer.applyRemoteEvent=YI.bind(null,e),e.remoteStore.remoteSyncer.getRemoteKeysForTarget=PR.bind(null,e),e.remoteStore.remoteSyncer.rejectListen=TR.bind(null,e),e.Ca.d_=gR.bind(null,e.eventManager),e.Ca.$a=_R.bind(null,e.eventManager),e}function Om(n){let e=M(n);return e.remoteStore.remoteSyncer.applySuccessfulWrite=SR.bind(null,e),e.remoteStore.remoteSyncer.rejectFailedWrite=CR.bind(null,e),e}function MR(n,e,t){let r=M(n);(function(s,o,l){return N(this,null,function*(){try{let u=yield o.getMetadata();if(yield function(y,C){let x=M(y),D=xe(C.createTime);return x.persistence.runTransaction("hasNewerBundle","readonly",q=>x.Gr.getBundleMetadata(q,C.id)).then(q=>!!q&&q.createTime.compareTo(D)>=0)}(s.localStore,u))return yield o.close(),l._completeWith(function(y){return{taskState:"Success",documentsLoaded:y.totalDocuments,bytesLoaded:y.totalBytes,totalDocuments:y.totalDocuments,totalBytes:y.totalBytes}}(u)),Promise.resolve(new Set);l._updateProgress($I(u));let c=new Gp(u,s.localStore,o.serializer),d=yield o.Ua();for(;d;){let m=yield c.la(d);m&&l._updateProgress(m),d=yield o.Ua()}let p=yield c.complete();return yield vn(s,p.Ia,void 0),yield function(y,C){let x=M(y);return x.persistence.runTransaction("Save bundle","readwrite",D=>x.Gr.saveBundleMetadata(D,C))}(s.localStore,u),l._completeWith(p.progress),Promise.resolve(p.Pa)}catch(u){return Dt("SyncEngine",`Loading bundle failed with ${u}`),l._failWith(u),Promise.resolve(new Set)}})})(r,e,t).then(i=>{r.sharedClientState.notifyBundleLoaded(i)})}var Qp=(()=>{class n{constructor(){this.kind="memory",this.synchronizeTabs=!1}initialize(t){return N(this,null,function*(){this.serializer=ta(t.databaseInfo.databaseId),this.sharedClientState=this.Wa(t),this.persistence=this.Ga(t),yield this.persistence.start(),this.localStore=this.za(t),this.gcScheduler=this.ja(t,this.localStore),this.indexBackfillerScheduler=this.Ha(t,this.localStore)})}ja(t,r){return null}Ha(t,r){return null}za(t){return FI(this.persistence,new Fu,t.initialUser,this.serializer)}Ga(t){return new ku(Vu.Zr,this.serializer)}Wa(t){return new Uu}terminate(){return N(this,null,function*(){var t,r;(t=this.gcScheduler)===null||t===void 0||t.stop(),(r=this.indexBackfillerScheduler)===null||r===void 0||r.stop(),this.sharedClientState.shutdown(),yield this.persistence.shutdown()})}}return n.provider={build:()=>new n},n})();var Hu=class n extends Qp{constructor(e,t,r){super(),this.Ja=e,this.cacheSizeBytes=t,this.forceOwnership=r,this.kind="persistent",this.synchronizeTabs=!1}initialize(e){return N(this,null,function*(){yield Jc(n.prototype,this,"initialize").call(this,e),yield this.Ja.initialize(this,e),yield Om(this.Ja.syncEngine),yield ns(this.Ja.remoteStore),yield this.persistence.yi(()=>(this.gcScheduler&&!this.gcScheduler.started&&this.gcScheduler.start(),this.indexBackfillerScheduler&&!this.indexBackfillerScheduler.started&&this.indexBackfillerScheduler.start(),Promise.resolve()))})}za(e){return FI(this.persistence,new Fu,e.initialUser,this.serializer)}ja(e,t){let r=this.persistence.referenceDelegate.garbageCollector;return new lp(r,e.asyncQueue,t)}Ha(e,t){let r=new Cf(t,this.persistence);return new Sf(e.asyncQueue,r)}Ga(e){let t=Cm(e.databaseInfo.databaseId,e.databaseInfo.persistenceKey),r=this.cacheSizeBytes!==void 0?Ct.withCacheSize(this.cacheSizeBytes):Ct.DEFAULT;return new Tp(this.synchronizeTabs,t,e.clientId,r,e.asyncQueue,GI(),lu(),this.serializer,this.sharedClientState,!!this.forceOwnership)}Wa(e){return new Uu}},$p=class n extends Hu{constructor(e,t){super(e,t,!1),this.Ja=e,this.cacheSizeBytes=t,this.synchronizeTabs=!0}initialize(e){return N(this,null,function*(){yield Jc(n.prototype,this,"initialize").call(this,e);let t=this.Ja.syncEngine;this.sharedClientState instanceof Po&&(this.sharedClientState.syncEngine={no:DR.bind(null,t),ro:FR.bind(null,t),io:OR.bind(null,t),Qi:VR.bind(null,t),eo:NR.bind(null,t)},yield this.sharedClientState.start()),yield this.persistence.yi(r=>N(this,null,function*(){yield kR(this.Ja.syncEngine,r),this.gcScheduler&&(r&&!this.gcScheduler.started?this.gcScheduler.start():r||this.gcScheduler.stop()),this.indexBackfillerScheduler&&(r&&!this.indexBackfillerScheduler.started?this.indexBackfillerScheduler.start():r||this.indexBackfillerScheduler.stop())}))})}Wa(e){let t=GI();if(!Po.D(t))throw new k(P.UNIMPLEMENTED,"IndexedDB persistence is only available on platforms that support LocalStorage.");let r=Cm(e.databaseInfo.databaseId,e.databaseInfo.persistenceKey);return new Po(t,e.asyncQueue,r,e.clientId,e.initialUser)}},Mm=(()=>{class n{initialize(t,r){return N(this,null,function*(){this.localStore||(this.localStore=t.localStore,this.sharedClientState=t.sharedClientState,this.datastore=this.createDatastore(r),this.remoteStore=this.createRemoteStore(r),this.eventManager=this.createEventManager(r),this.syncEngine=this.createSyncEngine(r,!t.synchronizeTabs),this.sharedClientState.onlineStateHandler=i=>EE(this.syncEngine,i,1),this.remoteStore.remoteSyncer.handleCredentialChange=RR.bind(null,this.syncEngine),yield Op(this.remoteStore,this.syncEngine.isPrimaryClient))})}createEventManager(t){return function(){return new Up}()}createDatastore(t){let r=ta(t.databaseInfo.databaseId),i=function(o){return new xp(o)}(t.databaseInfo);return function(o,l,u,c){return new kp(o,l,u,c)}(t.authCredentials,t.appCheckCredentials,i,r)}createRemoteStore(t){return function(i,s,o,l,u){return new Fp(i,s,o,l,u)}(this.localStore,this.datastore,t.asyncQueue,r=>EE(this.syncEngine,r,0),function(){return Bu.D()?new Bu:new Rp}())}createSyncEngine(t,r){return function(s,o,l,u,c,d,p){let m=new Kp(s,o,l,u,c,d);return p&&(m.Qa=!0),m}(this.localStore,this.remoteStore,this.eventManager,this.sharedClientState,t.initialUser,t.maxConcurrentLimboResolutions,r)}terminate(){return N(this,null,function*(){var t,r;yield function(s){return N(this,null,function*(){let o=M(s);V("RemoteStore","RemoteStore shutting down."),o.L_.add(5),yield ts(o),o.k_.shutdown(),o.q_.set("Unknown")})}(this.remoteStore),(t=this.datastore)===null||t===void 0||t.terminate(),(r=this.eventManager)===null||r===void 0||r.terminate()})}}return n.provider={build:()=>new n},n})();function TE(n,e=10240){let t=0;return{read(){return N(this,null,function*(){if(t<n.byteLength){let i={value:n.slice(t,t+e),done:!1};return t+=e,i}return{done:!0}})},cancel(){return N(this,null,function*(){})},releaseLock(){},closed:Promise.resolve()}}var Yi=class{constructor(e){this.observer=e,this.muted=!1}next(e){this.muted||this.observer.next&&this.Ya(this.observer.next,e)}error(e){this.muted||(this.observer.error?this.Ya(this.observer.error,e):Re("Uncaught Error in snapshot listener:",e.toString()))}Za(){this.muted=!0}Ya(e,t){setTimeout(()=>{this.muted||e(t)},0)}};var Hp=class{constructor(e,t){this.Xa=e,this.serializer=t,this.metadata=new Be,this.buffer=new Uint8Array,this.eu=function(){return new TextDecoder("utf-8")}(),this.tu().then(r=>{r&&r.ua()?this.metadata.resolve(r.aa.metadata):this.metadata.reject(new Error(`The first element of the bundle is not a metadata, it is
             ${JSON.stringify(r?.aa)}`))},r=>this.metadata.reject(r))}close(){return this.Xa.cancel()}getMetadata(){return N(this,null,function*(){return this.metadata.promise})}Ua(){return N(this,null,function*(){return yield this.getMetadata(),this.tu()})}tu(){return N(this,null,function*(){let e=yield this.nu();if(e===null)return null;let t=this.eu.decode(e),r=Number(t);isNaN(r)&&this.ru(`length string (${t}) is not valid number`);let i=yield this.iu(r);return new qp(JSON.parse(i),e.length+r)})}su(){return this.buffer.findIndex(e=>e===123)}nu(){return N(this,null,function*(){for(;this.su()<0&&!(yield this.ou()););if(this.buffer.length===0)return null;let e=this.su();e<0&&this.ru("Reached the end of bundle when a length string is expected.");let t=this.buffer.slice(0,e);return this.buffer=this.buffer.slice(e),t})}iu(e){return N(this,null,function*(){for(;this.buffer.length<e;)(yield this.ou())&&this.ru("Reached the end of bundle when more is expected.");let t=this.eu.decode(this.buffer.slice(0,e));return this.buffer=this.buffer.slice(e),t})}ru(e){throw this.Xa.cancel(),new Error(`Invalid bundle format: ${e}`)}ou(){return N(this,null,function*(){let e=yield this.Xa.read();if(!e.done){let t=new Uint8Array(this.buffer.length+e.value.length);t.set(this.buffer),t.set(e.value,this.buffer.length),this.buffer=t}return e.done})}};var Yp=class{constructor(e){this.datastore=e,this.readVersions=new Map,this.mutations=[],this.committed=!1,this.lastTransactionError=null,this.writtenDocs=new Set}lookup(e){return N(this,null,function*(){if(this.ensureCommitNotCalled(),this.mutations.length>0)throw this.lastTransactionError=new k(P.INVALID_ARGUMENT,"Firestore transactions require all reads to be executed before all writes."),this.lastTransactionError;let t=yield function(i,s){return N(this,null,function*(){let o=M(i),l={documents:s.map(p=>qo(o.serializer,p))},u=yield o.Lo("BatchGetDocuments",o.serializer.databaseId,oe.emptyPath(),l,s.length),c=new Map;u.forEach(p=>{let m=Gb(o.serializer,p);c.set(m.key.toString(),m)});let d=[];return s.forEach(p=>{let m=c.get(p.toString());G(!!m),d.push(m)}),d})}(this.datastore,e);return t.forEach(r=>this.recordVersion(r)),t})}set(e,t){this.write(t.toMutation(e,this.precondition(e))),this.writtenDocs.add(e.toString())}update(e,t){try{this.write(t.toMutation(e,this.preconditionForUpdate(e)))}catch(r){this.lastTransactionError=r}this.writtenDocs.add(e.toString())}delete(e){this.write(new tr(e,this.precondition(e))),this.writtenDocs.add(e.toString())}commit(){return N(this,null,function*(){if(this.ensureCommitNotCalled(),this.lastTransactionError)throw this.lastTransactionError;let e=this.readVersions;this.mutations.forEach(t=>{e.delete(t.key.toString())}),e.forEach((t,r)=>{let i=L.fromPath(r);this.mutations.push(new Oo(i,this.precondition(i)))}),yield function(r,i){return N(this,null,function*(){let s=M(r),o={writes:i.map(l=>Go(s.serializer,l))};yield s.Mo("Commit",s.serializer.databaseId,oe.emptyPath(),o)})}(this.datastore,this.mutations),this.committed=!0})}recordVersion(e){let t;if(e.isFoundDocument())t=e.version;else{if(!e.isNoDocument())throw U();t=z.min()}let r=this.readVersions.get(e.key.toString());if(r){if(!t.isEqual(r))throw new k(P.ABORTED,"Document version changed between two reads.")}else this.readVersions.set(e.key.toString(),t)}precondition(e){let t=this.readVersions.get(e.toString());return!this.writtenDocs.has(e.toString())&&t?t.isEqual(z.min())?be.exists(!1):be.updateTime(t):be.none()}preconditionForUpdate(e){let t=this.readVersions.get(e.toString());if(!this.writtenDocs.has(e.toString())&&t){if(t.isEqual(z.min()))throw new k(P.INVALID_ARGUMENT,"Can't update a document that doesn't exist.");return be.updateTime(t)}return be.exists(!0)}write(e){this.ensureCommitNotCalled(),this.mutations.push(e)}ensureCommitNotCalled(){}};var Jp=class{constructor(e,t,r,i,s){this.asyncQueue=e,this.datastore=t,this.options=r,this.updateFunction=i,this.deferred=s,this._u=r.maxAttempts,this.t_=new Wo(this.asyncQueue,"transaction_retry")}au(){this._u-=1,this.uu()}uu(){this.t_.Go(()=>N(this,null,function*(){let e=new Yp(this.datastore),t=this.cu(e);t&&t.then(r=>{this.asyncQueue.enqueueAndForget(()=>e.commit().then(()=>{this.deferred.resolve(r)}).catch(i=>{this.lu(i)}))}).catch(r=>{this.lu(r)})}))}cu(e){try{let t=this.updateFunction(e);return!Jo(t)&&t.catch&&t.then?t:(this.deferred.reject(Error("Transaction callback must return a Promise")),null)}catch(t){return this.deferred.reject(t),null}}lu(e){this._u>0&&this.hu(e)?(this._u-=1,this.asyncQueue.enqueueAndForget(()=>(this.uu(),Promise.resolve()))):this.deferred.reject(e)}hu(e){if(e.name==="FirebaseError"){let t=e.code;return t==="aborted"||t==="failed-precondition"||t==="already-exists"||!fI(t)}return!1}};var Xp=class{constructor(e,t,r,i,s){this.authCredentials=e,this.appCheckCredentials=t,this.asyncQueue=r,this.databaseInfo=i,this.user=Oe.UNAUTHENTICATED,this.clientId=cu.newId(),this.authCredentialListener=()=>Promise.resolve(),this.appCheckCredentialListener=()=>Promise.resolve(),this._uninitializedComponentsProvider=s,this.authCredentials.start(r,o=>N(this,null,function*(){V("FirestoreClient","Received user=",o.uid),yield this.authCredentialListener(o),this.user=o})),this.appCheckCredentials.start(r,o=>(V("FirestoreClient","Received new app check token=",o),this.appCheckCredentialListener(o,this.user)))}get configuration(){return{asyncQueue:this.asyncQueue,databaseInfo:this.databaseInfo,clientId:this.clientId,authCredentials:this.authCredentials,appCheckCredentials:this.appCheckCredentials,initialUser:this.user,maxConcurrentLimboResolutions:100}}setCredentialChangeListener(e){this.authCredentialListener=e}setAppCheckTokenChangeListener(e){this.appCheckCredentialListener=e}terminate(){this.asyncQueue.enterRestrictedMode();let e=new Be;return this.asyncQueue.enqueueAndForgetEvenWhileRestricted(()=>N(this,null,function*(){try{this._onlineComponents&&(yield this._onlineComponents.terminate()),this._offlineComponents&&(yield this._offlineComponents.terminate()),this.authCredentials.shutdown(),this.appCheckCredentials.shutdown(),e.resolve()}catch(t){let r=is(t,"Failed to shutdown persistence");e.reject(r)}})),e.promise}};function ff(n,e){return N(this,null,function*(){n.asyncQueue.verifyOperationInProgress(),V("FirestoreClient","Initializing OfflineComponentProvider");let t=n.configuration;yield e.initialize(t);let r=t.initialUser;n.setCredentialChangeListener(i=>N(this,null,function*(){r.isEqual(i)||(yield OI(e.localStore,i),r=i)})),e.persistence.setDatabaseDeletedListener(()=>n.terminate()),n._offlineComponents=e})}function SE(n,e){return N(this,null,function*(){n.asyncQueue.verifyOperationInProgress();let t=yield Lm(n);V("FirestoreClient","Initializing OnlineComponentProvider"),yield e.initialize(t,n.configuration),n.setCredentialChangeListener(r=>yE(e.remoteStore,r)),n.setAppCheckTokenChangeListener((r,i)=>yE(e.remoteStore,i)),n._onlineComponents=e})}function Lm(n){return N(this,null,function*(){if(!n._offlineComponents)if(n._uninitializedComponentsProvider){V("FirestoreClient","Using user provided OfflineComponentProvider");try{yield ff(n,n._uninitializedComponentsProvider._offline)}catch(e){let t=e;if(!function(i){return i.name==="FirebaseError"?i.code===P.FAILED_PRECONDITION||i.code===P.UNIMPLEMENTED:!(typeof DOMException<"u"&&i instanceof DOMException)||i.code===22||i.code===20||i.code===11}(t))throw t;Dt("Error using user provided cache. Falling back to memory cache: "+t),yield ff(n,new Qp)}}else V("FirestoreClient","Using default OfflineComponentProvider"),yield ff(n,new Qp);return n._offlineComponents})}function cc(n){return N(this,null,function*(){return n._onlineComponents||(n._uninitializedComponentsProvider?(V("FirestoreClient","Using user provided OnlineComponentProvider"),yield SE(n,n._uninitializedComponentsProvider._online)):(V("FirestoreClient","Using default OnlineComponentProvider"),yield SE(n,new Mm))),n._onlineComponents})}function ZI(n){return Lm(n).then(e=>e.persistence)}function Um(n){return Lm(n).then(e=>e.localStore)}function eT(n){return cc(n).then(e=>e.remoteStore)}function Bm(n){return cc(n).then(e=>e.syncEngine)}function LR(n){return cc(n).then(e=>e.datastore)}function Ji(n){return N(this,null,function*(){let e=yield cc(n),t=e.eventManager;return t.onListen=yR.bind(null,e.syncEngine),t.onUnlisten=wR.bind(null,e.syncEngine),t.onFirstRemoteStoreListen=vR.bind(null,e.syncEngine),t.onLastRemoteStoreUnlisten=ER.bind(null,e.syncEngine),t})}function UR(n){return n.asyncQueue.enqueue(()=>N(this,null,function*(){let e=yield ZI(n),t=yield eT(n);return e.setNetworkEnabled(!0),function(i){let s=M(i);return s.L_.delete(0),na(s)}(t)}))}function BR(n){return n.asyncQueue.enqueue(()=>N(this,null,function*(){let e=yield ZI(n),t=yield eT(n);return e.setNetworkEnabled(!1),function(i){return N(this,null,function*(){let s=M(i);s.L_.add(0),yield ts(s),s.q_.set("Offline")})}(t)}))}function qR(n,e){let t=new Be;return n.asyncQueue.enqueueAndForget(()=>N(this,null,function*(){return function(i,s,o){return N(this,null,function*(){try{let l=yield function(c,d){let p=M(c);return p.persistence.runTransaction("read document","readonly",m=>p.localDocuments.getDocument(m,d))}(i,s);l.isFoundDocument()?o.resolve(l):l.isNoDocument()?o.resolve(null):o.reject(new k(P.UNAVAILABLE,"Failed to get document from cache. (However, this document may exist on the server. Run again without setting 'source' in the GetOptions to attempt to retrieve the document from the server.)"))}catch(l){let u=is(l,`Failed to get document '${s} from cache`);o.reject(u)}})}(yield Um(n),e,t)})),t.promise}function tT(n,e,t={}){let r=new Be;return n.asyncQueue.enqueueAndForget(()=>N(this,null,function*(){return function(s,o,l,u,c){let d=new Yi({next:m=>{d.Za(),o.enqueueAndForget(()=>xm(s,p));let y=m.docs.has(l);!y&&m.fromCache?c.reject(new k(P.UNAVAILABLE,"Failed to get document because the client is offline.")):y&&m.fromCache&&u&&u.source==="server"?c.reject(new k(P.UNAVAILABLE,'Failed to get document from server. (However, this document does exist in the local cache. Run again without setting source to "server" to retrieve the cached document.)')):c.resolve(m)},error:m=>c.reject(m)}),p=new Qo(es(l.path),d,{includeMetadataChanges:!0,_a:!0});return Pm(s,p)}(yield Ji(n),n.asyncQueue,e,t,r)})),r.promise}function GR(n,e){let t=new Be;return n.asyncQueue.enqueueAndForget(()=>N(this,null,function*(){return function(i,s,o){return N(this,null,function*(){try{let l=yield Ou(i,s,!0),u=new $u(s,l.Ts),c=u.ma(l.documents),d=u.applyChanges(c,!1);o.resolve(d.snapshot)}catch(l){let u=is(l,`Failed to execute query '${s} against cache`);o.reject(u)}})}(yield Um(n),e,t)})),t.promise}function nT(n,e,t={}){let r=new Be;return n.asyncQueue.enqueueAndForget(()=>N(this,null,function*(){return function(s,o,l,u,c){let d=new Yi({next:m=>{d.Za(),o.enqueueAndForget(()=>xm(s,p)),m.fromCache&&u.source==="server"?c.reject(new k(P.UNAVAILABLE,'Failed to get documents from server. (However, these documents may exist in the local cache. Run again without setting source to "server" to retrieve the cached documents.)')):c.resolve(m)},error:m=>c.reject(m)}),p=new Qo(l,d,{includeMetadataChanges:!0,_a:!0});return Pm(s,p)}(yield Ji(n),n.asyncQueue,e,t,r)})),r.promise}function jR(n,e){let t=new Yi(e);return n.asyncQueue.enqueueAndForget(()=>N(this,null,function*(){return function(i,s){M(i).Y_.add(s),s.next()}(yield Ji(n),t)})),()=>{t.Za(),n.asyncQueue.enqueueAndForget(()=>N(this,null,function*(){return function(i,s){M(i).Y_.delete(s)}(yield Ji(n),t)}))}}function zR(n,e,t,r){let i=function(o,l){let u;return u=typeof o=="string"?mI().encode(o):o,function(d,p){return new Hp(d,p)}(function(d,p){if(d instanceof Uint8Array)return TE(d,p);if(d instanceof ArrayBuffer)return TE(new Uint8Array(d),p);if(d instanceof ReadableStream)return d.getReader();throw new Error("Source of `toByteStreamReader` has to be a ArrayBuffer or ReadableStream")}(u),l)}(t,ta(e));n.asyncQueue.enqueueAndForget(()=>N(this,null,function*(){MR(yield Bm(n),i,r)}))}function KR(n,e){return n.asyncQueue.enqueue(()=>N(this,null,function*(){return function(r,i){let s=M(r);return s.persistence.runTransaction("Get named query","readonly",o=>s.Gr.getNamedQuery(o,i))}(yield Um(n),e)}))}function rT(n){let e={};return n.timeoutSeconds!==void 0&&(e.timeoutSeconds=n.timeoutSeconds),e}var CE=new Map;function qm(n,e,t){if(!t)throw new k(P.INVALID_ARGUMENT,`Function ${n}() cannot be called with an empty ${e}.`)}function Gm(n,e,t,r){if(e===!0&&r===!0)throw new k(P.INVALID_ARGUMENT,`${n} and ${t} cannot be used together.`)}function AE(n){if(!L.isDocumentKey(n))throw new k(P.INVALID_ARGUMENT,`Invalid document reference. Document references must have an even number of segments, but ${n} has ${n.length}.`)}function bE(n){if(L.isDocumentKey(n))throw new k(P.INVALID_ARGUMENT,`Invalid collection reference. Collection references must have an odd number of segments, but ${n} has ${n.length}.`)}function hc(n){if(n===void 0)return"undefined";if(n===null)return"null";if(typeof n=="string")return n.length>20&&(n=`${n.substring(0,20)}...`),JSON.stringify(n);if(typeof n=="number"||typeof n=="boolean")return""+n;if(typeof n=="object"){if(n instanceof Array)return"an array";{let e=function(r){return r.constructor?r.constructor.name:null}(n);return e?`a custom ${e} object`:"an object"}}return typeof n=="function"?"a function":U()}function ae(n,e){if("_delegate"in n&&(n=n._delegate),!(n instanceof e)){if(e.name===n.constructor.name)throw new k(P.INVALID_ARGUMENT,"Type does not match the expected instance. Did you pass a reference from a different Firestore SDK?");{let t=hc(n);throw new k(P.INVALID_ARGUMENT,`Expected type '${e.name}', but it was: ${t}`)}}return n}function iT(n,e){if(e<=0)throw new k(P.INVALID_ARGUMENT,`Function ${n}() requires a positive number, but it was: ${e}.`)}var Yu=class{constructor(e){var t,r;if(e.host===void 0){if(e.ssl!==void 0)throw new k(P.INVALID_ARGUMENT,"Can't provide ssl option if host option is not set");this.host="firestore.googleapis.com",this.ssl=!0}else this.host=e.host,this.ssl=(t=e.ssl)===null||t===void 0||t;if(this.credentials=e.credentials,this.ignoreUndefinedProperties=!!e.ignoreUndefinedProperties,this.localCache=e.localCache,e.cacheSizeBytes===void 0)this.cacheSizeBytes=41943040;else{if(e.cacheSizeBytes!==-1&&e.cacheSizeBytes<1048576)throw new k(P.INVALID_ARGUMENT,"cacheSizeBytes must be at least 1048576");this.cacheSizeBytes=e.cacheSizeBytes}Gm("experimentalForceLongPolling",e.experimentalForceLongPolling,"experimentalAutoDetectLongPolling",e.experimentalAutoDetectLongPolling),this.experimentalForceLongPolling=!!e.experimentalForceLongPolling,this.experimentalForceLongPolling?this.experimentalAutoDetectLongPolling=!1:e.experimentalAutoDetectLongPolling===void 0?this.experimentalAutoDetectLongPolling=!0:this.experimentalAutoDetectLongPolling=!!e.experimentalAutoDetectLongPolling,this.experimentalLongPollingOptions=rT((r=e.experimentalLongPollingOptions)!==null&&r!==void 0?r:{}),function(s){if(s.timeoutSeconds!==void 0){if(isNaN(s.timeoutSeconds))throw new k(P.INVALID_ARGUMENT,`invalid long polling timeout: ${s.timeoutSeconds} (must not be NaN)`);if(s.timeoutSeconds<5)throw new k(P.INVALID_ARGUMENT,`invalid long polling timeout: ${s.timeoutSeconds} (minimum allowed value is 5)`);if(s.timeoutSeconds>30)throw new k(P.INVALID_ARGUMENT,`invalid long polling timeout: ${s.timeoutSeconds} (maximum allowed value is 30)`)}}(this.experimentalLongPollingOptions),this.useFetchStreams=!!e.useFetchStreams}isEqual(e){return this.host===e.host&&this.ssl===e.ssl&&this.credentials===e.credentials&&this.cacheSizeBytes===e.cacheSizeBytes&&this.experimentalForceLongPolling===e.experimentalForceLongPolling&&this.experimentalAutoDetectLongPolling===e.experimentalAutoDetectLongPolling&&function(r,i){return r.timeoutSeconds===i.timeoutSeconds}(this.experimentalLongPollingOptions,e.experimentalLongPollingOptions)&&this.ignoreUndefinedProperties===e.ignoreUndefinedProperties&&this.useFetchStreams===e.useFetchStreams}},Ur=class{constructor(e,t,r,i){this._authCredentials=e,this._appCheckCredentials=t,this._databaseId=r,this._app=i,this.type="firestore-lite",this._persistenceKey="(lite)",this._settings=new Yu({}),this._settingsFrozen=!1,this._terminateTask="notTerminated"}get app(){if(!this._app)throw new k(P.FAILED_PRECONDITION,"Firestore was not initialized using the Firebase SDK. 'app' is not available");return this._app}get _initialized(){return this._settingsFrozen}get _terminated(){return this._terminateTask!=="notTerminated"}_setSettings(e){if(this._settingsFrozen)throw new k(P.FAILED_PRECONDITION,"Firestore has already been started and its settings can no longer be changed. You can only modify settings before calling any other methods on a Firestore object.");this._settings=new Yu(e),e.credentials!==void 0&&(this._authCredentials=function(r){if(!r)return new pf;switch(r.type){case"firstParty":return new yf(r.sessionIndex||"0",r.iamToken||null,r.authTokenFactory||null);case"provider":return r.client;default:throw new k(P.INVALID_ARGUMENT,"makeAuthCredentialsProvider failed due to invalid credential type")}}(e.credentials))}_getSettings(){return this._settings}_freezeSettings(){return this._settingsFrozen=!0,this._settings}_delete(){return this._terminateTask==="notTerminated"&&(this._terminateTask=this._terminate()),this._terminateTask}_restart(){return N(this,null,function*(){this._terminateTask==="notTerminated"?yield this._terminate():this._terminateTask="notTerminated"})}toJSON(){return{app:this._app,databaseId:this._databaseId,settings:this._settings}}_terminate(){return function(t){let r=CE.get(t);r&&(V("ComponentProvider","Removing Datastore"),CE.delete(t),r.terminate())}(this),Promise.resolve()}};function sT(n,e,t,r={}){var i;let s=(n=ae(n,Ur))._getSettings(),o=`${e}:${t}`;if(s.host!=="firestore.googleapis.com"&&s.host!==o&&Dt("Host has been set in both settings() and connectFirestoreEmulator(), emulator host will be used."),n._setSettings(Object.assign(Object.assign({},s),{host:o,ssl:!1})),r.mockUserToken){let l,u;if(typeof r.mockUserToken=="string")l=r.mockUserToken,u=Oe.MOCK_USER;else{l=La(r.mockUserToken,(i=n._app)===null||i===void 0?void 0:i.options.projectId);let c=r.mockUserToken.sub||r.mockUserToken.user_id;if(!c)throw new k(P.INVALID_ARGUMENT,"mockUserToken must contain 'sub' or 'user_id' field!");u=new Oe(c)}n._authCredentials=new mf(new uu(l,u))}}var We=class n{constructor(e,t,r){this.converter=t,this._query=r,this.type="query",this.firestore=e}withConverter(e){return new n(this.firestore,e,this._query)}},ye=class n{constructor(e,t,r){this.converter=t,this._key=r,this.type="document",this.firestore=e}get _path(){return this._key.path}get id(){return this._key.path.lastSegment()}get path(){return this._key.path.canonicalString()}get parent(){return new Yt(this.firestore,this.converter,this._key.path.popLast())}withConverter(e){return new n(this.firestore,e,this._key)}},Yt=class n extends We{constructor(e,t,r){super(e,t,es(r)),this._path=r,this.type="collection"}get id(){return this._query.path.lastSegment()}get path(){return this._query.path.canonicalString()}get parent(){let e=this._path.popLast();return e.isEmpty()?null:new ye(this.firestore,null,new L(e))}withConverter(e){return new n(this.firestore,e,this._path)}};function jm(n,e,...t){if(n=te(n),qm("collection","path",e),n instanceof Ur){let r=oe.fromString(e,...t);return bE(r),new Yt(n,null,r)}{if(!(n instanceof ye||n instanceof Yt))throw new k(P.INVALID_ARGUMENT,"Expected first argument to collection() to be a CollectionReference, a DocumentReference or FirebaseFirestore");let r=n._path.child(oe.fromString(e,...t));return bE(r),new Yt(n.firestore,null,r)}}function oT(n,e){if(n=ae(n,Ur),qm("collectionGroup","collection id",e),e.indexOf("/")>=0)throw new k(P.INVALID_ARGUMENT,`Invalid collection ID '${e}' passed to function collectionGroup(). Collection IDs must not contain '/'.`);return new We(n,null,function(r){return new kt(oe.emptyPath(),r)}(e))}function ra(n,e,...t){if(n=te(n),arguments.length===1&&(e=cu.newId()),qm("doc","path",e),n instanceof Ur){let r=oe.fromString(e,...t);return AE(r),new ye(n,null,new L(r))}{if(!(n instanceof ye||n instanceof Yt))throw new k(P.INVALID_ARGUMENT,"Expected first argument to collection() to be a CollectionReference, a DocumentReference or FirebaseFirestore");let r=n._path.child(oe.fromString(e,...t));return AE(r),new ye(n.firestore,n instanceof Yt?n.converter:null,new L(r))}}function zm(n,e){return n=te(n),e=te(e),(n instanceof ye||n instanceof Yt)&&(e instanceof ye||e instanceof Yt)&&n.firestore===e.firestore&&n.path===e.path&&n.converter===e.converter}function Km(n,e){return n=te(n),e=te(e),n instanceof We&&e instanceof We&&n.firestore===e.firestore&&Zo(n._query,e._query)&&n.converter===e.converter}var Ju=class{constructor(e=Promise.resolve()){this.Pu=[],this.Iu=!1,this.Tu=[],this.Eu=null,this.du=!1,this.Au=!1,this.Ru=[],this.t_=new Wo(this,"async_queue_retry"),this.Vu=()=>{let r=lu();r&&V("AsyncQueue","Visibility state changed to "+r.visibilityState),this.t_.jo()},this.mu=e;let t=lu();t&&typeof t.addEventListener=="function"&&t.addEventListener("visibilitychange",this.Vu)}get isShuttingDown(){return this.Iu}enqueueAndForget(e){this.enqueue(e)}enqueueAndForgetEvenWhileRestricted(e){this.fu(),this.gu(e)}enterRestrictedMode(e){if(!this.Iu){this.Iu=!0,this.Au=e||!1;let t=lu();t&&typeof t.removeEventListener=="function"&&t.removeEventListener("visibilitychange",this.Vu)}}enqueue(e){if(this.fu(),this.Iu)return new Promise(()=>{});let t=new Be;return this.gu(()=>this.Iu&&this.Au?Promise.resolve():(e().then(t.resolve,t.reject),t.promise)).then(()=>t.promise)}enqueueRetryable(e){this.enqueueAndForget(()=>(this.Pu.push(e),this.pu()))}pu(){return N(this,null,function*(){if(this.Pu.length!==0){try{yield this.Pu[0](),this.Pu.shift(),this.t_.reset()}catch(e){if(!ir(e))throw e;V("AsyncQueue","Operation failed with retryable error: "+e)}this.Pu.length>0&&this.t_.Go(()=>this.pu())}})}gu(e){let t=this.mu.then(()=>(this.du=!0,e().catch(r=>{this.Eu=r,this.du=!1;let i=function(o){let l=o.message||"";return o.stack&&(l=o.stack.includes(o.message)?o.stack:o.message+`
`+o.stack),l}(r);throw Re("INTERNAL UNHANDLED ERROR: ",i),r}).then(r=>(this.du=!1,r))));return this.mu=t,t}enqueueAfterDelay(e,t,r){this.fu(),this.Ru.indexOf(e)>-1&&(t=0);let i=Mp.createAndSchedule(this,e,t,r,s=>this.yu(s));return this.Tu.push(i),i}fu(){this.Eu&&U()}verifyOperationInProgress(){}wu(){return N(this,null,function*(){let e;do e=this.mu,yield e;while(e!==this.mu)})}Su(e){for(let t of this.Tu)if(t.timerId===e)return!0;return!1}bu(e){return this.wu().then(()=>{this.Tu.sort((t,r)=>t.targetTimeMs-r.targetTimeMs);for(let t of this.Tu)if(t.skipDelay(),e!=="all"&&t.timerId===e)break;return this.wu()})}Du(e){this.Ru.push(e)}yu(e){let t=this.Tu.indexOf(e);this.Tu.splice(t,1)}};function Zp(n){return function(t,r){if(typeof t!="object"||t===null)return!1;let i=t;for(let s of r)if(s in i&&typeof i[s]=="function")return!0;return!1}(n,["next","error","complete"])}var em=class{constructor(){this._progressObserver={},this._taskCompletionResolver=new Be,this._lastProgress={taskState:"Running",totalBytes:0,totalDocuments:0,bytesLoaded:0,documentsLoaded:0}}onProgress(e,t,r){this._progressObserver={next:e,error:t,complete:r}}catch(e){return this._taskCompletionResolver.promise.catch(e)}then(e,t){return this._taskCompletionResolver.promise.then(e,t)}_completeWith(e){this._updateProgress(e),this._progressObserver.complete&&this._progressObserver.complete(),this._taskCompletionResolver.resolve(e)}_failWith(e){this._lastProgress.taskState="Error",this._progressObserver.next&&this._progressObserver.next(this._lastProgress),this._progressObserver.error&&this._progressObserver.error(e),this._taskCompletionResolver.reject(e)}_updateProgress(e){this._lastProgress=e,this._progressObserver.next&&this._progressObserver.next(e)}};var aT=-1,Ce=class extends Ur{constructor(e,t,r,i){super(e,t,r,i),this.type="firestore",this._queue=new Ju,this._persistenceKey=i?.name||"[DEFAULT]"}_terminate(){return N(this,null,function*(){if(this._firestoreClient){let e=this._firestoreClient.terminate();this._queue=new Ju(e),this._firestoreClient=void 0,yield e}})}};function Qe(n){if(n._terminated)throw new k(P.FAILED_PRECONDITION,"The client has already been terminated.");return n._firestoreClient||lT(n),n._firestoreClient}function lT(n){var e,t,r;let i=n._freezeSettings(),s=function(l,u,c,d){return new Af(l,u,c,d.host,d.ssl,d.experimentalForceLongPolling,d.experimentalAutoDetectLongPolling,rT(d.experimentalLongPollingOptions),d.useFetchStreams)}(n._databaseId,((e=n._app)===null||e===void 0?void 0:e.options.appId)||"",n._persistenceKey,i);n._componentsProvider||!((t=i.localCache)===null||t===void 0)&&t._offlineComponentProvider&&(!((r=i.localCache)===null||r===void 0)&&r._onlineComponentProvider)&&(n._componentsProvider={_offline:i.localCache._offlineComponentProvider,_online:i.localCache._onlineComponentProvider}),n._firestoreClient=new Xp(n._authCredentials,n._appCheckCredentials,n._queue,s,n._componentsProvider&&function(l){let u=l?._online.build();return{_offline:l?._offline.build(u),_online:u}}(n._componentsProvider))}function uT(n,e){Dt("enableIndexedDbPersistence() will be deprecated in the future, you can use `FirestoreSettings.cache` instead.");let t=n._freezeSettings();return hT(n,Mm.provider,{build:r=>new Hu(r,t.cacheSizeBytes,e?.forceOwnership)}),Promise.resolve()}function cT(n){return N(this,null,function*(){Dt("enableMultiTabIndexedDbPersistence() will be deprecated in the future, you can use `FirestoreSettings.cache` instead.");let e=n._freezeSettings();hT(n,Mm.provider,{build:t=>new $p(t,e.cacheSizeBytes)})})}function hT(n,e,t){if((n=ae(n,Ce))._firestoreClient||n._terminated)throw new k(P.FAILED_PRECONDITION,"Firestore has already been started and persistence can no longer be enabled. You can only enable persistence before calling any other methods on a Firestore object.");if(n._componentsProvider||n._getSettings().localCache)throw new k(P.FAILED_PRECONDITION,"SDK cache is already specified.");n._componentsProvider={_online:e,_offline:t},lT(n)}function dT(n){if(n._initialized&&!n._terminated)throw new k(P.FAILED_PRECONDITION,"Persistence can only be cleared before a Firestore instance is initialized or after it is terminated.");let e=new Be;return n._queue.enqueueAndForgetEvenWhileRestricted(()=>N(this,null,function*(){try{yield function(r){return N(this,null,function*(){if(!$n.D())return Promise.resolve();let i=r+"main";yield $n.delete(i)})}(Cm(n._databaseId,n._persistenceKey)),e.resolve()}catch(t){e.reject(t)}})),e.promise}function fT(n){return function(t){let r=new Be;return t.asyncQueue.enqueueAndForget(()=>N(this,null,function*(){return AR(yield Bm(t),r)})),r.promise}(Qe(n=ae(n,Ce)))}function pT(n){return UR(Qe(n=ae(n,Ce)))}function mT(n){return BR(Qe(n=ae(n,Ce)))}function gT(n,e){let t=Qe(n=ae(n,Ce)),r=new em;return zR(t,n._databaseId,e,r),r}function _T(n,e){return KR(Qe(n=ae(n,Ce)),e).then(t=>t?new We(n,null,t.query):null)}var en=class n{constructor(e){this._byteString=e}static fromBase64String(e){try{return new n(Ne.fromBase64String(e))}catch(t){throw new k(P.INVALID_ARGUMENT,"Failed to construct data from Base64 string: "+t)}}static fromUint8Array(e){return new n(Ne.fromUint8Array(e))}toBase64(){return this._byteString.toBase64()}toUint8Array(){return this._byteString.toUint8Array()}toString(){return"Bytes(base64: "+this.toBase64()+")"}isEqual(e){return this._byteString.isEqual(e._byteString)}};var Ft=class{constructor(...e){for(let t=0;t<e.length;++t)if(e[t].length===0)throw new k(P.INVALID_ARGUMENT,"Invalid field name at argument $(i + 1). Field names must not be empty.");this._internalPath=new Pe(e)}isEqual(e){return this._internalPath.isEqual(e._internalPath)}};var _n=class{constructor(e){this._methodName=e}};var Br=class{constructor(e,t){if(!isFinite(e)||e<-90||e>90)throw new k(P.INVALID_ARGUMENT,"Latitude must be a number between -90 and 90, but was: "+e);if(!isFinite(t)||t<-180||t>180)throw new k(P.INVALID_ARGUMENT,"Longitude must be a number between -180 and 180, but was: "+t);this._lat=e,this._long=t}get latitude(){return this._lat}get longitude(){return this._long}isEqual(e){return this._lat===e._lat&&this._long===e._long}toJSON(){return{latitude:this._lat,longitude:this._long}}_compareTo(e){return W(this._lat,e._lat)||W(this._long,e._long)}};var $o=class{constructor(e){this._values=(e||[]).map(t=>t)}toArray(){return this._values.map(e=>e)}isEqual(e){return function(r,i){if(r.length!==i.length)return!1;for(let s=0;s<r.length;++s)if(r[s]!==i[s])return!1;return!0}(this._values,e._values)}};var WR=/^__.*__$/,tm=class{constructor(e,t,r){this.data=e,this.fieldMask=t,this.fieldTransforms=r}toMutation(e,t){return this.fieldMask!==null?new Vt(e,this.data,this.fieldMask,t,this.fieldTransforms):new er(e,this.data,t,this.fieldTransforms)}},Xu=class{constructor(e,t,r){this.data=e,this.fieldMask=t,this.fieldTransforms=r}toMutation(e,t){return new Vt(e,this.data,this.fieldMask,t,this.fieldTransforms)}};function yT(n){switch(n){case 0:case 2:case 1:return!0;case 3:case 4:return!1;default:throw U()}}var Zu=class n{constructor(e,t,r,i,s,o){this.settings=e,this.databaseId=t,this.serializer=r,this.ignoreUndefinedProperties=i,s===void 0&&this.vu(),this.fieldTransforms=s||[],this.fieldMask=o||[]}get path(){return this.settings.path}get Cu(){return this.settings.Cu}Fu(e){return new n(Object.assign(Object.assign({},this.settings),e),this.databaseId,this.serializer,this.ignoreUndefinedProperties,this.fieldTransforms,this.fieldMask)}Mu(e){var t;let r=(t=this.path)===null||t===void 0?void 0:t.child(e),i=this.Fu({path:r,xu:!1});return i.Ou(e),i}Nu(e){var t;let r=(t=this.path)===null||t===void 0?void 0:t.child(e),i=this.Fu({path:r,xu:!1});return i.vu(),i}Lu(e){return this.Fu({path:void 0,xu:!0})}Bu(e){return ec(e,this.settings.methodName,this.settings.ku||!1,this.path,this.settings.qu)}contains(e){return this.fieldMask.find(t=>e.isPrefixOf(t))!==void 0||this.fieldTransforms.find(t=>e.isPrefixOf(t.field))!==void 0}vu(){if(this.path)for(let e=0;e<this.path.length;e++)this.Ou(this.path.get(e))}Ou(e){if(e.length===0)throw this.Bu("Document fields must not be empty");if(yT(this.Cu)&&WR.test(e))throw this.Bu('Document fields cannot begin and end with "__"')}},nm=class{constructor(e,t,r){this.databaseId=e,this.ignoreUndefinedProperties=t,this.serializer=r||ta(e)}Qu(e,t,r,i=!1){return new Zu({Cu:e,methodName:t,qu:r,path:Pe.emptyPath(),xu:!1,ku:i},this.databaseId,this.serializer,this.ignoreUndefinedProperties)}};function zr(n){let e=n._freezeSettings(),t=ta(n._databaseId);return new nm(n._databaseId,!!e.ignoreUndefinedProperties,t)}function dc(n,e,t,r,i,s={}){let o=n.Qu(s.merge||s.mergeFields?2:0,e,t,i);$m("Data must be an object, but it was:",o,r);let l=ET(r,o),u,c;if(s.merge)u=new yt(o.fieldMask),c=o.fieldTransforms;else if(s.mergeFields){let d=[];for(let p of s.mergeFields){let m=am(e,p,t);if(!o.contains(m))throw new k(P.INVALID_ARGUMENT,`Field '${m}' is specified in your field mask but missing from your input data.`);TT(d,m)||d.push(m)}u=new yt(d),c=o.fieldTransforms.filter(p=>u.covers(p.field))}else u=null,c=o.fieldTransforms;return new tm(new et(l),u,c)}var Ho=class n extends _n{_toFieldTransform(e){if(e.Cu!==2)throw e.Cu===1?e.Bu(`${this._methodName}() can only appear at the top level of your update data`):e.Bu(`${this._methodName}() cannot be used with set() unless you pass {merge:true}`);return e.fieldMask.push(e.path),null}isEqual(e){return e instanceof n}};function vT(n,e,t){return new Zu({Cu:3,qu:e.settings.qu,methodName:n._methodName,xu:t},e.databaseId,e.serializer,e.ignoreUndefinedProperties)}var rm=class n extends _n{_toFieldTransform(e){return new Or(e.path,new Xn)}isEqual(e){return e instanceof n}},im=class n extends _n{constructor(e,t){super(e),this.Ku=t}_toFieldTransform(e){let t=vT(this,e,!0),r=this.Ku.map(s=>Kr(s,t)),i=new mn(r);return new Or(e.path,i)}isEqual(e){return e instanceof n&&ih(this.Ku,e.Ku)}},sm=class n extends _n{constructor(e,t){super(e),this.Ku=t}_toFieldTransform(e){let t=vT(this,e,!0),r=this.Ku.map(s=>Kr(s,t)),i=new gn(r);return new Or(e.path,i)}isEqual(e){return e instanceof n&&ih(this.Ku,e.Ku)}},om=class n extends _n{constructor(e,t){super(e),this.$u=t}_toFieldTransform(e){let t=new Zn(e.serializer,oI(e.serializer,this.$u));return new Or(e.path,t)}isEqual(e){return e instanceof n&&this.$u===e.$u}};function Wm(n,e,t,r){let i=n.Qu(1,e,t);$m("Data must be an object, but it was:",i,r);let s=[],o=et.empty();jr(r,(u,c)=>{let d=Hm(e,u,t);c=te(c);let p=i.Nu(d);if(c instanceof Ho)s.push(d);else{let m=Kr(c,p);m!=null&&(s.push(d),o.set(d,m))}});let l=new yt(s);return new Xu(o,l,i.fieldTransforms)}function Qm(n,e,t,r,i,s){let o=n.Qu(1,e,t),l=[am(e,r,t)],u=[i];if(s.length%2!=0)throw new k(P.INVALID_ARGUMENT,`Function ${e}() needs to be called with an even number of arguments that alternate between field names and values.`);for(let m=0;m<s.length;m+=2)l.push(am(e,s[m])),u.push(s[m+1]);let c=[],d=et.empty();for(let m=l.length-1;m>=0;--m)if(!TT(c,l[m])){let y=l[m],C=u[m];C=te(C);let x=o.Nu(y);if(C instanceof Ho)c.push(y);else{let D=Kr(C,x);D!=null&&(c.push(y),d.set(y,D))}}let p=new yt(c);return new Xu(d,p,o.fieldTransforms)}function wT(n,e,t,r=!1){return Kr(t,n.Qu(r?4:3,e))}function Kr(n,e){if(IT(n=te(n)))return $m("Unsupported field value:",e,n),ET(n,e);if(n instanceof _n)return function(r,i){if(!yT(i.Cu))throw i.Bu(`${r._methodName}() can only be used with update() and set()`);if(!i.path)throw i.Bu(`${r._methodName}() is not currently supported inside arrays`);let s=r._toFieldTransform(i);s&&i.fieldTransforms.push(s)}(n,e),null;if(n===void 0&&e.ignoreUndefinedProperties)return null;if(e.path&&e.fieldMask.push(e.path),n instanceof Array){if(e.settings.xu&&e.Cu!==4)throw e.Bu("Nested arrays are not supported");return function(r,i){let s=[],o=0;for(let l of r){let u=Kr(l,i.Lu(o));u==null&&(u={nullValue:"NULL_VALUE"}),s.push(u),o++}return{arrayValue:{values:s}}}(n,e)}return function(r,i){if((r=te(r))===null)return{nullValue:"NULL_VALUE"};if(typeof r=="number")return oI(i.serializer,r);if(typeof r=="boolean")return{booleanValue:r};if(typeof r=="string")return{stringValue:r};if(r instanceof Date){let s=Se.fromDate(r);return{timestampValue:Gi(i.serializer,s)}}if(r instanceof Se){let s=new Se(r.seconds,1e3*Math.floor(r.nanoseconds/1e3));return{timestampValue:Gi(i.serializer,s)}}if(r instanceof Br)return{geoPointValue:{latitude:r.latitude,longitude:r.longitude}};if(r instanceof en)return{bytesValue:gI(i.serializer,r._byteString)};if(r instanceof ye){let s=i.databaseId,o=r.firestore._databaseId;if(!o.isEqual(s))throw i.Bu(`Document reference is for database ${o.projectId}/${o.database} but should be for database ${s.projectId}/${s.database}`);return{referenceValue:Im(r.firestore._databaseId||i.databaseId,r._key.path)}}if(r instanceof $o)return function(o,l){return{mapValue:{fields:{__type__:{stringValue:"__vector__"},value:{arrayValue:{values:o.toArray().map(u=>{if(typeof u!="number")throw l.Bu("VectorValues must only contain numeric values.");return Em(l.serializer,u)})}}}}}}(r,i);throw i.Bu(`Unsupported field value: ${hc(r)}`)}(n,e)}function ET(n,e){let t={};return GE(n)?e.path&&e.path.length>0&&e.fieldMask.push(e.path):jr(n,(r,i)=>{let s=Kr(i,e.Mu(r));s!=null&&(t[r]=s)}),{mapValue:{fields:t}}}function IT(n){return!(typeof n!="object"||n===null||n instanceof Array||n instanceof Date||n instanceof Se||n instanceof Br||n instanceof en||n instanceof ye||n instanceof _n||n instanceof $o)}function $m(n,e,t){if(!IT(t)||!function(i){return typeof i=="object"&&i!==null&&(Object.getPrototypeOf(i)===Object.prototype||Object.getPrototypeOf(i)===null)}(t)){let r=hc(t);throw r==="an object"?e.Bu(n+" a custom object"):e.Bu(n+" "+r)}}function am(n,e,t){if((e=te(e))instanceof Ft)return e._internalPath;if(typeof e=="string")return Hm(n,e);throw ec("Field path arguments must be of type string or ",n,!1,void 0,t)}var QR=new RegExp("[~\\*/\\[\\]]");function Hm(n,e,t){if(e.search(QR)>=0)throw ec(`Invalid field path (${e}). Paths must not contain '~', '*', '/', '[', or ']'`,n,!1,void 0,t);try{return new Ft(...e.split("."))._internalPath}catch{throw ec(`Invalid field path (${e}). Paths must not be empty, begin with '.', end with '.', or contain '..'`,n,!1,void 0,t)}}function ec(n,e,t,r,i){let s=r&&!r.isEmpty(),o=i!==void 0,l=`Function ${e}() called with invalid data`;t&&(l+=" (via `toFirestore()`)"),l+=". ";let u="";return(s||o)&&(u+=" (found",s&&(u+=` in field ${r}`),o&&(u+=` in document ${i}`),u+=")"),new k(P.INVALID_ARGUMENT,l+n+u)}function TT(n,e){return n.some(t=>t.isEqual(e))}var qr=class{constructor(e,t,r,i,s){this._firestore=e,this._userDataWriter=t,this._key=r,this._document=i,this._converter=s}get id(){return this._key.path.lastSegment()}get ref(){return new ye(this._firestore,this._converter,this._key)}exists(){return this._document!==null}data(){if(this._document){if(this._converter){let e=new lm(this._firestore,this._userDataWriter,this._key,this._document,null);return this._converter.fromFirestore(e)}return this._userDataWriter.convertValue(this._document.data.value)}}get(e){if(this._document){let t=this._document.data.field(fc("DocumentSnapshot.get",e));if(t!==null)return this._userDataWriter.convertValue(t)}}},lm=class extends qr{data(){return super.data()}};function fc(n,e){return typeof e=="string"?Hm(n,e):e instanceof Ft?e._internalPath:e._delegate._internalPath}function ST(n){if(n.limitType==="L"&&n.explicitOrderBy.length===0)throw new k(P.UNIMPLEMENTED,"limitToLast() queries require specifying at least one orderBy() clause")}var Yo=class{},Gr=class extends Yo{};function wn(n,e,...t){let r=[];e instanceof Yo&&r.push(e),r=r.concat(t),function(s){let o=s.filter(u=>u instanceof um).length,l=s.filter(u=>u instanceof tc).length;if(o>1||o>0&&l>0)throw new k(P.INVALID_ARGUMENT,"InvalidQuery. When using composite filters, you cannot use more than one filter at the top level. Consider nesting the multiple filters within an `and(...)` statement. For example: change `query(query, where(...), or(...))` to `query(query, and(where(...), or(...)))`.")}(r);for(let i of r)n=i._apply(n);return n}var tc=class n extends Gr{constructor(e,t,r){super(),this._field=e,this._op=t,this._value=r,this.type="where"}static _create(e,t,r){return new n(e,t,r)}_apply(e){let t=this._parse(e);return VT(e._query,t),new We(e.firestore,e.converter,Uf(e._query,t))}_parse(e){let t=zr(e.firestore);return function(s,o,l,u,c,d,p){let m;if(c.isKeyField()){if(d==="array-contains"||d==="array-contains-any")throw new k(P.INVALID_ARGUMENT,`Invalid Query. You can't perform '${d}' queries on documentId().`);if(d==="in"||d==="not-in"){PE(p,d);let y=[];for(let C of p)y.push(RE(u,s,C));m={arrayValue:{values:y}}}else m=RE(u,s,p)}else d!=="in"&&d!=="not-in"&&d!=="array-contains-any"||PE(p,d),m=wT(l,o,p,d==="in"||d==="not-in");return ne.create(c,d,m)}(e._query,"where",t,e.firestore._databaseId,this._field,this._op,this._value)}};function CT(n,e,t){let r=e,i=fc("where",n);return tc._create(i,r,t)}var um=class n extends Yo{constructor(e,t){super(),this.type=e,this._queryConstraints=t}static _create(e,t){return new n(e,t)}_parse(e){let t=this._queryConstraints.map(r=>r._parse(e)).filter(r=>r.getFilters().length>0);return t.length===1?t[0]:de.create(t,this._getOperator())}_apply(e){let t=this._parse(e);return t.getFilters().length===0?e:(function(i,s){let o=i,l=s.getFlattenedFilters();for(let u of l)VT(o,u),o=Uf(o,u)}(e._query,t),new We(e.firestore,e.converter,Uf(e._query,t)))}_getQueryConstraints(){return this._queryConstraints}_getOperator(){return this.type==="and"?"and":"or"}};var cm=class n extends Gr{constructor(e,t){super(),this._field=e,this._direction=t,this.type="orderBy"}static _create(e,t){return new n(e,t)}_apply(e){let t=function(i,s,o){if(i.startAt!==null)throw new k(P.INVALID_ARGUMENT,"Invalid query. You must not call startAt() or startAfter() before calling orderBy().");if(i.endAt!==null)throw new k(P.INVALID_ARGUMENT,"Invalid query. You must not call endAt() or endBefore() before calling orderBy().");return new Vr(s,o)}(e._query,this._field,this._direction);return new We(e.firestore,e.converter,function(i,s){let o=i.explicitOrderBy.concat([s]);return new kt(i.path,i.collectionGroup,o,i.filters.slice(),i.limit,i.limitType,i.startAt,i.endAt)}(e._query,t))}};function AT(n,e="asc"){let t=e,r=fc("orderBy",n);return cm._create(r,t)}var nc=class n extends Gr{constructor(e,t,r){super(),this.type=e,this._limit=t,this._limitType=r}static _create(e,t,r){return new n(e,t,r)}_apply(e){return new We(e.firestore,e.converter,wu(e._query,this._limit,this._limitType))}};function bT(n){return iT("limit",n),nc._create("limit",n,"F")}function RT(n){return iT("limitToLast",n),nc._create("limitToLast",n,"L")}var rc=class n extends Gr{constructor(e,t,r){super(),this.type=e,this._docOrFields=t,this._inclusive=r}static _create(e,t,r){return new n(e,t,r)}_apply(e){let t=kT(e,this.type,this._docOrFields,this._inclusive);return new We(e.firestore,e.converter,function(i,s){return new kt(i.path,i.collectionGroup,i.explicitOrderBy.slice(),i.filters.slice(),i.limit,i.limitType,s,i.endAt)}(e._query,t))}};function PT(...n){return rc._create("startAt",n,!0)}function xT(...n){return rc._create("startAfter",n,!1)}var ic=class n extends Gr{constructor(e,t,r){super(),this.type=e,this._docOrFields=t,this._inclusive=r}static _create(e,t,r){return new n(e,t,r)}_apply(e){let t=kT(e,this.type,this._docOrFields,this._inclusive);return new We(e.firestore,e.converter,function(i,s){return new kt(i.path,i.collectionGroup,i.explicitOrderBy.slice(),i.filters.slice(),i.limit,i.limitType,i.startAt,s)}(e._query,t))}};function NT(...n){return ic._create("endBefore",n,!1)}function DT(...n){return ic._create("endAt",n,!0)}function kT(n,e,t,r){if(t[0]=te(t[0]),t[0]instanceof qr)return function(s,o,l,u,c){if(!u)throw new k(P.NOT_FOUND,`Can't use a DocumentSnapshot that doesn't exist for ${l}().`);let d=[];for(let p of Vi(s))if(p.field.isKeyField())d.push(kr(o,u.key));else{let m=u.data.field(p.field);if(oc(m))throw new k(P.INVALID_ARGUMENT,'Invalid query. You are trying to start or end a query using a document for which the field "'+p.field+'" is an uncommitted server timestamp. (Since the value of this field is unknown, you cannot start/end a query with it.)');if(m===null){let y=p.field.canonicalString();throw new k(P.INVALID_ARGUMENT,`Invalid query. You are trying to start or end a query using a document for which the field '${y}' (used as the orderBy) does not exist.`)}d.push(m)}return new Xt(d,c)}(n._query,n.firestore._databaseId,e,t[0]._document,r);{let i=zr(n.firestore);return function(o,l,u,c,d,p){let m=o.explicitOrderBy;if(d.length>m.length)throw new k(P.INVALID_ARGUMENT,`Too many arguments provided to ${c}(). The number of arguments must be less than or equal to the number of orderBy() clauses`);let y=[];for(let C=0;C<d.length;C++){let x=d[C];if(m[C].field.isKeyField()){if(typeof x!="string")throw new k(P.INVALID_ARGUMENT,`Invalid query. Expected a string for document ID in ${c}(), but got a ${typeof x}`);if(!vm(o)&&x.indexOf("/")!==-1)throw new k(P.INVALID_ARGUMENT,`Invalid query. When querying a collection and ordering by documentId(), the value passed to ${c}() must be a plain document ID, but '${x}' contains a slash.`);let D=o.path.child(oe.fromString(x));if(!L.isDocumentKey(D))throw new k(P.INVALID_ARGUMENT,`Invalid query. When querying a collection group and ordering by documentId(), the value passed to ${c}() must result in a valid document path, but '${D}' is not because it contains an odd number of segments.`);let q=new L(D);y.push(kr(l,q))}else{let D=wT(u,c,x);y.push(D)}}return new Xt(y,p)}(n._query,n.firestore._databaseId,i,e,t,r)}}function RE(n,e,t){if(typeof(t=te(t))=="string"){if(t==="")throw new k(P.INVALID_ARGUMENT,"Invalid query. When querying with documentId(), you must provide a valid document ID, but it was an empty string.");if(!vm(e)&&t.indexOf("/")!==-1)throw new k(P.INVALID_ARGUMENT,`Invalid query. When querying a collection by documentId(), you must provide a plain document ID, but '${t}' contains a '/' character.`);let r=e.path.child(oe.fromString(t));if(!L.isDocumentKey(r))throw new k(P.INVALID_ARGUMENT,`Invalid query. When querying a collection group by documentId(), the value provided must result in a valid document path, but '${r}' is not because it has an odd number of segments (${r.length}).`);return kr(n,new L(r))}if(t instanceof ye)return kr(n,t._key);throw new k(P.INVALID_ARGUMENT,`Invalid query. When querying with documentId(), you must provide a valid string or a DocumentReference, but it was: ${hc(t)}.`)}function PE(n,e){if(!Array.isArray(n)||n.length===0)throw new k(P.INVALID_ARGUMENT,`Invalid Query. A non-empty array is required for '${e.toString()}' filters.`)}function VT(n,e){let t=function(i,s){for(let o of i)for(let l of o.getFlattenedFilters())if(s.indexOf(l.op)>=0)return l.op;return null}(n.filters,function(i){switch(i){case"!=":return["!=","not-in"];case"array-contains-any":case"in":return["not-in"];case"not-in":return["array-contains-any","in","not-in","!="];default:return[]}}(e.op));if(t!==null)throw t===e.op?new k(P.INVALID_ARGUMENT,`Invalid query. You cannot use more than one '${e.op.toString()}' filter.`):new k(P.INVALID_ARGUMENT,`Invalid query. You cannot use '${e.op.toString()}' filters with '${t.toString()}' filters.`)}var Xi=class{convertValue(e,t="none"){switch(Dr(e)){case 0:return null;case 1:return e.booleanValue;case 2:return Ie(e.integerValue||e.doubleValue);case 3:return this.convertTimestamp(e.timestampValue);case 4:return this.convertServerTimestamp(e,t);case 5:return e.stringValue;case 6:return this.convertBytes(Hn(e.bytesValue));case 7:return this.convertReference(e.referenceValue);case 8:return this.convertGeoPoint(e.geoPointValue);case 9:return this.convertArray(e.arrayValue,t);case 11:return this.convertObject(e.mapValue,t);case 10:return this.convertVectorValue(e.mapValue);default:throw U()}}convertObject(e,t){return this.convertObjectMap(e.fields,t)}convertObjectMap(e,t="none"){let r={};return jr(e,(i,s)=>{r[i]=this.convertValue(s,t)}),r}convertVectorValue(e){var t,r,i;let s=(i=(r=(t=e.fields)===null||t===void 0?void 0:t.value.arrayValue)===null||r===void 0?void 0:r.values)===null||i===void 0?void 0:i.map(o=>Ie(o.doubleValue));return new $o(s)}convertGeoPoint(e){return new Br(Ie(e.latitude),Ie(e.longitude))}convertArray(e,t){return(e.values||[]).map(r=>this.convertValue(r,t))}convertServerTimestamp(e,t){switch(t){case"previous":let r=_m(e);return r==null?null:this.convertValue(r,t);case"estimate":return this.convertTimestamp(ko(e));default:return null}}convertTimestamp(e){let t=pn(e);return new Se(t.seconds,t.nanos)}convertDocumentKey(e,t){let r=oe.fromString(e);G(bI(r));let i=new Yn(r.get(1),r.get(3)),s=new L(r.popFirst(5));return i.isEqual(t)||Re(`Document ${s} contains a document reference within a different database (${i.projectId}/${i.database}) which is not supported. It will be treated as a reference in the current database (${t.projectId}/${t.database}) instead.`),s}};function pc(n,e,t){let r;return r=n?t&&(t.merge||t.mergeFields)?n.toFirestore(e,t):n.toFirestore(e):e,r}var hm=class extends Xi{constructor(e){super(),this.firestore=e}convertBytes(e){return new en(e)}convertReference(e){let t=this.convertDocumentKey(e,this.firestore._databaseId);return new ye(this.firestore,null,t)}};var fn=class{constructor(e,t){this.hasPendingWrites=e,this.fromCache=t}isEqual(e){return this.hasPendingWrites===e.hasPendingWrites&&this.fromCache===e.fromCache}},bt=class extends qr{constructor(e,t,r,i,s,o){super(e,t,r,i,o),this._firestore=e,this._firestoreImpl=e,this.metadata=s}exists(){return super.exists()}data(e={}){if(this._document){if(this._converter){let t=new Wn(this._firestore,this._userDataWriter,this._key,this._document,this.metadata,null);return this._converter.fromFirestore(t,e)}return this._userDataWriter.convertValue(this._document.data.value,e.serverTimestamps)}}get(e,t={}){if(this._document){let r=this._document.data.field(fc("DocumentSnapshot.get",e));if(r!==null)return this._userDataWriter.convertValue(r,t.serverTimestamps)}}},Wn=class extends bt{data(e={}){return super.data(e)}},Ot=class{constructor(e,t,r,i){this._firestore=e,this._userDataWriter=t,this._snapshot=i,this.metadata=new fn(i.hasPendingWrites,i.fromCache),this.query=r}get docs(){let e=[];return this.forEach(t=>e.push(t)),e}get size(){return this._snapshot.docs.size}get empty(){return this.size===0}forEach(e,t){this._snapshot.docs.forEach(r=>{e.call(t,new Wn(this._firestore,this._userDataWriter,r.key,r,new fn(this._snapshot.mutatedKeys.has(r.key),this._snapshot.fromCache),this.query.converter))})}docChanges(e={}){let t=!!e.includeMetadataChanges;if(t&&this._snapshot.excludesMetadataChanges)throw new k(P.INVALID_ARGUMENT,"To include metadata changes with your document changes, you must also pass { includeMetadataChanges:true } to onSnapshot().");return this._cachedChanges&&this._cachedChangesIncludeMetadataChanges===t||(this._cachedChanges=function(i,s){if(i._snapshot.oldDocs.isEmpty()){let o=0;return i._snapshot.docChanges.map(l=>{let u=new Wn(i._firestore,i._userDataWriter,l.doc.key,l.doc,new fn(i._snapshot.mutatedKeys.has(l.doc.key),i._snapshot.fromCache),i.query.converter);return l.doc,{type:"added",doc:u,oldIndex:-1,newIndex:o++}})}{let o=i._snapshot.oldDocs;return i._snapshot.docChanges.filter(l=>s||l.type!==3).map(l=>{let u=new Wn(i._firestore,i._userDataWriter,l.doc.key,l.doc,new fn(i._snapshot.mutatedKeys.has(l.doc.key),i._snapshot.fromCache),i.query.converter),c=-1,d=-1;return l.type!==0&&(c=o.indexOf(l.doc.key),o=o.delete(l.doc.key)),l.type!==1&&(o=o.add(l.doc),d=o.indexOf(l.doc.key)),{type:$R(l.type),doc:u,oldIndex:c,newIndex:d}})}}(this,t),this._cachedChangesIncludeMetadataChanges=t),this._cachedChanges}};function $R(n){switch(n){case 0:return"added";case 2:case 3:return"modified";case 1:return"removed";default:return U()}}function Ym(n,e){return n instanceof bt&&e instanceof bt?n._firestore===e._firestore&&n._key.isEqual(e._key)&&(n._document===null?e._document===null:n._document.isEqual(e._document))&&n._converter===e._converter:n instanceof Ot&&e instanceof Ot&&n._firestore===e._firestore&&Km(n.query,e.query)&&n.metadata.isEqual(e.metadata)&&n._snapshot.isEqual(e._snapshot)}function FT(n){n=ae(n,ye);let e=ae(n.firestore,Ce);return tT(Qe(e),n._key).then(t=>eg(e,n,t))}var yn=class extends Xi{constructor(e){super(),this.firestore=e}convertBytes(e){return new en(e)}convertReference(e){let t=this.convertDocumentKey(e,this.firestore._databaseId);return new ye(this.firestore,null,t)}};function OT(n){n=ae(n,ye);let e=ae(n.firestore,Ce),t=Qe(e),r=new yn(e);return qR(t,n._key).then(i=>new bt(e,r,n._key,i,new fn(i!==null&&i.hasLocalMutations,!0),n.converter))}function MT(n){n=ae(n,ye);let e=ae(n.firestore,Ce);return tT(Qe(e),n._key,{source:"server"}).then(t=>eg(e,n,t))}function LT(n){n=ae(n,We);let e=ae(n.firestore,Ce),t=Qe(e),r=new yn(e);return ST(n._query),nT(t,n._query).then(i=>new Ot(e,r,n,i))}function UT(n){n=ae(n,We);let e=ae(n.firestore,Ce),t=Qe(e),r=new yn(e);return GR(t,n._query).then(i=>new Ot(e,r,n,i))}function BT(n){n=ae(n,We);let e=ae(n.firestore,Ce),t=Qe(e),r=new yn(e);return nT(t,n._query,{source:"server"}).then(i=>new Ot(e,r,n,i))}function Jm(n,e,t){n=ae(n,ye);let r=ae(n.firestore,Ce),i=pc(n.converter,e,t);return ss(r,[dc(zr(r),"setDoc",n._key,i,n.converter!==null,t).toMutation(n._key,be.none())])}function Xm(n,e,t,...r){n=ae(n,ye);let i=ae(n.firestore,Ce),s=zr(i),o;return o=typeof(e=te(e))=="string"||e instanceof Ft?Qm(s,"updateDoc",n._key,e,t,r):Wm(s,"updateDoc",n._key,e),ss(i,[o.toMutation(n._key,be.exists(!0))])}function qT(n){return ss(ae(n.firestore,Ce),[new tr(n._key,be.none())])}function GT(n,e){let t=ae(n.firestore,Ce),r=ra(n),i=pc(n.converter,e);return ss(t,[dc(zr(n.firestore),"addDoc",r._key,i,n.converter!==null,{}).toMutation(r._key,be.exists(!1))]).then(()=>r)}function Zm(n,...e){var t,r,i;n=te(n);let s={includeMetadataChanges:!1,source:"default"},o=0;typeof e[o]!="object"||Zp(e[o])||(s=e[o],o++);let l={includeMetadataChanges:s.includeMetadataChanges,source:s.source};if(Zp(e[o])){let p=e[o];e[o]=(t=p.next)===null||t===void 0?void 0:t.bind(p),e[o+1]=(r=p.error)===null||r===void 0?void 0:r.bind(p),e[o+2]=(i=p.complete)===null||i===void 0?void 0:i.bind(p)}let u,c,d;if(n instanceof ye)c=ae(n.firestore,Ce),d=es(n._key.path),u={next:p=>{e[o]&&e[o](eg(c,n,p))},error:e[o+1],complete:e[o+2]};else{let p=ae(n,We);c=ae(p.firestore,Ce),d=p._query;let m=new yn(c);u={next:y=>{e[o]&&e[o](new Ot(c,m,p,y))},error:e[o+1],complete:e[o+2]},ST(n._query)}return function(m,y,C,x){let D=new Yi(x),q=new Qo(y,D,C);return m.asyncQueue.enqueueAndForget(()=>N(this,null,function*(){return Pm(yield Ji(m),q)})),()=>{D.Za(),m.asyncQueue.enqueueAndForget(()=>N(this,null,function*(){return xm(yield Ji(m),q)}))}}(Qe(c),d,l,u)}function jT(n,e){return jR(Qe(n=ae(n,Ce)),Zp(e)?e:{next:e})}function ss(n,e){return function(r,i){let s=new Be;return r.asyncQueue.enqueueAndForget(()=>N(this,null,function*(){return IR(yield Bm(r),i,s)})),s.promise}(Qe(n),e)}function eg(n,e,t){let r=t.docs.get(e._key),i=new yn(n);return new bt(n,i,e._key,r,new fn(t.hasPendingWrites,t.fromCache),e.converter)}var HR={maxAttempts:5};var sc=class{constructor(e,t){this._firestore=e,this._commitHandler=t,this._mutations=[],this._committed=!1,this._dataReader=zr(e)}set(e,t,r){this._verifyNotCommitted();let i=zn(e,this._firestore),s=pc(i.converter,t,r),o=dc(this._dataReader,"WriteBatch.set",i._key,s,i.converter!==null,r);return this._mutations.push(o.toMutation(i._key,be.none())),this}update(e,t,r,...i){this._verifyNotCommitted();let s=zn(e,this._firestore),o;return o=typeof(t=te(t))=="string"||t instanceof Ft?Qm(this._dataReader,"WriteBatch.update",s._key,t,r,i):Wm(this._dataReader,"WriteBatch.update",s._key,t),this._mutations.push(o.toMutation(s._key,be.exists(!0))),this}delete(e){this._verifyNotCommitted();let t=zn(e,this._firestore);return this._mutations=this._mutations.concat(new tr(t._key,be.none())),this}commit(){return this._verifyNotCommitted(),this._committed=!0,this._mutations.length>0?this._commitHandler(this._mutations):Promise.resolve()}_verifyNotCommitted(){if(this._committed)throw new k(P.FAILED_PRECONDITION,"A write batch can no longer be used after commit() has been called.")}};function zn(n,e){if((n=te(n)).firestore!==e)throw new k(P.INVALID_ARGUMENT,"Provided document reference is from a different Firestore instance.");return n}var dm=class extends class{constructor(t,r){this._firestore=t,this._transaction=r,this._dataReader=zr(t)}get(t){let r=zn(t,this._firestore),i=new hm(this._firestore);return this._transaction.lookup([r._key]).then(s=>{if(!s||s.length!==1)return U();let o=s[0];if(o.isFoundDocument())return new qr(this._firestore,i,o.key,o,r.converter);if(o.isNoDocument())return new qr(this._firestore,i,r._key,null,r.converter);throw U()})}set(t,r,i){let s=zn(t,this._firestore),o=pc(s.converter,r,i),l=dc(this._dataReader,"Transaction.set",s._key,o,s.converter!==null,i);return this._transaction.set(s._key,l),this}update(t,r,i,...s){let o=zn(t,this._firestore),l;return l=typeof(r=te(r))=="string"||r instanceof Ft?Qm(this._dataReader,"Transaction.update",o._key,r,i,s):Wm(this._dataReader,"Transaction.update",o._key,r),this._transaction.update(o._key,l),this}delete(t){let r=zn(t,this._firestore);return this._transaction.delete(r._key),this}}{constructor(e,t){super(e,t),this._firestore=e}get(e){let t=zn(e,this._firestore),r=new yn(this._firestore);return super.get(e).then(i=>new bt(this._firestore,r,t._key,i._document,new fn(!1,!1),t.converter))}};function zT(n,e,t){n=ae(n,Ce);let r=Object.assign(Object.assign({},HR),t);return function(s){if(s.maxAttempts<1)throw new k(P.INVALID_ARGUMENT,"Max attempts must be at least 1")}(r),function(s,o,l){let u=new Be;return s.asyncQueue.enqueueAndForget(()=>N(this,null,function*(){let c=yield LR(s);new Jp(s.asyncQueue,c,l,o,u).au()})),u.promise}(Qe(n),i=>e(new dm(n,i)),r)}function KT(){return new Ho("deleteField")}function WT(){return new rm("serverTimestamp")}function QT(...n){return new im("arrayUnion",n)}function $T(...n){return new sm("arrayRemove",n)}function HT(n){return new om("increment",n)}(function(e,t=!0){(function(i){Zi=i})(ja),Ga(new Bt("firestore",(r,{instanceIdentifier:i,options:s})=>{let o=r.getProvider("app").getImmediate(),l=new Ce(new gf(r.getProvider("auth-internal")),new wf(r.getProvider("app-check-internal")),function(c,d){if(!Object.prototype.hasOwnProperty.apply(c.options,["projectId"]))throw new k(P.INVALID_ARGUMENT,'"projectId" not provided in firebase.initializeApp.');return new Yn(c.options.projectId,d)}(o,i),o);return s=Object.assign({useFetchStreams:t},s),l._setSettings(s),l},"PUBLIC").setMultipleInstances(!0)),ii(bw,"4.7.3",e),ii(bw,"4.7.3","esm2017")})();var YR="@firebase/firestore-compat",JR="0.3.38";function og(n,e){if(e===void 0)return{merge:!1};if(e.mergeFields!==void 0&&e.merge!==void 0)throw new k("invalid-argument",`Invalid options passed to function ${n}(): You cannot specify both "merge" and "mergeFields".`);return e}function YT(){if(typeof Uint8Array>"u")throw new k("unimplemented","Uint8Arrays are not available in this environment.")}function JT(){if(!jE())throw new k("unimplemented","Blobs are unavailable in Firestore in this environment.")}var mc=class n{constructor(e){this._delegate=e}static fromBase64String(e){return JT(),new n(en.fromBase64String(e))}static fromUint8Array(e){return YT(),new n(en.fromUint8Array(e))}toBase64(){return JT(),this._delegate.toBase64()}toUint8Array(){return YT(),this._delegate.toUint8Array()}isEqual(e){return this._delegate.isEqual(e._delegate)}toString(){return"Blob(base64: "+this.toBase64()+")"}};function tg(n){return XR(n,["next","error","complete"])}function XR(n,e){if(typeof n!="object"||n===null)return!1;let t=n;for(let r of e)if(r in t&&typeof t[r]=="function")return!0;return!1}var ng=class{enableIndexedDbPersistence(e,t){return uT(e._delegate,{forceOwnership:t})}enableMultiTabIndexedDbPersistence(e){return cT(e._delegate)}clearIndexedDbPersistence(e){return dT(e._delegate)}},gc=class{constructor(e,t,r){this._delegate=t,this._persistenceProvider=r,this.INTERNAL={delete:()=>this.terminate()},e instanceof Yn||(this._appCompat=e)}get _databaseId(){return this._delegate._databaseId}settings(e){let t=this._delegate._getSettings();!e.merge&&t.host!==e.host&&Dt("You are overriding the original host. If you did not intend to override your settings, use {merge: true}."),e.merge&&(e=Object.assign(Object.assign({},t),e),delete e.merge),this._delegate._setSettings(e)}useEmulator(e,t,r={}){sT(this._delegate,e,t,r)}enableNetwork(){return pT(this._delegate)}disableNetwork(){return mT(this._delegate)}enablePersistence(e){let t=!1,r=!1;return e&&(t=!!e.synchronizeTabs,r=!!e.experimentalForceOwningTab,Gm("synchronizeTabs",t,"experimentalForceOwningTab",r)),t?this._persistenceProvider.enableMultiTabIndexedDbPersistence(this):this._persistenceProvider.enableIndexedDbPersistence(this,r)}clearPersistence(){return this._persistenceProvider.clearIndexedDbPersistence(this)}terminate(){return this._appCompat&&(this._appCompat._removeServiceInstance("firestore-compat"),this._appCompat._removeServiceInstance("firestore")),this._delegate._delete()}waitForPendingWrites(){return fT(this._delegate)}onSnapshotsInSync(e){return jT(this._delegate,e)}get app(){if(!this._appCompat)throw new k("failed-precondition","Firestore was not initialized using the Firebase SDK. 'app' is not available");return this._appCompat}collection(e){try{return new ls(this,jm(this._delegate,e))}catch(t){throw ut(t,"collection()","Firestore.collection()")}}doc(e){try{return new tn(this,ra(this._delegate,e))}catch(t){throw ut(t,"doc()","Firestore.doc()")}}collectionGroup(e){try{return new Hr(this,oT(this._delegate,e))}catch(t){throw ut(t,"collectionGroup()","Firestore.collectionGroup()")}}runTransaction(e){return zT(this._delegate,t=>e(new _c(this,t)))}batch(){return Qe(this._delegate),new yc(new sc(this._delegate,e=>ss(this._delegate,e)))}loadBundle(e){return gT(this._delegate,e)}namedQuery(e){return _T(this._delegate,e).then(t=>t?new Hr(this,t):null)}},os=class extends Xi{constructor(e){super(),this.firestore=e}convertBytes(e){return new mc(new en(e))}convertReference(e){let t=this.convertDocumentKey(e,this.firestore._databaseId);return tn.forKey(t,this.firestore,null)}};function ZR(n){xE(n)}var _c=class{constructor(e,t){this._firestore=e,this._delegate=t,this._userDataWriter=new os(e)}get(e){let t=Wr(e);return this._delegate.get(t).then(r=>new Qr(this._firestore,new bt(this._firestore._delegate,this._userDataWriter,r._key,r._document,r.metadata,t.converter)))}set(e,t,r){let i=Wr(e);return r?(og("Transaction.set",r),this._delegate.set(i,t,r)):this._delegate.set(i,t),this}update(e,t,r,...i){let s=Wr(e);return arguments.length===2?this._delegate.update(s,t):this._delegate.update(s,t,r,...i),this}delete(e){let t=Wr(e);return this._delegate.delete(t),this}},yc=class{constructor(e){this._delegate=e}set(e,t,r){let i=Wr(e);return r?(og("WriteBatch.set",r),this._delegate.set(i,t,r)):this._delegate.set(i,t),this}update(e,t,r,...i){let s=Wr(e);return arguments.length===2?this._delegate.update(s,t):this._delegate.update(s,t,r,...i),this}delete(e){let t=Wr(e);return this._delegate.delete(t),this}commit(){return this._delegate.commit()}},as=class n{constructor(e,t,r){this._firestore=e,this._userDataWriter=t,this._delegate=r}fromFirestore(e,t){let r=new Wn(this._firestore._delegate,this._userDataWriter,e._key,e._document,e.metadata,null);return this._delegate.fromFirestore(new $r(this._firestore,r),t??{})}toFirestore(e,t){return t?this._delegate.toFirestore(e,t):this._delegate.toFirestore(e)}static getInstance(e,t){let r=n.INSTANCES,i=r.get(e);i||(i=new WeakMap,r.set(e,i));let s=i.get(t);return s||(s=new n(e,new os(e),t),i.set(t,s)),s}};as.INSTANCES=new WeakMap;var tn=class n{constructor(e,t){this.firestore=e,this._delegate=t,this._userDataWriter=new os(e)}static forPath(e,t,r){if(e.length%2!==0)throw new k("invalid-argument",`Invalid document reference. Document references must have an even number of segments, but ${e.canonicalString()} has ${e.length}`);return new n(t,new ye(t._delegate,r,new L(e)))}static forKey(e,t,r){return new n(t,new ye(t._delegate,r,e))}get id(){return this._delegate.id}get parent(){return new ls(this.firestore,this._delegate.parent)}get path(){return this._delegate.path}collection(e){try{return new ls(this.firestore,jm(this._delegate,e))}catch(t){throw ut(t,"collection()","DocumentReference.collection()")}}isEqual(e){return e=te(e),e instanceof ye?zm(this._delegate,e):!1}set(e,t){t=og("DocumentReference.set",t);try{return t?Jm(this._delegate,e,t):Jm(this._delegate,e)}catch(r){throw ut(r,"setDoc()","DocumentReference.set()")}}update(e,t,...r){try{return arguments.length===1?Xm(this._delegate,e):Xm(this._delegate,e,t,...r)}catch(i){throw ut(i,"updateDoc()","DocumentReference.update()")}}delete(){return qT(this._delegate)}onSnapshot(...e){let t=XT(e),r=ZT(e,i=>new Qr(this.firestore,new bt(this.firestore._delegate,this._userDataWriter,i._key,i._document,i.metadata,this._delegate.converter)));return Zm(this._delegate,t,r)}get(e){let t;return e?.source==="cache"?t=OT(this._delegate):e?.source==="server"?t=MT(this._delegate):t=FT(this._delegate),t.then(r=>new Qr(this.firestore,new bt(this.firestore._delegate,this._userDataWriter,r._key,r._document,r.metadata,this._delegate.converter)))}withConverter(e){return new n(this.firestore,e?this._delegate.withConverter(as.getInstance(this.firestore,e)):this._delegate.withConverter(null))}};function ut(n,e,t){return n.message=n.message.replace(e,t),n}function XT(n){for(let e of n)if(typeof e=="object"&&!tg(e))return e;return{}}function ZT(n,e){var t,r;let i;return tg(n[0])?i=n[0]:tg(n[1])?i=n[1]:typeof n[0]=="function"?i={next:n[0],error:n[1],complete:n[2]}:i={next:n[1],error:n[2],complete:n[3]},{next:s=>{i.next&&i.next(e(s))},error:(t=i.error)===null||t===void 0?void 0:t.bind(i),complete:(r=i.complete)===null||r===void 0?void 0:r.bind(i)}}var Qr=class{constructor(e,t){this._firestore=e,this._delegate=t}get ref(){return new tn(this._firestore,this._delegate.ref)}get id(){return this._delegate.id}get metadata(){return this._delegate.metadata}get exists(){return this._delegate.exists()}data(e){return this._delegate.data(e)}get(e,t){return this._delegate.get(e,t)}isEqual(e){return Ym(this._delegate,e._delegate)}},$r=class extends Qr{data(e){let t=this._delegate.data(e);return this._delegate._converter||NE(t!==void 0,"Document in a QueryDocumentSnapshot should exist"),t}},Hr=class n{constructor(e,t){this.firestore=e,this._delegate=t,this._userDataWriter=new os(e)}where(e,t,r){try{return new n(this.firestore,wn(this._delegate,CT(e,t,r)))}catch(i){throw ut(i,/(orderBy|where)\(\)/,"Query.$1()")}}orderBy(e,t){try{return new n(this.firestore,wn(this._delegate,AT(e,t)))}catch(r){throw ut(r,/(orderBy|where)\(\)/,"Query.$1()")}}limit(e){try{return new n(this.firestore,wn(this._delegate,bT(e)))}catch(t){throw ut(t,"limit()","Query.limit()")}}limitToLast(e){try{return new n(this.firestore,wn(this._delegate,RT(e)))}catch(t){throw ut(t,"limitToLast()","Query.limitToLast()")}}startAt(...e){try{return new n(this.firestore,wn(this._delegate,PT(...e)))}catch(t){throw ut(t,"startAt()","Query.startAt()")}}startAfter(...e){try{return new n(this.firestore,wn(this._delegate,xT(...e)))}catch(t){throw ut(t,"startAfter()","Query.startAfter()")}}endBefore(...e){try{return new n(this.firestore,wn(this._delegate,NT(...e)))}catch(t){throw ut(t,"endBefore()","Query.endBefore()")}}endAt(...e){try{return new n(this.firestore,wn(this._delegate,DT(...e)))}catch(t){throw ut(t,"endAt()","Query.endAt()")}}isEqual(e){return Km(this._delegate,e._delegate)}get(e){let t;return e?.source==="cache"?t=UT(this._delegate):e?.source==="server"?t=BT(this._delegate):t=LT(this._delegate),t.then(r=>new ia(this.firestore,new Ot(this.firestore._delegate,this._userDataWriter,this._delegate,r._snapshot)))}onSnapshot(...e){let t=XT(e),r=ZT(e,i=>new ia(this.firestore,new Ot(this.firestore._delegate,this._userDataWriter,this._delegate,i._snapshot)));return Zm(this._delegate,t,r)}withConverter(e){return new n(this.firestore,e?this._delegate.withConverter(as.getInstance(this.firestore,e)):this._delegate.withConverter(null))}},rg=class{constructor(e,t){this._firestore=e,this._delegate=t}get type(){return this._delegate.type}get doc(){return new $r(this._firestore,this._delegate.doc)}get oldIndex(){return this._delegate.oldIndex}get newIndex(){return this._delegate.newIndex}},ia=class{constructor(e,t){this._firestore=e,this._delegate=t}get query(){return new Hr(this._firestore,this._delegate.query)}get metadata(){return this._delegate.metadata}get size(){return this._delegate.size}get empty(){return this._delegate.empty}get docs(){return this._delegate.docs.map(e=>new $r(this._firestore,e))}docChanges(e){return this._delegate.docChanges(e).map(t=>new rg(this._firestore,t))}forEach(e,t){this._delegate.forEach(r=>{e.call(t,new $r(this._firestore,r))})}isEqual(e){return Ym(this._delegate,e._delegate)}},ls=class n extends Hr{constructor(e,t){super(e,t),this.firestore=e,this._delegate=t}get id(){return this._delegate.id}get path(){return this._delegate.path}get parent(){let e=this._delegate.parent;return e?new tn(this.firestore,e):null}doc(e){try{return e===void 0?new tn(this.firestore,ra(this._delegate)):new tn(this.firestore,ra(this._delegate,e))}catch(t){throw ut(t,"doc()","CollectionReference.doc()")}}add(e){return GT(this._delegate,e).then(t=>new tn(this.firestore,t))}isEqual(e){return zm(this._delegate,e._delegate)}withConverter(e){return new n(this.firestore,e?this._delegate.withConverter(as.getInstance(this.firestore,e)):this._delegate.withConverter(null))}};function Wr(n){return ae(n,ye)}var ig=class n{constructor(...e){this._delegate=new Ft(...e)}static documentId(){return new n(Pe.keyField().canonicalString())}isEqual(e){return e=te(e),e instanceof Ft?this._delegate._internalPath.isEqual(e._internalPath):!1}};var sg=class n{constructor(e){this._delegate=e}static serverTimestamp(){let e=WT();return e._methodName="FieldValue.serverTimestamp",new n(e)}static delete(){let e=KT();return e._methodName="FieldValue.delete",new n(e)}static arrayUnion(...e){let t=QT(...e);return t._methodName="FieldValue.arrayUnion",new n(t)}static arrayRemove(...e){let t=$T(...e);return t._methodName="FieldValue.arrayRemove",new n(t)}static increment(e){let t=HT(e);return t._methodName="FieldValue.increment",new n(t)}isEqual(e){return this._delegate.isEqual(e._delegate)}};var eP={Firestore:gc,GeoPoint:Br,Timestamp:Se,Blob:mc,Transaction:_c,WriteBatch:yc,DocumentReference:tn,DocumentSnapshot:Qr,Query:Hr,QueryDocumentSnapshot:$r,QuerySnapshot:ia,CollectionReference:ls,FieldPath:ig,FieldValue:sg,setLogLevel:ZR,CACHE_SIZE_UNLIMITED:aT};function tP(n,e){n.INTERNAL.registerComponent(new Bt("firestore-compat",t=>{let r=t.getProvider("app-compat").getImmediate(),i=t.getProvider("firestore").getImmediate();return e(r,i)},"PUBLIC").setServiceProps(Object.assign({},eP)))}function nP(n){tP(n,(e,t)=>new gc(e,t,new ng)),n.registerVersion(YR,JR)}nP(xn);function rP(n,e=Sa){return new Ta(t=>{let r;return e!=null?e.schedule(()=>{r=n.onSnapshot({includeMetadataChanges:!0},t)}):r=n.onSnapshot({includeMetadataChanges:!0},t),()=>{r?.()}})}function e0(n,e){return rP(n,e)}function iP(n,e){return e0(n,e).pipe(ba(void 0),Aa(),De(t=>{let[r,i]=t;return i.exists?r?.exists?{payload:i,type:"modified"}:{payload:i,type:"added"}:{payload:i,type:"removed"}}))}function ug(n,e){return e0(n,e).pipe(De(t=>({payload:t,type:"query"})))}var vc=class{ref;afs;constructor(e,t){this.ref=e,this.afs=t}set(e,t){return this.ref.set(e,t)}update(e){return this.ref.update(e)}delete(){return this.ref.delete()}collection(e,t){let r=this.ref.collection(e),{ref:i,query:s}=s0(r,t);return new Ec(i,s,this.afs)}snapshotChanges(){return iP(this.ref,this.afs.schedulers.outsideAngular).pipe(Ue)}valueChanges(e={}){return this.snapshotChanges().pipe(De(({payload:t})=>e.idField?Ps(Cn({},t.data()),{[e.idField]:t.id}):t.data()))}get(e){return xs(this.ref.get(e)).pipe(Ue)}};function wc(n,e){return ug(n,e).pipe(ba(void 0),Aa(),De(t=>{let[r,i]=t,s=i.payload.docChanges(),o=s.map(l=>({type:l.type,payload:l}));return r&&JSON.stringify(r.payload.metadata)!==JSON.stringify(i.payload.metadata)&&i.payload.docs.forEach((l,u)=>{let c=s.find(p=>p.doc.ref.isEqual(l.ref)),d=r?.payload.docs.find(p=>p.ref.isEqual(l.ref));c&&JSON.stringify(c.doc.metadata)===JSON.stringify(l.metadata)||!c&&d&&JSON.stringify(d.metadata)===JSON.stringify(l.metadata)||o.push({type:"modified",payload:{oldIndex:u,newIndex:u,type:"modified",doc:l}})}),o}))}function t0(n,e,t){return wc(n,t).pipe(cr((r,i)=>sP(r,i.map(s=>s.payload),e),[]),Ca(),De(r=>r.map(i=>({type:i.type,payload:i}))))}function sP(n,e,t){return e.forEach(r=>{t.indexOf(r.type)>-1&&(n=oP(n,r))}),n}function ag(n,e,t,...r){let i=n.slice();return i.splice(e,t,...r),i}function oP(n,e){switch(e.type){case"added":if(!(n[e.newIndex]&&n[e.newIndex].doc.ref.isEqual(e.doc.ref)))return ag(n,e.newIndex,0,e);break;case"modified":if(n[e.oldIndex]==null||n[e.oldIndex].doc.ref.isEqual(e.doc.ref))if(e.oldIndex!==e.newIndex){let t=n.slice();return t.splice(e.oldIndex,1),t.splice(e.newIndex,0,e),t}else return ag(n,e.newIndex,1,e);break;case"removed":if(n[e.oldIndex]&&n[e.oldIndex].doc.ref.isEqual(e.doc.ref))return ag(n,e.oldIndex,1);break}return n}function n0(n){return(!n||n.length===0)&&(n=["added","removed","modified"]),n}var Ec=class{ref;query;afs;constructor(e,t,r){this.ref=e,this.query=t,this.afs=r}stateChanges(e){let t=wc(this.query,this.afs.schedulers.outsideAngular);return e&&e.length>0&&(t=t.pipe(De(r=>r.filter(i=>e.indexOf(i.type)>-1)))),t.pipe(ba(void 0),Aa(),Zc(([r,i])=>i.length>0||!r),De(([,r])=>r),Ue)}auditTrail(e){return this.stateChanges(e).pipe(cr((t,r)=>[...t,...r],[]))}snapshotChanges(e){let t=n0(e);return t0(this.query,t,this.afs.schedulers.outsideAngular).pipe(Ue)}valueChanges(e={}){return ug(this.query,this.afs.schedulers.outsideAngular).pipe(De(t=>t.payload.docs.map(r=>e.idField?Ps(Cn({},r.data()),{[e.idField]:r.id}):r.data())),Ue)}get(e){return xs(this.query.get(e)).pipe(Ue)}add(e){return this.ref.add(e)}doc(e){return new vc(this.ref.doc(e),this.afs)}},lg=class{query;afs;constructor(e,t){this.query=e,this.afs=t}stateChanges(e){return!e||e.length===0?wc(this.query,this.afs.schedulers.outsideAngular).pipe(Ue):wc(this.query,this.afs.schedulers.outsideAngular).pipe(De(t=>t.filter(r=>e.indexOf(r.type)>-1)),Zc(t=>t.length>0),Ue)}auditTrail(e){return this.stateChanges(e).pipe(cr((t,r)=>[...t,...r],[]))}snapshotChanges(e){let t=n0(e);return t0(this.query,t,this.afs.schedulers.outsideAngular).pipe(Ue)}valueChanges(e={}){return ug(this.query,this.afs.schedulers.outsideAngular).pipe(De(r=>r.payload.docs.map(i=>e.idField?Cn({[e.idField]:i.id},i.data()):i.data())),Ue)}get(e){return xs(this.query.get(e)).pipe(Ue)}},r0=new An("angularfire2.enableFirestorePersistence"),i0=new An("angularfire2.firestore.persistenceSettings"),aP=new An("angularfire2.firestore.settings"),lP=new An("angularfire2.firestore.use-emulator");function s0(n,e=t=>t){return{query:e(n),ref:n}}var cg=(()=>{class n{schedulers;firestore;persistenceEnabled$;constructor(t,r,i,s,o,l,u,c,d,p,m,y,C,x,D,q,j){this.schedulers=u;let B=Ha(t,l,r),Y=d;p&&rl(B,l,m,C,x,D,y,q),[this.firestore,this.persistenceEnabled$]=Ya(`${B.name}.firestore`,"AngularFirestore",B.name,()=>{let re=l.runOutsideAngular(()=>B.firestore());if(s&&re.settings(s),Y&&re.useEmulator(...Y),i&&!A_(o)){let Q=()=>{try{return xs(re.enablePersistence(c||void 0).then(()=>!0,()=>!1))}catch(E){return typeof console<"u"&&console.warn(E),Ns(!1)}};return[re,l.runOutsideAngular(Q)]}else return[re,Ns(!1)]},[s,Y,i])}collection(t,r){let i;typeof t=="string"?i=this.firestore.collection(t):i=t;let{ref:s,query:o}=s0(i,r),l=this.schedulers.ngZone.run(()=>s);return new Ec(l,o,this)}collectionGroup(t,r){let i=r||(o=>o),s=this.firestore.collectionGroup(t);return new lg(i(s),this)}doc(t){let r;typeof t=="string"?r=this.firestore.doc(t):r=t;let i=this.schedulers.ngZone.run(()=>r);return new vc(i,this)}createId(){return this.firestore.collection("_").doc().id}static \u0275fac=function(r){return new(r||n)(ee(Qa),ee($a,8),ee(r0,8),ee(aP,8),ee(Na),ee(xa),ee(Wa),ee(i0,8),ee(lP,8),ee(il,8),ee(Ja,8),ee(Xa,8),ee(Za,8),ee(el,8),ee(tl,8),ee(nl,8),ee(Ka,8))};static \u0275prov=ei({token:n,factory:n.\u0275fac,providedIn:"any"})}return n})(),o0=(()=>{class n{constructor(){xn.registerVersion("angularfire",za.full,"fst-compat")}static enablePersistence(t){return{ngModule:n,providers:[{provide:r0,useValue:!0},{provide:i0,useValue:t}]}}static \u0275fac=function(r){return new(r||n)};static \u0275mod=Pa({type:n});static \u0275inj=Ra({providers:[cg]})}return n})();var cP=["*"];function hP(n,e){if(n&1){let t=Da();ue(0,"div",1)(1,"div",2)(2,"span",3)(3,"button",4),vt("click",function(){Ds(t);let i=dr();return ks(i.onClose())}),fe(4,"\xD7"),ie()(),I_(5),ie()()}}var Ic=class n{showModal=!1;closeModal=new v_;onClose(){this.closeModal.emit()}static \u0275fac=function(t){return new(t||n)};static \u0275cmp=bn({type:n,selectors:[["app-modal"]],inputs:{showModal:"showModal"},outputs:{closeModal:"closeModal"},standalone:!0,features:[Rn],ngContentSelectors:cP,decls:1,vars:1,consts:[["class","fixed inset-0 z-50 overflow-auto bg-gray-900/60 flex",4,"ngIf"],[1,"fixed","inset-0","z-50","overflow-auto","bg-gray-900/60","flex"],[1,"relative","p-8","bg-white","w-full","max-w-md","m-auto","flex-col","flex","rounded-lg"],[1,"absolute","top-0","right-0","p-4"],[1,"text-black",3,"click"]],template:function(t,r){t&1&&(E_(),Pt(0,hP,6,0,"div",0)),t&2&&Lt("ngIf",r.showModal)},dependencies:[Va]})};var Tc=class n{constructor(e){this.sanitizer=e}transform(e){return this.sanitizer.bypassSecurityTrustHtml(e)}static \u0275fac=function(t){return new(t||n)(Mt(R_,16))};static \u0275pipe=__({name:"safeHtml",type:n,pure:!0,standalone:!0})};var us=class n{constructor(e){this.afs=e}getAllExpenses(){return this.afs.collection("expenses").snapshotChanges().pipe(De(e=>e.map(t=>{let r=t.payload.doc.data(),i=t.payload.doc.id;return r.key=i,Cn({},r)})))}getExpense(e){return this.afs.collection("expenses").doc(e).valueChanges()}addExpense(e){this.afs.collection("expenses").add(e)}updateExpense(e,t){this.afs.collection("expenses").doc(e).update(t)}deleteExpense(e){this.afs.doc("expenses/"+e).delete()}static \u0275fac=function(t){return new(t||n)(ee(cg))};static \u0275prov=ei({token:n,factory:n.\u0275fac,providedIn:"root"})};function pP(n,e){n&1&&(ue(0,"div",4),fe(1,"Unauthorised! Please login to add/update items."),ie())}function mP(n,e){if(n&1){let t=Da();ue(0,"div",8)(1,"div",9)(2,"div",10)(3,"div",11)(4,"h5",12),fe(5),ie(),ue(6,"h2",13),fe(7),fr(8,"number"),ie(),an(9,"p",14),fr(10,"safeHtml"),ue(11,"div",15)(12,"button",16),vt("click",function(){let i=Ds(t).$implicit,s=dr();return ks(s.editExpense(i.key))}),fe(13,"Edit"),ie(),ue(14,"button",17),vt("click",function(){let i=Ds(t).$implicit,s=dr();return ks(s.deleteExpense(i.key))}),fe(15,"Remove"),ie()()()()()()}if(n&2){let t=e.$implicit;Ke(5),ka(t.title),Ke(2),eh("\xA3",th(8,3,t.price,"1.2-2"),""),Ke(2),Lt("innerHTML",Vs(10,6,t.description),w_)}}var Sc=class n{constructor(e,t){this.expenseService=e;this.router=t;this.items=this.getAllDocuments(),this.isLoggedIn.subscribe(r=>{this.authorised=r}),this.items.subscribe(r=>{this.totalPrice=0,r.forEach(i=>{this.totalPrice+=Number(i.price)})})}items;totalPrice=0;isLoggedIn=on(ln).isLoggedIn();authorised;authService=on(ln);unauthorised=!1;isLoginFormModelOpen=!1;getAllDocuments(){return this.expenseService.getAllExpenses()}editExpense(e){this.router.navigate(["/expense-form/"+e])}deleteExpense(e){this.authorised?this.expenseService.deleteExpense(e):this.unauthorised=!0}addExpense(){this.authorised?this.router.navigate(["/expense-form"]):this.unauthorised=!0}ngOnInit(){}ngOnDestroy(){}static \u0275fac=function(t){return new(t||n)(Mt(us),Mt(Oa))};static \u0275cmp=bn({type:n,selectors:[["app-expense"]],standalone:!0,features:[Rn],decls:13,vars:9,consts:[[1,"mb-4","d-flex","justify-content-between","align-items-center"],["type","button","routerLink","/expense-form",1,"btn","btn-primary",3,"click"],[1,"fw-bold","align-items-center"],[1,"text-success"],[1,"form-text","text-danger","fw-bold"],["class","mt-4",4,"ngFor","ngForOf"],[3,"closeModal","showModal"],[3,"formSubmit"],[1,"mt-4"],[1,"d-flex","flex-column","gap-3"],[1,"card"],[1,"card-body"],[1,"card-title"],[1,"fw-bold","text-success"],[1,"card-text",3,"innerHTML"],[1,"d-flex","gap-2"],[1,"btn","btn-sm","btn-success",3,"click"],[1,"btn","btn-sm","btn-danger",3,"click"]],template:function(t,r){t&1&&(ue(0,"div",0)(1,"button",1),vt("click",function(){return r.addExpense()}),fe(2,"Add Expense"),ie(),ue(3,"h5",2),fe(4,"Total Expenses: "),ue(5,"strong",3),fe(6),fr(7,"number"),ie()()(),Pt(8,pP,2,0,"div",4)(9,mP,16,8,"div",5),fr(10,"async"),ue(11,"app-modal",6),vt("closeModal",function(){return r.isLoginFormModelOpen=!1}),ue(12,"app-login-form",7),vt("formSubmit",function(){return r.isLoginFormModelOpen=!1}),ie()()),t&2&&(Ke(6),eh("\xA3",th(7,4,r.totalPrice,"1.2-2"),""),Ke(2),hr(r.unauthorised?8:-1),Ke(),Lt("ngForOf",Vs(10,7,r.items)),Ke(2),Lt("showModal",r.isLoginFormModelOpen))},dependencies:[ti,S_,Fa,C_,Ma,N_,Ic,ty,Tc]})};function l0(n){return e=>n.test(e.value)?{forbiddenName:{value:e.value}}:null}function gP(n,e){n&1&&(ue(0,"div",6),fe(1,"Title is a required field"),ie())}function _P(n,e){n&1&&(ue(0,"div",6),fe(1,"Price is a required field"),ie())}function yP(n,e){n&1&&(ue(0,"div",6),fe(1,"Contains an illegal name"),ie())}function vP(n,e){n&1&&(ue(0,"div",6),fe(1,"Unauthorised! Please login to add/update items."),ie())}var sa=class n{constructor(e,t,r,i){this.fb=e;this.afs=t;this.activatedRoute=r;this.router=i;this.expenseForm=this.fb.group({price:new sl("",[ah.required]),title:new sl("",[ah.required]),description:new sl("",[l0(/craig/i)])})}expenseForm;expenseId;isLoggedIn=on(ln).isLoggedIn();authorised;authService=on(ln);unauthorised=!1;ngOnInit(){this.isLoggedIn.subscribe(e=>{this.authorised=e}),this.activatedRoute.params.subscribe({next:e=>this.expenseId=e.id}),this.getExpense(this.expenseId)}getExpense(e){this.afs.getExpense(e).subscribe(t=>{this.expenseForm.patchValue(t)})}addExpense(){this.authorised?(this.afs.addExpense(this.expenseForm.value),this.router.navigate(["./"])):this.unauthorised=!0}updateExpense(){this.expenseForm.valid&&this.authorised?(this.activatedRoute.params.subscribe({next:e=>e.id?this.afs.updateExpense(e.id,this.expenseForm.value):this.afs.addExpense(this.expenseForm.value)}),this.router.navigate(["./"])):(this.expenseForm.markAllAsTouched(),this.expenseForm.hasError,this.unauthorised=!0)}static \u0275fac=function(t){return new(t||n)(Mt(Z_),Mt(us),Mt(P_),Mt(Oa))};static \u0275cmp=bn({type:n,selectors:[["app-expense-form"]],standalone:!0,features:[Rn],decls:23,vars:5,consts:[[1,"row"],[1,"col-lg-6"],[3,"formGroup"],[1,"mb-3"],["for","title",1,"form-label"],["type","text","id","title","placeholder","Title","formControlName","title",1,"form-control"],[1,"form-text","text-danger","fw-bold"],["for","price",1,"form-label"],["type","number","id","price","placeholder","Price","formControlName","price",1,"form-control"],["for","description",1,"form-label"],["type","password","id","description","formControlName","description",1,"form-control"],["type","submit",1,"btn","btn-success",3,"click"]],template:function(t,r){if(t&1&&(ue(0,"div",0)(1,"div",1)(2,"h4"),fe(3,"Expense Form"),ie(),ue(4,"form",2)(5,"div",3)(6,"label",4),fe(7,"Title"),ie(),an(8,"input",5),Pt(9,gP,2,0,"div",6),ie(),ue(10,"div",3)(11,"label",7),fe(12,"Price"),ie(),an(13,"input",8),Pt(14,_P,2,0,"div",6),ie(),ue(15,"div",3)(16,"label",9),fe(17,"Description"),ie(),an(18,"textarea",10),Pt(19,yP,2,0,"div",6),ie(),ue(20,"button",11),vt("click",function(s){return s.preventDefault(),r.updateExpense()}),fe(21,"Save Changes"),ie()(),Pt(22,vP,2,0,"div",6),ie()()),t&2){let i,s,o;Ke(4),Lt("formGroup",r.expenseForm),Ke(5),hr((i=r.expenseForm.get("title"))!=null&&i.hasError("required")&&((i=r.expenseForm.get("title"))!=null&&i.touched)?9:-1),Ke(5),hr((s=r.expenseForm.get("price"))!=null&&s.hasError("required")&&((s=r.expenseForm.get("price"))!=null&&s.touched)?14:-1),Ke(5),hr((o=r.expenseForm.get("description"))!=null&&o.hasError("forbiddenName")&&((o=r.expenseForm.get("description"))!=null&&o.touched)?19:-1),Ke(3),hr(r.unauthorised?22:-1)}},dependencies:[ti,ey,H_,W_,Y_,Q_,$_,J_,X_,Ma]})};var u0=[{path:"",component:Sc},{path:"expense-form",component:sa},{path:"expense-form/:id",component:sa},{path:"login",loadComponent:()=>import("./chunk-WP4JSLYM.js").then(n=>n.LoginComponent)},{path:"signup",loadComponent:()=>import("./chunk-QKFDAES5.js").then(n=>n.SignupComponent)},{path:"reset",loadComponent:()=>import("./chunk-T5PCNJGG.js").then(n=>n.ResetComponent)}];var c0={apiKey:"AIzaSyAdWLVOkP8pLrNZkELpC8Mm1fVdbkd1kEk",authDomain:"expenses-5d437.firebaseapp.com",projectId:"expenses-5d437",storageBucket:"expenses-5d437.appspot.com",messagingSenderId:"202582971776",appId:"1:202582971776:web:6b55340bb59e17d4565d65"};var h0={providers:[T_({eventCoalescing:!0}),D_(u0),y_([z_.initializeApp(c0),K_,Sw,o0])]};function wP(n,e){if(n&1&&(ue(0,"div",13),fe(1,"Logged on user: "),ue(2,"strong"),fe(3),ie()()),n&2){let t=dr();Ke(3),ka(t.user)}}var Cc=class n{title="expenses";auth=on(ln);isLoginFormModelOpen=!1;isLoggedIn=on(ln).isLoggedIn();user;logOut(){this.auth.logout()}ngOnInit(){this.isLoggedIn.subscribe(e=>{if(e){let t=localStorage.getItem("user");if(t){let r=JSON.parse(t);this.user=r.email}}})}static \u0275fac=function(t){return new(t||n)};static \u0275cmp=bn({type:n,selectors:[["app-root"]],standalone:!0,features:[Rn],decls:21,vars:3,consts:[[1,"navbar","navbar-expand-lg","border-bottom","sticky-top","navbar-light","bg-light"],[1,"container-fluid"],["href","#",1,"navbar-brand"],["type","button","data-bs-toggle","collapse","data-bs-target","#navbarSupportedContent","aria-controls","navbarSupportedContent","aria-expanded","false","aria-label","Toggle navigation",1,"navbar-toggler"],[1,"navbar-toggler-icon"],["id","navbarSupportedContent",1,"collapse","navbar-collapse"],[1,"navbar-nav","me-auto","mb-2","mb-lg-0"],[1,"nav-item"],["aria-current","page","href","/",1,"nav-link","active"],["aria-current","page","href","/login",1,"nav-link","active"],["aria-current","page","href","/",1,"nav-link","active",3,"click"],["class","align-items-center",4,"ngIf"],[1,"container","my-4"],[1,"align-items-center"]],template:function(t,r){t&1&&(ue(0,"nav",0)(1,"div",1)(2,"a",2),fe(3,"Expense Tracker"),ie(),ue(4,"button",3),an(5,"span",4),ie(),ue(6,"div",5)(7,"ul",6)(8,"li",7)(9,"a",8),fe(10,"Home"),ie()(),ue(11,"li",7)(12,"a",9),fe(13,"Login"),ie()(),ue(14,"li",7)(15,"a",10),vt("click",function(){return r.logOut()}),fe(16,"Logout"),ie()()(),Pt(17,wP,4,1,"div",11),fr(18,"async"),ie()()(),ue(19,"div",12),an(20,"router-outlet"),ie()),t&2&&(Ke(17),Lt("ngIf",Vs(18,1,r.isLoggedIn)))},dependencies:[x_,ti,Va,Fa]})};b_(Cc,h0).catch(n=>console.error(n));
